<!DOCTYPE html>
<html>
<head>
    <title>CSV API</title>
    <meta http-equiv="Access-Control-Allow-Origin" content="*">
    <meta http-equiv="Access-Control-Allow-Methods" content="GET, OPTIONS">
    <meta http-equiv="Access-Control-Allow-Headers" content="Origin, X-Requested-With, Content-Type, Accept">
    <script>
        // อ่านไฟล์ CSV และแปลงเป็น JSON
        async function loadCSV() {
            const response = await fetch('data.csv');
            const csvText = await response.text();
            
            // แปลง CSV เป็น Array ของ Objects
            const lines = csvText.split('\n');
            const headers = lines[0].split(',').map(header => header.trim());
            
            const jsonData = lines.slice(1).map(line => {
                const values = line.split(',');
                return headers.reduce((obj, header, index) => {
                    obj[header] = values[index]?.trim();
                    return obj;
                }, {});
            });

            // เก็บข้อมูลใน localStorage
            localStorage.setItem('apiData', JSON.stringify(jsonData));
            
            return jsonData;
        }

        // สร้าง CORS Response
        function createCORSResponse(responseData) {
            return {
                headers: {
                    'Access-Control-Allow-Origin': '*',
                    'Access-Control-Allow-Methods': 'GET, OPTIONS',
                    'Access-Control-Allow-Headers': 'Origin, X-Requested-With, Content-Type, Accept',
                    'Content-Type': 'application/json'
                },
                ...responseData
            };
        }

        // API Endpoints
        async function handleRequest() {
            // ตรวจสอบว่าเป็น API request หรือไม่
            const isApiRequest = window.location.search.includes('format=json') || 
                               (window.location.pathname.startsWith('/api/'));

            let data = localStorage.getItem('apiData');
            if (!data) {
                data = await loadCSV();
            } else {
                data = JSON.parse(data);
            }

            // ถ้าเป็น API request ให้ส่งคืน JSON
            if (isApiRequest) {
                const path = window.location.hash.slice(1) || '/';
                
                switch (path) {
                    case '/':
                        return createCORSResponse({
                            status: 200,
                            data: data
                        });
                    default:
                        const id = path.split('/')[1];
                        if (id) {
                            const item = data.find(item => item.id === id);
                            if (item) {
                                return createCORSResponse({
                                    status: 200,
                                    data: item
                                });
                            }
                        }
                        return createCORSResponse({
                            status: 404,
                            error: 'Not found'
                        });
                }
            }

            // ถ้าไม่ใช่ API request ให้แสดงหน้า UI ปกติ
            return {
                status: 200,
                isHtml: true,
                data: data
            };
        }

        // แสดงผลลัพธ์
        async function displayResponse() {
            const result = await handleRequest();
            
            if (result.isHtml) {
                // แสดงผลในหน้าเว็บ
                document.getElementById('response').textContent = 
                    JSON.stringify(result.data, null, 2);
            } else {
                // ส่งคืน JSON response
                document.getElementById('content').style.display = 'none';
                document.write(JSON.stringify(result));
            }
        }

        // Event Listeners
        window.addEventListener('load', displayResponse);
        window.addEventListener('hashchange', displayResponse);
    </script>
</head>
<body>
    <div id="content">
        <h1>CSV API</h1>
        <p>API Endpoints:</p>
        <ul>
            <li>GET /api/ หรือ /?format=json - แสดงข้อมูลทั้งหมดในรูปแบบ JSON</li>
            <li>GET /api/#/:id หรือ /?format=json#/:id - แสดงข้อมูลตาม ID ในรูปแบบ JSON</li>
        </ul>
        <h2>ตัวอย่างข้อมูล:</h2>
        <pre id="response"></pre>
    </div>
</body>
</html>
