<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NoteMap</title>
    <link rel="stylesheet" href="https://js.arcgis.com/4.22/esri/themes/light/main.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        html, body, #viewDiv { padding: 0; margin: 0; height: 100%; width: 100%; }
        .esri-view .esri-view-surface--inset-outline:focus::after { outline: none !important; }
        
        .top-toolbar-container {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            z-index: 1000;
            display: flex; flex-direction: column; align-items: center;
        }

        .top-toolbar {
            background: white; padding: 5px; border-radius: 5px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            display: flex; transition: all 0.3s ease;
            max-height: 60px; overflow: hidden; opacity: 1;
        }

        .top-toolbar.collapsed {
            max-height: 0; padding: 0; opacity: 0; margin: 0; border: none;
        }

        .toolbar-toggle-btn {
            background: white; border: none; border-radius: 0 0 10px 10px;
            box-shadow: 0 4px 4px rgba(0,0,0,0.2); padding: 0px 15px;
            cursor: pointer; color: #666; font-size: 12px; height: 20px;
            line-height: 20px; margin-top: -2px; z-index: 999;
        }
        .toolbar-toggle-btn:hover { background: #f8f9fa; color: #000; }

        .home-button {
            position: absolute; top: 10px; right: 10px; z-index: 1000;
            background: white; padding: 8px; border-radius: 5px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3); cursor: pointer; color: #333;
        }
        .home-button:hover { background: #f0f0f0; color: #000; }

        .panel {
            position: absolute; background-color: white; padding: 10px;
            border-radius: 5px; box-shadow: 0 0 10px rgba(0,0,0,0.1);
            display: none; z-index: 1000;
        }

        #layerPanel { top: 60px; right: 10px; width: 300px; max-height: 80%; overflow-y: auto; }
        #searchPanel { top: 60px; left: 10px; width: 320px; }
        #addServicePanel { top: 60px; left: 10px; }
        #exportPanel { top: 60px; right: 60px; width: 300px; }
        #basemapGalleryPanel, #printPanel { top: 60px; right: 10px; width: 280px; max-height: 400px; overflow-y: auto; }
        
        .draw-tools {
            position: absolute; top: 60px; left: 10px; z-index: 1000;
            background: white; padding: 10px; border-radius: 5px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3); display: none; width: 280px;
        }
        
        .draw-layer-control { border-bottom: 1px solid #ddd; padding-bottom: 10px; margin-bottom: 10px; }
        .color-picker, .buffer-control { margin: 5px 0; }
        .close-btn { position: absolute; top: 5px; right: 5px; cursor: pointer; font-size: 20px; color: #666; }
        .layer-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .layer-controls { display: flex; gap: 5px; }
        
        .custom-modal {
            display: none; position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%); background: white; padding: 20px;
            border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 2000; min-width: 350px;
        }
        .modal-backdrop {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 1999;
        }
        
        .btn-toolbar-custom { padding: 6px 12px; margin: 0 2px; border: none; background: transparent; color: #333; }
        .btn-toolbar-custom:hover { background: #f0f0f0; }
        .tool-active { background: #e0e0e0; color: #000; }
        
        .excel-import-panel {
            position: absolute; top: 60px; left: 10px; z-index: 1000;
            background: white; padding: 15px; border-radius: 5px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3); display: none; width: 300px;
        }
        .search-type-selector { display: flex; gap: 15px; margin-bottom: 10px; }
    </style>
</head>
<body>
    <div id="viewDiv"></div>

    <div class="top-toolbar-container">
        <div class="top-toolbar btn-group" id="mainToolbar">
            <button id="basemapBtn" class="btn btn-toolbar-custom" title="Basemap Gallery"><i class="fas fa-layer-group"></i></button>
            <button id="fullscreenBtn" class="btn btn-toolbar-custom" title="Fullscreen"><i class="fas fa-expand"></i></button>
            <button id="searchBtn" class="btn btn-toolbar-custom" title="Search"><i class="fas fa-search"></i></button>
            <button id="printBtn" class="btn btn-toolbar-custom" title="Print"><i class="fas fa-print"></i></button>
            <button id="addServiceBtn" class="btn btn-toolbar-custom" title="Add Service"><i class="fas fa-plus"></i></button>
            <button id="drawBtn" class="btn btn-toolbar-custom" title="Draw"><i class="fas fa-pen"></i></button>
            <button id="layerListBtn" class="btn btn-toolbar-custom" title="Layer List"><i class="fas fa-list"></i></button>
            <button id="locationBtn" class="btn btn-toolbar-custom" title="Track Location"><i class="fas fa-location-dot"></i></button> 
            <button id="exportPanelBtn" class="btn btn-toolbar-custom" title="Export Data"><i class="fas fa-download"></i></button> 
            <button id="excelImportBtn" class="btn btn-toolbar-custom" title="Import Excel"><i class="fas fa-file-excel"></i></button>
        </div>
        <button id="toolbarToggleBtn" class="toolbar-toggle-btn" title="Show/Hide Toolbar">
            <i class="fas fa-chevron-up" id="toggleIcon"></i>
        </button>
    </div>

    <a href="index.html" class="home-button" title="Home"><i class="fas fa-home"></i></a>

    <div id="drawTools" class="draw-tools">
        <span class="close-btn" onclick="closePanel('drawTools')">×</span>
        <h6>Draw Tools</h6>
        <div class="draw-layer-control">
            <label class="form-label small">Active Draw Layer:</label>
            <select id="drawLayerSelect" class="form-select form-select-sm mb-2"></select>
            <label class="form-label small">Create New Layer:</label>
            <div class="input-group input-group-sm mb-2">
                <input type="text" id="newLayerName" class="form-control" placeholder="Layer Name">
                <button class="btn btn-primary" id="createLayerBtn">Create</button>
            </div>
        </div>
        <div class="color-picker">
            <label>Color:</label>
            <input type="color" id="drawColor" value="#ff0000">
        </div>
        <div class="buffer-control">
            <label>Buffer (meters):</label>
            <input type="number" id="bufferDistance" value="0" min="0" class="form-control form-control-sm">
        </div>
    </div>

    <div id="layerPanel" class="panel">
        <span class="close-btn" onclick="closePanel('layerPanel')">×</span>
        <h5>Layer List</h5>
        <ul id="layerList" class="list-group"></ul>
    </div>

    <div id="searchPanel" class="panel">
        <span class="close-btn" onclick="closePanel('searchPanel')">×</span>
        <h5>Search Location</h5>
        <div class="search-type-selector">
            <div class="form-check">
                <input class="form-check-input" type="radio" name="searchType" id="searchTypeLatLon" value="latlon" checked>
                <label class="form-check-label" for="searchTypeLatLon">Lat, Long</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="searchType" id="searchTypeMgrs" value="mgrs">
                <label class="form-check-label" for="searchTypeMgrs">MGRS</label>
            </div>
        </div>
        <input type="text" id="searchInput" class="form-control mb-2" placeholder="e.g. 13.7, 100.5">
        <button id="searchCoordBtn" class="btn btn-primary btn-sm w-100">Search</button>
    </div>

    <div id="exportPanel" class="panel">
        <span class="close-btn" onclick="closePanel('exportPanel')">×</span>
        <h5>Export Data</h5>
        
        <div class="mb-3 border-bottom pb-2">
            <label class="form-label small fw-bold">Select Format:</label>
            <div class="d-flex flex-column gap-2">
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="exportFormat" id="formatKml" value="kml" checked>
                    <label class="form-check-label" for="formatKml">KML (Google Earth - WGS84)</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="exportFormat" id="formatGeojson" value="geojson">
                    <label class="form-check-label" for="formatGeojson">GeoJSON (WGS84)</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="exportFormat" id="formatGeojson47" value="geojson_47">
                    <label class="form-check-label" for="formatGeojson47">GeoJSON (UTM Zone 47N)</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="exportFormat" id="formatGeojson48" value="geojson_48">
                    <label class="form-check-label" for="formatGeojson48">GeoJSON (UTM Zone 48N)</label>
                </div>
            </div>
        </div>

        <p class="small text-muted">Select layers to export:</p>
        <div id="exportLayerList" class="mb-3" style="max-height: 150px; overflow-y: auto;"></div>
        <button id="confirmExportBtn" class="btn btn-success btn-sm w-100">Export Selected</button>
    </div>

    <div id="addServicePanel" class="panel">
        <span class="close-btn" onclick="closePanel('addServicePanel')">×</span>
        <div class="mb-3"><input type="text" id="serviceUrl" class="form-control" placeholder="Service URL"></div>
        <div class="mb-3">
            <select id="serviceType" class="form-select">
                <option value="featureLayer">Feature Layer</option>
                <option value="mapImageLayer">Map Image Layer</option>
                <option value="wmsLayer">WMS Layer</option>
                <option value="tileLayer">Tile Layer</option>
            </select>
        </div>
        <button id="addServiceConfirmBtn" class="btn btn-primary btn-sm">Add Service</button>
    </div>

    <div id="basemapGalleryPanel" class="panel">
        <span class="close-btn" onclick="closePanel('basemapGalleryPanel')">×</span>
        <div id="basemapGalleryDiv"></div>
    </div>

    <div id="printPanel" class="panel">
        <span class="close-btn" onclick="closePanel('printPanel')">×</span>
        <h5>Print Map</h5>
        <div id="printDiv"></div>
    </div>

    <div id="excelImportPanel" class="excel-import-panel">
        <span class="close-btn" onclick="closePanel('excelImportPanel')">×</span>
        <h5>Import Excel Points</h5>
        <div class="mb-3"><input type="file" id="excelFile" class="form-control" accept=".xlsx, .xls"></div>
        <div class="column-select">
            <label>Latitude Column:</label><select id="latColumn" class="form-select mb-2"></select>
            <label>Longitude Column:</label><select id="lonColumn" class="form-select mb-2"></select>
            <label>Label Column (optional):</label><select id="labelColumn" class="form-select"></select>
        </div>
        <button id="importExcelBtn" class="btn btn-primary" disabled>Import Points</button>
    </div>

    <div class="modal-backdrop" id="modalBackdrop"></div>
    <div class="custom-modal" id="attributeModal">
        <h5>Feature Attributes</h5>
        <form id="attributeForm">
            <div class="row mb-2">
                <div class="col-6">
                    <label class="form-label small">Latitude (Center)</label>
                    <input type="text" class="form-control form-control-sm" id="attrLat" readonly>
                </div>
                <div class="col-6">
                    <label class="form-label small">Longitude (Center)</label>
                    <input type="text" class="form-control form-control-sm" id="attrLon" readonly>
                </div>
            </div>
            <div class="mb-2">
                <label class="form-label small">MGRS (Center)</label>
                <input type="text" class="form-control form-control-sm" id="attrMgrs" readonly>
            </div>
            <div class="row mb-2">
                <div class="col-6">
                    <label class="form-label small">UTM Z47 (E, N)</label>
                    <input type="text" class="form-control form-control-sm" id="attrUtm47" readonly>
                </div>
                <div class="col-6">
                    <label class="form-label small">UTM Z48 (E, N)</label>
                    <input type="text" class="form-control form-control-sm" id="attrUtm48" readonly>
                </div>
            </div>
            <div class="mb-3">
                <label for="description" class="form-label">Description / Name</label>
                <input type="text" class="form-control" id="description" required>
            </div>
            <div class="d-flex justify-content-end gap-2">
                <button type="button" class="btn btn-secondary" onclick="closeAttributeModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Save</button>
            </div>
        </form>
    </div>

    <script src="https://js.arcgis.com/4.22/"></script>
    <script>
        require([
            "esri/Map",
            "esri/views/MapView",
            "esri/widgets/BasemapGallery",
            "esri/widgets/Search",
            "esri/widgets/Print",
            "esri/layers/FeatureLayer",
            "esri/layers/MapImageLayer",
            "esri/layers/WMSLayer",
            "esri/layers/TileLayer",
            "esri/widgets/Sketch",
            "esri/layers/GraphicsLayer",
            "esri/Graphic",
            "esri/geometry/geometryEngine",
            "esri/symbols/SimpleMarkerSymbol",
            "esri/symbols/SimpleLineSymbol",
            "esri/symbols/SimpleFillSymbol",
            "esri/symbols/TextSymbol",
            "esri/widgets/Track",
            "esri/geometry/Point",
            "esri/geometry/support/webMercatorUtils",
            "esri/geometry/coordinateFormatter", 
            "esri/geometry/projection"          
        ], function(Map, MapView, BasemapGallery, Search, Print, FeatureLayer, MapImageLayer, WMSLayer, TileLayer, 
                   Sketch, GraphicsLayer, Graphic, geometryEngine, SimpleMarkerSymbol, SimpleLineSymbol, SimpleFillSymbol, TextSymbol,
                   Track, Point, webMercatorUtils, coordinateFormatter, projection) {
            
            // Load Coordinate and Projection modules
            Promise.all([
                coordinateFormatter.load(),
                projection.load()
            ]).then(() => {
                console.log("Coordinate & Projection modules loaded");
            });

            var map = new Map({ basemap: "topo-vector" });
            var view = new MapView({
                container: "viewDiv",
                map: map,
                center: [100.5, 13.7],
                zoom: 6
            });

            var print = new Print({
                view: view,
                container: "printDiv",
                templateOptions: {
                    title: "My Map", author: "ArcGIS Web Map",
                    copyright: "© ArcGIS Web Map", legendEnabled: true, scalebarEnabled: true
                },
                format: { formats: ["pdf", "png32", "jpg"] }
            });

            var activeDrawingLayer = null;
            var activeColor = "#ff0000";
            var bufferDistance = 0;
            var sketch;

            // Search History Layer
            var searchGraphicsLayer = new GraphicsLayer({
                id: "system_search_layer",
                title: "Search History",
                listMode: "show",
                isDrawLayer: true // Enabled for Export
            });
            map.add(searchGraphicsLayer);

            var locationLabelLayer = new GraphicsLayer({ id: "location_label_layer", listMode: "hide" });
            map.add(locationLabelLayer);

            var markerSymbol = new SimpleMarkerSymbol({
                color: [0, 0, 255, 0.8],
                size: "24px",
                outline: { color: [255, 255, 255], width: 2 }
            });

            view.ui.move("zoom", "bottom-right");
            var basemapGallery = new BasemapGallery({ view: view, container: "basemapGalleryDiv" });

            // Toolbar Toggle
            document.getElementById("toolbarToggleBtn").addEventListener("click", function() {
                var toolbar = document.getElementById("mainToolbar");
                var icon = document.getElementById("toggleIcon");
                if (toolbar.classList.contains("collapsed")) {
                    toolbar.classList.remove("collapsed");
                    icon.classList.remove("fa-chevron-down");
                    icon.classList.add("fa-chevron-up");
                } else {
                    toolbar.classList.add("collapsed");
                    icon.classList.remove("fa-chevron-up");
                    icon.classList.add("fa-chevron-down");
                }
            });

            function togglePanel(panelId) {
                var panels = document.querySelectorAll('.panel');
                var drawTools = document.getElementById('drawTools');
                panels.forEach(p => { if (p.id !== panelId) p.style.display = 'none'; });
                if(panelId !== 'drawTools' && drawTools) drawTools.style.display = 'none';
                var panel = document.getElementById(panelId);
                panel.style.display = (panel.style.display === 'none' || panel.style.display === '') ? 'block' : 'none';
            }
            window.closePanel = function(panelId) { document.getElementById(panelId).style.display = 'none'; }

            // Button Listeners
            document.getElementById("basemapBtn").addEventListener("click", () => togglePanel("basemapGalleryPanel"));
            document.getElementById("fullscreenBtn").addEventListener("click", () => {
                if (!document.fullscreenElement) document.documentElement.requestFullscreen();
                else if (document.exitFullscreen) document.exitFullscreen();
            });
            document.getElementById("searchBtn").addEventListener("click", () => togglePanel("searchPanel"));
            document.getElementById("printBtn").addEventListener("click", () => togglePanel("printPanel"));
            document.getElementById("layerListBtn").addEventListener("click", () => { togglePanel("layerPanel"); updateLayerList(); });
            document.getElementById("exportPanelBtn").addEventListener("click", () => { togglePanel("exportPanel"); updateExportLayerList(); });

            // --- DRAW SYSTEM ---
            document.getElementById("drawBtn").addEventListener("click", function() {
                var drawTools = document.getElementById("drawTools");
                var button = document.getElementById("drawBtn");
                if (drawTools.style.display === "none" || drawTools.style.display === "") {
                    drawTools.style.display = "block";
                    button.classList.add("tool-active");
                    if (!activeDrawingLayer) createNewDrawingLayer("Default Drawing Layer");
                    populateDrawLayerSelect();
                    initializeSketch();
                } else {
                    drawTools.style.display = "none";
                    button.classList.remove("tool-active");
                    if (sketch) { view.ui.remove(sketch); sketch.destroy(); sketch = null; }
                }
            });

            document.getElementById("createLayerBtn").addEventListener("click", function() {
                var nameInput = document.getElementById("newLayerName");
                if (nameInput.value.trim()) {
                    createNewDrawingLayer(nameInput.value.trim());
                    nameInput.value = "";
                    populateDrawLayerSelect();
                } else { alert("Please enter a layer name"); }
            });

            document.getElementById("drawLayerSelect").addEventListener("change", function(e) {
                var layer = map.findLayerById(e.target.value);
                if (layer) { activeDrawingLayer = layer; initializeSketch(); updateLayerList(); }
            });

            function createNewDrawingLayer(name) {
                var newLayer = new GraphicsLayer({ title: name, isDrawLayer: true });
                map.add(newLayer);
                activeDrawingLayer = newLayer;
                updateLayerList();
            }

            function populateDrawLayerSelect() {
                var select = document.getElementById("drawLayerSelect");
                select.innerHTML = "";
                map.layers.forEach(function(layer) {
                    if (layer.isDrawLayer && layer.id !== "system_search_layer") {
                        var option = document.createElement("option");
                        option.value = layer.id;
                        option.textContent = layer.title;
                        if (activeDrawingLayer && layer.id === activeDrawingLayer.id) option.selected = true;
                        select.appendChild(option);
                    }
                });
            }

            document.getElementById("drawColor").addEventListener("change", function(e) {
                activeColor = e.target.value;
                updateSketchSymbols();
            });

            document.getElementById("bufferDistance").addEventListener("change", function(e) {
                bufferDistance = parseFloat(e.target.value);
            });

            function initializeSketch() {
                if (sketch) { view.ui.remove(sketch); sketch.destroy(); }
                if (!activeDrawingLayer) return;

                sketch = new Sketch({
                    layer: activeDrawingLayer,
                    view: view,
                    creationMode: "single",
                    updateOnGraphicClick: false,
                    availableCreateTools: ["point", "polyline", "polygon"],
                    visibleElements: {
                        createTools: { point: true, polyline: true, polygon: true, rectangle: false, circle: false },
                        selectionTools: { "lasso-selection": false, "rectangle-selection": false },
                        settingsMenu: false, undoRedoMenu: true
                    }
                });
                updateSketchSymbols();
                
                sketch.on("create", function(event) {
                    if (event.state === "complete") {
                        var graphic = event.graphic;
                        handleGraphicCreation(graphic, false); 

                        if (bufferDistance > 0) {
                            try {
                                var bufferGeometry = geometryEngine.buffer(graphic.geometry, bufferDistance, "meters");
                                if (bufferGeometry) {
                                    var bufferGraphic = new Graphic({
                                        geometry: bufferGeometry,
                                        symbol: new SimpleFillSymbol({
                                            color: hexToRgba(activeColor, 0.3),
                                            outline: { color: activeColor, width: 2 }
                                        })
                                    });
                                    activeDrawingLayer.add(bufferGraphic);
                                    handleGraphicCreation(bufferGraphic, true);
                                }
                            } catch (e) {
                                console.error("Buffer error:", e);
                            }
                        }
                    }
                });
                view.ui.add(sketch, "top-left");
            }

            // --- HELPER: Calculate UTM Attributes ---
            function getUTMAttributes(pointWGS84) {
                var result = { utmz47: "-", utmz48: "-" };
                try {
                    // Project to UTM Zone 47N (WKID: 32647)
                    var p47 = projection.project(pointWGS84, { wkid: 32647 });
                    if (p47) result.utmz47 = `${p47.x.toFixed(2)}, ${p47.y.toFixed(2)}`;

                    // Project to UTM Zone 48N (WKID: 32648)
                    var p48 = projection.project(pointWGS84, { wkid: 32648 });
                    if (p48) result.utmz48 = `${p48.x.toFixed(2)}, ${p48.y.toFixed(2)}`;
                } catch (e) { console.error("Projection Error:", e); }
                return result;
            }

            function handleGraphicCreation(graphic, isBuffer) {
                graphic.attributes = graphic.attributes || {};
                graphic.attributes.color = graphic.attributes.color || activeColor;
                graphic.attributes.isBuffer = isBuffer ? "Yes" : "No";

                var geom = graphic.geometry;
                var centerPoint = (geom.type === "point") ? geom : geom.extent.center;
                var latLon = webMercatorUtils.webMercatorToGeographic(centerPoint);
                
                // --- ADD UTM ATTRIBUTES ---
                var utmAttrs = getUTMAttributes(latLon);
                graphic.attributes.utmz47 = utmAttrs.utmz47;
                graphic.attributes.utmz48 = utmAttrs.utmz48;

                var lat = latLon.latitude.toFixed(6);
                var lon = latLon.longitude.toFixed(6);
                var mgrsStr = "";
                try { mgrsStr = coordinateFormatter.toMgrs(latLon, "automatic", 5); } catch(e) { mgrsStr = "Error"; }

                graphic.popupTemplate = {
                    title: "{description}",
                    content: [{
                        type: "fields",
                        fieldInfos: [
                            { fieldName: "latitude", label: "Center Lat" },
                            { fieldName: "longitude", label: "Center Lon" },
                            { fieldName: "mgrs", label: "MGRS" },
                            { fieldName: "utmz47", label: "UTM Zone 47N" },
                            { fieldName: "utmz48", label: "UTM Zone 48N" },
                            { fieldName: "type", label: "Type" },
                            { fieldName: "isBuffer", label: "Is Buffer" },
                            { fieldName: "timestamp", label: "Time" }
                        ]
                    }]
                };

                if (!isBuffer) {
                    if (!graphic.attributes.description) {
                        showAttributeModal(graphic, lat, lon, mgrsStr, utmAttrs.utmz47, utmAttrs.utmz48, geom.type);
                    }
                } else {
                    graphic.attributes.description = "Buffer (" + bufferDistance + "m)";
                    graphic.attributes.latitude = lat;
                    graphic.attributes.longitude = lon;
                    graphic.attributes.mgrs = mgrsStr; 
                    graphic.attributes.type = "polygon";
                    graphic.attributes.timestamp = new Date().toISOString();
                }
            }

            function updateSketchSymbols() {
                if (sketch) {
                    sketch.viewModel.pointSymbol = new SimpleMarkerSymbol({ color: activeColor, size: "8px", outline: { color: [255, 255, 255], width: 1 } });
                    sketch.viewModel.polylineSymbol = new SimpleLineSymbol({ color: activeColor, width: 2 });
                    sketch.viewModel.polygonSymbol = new SimpleFillSymbol({ color: hexToRgba(activeColor, 0.3), outline: { color: activeColor, width: 2 } });
                }
            }
            function hexToRgba(hex, alpha) {
                var r = parseInt(hex.substr(1,2), 16), g = parseInt(hex.substr(3,2), 16), b = parseInt(hex.substr(5,2), 16);
                return [r, g, b, alpha];
            }

            window.showAttributeModal = function(graphic, lat, lon, mgrs, utm47, utm48, type) {
                document.getElementById('modalBackdrop').style.display = 'block';
                document.getElementById('attributeModal').style.display = 'block';
                document.getElementById('attrLat').value = lat;
                document.getElementById('attrLon').value = lon;
                document.getElementById('attrMgrs').value = mgrs;
                document.getElementById('attrUtm47').value = utm47;
                document.getElementById('attrUtm48').value = utm48;
                document.getElementById('description').focus();

                document.getElementById('attributeForm').onsubmit = function(e) {
                    e.preventDefault();
                    graphic.attributes.description = document.getElementById('description').value;
                    graphic.attributes.latitude = lat;
                    graphic.attributes.longitude = lon;
                    graphic.attributes.mgrs = mgrs;
                    graphic.attributes.type = type;
                    graphic.attributes.timestamp = new Date().toISOString();
                    closeAttributeModal();
                };
            }
            window.closeAttributeModal = function() {
                document.getElementById('modalBackdrop').style.display = 'none';
                document.getElementById('attributeModal').style.display = 'none';
                document.getElementById('attributeForm').reset();
            }

            // --- EXPORT SYSTEM (KML & GeoJSON with UTM) ---
            function updateExportLayerList() {
                var container = document.getElementById("exportLayerList");
                container.innerHTML = "";
                var hasLayers = false;
                map.layers.forEach(function(layer) {
                    if (layer.isDrawLayer) {
                        hasLayers = true;
                        var div = document.createElement("div");
                        div.className = "form-check";
                        div.innerHTML = `<input class="form-check-input export-layer-checkbox" type="checkbox" value="${layer.id}" id="export_${layer.id}" checked>
                            <label class="form-check-label" for="export_${layer.id}">${layer.title}</label>`;
                        container.appendChild(div);
                    }
                });
                if (!hasLayers) {
                    container.innerHTML = "<p class='text-center text-muted'>No drawing layers found.</p>";
                    document.getElementById("confirmExportBtn").disabled = true;
                } else document.getElementById("confirmExportBtn").disabled = false;
            }

            // Export Button Click Handler
            document.getElementById("confirmExportBtn").addEventListener("click", function() {
                var checkboxes = document.querySelectorAll('.export-layer-checkbox:checked');
                var layerIds = Array.from(checkboxes).map(cb => cb.value);
                if (layerIds.length === 0) { alert("Please select at least one layer."); return; }

                // Check selected format
                var exportType = document.querySelector('input[name="exportFormat"]:checked').value;

                if (exportType === "kml") {
                    exportSelectedLayersToKML(layerIds);
                } else if (exportType === "geojson") {
                    exportSelectedLayersToGeoJSON(layerIds, 4326); // WGS84
                } else if (exportType === "geojson_47") {
                    exportSelectedLayersToGeoJSON(layerIds, 32647); // UTM 47N
                } else if (exportType === "geojson_48") {
                    exportSelectedLayersToGeoJSON(layerIds, 32648); // UTM 48N
                }
            });

            function toKmlColor(hexColor, alpha) {
                var a = alpha || "ff";
                if (!hexColor) return "ff0000ff";
                var hex = hexColor.replace("#", "");
                if (hex.length === 3) hex = hex[0]+hex[0] + hex[1]+hex[1] + hex[2]+hex[2];
                var r = hex.substring(0, 2), g = hex.substring(2, 4), b = hex.substring(4, 6);
                return a + b + g + r;
            }

            function exportSelectedLayersToKML(layerIds) {
                var kml = `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
<Document>
<name>Map Export</name>`;
                
                layerIds.forEach(function(id) {
                    var layer = map.findLayerById(id);
                    if (layer && layer.graphics && layer.graphics.length > 0) {
                        kml += `<Folder><name>${layer.title}</name>`;
                        layer.graphics.forEach(function(graphic, index) {
                            var attrs = graphic.attributes || {};
                            var name = attrs.description || attrs.label || "Untitled"; 
                            var color = attrs.color || "#0000ff";
                            var styleId = "style_" + id + "_" + index;
                            var kmlColor = toKmlColor(color, "ff");
                            var kmlFillColor = toKmlColor(color, "4D");

                            kml += `
                            <Style id="${styleId}">
                                <LineStyle><color>${kmlColor}</color><width>2</width></LineStyle>
                                <PolyStyle><color>${kmlFillColor}</color></PolyStyle>
                                <IconStyle><color>${kmlColor}</color><scale>1.0</scale><Icon><href>http://maps.google.com/mapfiles/kml/pushpin/wht-pushpin.png</href></Icon></IconStyle>
                            </Style>`;

                            var desc = "";
                            for (var key in attrs) {
                                if (key !== "color" && key !== "timestamp") { 
                                    desc += `<b>${key}:</b> ${attrs[key]}<br>`;
                                }
                            }
                            if(desc === "") desc = `<b>Lat:</b> ${attrs.latitude || "-"}<br><b>Lon:</b> ${attrs.longitude || "-"}`;

                            kml += `<Placemark><name>${name}</name><description><![CDATA[${desc}]]></description><styleUrl>#${styleId}</styleUrl>`;
                            
                            var geom = graphic.geometry;
                            if (geom.type === "point") {
                                if (attrs.latitude && attrs.longitude) {
                                    kml += `<Point><coordinates>${attrs.longitude},${attrs.latitude}</coordinates></Point>`;
                                } else {
                                    var ll = webMercatorUtils.webMercatorToGeographic(geom);
                                    kml += `<Point><coordinates>${ll.longitude},${ll.latitude}</coordinates></Point>`;
                                }
                            } 
                            else if (geom.type === "polyline") {
                                kml += '<LineString><coordinates>';
                                var geoLine = webMercatorUtils.webMercatorToGeographic(geom);
                                geoLine.paths[0].forEach(p => { kml += `${p[0]},${p[1]} `; });
                                kml += '</coordinates></LineString>';
                            } 
                            else if (geom.type === "polygon") {
                                kml += '<Polygon><outerBoundaryIs><LinearRing><coordinates>';
                                var geoPoly = webMercatorUtils.webMercatorToGeographic(geom);
                                geoPoly.rings[0].forEach(p => { kml += `${p[0]},${p[1]} `; });
                                kml += '</coordinates></LinearRing></outerBoundaryIs></Polygon>';
                            }
                            kml += `</Placemark>`;
                        });
                        kml += `</Folder>`;
                    }
                });
                kml += `</Document></kml>`;

                downloadFile(kml, "map_export.kml", "application/vnd.google-earth.kml+xml");
            }

            // --- GeoJSON Export (Supports WGS84, UTM47, UTM48) ---
            function exportSelectedLayersToGeoJSON(layerIds, wkid) {
                var features = [];
                var crsObj = null;

                // Define CRS for GeoJSON (if not WGS84)
                if (wkid === 32647) {
                    crsObj = { "type": "name", "properties": { "name": "urn:ogc:def:crs:EPSG::32647" } };
                } else if (wkid === 32648) {
                    crsObj = { "type": "name", "properties": { "name": "urn:ogc:def:crs:EPSG::32648" } };
                }

                layerIds.forEach(function(id) {
                    var layer = map.findLayerById(id);
                    if (layer && layer.graphics && layer.graphics.length > 0) {
                        layer.graphics.forEach(function(graphic) {
                            var attrs = graphic.attributes || {};
                            var properties = Object.assign({}, attrs);
                            
                            // Project Geometry
                            var geoJsonGeom = null;
                            var projectedGeom = null;

                            // 1. Get Geometry in correct projection
                            if (wkid === 4326) {
                                projectedGeom = webMercatorUtils.webMercatorToGeographic(graphic.geometry);
                            } else {
                                // Project to UTM
                                projectedGeom = projection.project(graphic.geometry, { wkid: wkid });
                            }

                            if (projectedGeom) {
                                if (projectedGeom.type === "point") {
                                    geoJsonGeom = { type: "Point", coordinates: [projectedGeom.x, projectedGeom.y] };
                                } else if (projectedGeom.type === "polyline") {
                                    geoJsonGeom = { type: "LineString", coordinates: projectedGeom.paths[0] };
                                } else if (projectedGeom.type === "polygon") {
                                    geoJsonGeom = { type: "Polygon", coordinates: projectedGeom.rings };
                                }
                            }

                            if (geoJsonGeom) {
                                features.push({
                                    type: "Feature",
                                    properties: properties,
                                    geometry: geoJsonGeom
                                });
                            }
                        });
                    }
                });

                var geoJsonObj = {
                    type: "FeatureCollection",
                    features: features
                };
                if (crsObj) geoJsonObj.crs = crsObj;

                var fileName = "map_export_wgs84.geojson";
                if (wkid === 32647) fileName = "map_export_utm47n.geojson";
                if (wkid === 32648) fileName = "map_export_utm48n.geojson";

                var jsonStr = JSON.stringify(geoJsonObj, null, 2);
                downloadFile(jsonStr, fileName, "application/geo+json");
            }

            function downloadFile(content, fileName, mimeType) {
                var blob = new Blob([content], {type: mimeType});
                var url = URL.createObjectURL(blob);
                var a = document.createElement("a");
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                closePanel('exportPanel');
            }

            // --- TRACK LOCATION (Same as before) ---
            var track = new Track({
                view: view,
                graphic: new Graphic({
                    symbol: { type: "simple-marker", size: "14px", color: "blue", outline: { color: "white", width: 2 } }
                }),
                useHeadingEnabled: false
            });

            track.on("track", function(trackEvent) {
                view.goTo({ target: trackEvent.position, zoom: 18 });
                var geom = trackEvent.position.geometry;
                var geographic = webMercatorUtils.webMercatorToGeographic(geom);
                var mgrs = "";
                try { mgrs = coordinateFormatter.toMgrs(geographic, "automatic", 5); } catch(e) {}
                var labelText = `Lat: ${geographic.latitude.toFixed(5)}\nLon: ${geographic.longitude.toFixed(5)}\nMGRS: ${mgrs}`;
                var textGraphic = new Graphic({
                    geometry: geom,
                    symbol: { type: "text", color: "black", haloColor: "white", haloSize: "2px", text: labelText, xoffset: 0, yoffset: -25, font: { size: 10, weight: "bold" } }
                });
                locationLabelLayer.removeAll();
                locationLabelLayer.add(textGraphic);
            });

            document.getElementById("locationBtn").addEventListener("click", function() {
                var btn = this;
                if (!track.tracking) { track.start(); btn.classList.add("tool-active"); } 
                else { track.stop(); btn.classList.remove("tool-active"); locationLabelLayer.removeAll(); }
            });

            // --- SEARCH ---
            document.querySelectorAll('input[name="searchType"]').forEach((elem) => {
                elem.addEventListener("change", function(event) {
                    var input = document.getElementById("searchInput");
                    input.placeholder = event.target.value === "latlon" ? "e.g. 13.7, 100.5" : "e.g. 47Q LA 377 437";
                });
            });

            document.getElementById("searchCoordBtn").addEventListener("click", function() {
                var input = document.getElementById("searchInput").value.trim();
                var searchType = document.querySelector('input[name="searchType"]:checked').value;
                if (searchType === "latlon") {
                    if (input.includes(",")) {
                        var coords = input.split(",");
                        if (coords.length === 2) {
                            var lat = parseFloat(coords[0].trim()), lon = parseFloat(coords[1].trim());
                            if (!isNaN(lat) && !isNaN(lon)) executeSearch(lon, lat);
                            else alert("Invalid Lat/Lon");
                        }
                    } else alert("Please use format: Lat, Lon");
                } 
                else if (searchType === "mgrs") {
                    if (coordinateFormatter.isSupported()) {
                        try {
                            var wgs84Point = coordinateFormatter.fromMgrs(input, { wkid: 4326 }, "automatic");
                            if (wgs84Point) executeSearch(wgs84Point.longitude, wgs84Point.latitude);
                            else alert("Invalid MGRS format.");
                        } catch (e) { alert("Error parsing MGRS."); }
                    } else alert("Modules loading...");
                }
            });

            function executeSearch(lon, lat) {
                var point = new Point({ latitude: lat, longitude: lon });
                var mgrsStr = "";
                try { mgrsStr = coordinateFormatter.toMgrs(point, "automatic", 5); } catch(e) { mgrsStr = "Error"; }
                
                // Calculate UTM
                var utmAttrs = getUTMAttributes(point);

                var graphic = new Graphic({ 
                    geometry: point, 
                    symbol: markerSymbol,
                    attributes: {
                        description: "Search: " + lat.toFixed(5) + ", " + lon.toFixed(5),
                        latitude: lat.toFixed(6),
                        longitude: lon.toFixed(6),
                        mgrs: mgrsStr,
                        utmz47: utmAttrs.utmz47, // Stored
                        utmz48: utmAttrs.utmz48, // Stored
                        type: "point",
                        timestamp: new Date().toISOString(),
                        color: "#0000ff" 
                    }
                });
                
                handleGraphicCreation(graphic, false); 
                searchGraphicsLayer.add(graphic);
                view.goTo({ target: point, zoom: 16 }, { duration: 1000 });
                updateLayerList();
                updateExportLayerList();
            }

            // --- SERVICES & EXCEL ---
            document.getElementById("addServiceBtn").addEventListener("click", () => togglePanel("addServicePanel"));
            document.getElementById("addServiceConfirmBtn").addEventListener("click", function() {
                var url = document.getElementById("serviceUrl").value, type = document.getElementById("serviceType").value, layer;
                if(type==="wmsLayer") layer = new WMSLayer({url:url, customParameters:{transparent:true}});
                else if(type==="featureLayer") layer = new FeatureLayer({url:url});
                else if(type==="mapImageLayer") layer = new MapImageLayer({url:url});
                else if(type==="tileLayer") layer = new TileLayer({url:url});
                if(layer){ map.add(layer); updateLayerList(); closePanel('addServicePanel'); }
            });
            function updateLayerList() {
                var list = document.getElementById("layerList"); list.innerHTML = "";
                map.layers.toArray().reverse().forEach((l,i) => {
                    if(l.listMode!=="hide"){
                        var li=document.createElement("li"); li.className="list-group-item layer-item";
                        if(l===activeDrawingLayer) li.classList.add("border-primary","border");
                        li.innerHTML=`<span>${l.title}</span><div class="layer-controls"><button class="btn btn-sm btn-danger" onclick="removeLayer('${l.id}')"><i class="fas fa-trash"></i></button></div>`;
                        list.appendChild(li);
                    }
                });
            }
            window.removeLayer = function(id) { map.remove(map.findLayerById(id)); updateLayerList(); populateDrawLayerSelect(); };

            var excelPointsLayer = new GraphicsLayer({
                title: "Excel Points", 
                listMode: "show",
                isDrawLayer: true 
            }); 
            map.add(excelPointsLayer);

            document.getElementById("excelImportBtn").addEventListener("click", () => togglePanel("excelImportPanel"));
            document.getElementById("excelFile").addEventListener("change", function(e) {
                var file = e.target.files[0];
                if (file) {
                    var reader = new FileReader();
                    reader.onload = function(e) {
                        var data = new Uint8Array(e.target.result);
                        var workbook = XLSX.read(data, { type: 'array' });
                        var jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1 });
                        if (jsonData.length > 0) {
                            var headers = jsonData[0];
                            ['latColumn', 'lonColumn', 'labelColumn'].forEach(id => {
                                var sel = document.getElementById(id);
                                sel.innerHTML = '<option value="">Select Column</option>';
                                headers.forEach((h,i) => { var op=document.createElement('option'); op.value=i; op.textContent=h; sel.appendChild(op); });
                            });
                            document.getElementById("importExcelBtn").disabled = false;
                        }
                    };
                    reader.readAsArrayBuffer(file);
                }
            });

            document.getElementById("importExcelBtn").addEventListener("click", function() {
                var file = document.getElementById("excelFile").files[0];
                var latI = parseInt(document.getElementById("latColumn").value);
                var lonI = parseInt(document.getElementById("lonColumn").value);
                var lblI = parseInt(document.getElementById("labelColumn").value);

                if (file && !isNaN(latI) && !isNaN(lonI)) {
                    var reader = new FileReader();
                    reader.onload = function(e) {
                        var data = new Uint8Array(e.target.result);
                        var wb = XLSX.read(data, { type: 'array' });
                        var json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header: 1 });
                        var headers = json[0];

                        excelPointsLayer.removeAll();
                        var pts = [];

                        for (var i = 1; i < json.length; i++) {
                            var row = json[i];
                            var lat = parseFloat(row[latI]);
                            var lon = parseFloat(row[lonI]);

                            if (!isNaN(lat) && !isNaN(lon)) {
                                var point = new Point({latitude: lat, longitude: lon});
                                
                                var attributes = {};
                                headers.forEach((header, index) => {
                                    attributes[header] = row[index];
                                });

                                var mgrsStr = "";
                                try { mgrsStr = coordinateFormatter.toMgrs(point, "automatic", 5); } 
                                catch(ex) { mgrsStr = "Error"; }
                                attributes.mgrs = mgrsStr;
                                
                                // Calculate UTM Attributes
                                var utmAttrs = getUTMAttributes(point);
                                attributes.utmz47 = utmAttrs.utmz47;
                                attributes.utmz48 = utmAttrs.utmz48;

                                attributes.latitude = lat;
                                attributes.longitude = lon;
                                if (!isNaN(lblI)) attributes.description = row[lblI];
                                attributes.color = "#ff0000";

                                var popupFields = headers.map(h => ({ fieldName: h, label: h }));
                                popupFields.push({ fieldName: "mgrs", label: "MGRS" });
                                popupFields.push({ fieldName: "utmz47", label: "UTM Z47" });
                                popupFields.push({ fieldName: "utmz48", label: "UTM Z48" });

                                pts.push(new Graphic({
                                    geometry: point,
                                    symbol: new SimpleMarkerSymbol({color:[255,0,0,0.8], size:"12px", outline:{color:[255,255,255], width:2}}),
                                    attributes: attributes,
                                    popupTemplate: { 
                                        title: "Point Info", 
                                        content: [{ 
                                            type: "fields", 
                                            fieldInfos: popupFields 
                                        }] 
                                    }
                                }));
                            }
                        }
                        excelPointsLayer.addMany(pts);
                        if(pts.length>0) view.goTo(pts);
                        updateLayerList(); 
                        updateExportLayerList();
                        closePanel('excelImportPanel');
                    };
                    reader.readAsArrayBuffer(file);
                }
            });

            view.when(() => document.querySelectorAll('.panel').forEach(p => p.style.display = 'none'));
        });
    </script>
</body>
</html>
