<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NoteMap</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Update ArcGIS API to 4.29 for better Draw Tools -->
    <link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Libraries for Import Functionality -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shpjs/4.0.4/shp.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/togeojson/0.16.0/togeojson.min.js"></script>

    <style>
        /* ================= HEADER STYLES ================= */
        :root {
            --primary-gradient: linear-gradient(135deg, #1e88e5 0%, #1565c0 50%, #0d47a1 100%);
            --text-white: #ffffff;
            --text-yellow: #ffeb3b;
            --bg-glass: rgba(255, 255, 255, 0.1);
            --bg-glass-hover: rgba(255, 255, 255, 0.25);
            --header-height: 70px;
        }

        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Prompt', sans-serif;
        }

        .mapraw-header {
            background: var(--primary-gradient);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            position: fixed; top: 0; left: 0; width: 100%;
            z-index: 2000; height: var(--header-height);
        }
        
        .mapraw-header-content {
            max-width: 100%; margin: 0 auto; display: flex;
            align-items: center; justify-content: space-between;
            padding: 0 20px; height: 100%;
        }
        
        .mapraw-logo-section { display: flex; flex-direction: column; justify-content: center; flex-shrink: 0; padding-right: 15px; }
        .mapraw-logo-main { color: var(--text-white); font-size: 1.2rem; font-weight: 700; margin: 0; line-height: 1; white-space: nowrap; }
        .mapraw-logo-main span { color: var(--text-yellow); text-shadow: 0 0 10px rgba(255, 235, 59, 0.5); }
        .mapraw-page-title { color: #e3f2fd; font-size: 1rem; font-weight: 400; margin: 2px 0 0 0; white-space: nowrap; }
        
        .mapraw-nav { display: flex; gap: 8px; align-items: center; height: 100%; }
        .mapraw-nav-item { position: relative; height: 100%; display: flex; align-items: center; }
        
        .mapraw-nav-btn {
            background: var(--bg-glass); color: white; border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85rem;
            font-weight: 500; transition: all 0.2s ease; text-decoration: none;
            display: flex; align-items: center; gap: 6px; font-family: 'Prompt', sans-serif; white-space: nowrap;
        }
        .mapraw-nav-btn:hover { background: var(--bg-glass-hover); transform: translateY(-1px); }
        .mapraw-nav-btn.home-btn { background: rgba(255, 235, 59, 0.15); border-color: #ffeb3b; color: #ffeb3b; }
        .mapraw-nav-btn.home-btn:hover { background: #ffeb3b; color: #1565c0; }

        .mapraw-dropdown {
            position: absolute; top: calc(100% - 10px); left: 50%; transform: translateX(-50%) translateY(10px);
            background: white; border-radius: 8px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            min-width: 200px; opacity: 0; visibility: hidden; transition: all 0.2s ease; padding: 5px 0; z-index: 2001;
        }
        
        @media (min-width: 1201px) {
            .mapraw-nav-item:hover .mapraw-dropdown { opacity: 1; visibility: visible; transform: translateX(-50%) translateY(0); }
        }
        
        .mapraw-dropdown-item { display: block; padding: 10px 20px; color: #333; text-decoration: none; font-size: 0.9rem; transition: background 0.2s; white-space: nowrap; }
        .mapraw-dropdown-item:hover { background: #f1f8ff; color: #1565c0; }

        .mobile-menu-toggle { display: none; background: none; border: none; cursor: pointer; padding: 10px; z-index: 2002; }
        .bar { display: block; width: 25px; height: 3px; margin: 5px auto; background-color: white; transition: all 0.3s ease-in-out; border-radius: 2px; }

        @media (max-width: 1400px) { .mapraw-nav-btn { padding: 6px 8px; font-size: 0.8rem; } .mapraw-nav { gap: 4px; } }
        @media (max-width: 1200px) {
            .mobile-menu-toggle { display: block; }
            .mapraw-nav {
                position: fixed; top: var(--header-height); right: -100%; width: 280px; height: calc(100vh - var(--header-height));
                background: white; flex-direction: column; align-items: stretch; gap: 0; padding: 10px 0;
                transition: right 0.3s ease; box-shadow: -5px 0 15px rgba(0,0,0,0.1); overflow-y: auto;
            }
            .mapraw-nav.active { right: 0; }
            .mapraw-nav-item { height: auto; flex-direction: column; width: 100%; display: block; border-bottom: 1px solid #eee; }
            .mapraw-nav-btn { background: white; color: #333; border: none; border-radius: 0; padding: 15px 20px; font-size: 1rem; justify-content: space-between; width: 100%; box-sizing: border-box; }
            .mapraw-dropdown { position: static; transform: none; visibility: visible; opacity: 1; box-shadow: none; min-width: 100%; background: #f9f9f9; display: none; padding: 0; }
            .mapraw-nav-item.active .mapraw-dropdown { display: block; }
            .mapraw-dropdown-item { padding-left: 40px; font-size: 0.9rem; color: #666; }
            .mobile-menu-toggle.active .bar:nth-child(2) { opacity: 0; }
            .mobile-menu-toggle.active .bar:nth-child(1) { transform: translateY(8px) rotate(45deg); }
            .mobile-menu-toggle.active .bar:nth-child(3) { transform: translateY(-8px) rotate(-45deg); }
        }
        @media (max-width: 480px) { .mapraw-logo-main { font-size: 1rem; } .mapraw-page-title { font-size: 0.75rem; } }

        /* ================= MAP PAGE STYLES ================= */
        #viewDiv { 
            padding: 0; margin: 0; height: calc(100vh - 70px); width: 100%;
            position: absolute; top: 70px; left: 0;
        }

        .esri-view .esri-view-surface--inset-outline:focus::after { outline: none !important; }
        
        .top-toolbar-container {
            position: absolute;
            top: auto;            
            bottom: 30px;         
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: flex;
            flex-direction: column-reverse; 
            align-items: center;
        }

        .top-toolbar {
            background: white; padding: 5px; border-radius: 5px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3); display: flex; transition: all 0.3s ease;
            max-height: 60px; overflow: hidden; opacity: 1; flex-wrap: nowrap;
        }
        .top-toolbar.collapsed { max-height: 0; padding: 0; opacity: 0; margin: 0; border: none; }

        .toolbar-toggle-btn {
            background: white; border: none;
            border-radius: 10px 10px 0 0; 
            box-shadow: 0 -4px 4px rgba(0,0,0,0.1); 
            padding: 0px 15px;
            cursor: pointer; color: #666; font-size: 12px; height: 20px;
            line-height: 20px; 
            margin-bottom: -2px; 
            margin-top: 0;
            z-index: 999;
        }
        .toolbar-toggle-btn:hover { background: #f8f9fa; color: #000; }

        .panel {
            position: absolute; background-color: white; padding: 10px;
            border-radius: 5px; box-shadow: 0 0 10px rgba(0,0,0,0.1);
            display: none; z-index: 1000;
        }

        #layerPanel { top: 130px; right: 10px; width: 320px; max-height: calc(100vh - 150px); overflow-y: auto; }
        #searchPanel { top: 130px; left: 10px; width: 320px; }
        #addServicePanel { top: 130px; left: 10px; width: 280px; }
        #importDataPanel { top: 130px; left: 10px; width: 320px; }
        #selectAttributePanel { top: 130px; right: 60px; width: 320px; }
        #exportPanel { top: 130px; right: 60px; width: 300px; }
        #basemapGalleryPanel, #printPanel { top: 130px; right: 10px; width: 280px; max-height: 400px; overflow-y: auto; }
        
        /* New Table Panel Style */
        #attributeTablePanel {
            top: 130px; left: 50%; transform: translateX(-50%); width: 80%; max-height: 70vh;
            display: none; z-index: 1002; overflow: hidden; display: flex; flex-direction: column;
        }
        .table-container { flex: 1; overflow: auto; margin-top: 10px; border: 1px solid #ddd; }
        .table-custom th { background-color: #f8f9fa; position: sticky; top: 0; z-index: 1; }
        .table-custom td[contenteditable="true"]:focus { background-color: #fffde7; outline: 2px solid #ffeb3b; }

        .draw-tools {
            position: absolute; top: 130px; left: 10px; z-index: 1000;
            background: white; padding: 10px; border-radius: 5px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3); display: none; width: 260px; /* Reduced width */
            max-width: 90vw; /* Ensure it fits on small screens */
        }
        
        .excel-import-panel {
            position: absolute; top: 130px; left: 10px; z-index: 1000;
            background: white; padding: 15px; border-radius: 5px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3); display: none; width: 300px;
        }

        .draw-layer-control { border-bottom: 1px solid #ddd; padding-bottom: 8px; margin-bottom: 8px; }
        .color-picker { margin: 5px 0; }
        .buffer-section { margin-top: 10px; padding-top: 8px; border-top: 1px solid #ddd; }
        .close-btn { position: absolute; top: 5px; right: 5px; cursor: pointer; font-size: 20px; color: #666; }
        
        /* Layer List Item Styles */
        .layer-item { display: flex; flex-direction: column; margin-bottom: 8px; border: 1px solid #eee; border-radius: 4px; padding: 8px; }
        .layer-header { display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 5px; }
        .layer-controls-row { display: flex; gap: 5px; align-items: center; justify-content: space-between; width: 100%; }
        .layer-opacity { display: flex; align-items: center; gap: 5px; flex-grow: 1; max-width: 120px; }
        .layer-actions { display: flex; gap: 4px; }
        
        .custom-modal {
            display: none; position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%); background: white; padding: 20px;
            border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 3000; min-width: 400px; max-height: 80vh; overflow-y: auto;
        }
        .modal-backdrop {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 2999;
        }
        
        .btn-toolbar-custom { padding: 6px 10px; margin: 0 1px; border: none; background: transparent; color: #333; font-size: 1.1em; }
        .btn-toolbar-custom:hover { background: #f0f0f0; }
        .tool-active { background: #e0e0e0; color: #000; }
        
        .search-type-selector { display: flex; gap: 15px; margin-bottom: 10px; }
        .btn-group-custom { display: flex; gap: 5px; flex-wrap: wrap; }

        /* Color Palette Styles */
        .color-palette { display: grid; grid-template-columns: repeat(8, 1fr); gap: 3px; margin-top: 5px; margin-bottom: 8px; }
        .color-swatch { width: 100%; height: 18px; border: 1px solid #ccc; cursor: pointer; border-radius: 2px; }
        .color-swatch:hover { border-color: #000; transform: scale(1.1); }
        .color-swatch.active { border: 2px solid #000; box-shadow: 0 0 3px rgba(0,0,0,0.5); }
    </style>
</head>
<body>

    <header class="mapraw-header">
        <div class="mapraw-header-content">
            <div class="mapraw-logo-section">
                <h1 class="mapraw-logo-main">TOOL FROM <span>MAPRAW</span></h1>
                <p class="mapraw-page-title">NoteMap</p>
            </div>
            
            <button class="mobile-menu-toggle" id="mobileMenuBtn">
                <span class="bar"></span><span class="bar"></span><span class="bar"></span>
            </button>
    
            <nav class="mapraw-nav" id="mainNav">
                <div class="mapraw-nav-item"><a href="index.html" class="mapraw-nav-btn home-btn"><span>üè† ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</span></a></div>
                <div class="mapraw-nav-item" onclick="toggleMobileDropdown(this)">
                    <div class="mapraw-nav-btn"><span>üìã ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏™‡∏≥‡∏£‡∏ß‡∏à</span><span style="font-size: 0.8em">‚ñº</span></div>
                    <div class="mapraw-dropdown"><a href="page1.html" class="mapraw-dropdown-item">NoteMAP</a><a href="#" class="mapraw-dropdown-item">SURVEY WORK</a></div>
                </div>
                <!-- Menus preserved as original -->
                <div class="mapraw-nav-item" onclick="toggleMobileDropdown(this)">
                    <div class="mapraw-nav-btn"><span>üîß ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span><span style="font-size: 0.8em">‚ñº</span></div>
                    <div class="mapraw-dropdown"><a href="page2.html" class="mapraw-dropdown-item">Reclass BLDG</a><a href="page5.html" class="mapraw-dropdown-item">Prepare PLLU</a><a href="page8.html" class="mapraw-dropdown-item">SHAPEFILE TO EXCEL</a><a href="page10.html" class="mapraw-dropdown-item">CAPTURE MAP</a><a href="page13.html" class="mapraw-dropdown-item">Perpendicular Line</a></div>
                </div>
                <div class="mapraw-nav-item" onclick="toggleMobileDropdown(this)">
                    <div class="mapraw-nav-btn"><span>‚öôÔ∏è ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•</span><span style="font-size: 0.8em">‚ñº</span></div>
                    <div class="mapraw-dropdown"><a href="page3.html" class="mapraw-dropdown-item">Calculate Landuse</a><a href="page6.html" class="mapraw-dropdown-item">Calculate Population</a><a href="page11.html" class="mapraw-dropdown-item">Calculate AREA</a><a href="page14.html" class="mapraw-dropdown-item">RECLASS FACTORY</a><a href="page12.html" class="mapraw-dropdown-item">COMPARISON LANDUSE</a></div>
                </div>
                <div class="mapraw-nav-item" onclick="toggleMobileDropdown(this)">
                    <div class="mapraw-nav-btn"><span>‚öñÔ∏è ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢</span><span style="font-size: 0.8em">‚ñº</span></div>
                    <div class="mapraw-dropdown"><a href="page4.html" class="mapraw-dropdown-item">Town Planning Laws</a><a href="page15.html" class="mapraw-dropdown-item">Building Laws</a></div>
                </div>
                <div class="mapraw-nav-item" onclick="toggleMobileDropdown(this)">
                    <div class="mapraw-nav-btn"><span>üßÆ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô</span><span style="font-size: 0.8em">‚ñº</span></div>
                    <div class="mapraw-dropdown"><a href="page7.html" class="mapraw-dropdown-item">AREA Calculator</a></div>
                </div>
                <div class="mapraw-nav-item" onclick="toggleMobileDropdown(this)">
                    <div class="mapraw-nav-btn"><span>üéØ ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏≠‡∏∑‡πà‡∏ô‡πÜ</span><span style="font-size: 0.8em">‚ñº</span></div>
                    <div class="mapraw-dropdown"><a href="page9.html" class="mapraw-dropdown-item">CREATE QRCODE</a></div>
                </div>
            </nav>
        </div>
    </header>

    <div id="viewDiv"></div>

    <div class="top-toolbar-container">
        <div class="top-toolbar btn-group" id="mainToolbar">
            <button id="basemapBtn" class="btn btn-toolbar-custom" title="Basemap Gallery"><i class="fas fa-layer-group"></i></button>
            <button id="fullscreenBtn" class="btn btn-toolbar-custom" title="Fullscreen"><i class="fas fa-expand"></i></button>
            <button id="searchBtn" class="btn btn-toolbar-custom" title="Search (Lat/Lon, MGRS)"><i class="fas fa-search"></i></button>
            <button id="selectAttrBtn" class="btn btn-toolbar-custom" title="Select By Attribute"><i class="fas fa-filter"></i></button>
            <button id="printBtn" class="btn btn-toolbar-custom" title="Print"><i class="fas fa-print"></i></button>
            <button id="addServiceBtn" class="btn btn-toolbar-custom" title="Add Service"><i class="fas fa-plus"></i></button>
            <button id="importDataBtn" class="btn btn-toolbar-custom" title="Import Data (KML, GeoJSON, Shp, Excel)"><i class="fas fa-file-import"></i></button>
            <button id="drawBtn" class="btn btn-toolbar-custom" title="Draw Tools"><i class="fas fa-pen"></i></button>
            <button id="layerListBtn" class="btn btn-toolbar-custom" title="Layer List"><i class="fas fa-list"></i></button>
            <button id="locationBtn" class="btn btn-toolbar-custom" title="Track Location"><i class="fas fa-location-dot"></i></button> 
            <button id="exportPanelBtn" class="btn btn-toolbar-custom" title="Export Data"><i class="fas fa-download"></i></button> 
        </div>
        <button id="toolbarToggleBtn" class="toolbar-toggle-btn" title="Show/Hide Toolbar"><i class="fas fa-chevron-down" id="toggleIcon"></i></button>
    </div>

    <!-- DRAW TOOLS PANEL -->
    <div id="drawTools" class="draw-tools">
        <span class="close-btn" onclick="closePanel('drawTools')">√ó</span>
        <h6 class="fw-bold"><i class="fas fa-pencil-alt"></i> Draw Tools</h6>
        <div class="draw-layer-control">
            <label class="form-label small fw-bold">Active Draw Layer:</label>
            <select id="drawLayerSelect" class="form-select form-select-sm mb-2"></select>
            <label class="form-label small fw-bold">Create New Layer:</label>
            <div class="input-group input-group-sm mb-2">
                <input type="text" id="newLayerName" class="form-control" placeholder="Layer Name">
                <button class="btn btn-primary" id="createLayerBtn">Create</button>
            </div>
            
            <label class="small fw-bold mb-1">Select Color:</label>
            <div id="colorPalette" class="color-palette">
                <!-- 24 Colors generated by JS -->
            </div>
            
            <div class="d-flex align-items-center gap-2 mb-2">
                <label class="small fw-bold mb-0">Hex:</label>
                <input type="text" id="hexColorInput" class="form-control form-control-sm" placeholder="#ff0000" style="width: 80px;">
                <input type="color" id="drawColor" value="#ff0000" class="form-control form-control-color form-control-sm">
            </div>
            
            <button id="updateLayerColorBtn" class="btn btn-outline-primary btn-sm w-100 mb-2">Apply Color to Active Layer</button>
        </div>
        <div class="buffer-section">
            <h6 class="fw-bold small"><i class="fas fa-bullseye"></i> Buffer Tool</h6>
            <div class="mb-2">
                <label class="form-label small">Select Layer to Buffer:</label>
                <select id="bufferTargetLayer" class="form-select form-select-sm"></select>
            </div>
            <div class="mb-2">
                <label class="form-label small">Distance (meters):</label>
                <input type="number" id="manualBufferDist" value="100" min="1" class="form-control form-control-sm">
            </div>
            <button id="executeBufferBtn" class="btn btn-warning btn-sm w-100"><i class="fas fa-circle-notch"></i> Create Buffer</button>
        </div>
    </div>

    <!-- LAYER LIST PANEL -->
    <div id="layerPanel" class="panel">
        <span class="close-btn" onclick="closePanel('layerPanel')">√ó</span>
        <h5>Layer List</h5>
        <div id="layerList" class="list-group" style="max-height: 400px; overflow-y: auto;"></div>
    </div>

    <!-- ATTRIBUTE TABLE PANEL (NEW) -->
    <div id="attributeTablePanel" class="panel">
        <span class="close-btn" onclick="closePanel('attributeTablePanel')">√ó</span>
        <h5 id="tableLayerName">Attribute Table</h5>
        <div class="table-container">
            <table class="table table-bordered table-sm table-hover table-custom" id="featureTable">
                <thead></thead>
                <tbody></tbody>
            </table>
        </div>
        <div class="d-flex justify-content-end gap-2 mt-2">
            <button class="btn btn-sm btn-secondary" onclick="closePanel('attributeTablePanel')">Close</button>
            <button id="saveTableBtn" class="btn btn-sm btn-primary">Save Changes</button>
        </div>
    </div>

    <!-- SEARCH PANEL -->
    <div id="searchPanel" class="panel">
        <span class="close-btn" onclick="closePanel('searchPanel')">√ó</span>
        <h5>Search Location</h5>
        <div class="search-type-selector">
            <div class="form-check">
                <input class="form-check-input" type="radio" name="searchType" id="searchTypeLatLon" value="latlon" checked>
                <label class="form-check-label" for="searchTypeLatLon">Lat, Long</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="searchType" id="searchTypeMgrs" value="mgrs">
                <label class="form-check-label" for="searchTypeMgrs">MGRS</label>
            </div>
        </div>
        <input type="text" id="searchInput" class="form-control mb-2" placeholder="e.g. 13.7, 100.5">
        <button id="searchCoordBtn" class="btn btn-primary btn-sm w-100">Search</button>
    </div>

    <!-- SELECT BY ATTRIBUTE PANEL -->
    <div id="selectAttributePanel" class="panel">
        <span class="close-btn" onclick="closePanel('selectAttributePanel')">√ó</span>
        <h5>Select by Attribute</h5>
        <div class="mb-2">
            <label class="form-label small">Layer:</label>
            <select id="selectAttrLayer" class="form-select form-select-sm"></select>
        </div>
        <div class="mb-2">
            <label class="form-label small">Field:</label>
            <select id="selectAttrField" class="form-select form-select-sm"></select>
        </div>
        
        <!-- Updated: Operator Dropdown -->
        <div class="mb-2">
            <label class="form-label small">Operator:</label>
            <select id="selectOperator" class="form-select form-select-sm">
                <option value="=">Equal (=)</option>
                <option value="contains">Contains (Like)</option>
                <option value=">">Greater than (>)</option>
                <option value="<">Less than (<)</option>
                <option value=">=">Greater or Equal (>=)</option>
                <option value="<=">Less or Equal (<=)</option>
            </select>
        </div>

        <div class="mb-2">
            <label class="form-label small">Value:</label>
            <input type="text" id="selectAttrValue" class="form-control form-control-sm">
        </div>
        <button id="executeSelectAttrBtn" class="btn btn-info btn-sm w-100 text-white">Select</button>
        <div id="selectResultMsg" class="mt-2 small text-danger"></div>
    </div>

    <!-- EXPORT PANEL -->
    <div id="exportPanel" class="panel">
        <span class="close-btn" onclick="closePanel('exportPanel')">√ó</span>
        <h5>Export Data</h5>
        <div class="mb-3 border-bottom pb-2">
            <label class="form-label small fw-bold">Select Format:</label>
            <div class="d-flex flex-column gap-2">
                <div class="form-check"><input class="form-check-input" type="radio" name="exportFormat" id="formatKml" value="kml" checked><label class="form-check-label" for="formatKml">KML (Google Earth - WGS84)</label></div>
                <div class="form-check"><input class="form-check-input" type="radio" name="exportFormat" id="formatGeojson" value="geojson"><label class="form-check-label" for="formatGeojson">GeoJSON (WGS84)</label></div>
                <div class="form-check"><input class="form-check-input" type="radio" name="exportFormat" id="formatGeojson47" value="geojson_47"><label class="form-check-label" for="formatGeojson47">GeoJSON (UTM Zone 47N)</label></div>
                <div class="form-check"><input class="form-check-input" type="radio" name="exportFormat" id="formatGeojson48" value="geojson_48"><label class="form-check-label" for="formatGeojson48">GeoJSON (UTM Zone 48N)</label></div>
                <div class="form-check"><input class="form-check-input" type="radio" name="exportFormat" id="formatExcel" value="excel"><label class="form-check-label" for="formatExcel" style="color: #198754; font-weight: 500;">Excel (.xlsx)</label></div>
            </div>
        </div>
        <p class="small text-muted">Select layers to export:</p>
        <div id="exportLayerList" class="mb-3" style="max-height: 150px; overflow-y: auto;"></div>
        <button id="confirmExportBtn" class="btn btn-success btn-sm w-100">Export Selected</button>
    </div>

    <!-- ADD SERVICE PANEL (FROM PAGE 2) -->
    <div id="addServicePanel" class="panel">
        <span class="close-btn" onclick="closePanel('addServicePanel')">√ó</span>
        <h5>Add Service</h5>
        <div class="mb-2">
            <label class="form-label small">Service URL:</label>
            <input type="text" id="serviceUrl" class="form-control form-control-sm" placeholder="https://...">
        </div>
        <div class="mb-2">
            <label class="form-label small">Service Type:</label>
            <select id="serviceType" class="form-select form-select-sm">
                <option value="feature">Feature Layer</option>
                <option value="map-image">Map Image Layer</option>
                <option value="wms">WMS Layer</option>
                <option value="tile">Tile Layer</option>
            </select>
        </div>
        <button id="btnAddService" class="btn btn-success btn-sm w-100">Add to Map</button>
    </div>

    <!-- NEW IMPORT PANEL (Consolidated) -->
    <div id="importDataPanel" class="panel">
        <span class="close-btn" onclick="closePanel('importDataPanel')">√ó</span>
        <h5>Import Data</h5>
        <ul class="nav nav-tabs small mb-2" id="importTabs" role="tablist">
            <li class="nav-item"><button class="nav-link active p-2" id="file-tab" data-bs-toggle="tab" data-bs-target="#fileImport" type="button">Vector Files</button></li>
            <li class="nav-item"><button class="nav-link p-2" id="excel-tab" data-bs-toggle="tab" data-bs-target="#excelImport" type="button">Excel</button></li>
        </ul>
        
        <div class="tab-content" id="importTabContent">
            <!-- Vector File Import -->
            <div class="tab-pane fade show active" id="fileImport" role="tabpanel">
                <div class="alert alert-info py-2 small">
                    Support: .kml, .kmz, .geojson, .zip (Shapefile)
                </div>
                <div class="mb-2">
                    <input type="file" id="vectorFile" class="form-control form-control-sm" accept=".kml,.kmz,.json,.geojson,.zip">
                </div>
                <button id="importVectorBtn" class="btn btn-primary btn-sm w-100">Import to Map</button>
            </div>
            
            <!-- Excel Import -->
            <div class="tab-pane fade" id="excelImport" role="tabpanel">
                <div class="mb-2 border-bottom pb-2">
                    <h6 class="small fw-bold">Excel (Lat/Lon)</h6>
                    <input type="file" id="excelFile" class="form-control form-control-sm mb-1" accept=".xlsx, .xls">
                    <div class="row g-1">
                        <div class="col-4"><select id="latColumn" class="form-select form-select-sm"><option value="">Lat</option></select></div>
                        <div class="col-4"><select id="lonColumn" class="form-select form-select-sm"><option value="">Lon</option></select></div>
                        <div class="col-4"><select id="labelColumn" class="form-select form-select-sm"><option value="">Label</option></select></div>
                    </div>
                    <button id="importExcelBtn" class="btn btn-success btn-sm w-100 mt-1" disabled>Import Points</button>
                </div>
                <div>
                    <h6 class="small fw-bold">Excel (MGRS)</h6>
                    <input type="file" id="mgrsExcelFile" class="form-control form-control-sm mb-1" accept=".xlsx, .xls">
                    <div class="row g-1">
                        <div class="col-6"><select id="mgrsColumn" class="form-select form-select-sm"><option value="">MGRS Col</option></select></div>
                        <div class="col-6"><select id="mgrsLabelColumn" class="form-select form-select-sm"><option value="">Label</option></select></div>
                    </div>
                    <button id="importMgrsExcelBtn" class="btn btn-success btn-sm w-100 mt-1" disabled>Import MGRS</button>
                </div>
            </div>
        </div>
    </div>

    <div id="basemapGalleryPanel" class="panel">
        <span class="close-btn" onclick="closePanel('basemapGalleryPanel')">√ó</span>
        <div id="basemapGalleryDiv"></div>
    </div>

    <div id="printPanel" class="panel">
        <span class="close-btn" onclick="closePanel('printPanel')">√ó</span>
        <h5>Print Map</h5>
        <div id="printDiv"></div>
    </div>

    <div class="modal-backdrop" id="modalBackdrop"></div>
    <!-- Updated Dynamic Attribute Modal -->
    <div class="custom-modal" id="attributeModal">
        <h5>Feature Attributes</h5>
        <form id="attributeForm">
            <input type="hidden" id="attrGraphicUid">
            <div id="attributeDynamicFields" style="max-height: 400px; overflow-y: auto;">
                <!-- Dynamic fields will be inserted here -->
            </div>
            <div class="d-flex justify-content-end gap-2 mt-3">
                <button type="button" class="btn btn-secondary" onclick="closeAttributeModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Save</button>
            </div>
        </form>
    </div>

    <script>
        const menuBtn = document.getElementById('mobileMenuBtn');
        const nav = document.getElementById('mainNav');
        menuBtn.addEventListener('click', () => { menuBtn.classList.toggle('active'); nav.classList.toggle('active'); });
        function toggleMobileDropdown(element) { if (window.innerWidth <= 1200) { element.classList.toggle('active'); } }
        document.addEventListener('click', (e) => { if (!nav.contains(e.target) && !menuBtn.contains(e.target) && nav.classList.contains('active')) { nav.classList.remove('active'); menuBtn.classList.remove('active'); } });
        
        // Bootstrap Tab Trigger
        document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(t => {
            t.addEventListener('click', function (e) {
                e.preventDefault();
                document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('show', 'active'));
                document.querySelectorAll('.nav-link').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                document.querySelector(this.getAttribute('data-bs-target')).classList.add('show', 'active');
            })
        });
    </script>

 <script src="https://js.arcgis.com/4.29/"></script>
    <script>
        require([
            "esri/Map", "esri/views/MapView", "esri/widgets/BasemapGallery", "esri/widgets/Search", "esri/widgets/Print",
            "esri/layers/FeatureLayer", "esri/layers/MapImageLayer", "esri/layers/WMSLayer", "esri/layers/TileLayer",
            "esri/widgets/Sketch", "esri/layers/GraphicsLayer", "esri/Graphic", "esri/geometry/geometryEngine",
            "esri/symbols/SimpleMarkerSymbol", "esri/symbols/SimpleLineSymbol", "esri/symbols/SimpleFillSymbol", "esri/symbols/TextSymbol",
            "esri/widgets/Track", "esri/geometry/Point", "esri/geometry/Polygon", "esri/geometry/Polyline", "esri/geometry/Multipoint",
            "esri/geometry/support/webMercatorUtils",
            "esri/geometry/coordinateFormatter", "esri/geometry/projection",
            "esri/geometry/SpatialReference", "esri/core/reactiveUtils"
        ], function(Map, MapView, BasemapGallery, Search, Print, FeatureLayer, MapImageLayer, WMSLayer, TileLayer, 
                   Sketch, GraphicsLayer, Graphic, geometryEngine, SimpleMarkerSymbol, SimpleLineSymbol, SimpleFillSymbol, TextSymbol,
                   Track, Point, Polygon, Polyline, Multipoint, webMercatorUtils, coordinateFormatter, projection,
                   SpatialReference, reactiveUtils 
        ) {
            
            // 1. Load Projection Engine & Coordinate Formatter
            Promise.all([coordinateFormatter.load(), projection.load()]).then(() => { 
                console.log("Projection modules loaded"); 
            });

            var map = new Map({ basemap: "topo-vector" });
            var view = new MapView({ container: "viewDiv", map: map, center: [100.5, 13.7], zoom: 6, popup: { defaultPopupTemplateEnabled: true } });
            var print = new Print({ view: view, container: "printDiv", templateOptions: { title: "My Map", author: "ArcGIS Web Map", copyright: "¬© ArcGIS Web Map", legendEnabled: true, scalebarEnabled: true }, format: { formats: ["pdf", "png32", "jpg"] } });

            var activeDrawingLayer = null;
            var activeColor = "#ff0000";
            var sketch;

            // Define Action for Popup to Edit Attributes
            var editAttributeAction = { title: "Edit Attributes", id: "edit-attributes", className: "esri-icon-edit" };
            // Define Action for Copy to Draw
            var copyToDrawAction = { title: "Copy to Draw Layer", id: "copy-to-draw", className: "esri-icon-duplicate" };

            var searchGraphicsLayer = new GraphicsLayer({ id: "system_search_layer", title: "Search History", listMode: "show", isDrawLayer: true });
            map.add(searchGraphicsLayer);
            var locationLabelLayer = new GraphicsLayer({ id: "location_label_layer", listMode: "hide" });
            map.add(locationLabelLayer);

            var markerSymbol = new SimpleMarkerSymbol({ color: [0, 0, 255, 0.8], size: "24px", outline: { color: [255, 255, 255], width: 2 } });

            view.ui.move("zoom", "bottom-right");
            var basemapGallery = new BasemapGallery({ view: view, container: "basemapGalleryDiv" });

            // --- FUNCTION DECLARATIONS (Hoisted to be available globally in require) ---
            
            function hexToRgba(hex, alpha) {
                var r = parseInt(hex.substr(1,2), 16), g = parseInt(hex.substr(3,2), 16), b = parseInt(hex.substr(5,2), 16);
                return [r, g, b, alpha];
            }

            function updateSketchSymbols() {
                if (sketch) {
                    sketch.viewModel.pointSymbol = new SimpleMarkerSymbol({ color: activeColor, size: "8px", outline: { color: [255, 255, 255], width: 1 } });
                    sketch.viewModel.polylineSymbol = new SimpleLineSymbol({ color: activeColor, width: 2 });
                    sketch.viewModel.polygonSymbol = new SimpleFillSymbol({ color: hexToRgba(activeColor, 0.3), outline: { color: activeColor, width: 2 } });
                }
            }

            function initializeSketch() {
                if (sketch) {
                    view.ui.remove(sketch);
                    sketch.destroy();
                }
                if (!activeDrawingLayer) return;

                sketch = new Sketch({
                    layer: activeDrawingLayer,
                    view: view,
                    // Enable new features in 4.x
                    creationMode: "single",
                    defaultUpdateOptions: {
                        tool: "reshape",
                        enableRotation: true,
                        enableScaling: true,
                        multipleSelectionEnabled: true,
                        toggleToolOnClick: false
                    },
                    visibleElements: {
                        createTools: {
                            point: true,
                            polyline: true,
                            polygon: true,
                            rectangle: true,
                            circle: true
                        },
                        selectionTools: {
                            "lasso-selection": true,
                            "rectangle-selection": true
                        },
                        settingsMenu: true,  // Show settings
                        undoRedoMenu: true,
                        snappingControls: true // Show snapping controls
                    },
                    // Enable snapping
                    snappingOptions: {
                        enabled: true,
                        selfEnabled: true,
                        featureEnabled: true,
                        featureSources: [{ layer: activeDrawingLayer }]
                    }
                });

                updateSketchSymbols();

                sketch.on("create", function(event) {
                    if (event.state === "complete") {
                        handleGraphicCreation(event.graphic, false);
                    }
                });
                view.ui.add(sketch, "top-left");
            }

            function createSymbol(type, color) {
                if (type === "point") return new SimpleMarkerSymbol({ color: color, size: "8px", outline: { color: "white", width: 1 } });
                if (type === "polyline") return new SimpleLineSymbol({ color: color, width: 2 });
                if (type === "polygon") return new SimpleFillSymbol({ color: hexToRgba(color, 0.3), outline: { color: color, width: 2 } });
                return null;
            }

            function updateLayerList() {
                var list = document.getElementById("layerList"); list.innerHTML = "";
                map.layers.toArray().reverse().forEach((l,i) => {
                    if(l.listMode!=="hide"){
                        var li = document.createElement("div"); li.className="layer-item";
                        if(l===activeDrawingLayer) li.style.borderColor = "#0d6efd";
                        
                        var visIcon = l.visible ? "fa-eye" : "fa-eye-slash";
                        var visColor = l.visible ? "text-primary" : "text-muted";
                        
                        li.innerHTML = `
                            <div class="layer-header">
                                <span class="fw-bold small text-truncate" style="max-width: 180px;">${l.title}</span>
                                <div class="layer-actions">
                                    <button class="btn btn-sm btn-light border" title="Toggle Visibility" onclick="toggleLayerVisibility('${l.id}')">
                                        <i class="fas ${visIcon} ${visColor}"></i>
                                    </button>
                                    <button class="btn btn-sm btn-info text-white" title="Attribute Table" onclick="openAttributeTable('${l.id}')">
                                        <i class="fas fa-table"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger" title="Remove" onclick="removeLayer('${l.id}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="layer-controls-row">
                                <div class="layer-opacity">
                                    <i class="fas fa-adjust small text-muted"></i>
                                    <input type="range" class="form-range" min="0" max="1" step="0.1" value="${l.opacity}" onchange="changeLayerOpacity('${l.id}', this.value)">
                                </div>
                            </div>
                        `;
                        list.appendChild(li);
                    }
                });
            }

            // Expose global functions needed for HTML inline onclick handlers
            window.removeLayer = function(id) { map.remove(map.findLayerById(id)); updateLayerList(); populateDrawLayerSelect(); };
            
            window.toggleLayerVisibility = function(layerId) {
                var layer = map.findLayerById(layerId);
                if(layer) {
                    layer.visible = !layer.visible;
                    updateLayerList();
                }
            }

            window.changeLayerOpacity = function(layerId, val) {
                var layer = map.findLayerById(layerId);
                if(layer) {
                    layer.opacity = parseFloat(val);
                }
            }

            window.openAttributeTable = function(layerId) {
                var layer = map.findLayerById(layerId);
                if(!layer || !layer.graphics || layer.graphics.length === 0) {
                    alert("No data in this layer."); return;
                }
                
                currentTableLayerId = layerId;
                document.getElementById("tableLayerName").textContent = "Table: " + layer.title;
                
                var graphics = layer.graphics.toArray();
                var tableHead = document.querySelector("#featureTable thead");
                var tableBody = document.querySelector("#featureTable tbody");
                tableHead.innerHTML = ""; tableBody.innerHTML = "";
                
                // Get all unique keys
                var keys = new Set();
                graphics.forEach(g => {
                    if(g.attributes) Object.keys(g.attributes).forEach(k => keys.add(k));
                });
                var columns = Array.from(keys);
                
                // Build Header
                var trHead = document.createElement("tr");
                columns.forEach(col => {
                    var th = document.createElement("th"); th.textContent = col; trHead.appendChild(th);
                });
                tableHead.appendChild(trHead);
                
                // Build Body
                graphics.forEach((g, index) => {
                    var tr = document.createElement("tr");
                    tr.dataset.uid = g.uid; // Store UID for saving
                    columns.forEach(col => {
                        var td = document.createElement("td");
                        td.textContent = (g.attributes[col] !== undefined && g.attributes[col] !== null) ? g.attributes[col] : "";
                        td.contentEditable = true; // Allow editing
                        td.dataset.col = col;
                        tr.appendChild(td);
                    });
                    tableBody.appendChild(tr);
                });
                
                togglePanel("attributeTablePanel");
            }

            function createNewDrawingLayer(name) {
                var newLayer = new GraphicsLayer({ title: name, isDrawLayer: true });
                map.add(newLayer);
                activeDrawingLayer = newLayer;
                updateLayerList();
                populateDrawLayerSelect();
            }

            function populateDrawLayerSelect() {
                var select = document.getElementById("drawLayerSelect"); select.innerHTML = "";
                var bufferSelect = document.getElementById("bufferTargetLayer"); bufferSelect.innerHTML = "";
                var attrSelect = document.getElementById("selectAttrLayer"); attrSelect.innerHTML = '<option value="">Select Layer</option>';
                var fieldSelect = document.getElementById("selectAttrField"); fieldSelect.innerHTML = ""; // Clear Fields on layer reload

                map.layers.forEach(function(layer) {
                    if (layer.isDrawLayer) {
                        var option = document.createElement("option"); option.value = layer.id; option.textContent = layer.title;
                        if (activeDrawingLayer && layer.id === activeDrawingLayer.id) option.selected = true;
                        select.appendChild(option);
                        
                        var bufferOption = document.createElement("option"); bufferOption.value = layer.id; bufferOption.textContent = layer.title;
                        bufferSelect.appendChild(bufferOption);

                        var attrOption = document.createElement("option"); attrOption.value = layer.id; attrOption.textContent = layer.title;
                        attrSelect.appendChild(attrOption);
                    }
                });
            }

            function handleCopyToDraw() {
                if (!activeDrawingLayer) { alert("Please create or select a 'Draw Layer' first."); return; }
                var selectedFeature = view.popup.selectedFeature;
                if (selectedFeature) {
                    var clonedGeometry = selectedFeature.geometry.clone();
                    var sym = null;
                    if (clonedGeometry.type === "point") sym = new SimpleMarkerSymbol({ color: activeColor, size: "8px", outline: { color: "white", width: 1 } });
                    else if (clonedGeometry.type === "polyline") sym = new SimpleLineSymbol({ color: activeColor, width: 2 });
                    else if (clonedGeometry.type === "polygon") sym = new SimpleFillSymbol({ color: hexToRgba(activeColor, 0.3), outline: { color: activeColor, width: 2 } });

                    var newAttributes = Object.assign({}, selectedFeature.attributes);
                    delete newAttributes.latitude; delete newAttributes.longitude;
                    delete newAttributes.mgrs; delete newAttributes.utmz47; delete newAttributes.utmz48;

                    var newGraphic = new Graphic({ geometry: clonedGeometry, symbol: sym, attributes: newAttributes });
                    newGraphic.attributes.color = activeColor;
                    handleGraphicCreation(newGraphic, false); 
                    activeDrawingLayer.add(newGraphic);
                    alert("Feature copied to: " + activeDrawingLayer.title); 
                    view.popup.close();
                    updateLayerList(); 
                }
            }

            function updateSelectAttributeOptions() {
                var layerSelect = document.getElementById("selectAttrLayer");
                var fieldSelect = document.getElementById("selectAttrField");
                populateDrawLayerSelect(); 
            }

            // --- END FUNCTION DECLARATIONS ---

            document.getElementById("toolbarToggleBtn").addEventListener("click", function() {
                var toolbar = document.getElementById("mainToolbar");
                var icon = document.getElementById("toggleIcon");
                if (toolbar.classList.contains("collapsed")) { 
                    toolbar.classList.remove("collapsed"); 
                    icon.classList.remove("fa-chevron-up"); 
                    icon.classList.add("fa-chevron-down");
                } else { 
                    toolbar.classList.add("collapsed"); 
                    icon.classList.remove("fa-chevron-down"); 
                    icon.classList.add("fa-chevron-up");
                }
            });

            function togglePanel(panelId) {
                document.querySelectorAll('.panel, .draw-tools, .excel-import-panel, #attributeTablePanel').forEach(p => { if (p.id !== panelId) p.style.display = 'none'; });
                var panel = document.getElementById(panelId);
                panel.style.display = (panel.style.display === 'none' || panel.style.display === '') ? 'flex' : 'none';
                if(panelId !== "attributeTablePanel") panel.style.display = (panel.style.display === 'flex') ? 'block' : 'none'; 
                if(panelId === "attributeTablePanel" && panel.style.display === 'flex') panel.style.flexDirection = 'column';
            }
            window.closePanel = function(panelId) { document.getElementById(panelId).style.display = 'none'; }

            document.getElementById("basemapBtn").addEventListener("click", () => togglePanel("basemapGalleryPanel"));
            document.getElementById("fullscreenBtn").addEventListener("click", () => { if (!document.fullscreenElement) document.documentElement.requestFullscreen(); else if (document.exitFullscreen) document.exitFullscreen(); });
            document.getElementById("searchBtn").addEventListener("click", () => togglePanel("searchPanel"));
            document.getElementById("printBtn").addEventListener("click", () => togglePanel("printPanel"));
            document.getElementById("layerListBtn").addEventListener("click", () => { togglePanel("layerPanel"); updateLayerList(); });
            document.getElementById("exportPanelBtn").addEventListener("click", () => { togglePanel("exportPanel"); updateExportLayerList(); });
            document.getElementById("importDataBtn").addEventListener("click", () => { togglePanel("importDataPanel"); });
            document.getElementById("selectAttrBtn").addEventListener("click", () => { togglePanel("selectAttributePanel"); updateSelectAttributeOptions(); });

            // --- FIX: USE REACTIVE UTILS FOR POPUP EVENTS ---
            view.when(() => {
                reactiveUtils.on(
                    () => view.popup,
                    "trigger-action",
                    (event) => {
                        if (event.action.id === "edit-attributes") {
                            var selectedFeature = view.popup.selectedFeature;
                            if (selectedFeature) {
                                showAttributeModal(selectedFeature);
                            }
                        } else if (event.action.id === "copy-to-draw") {
                            handleCopyToDraw();
                        }
                    }
                );
            });

            // --- DRAW SYSTEM ---
            const popularColors = [
                "#ff0000", "#ff7f00", "#ffff00", "#00ff00", "#0000ff", "#4b0082", "#9400d3", "#000000",
                "#ffffff", "#808080", "#a52a2a", "#ffc0cb", "#00ffff", "#ff00ff", "#ffd700", "#c0c0c0",
                "#008000", "#800000", "#808000", "#008080", "#000080", "#ffa500", "#dc143c", "#40e0d0"
            ];
            
            const paletteDiv = document.getElementById("colorPalette");
            popularColors.forEach(color => {
                const swatch = document.createElement("div");
                swatch.className = "color-swatch";
                swatch.style.backgroundColor = color;
                swatch.title = color;
                swatch.onclick = () => {
                    activeColor = color;
                    updateColorInputs(color);
                    updateSketchSymbols();
                };
                paletteDiv.appendChild(swatch);
            });

            document.getElementById("drawColor").addEventListener("input", function(e) { activeColor = e.target.value; updateColorInputs(activeColor); updateSketchSymbols(); });
            document.getElementById("hexColorInput").addEventListener("change", function(e) { 
                let val = e.target.value;
                if(!val.startsWith("#")) val = "#" + val;
                if(/^#[0-9A-F]{6}$/i.test(val)) {
                    activeColor = val;
                    updateColorInputs(val);
                    updateSketchSymbols();
                }
            });

            document.getElementById("drawBtn").addEventListener("click", function() {
                var drawTools = document.getElementById("drawTools");
                var button = document.getElementById("drawBtn");
                if (drawTools.style.display === "none" || drawTools.style.display === "") {
                    togglePanel("drawTools");
                    button.classList.add("tool-active");
                    if (!activeDrawingLayer) createNewDrawingLayer("Default Drawing Layer");
                    populateDrawLayerSelect();
                    initializeSketch();
                } else {
                    drawTools.style.display = "none";
                    button.classList.remove("tool-active");
                    if (sketch) { view.ui.remove(sketch); sketch.destroy(); sketch = null; }
                }
            });

            document.getElementById("createLayerBtn").addEventListener("click", function() {
                var nameInput = document.getElementById("newLayerName");
                if (nameInput.value.trim()) { createNewDrawingLayer(nameInput.value.trim()); nameInput.value = ""; populateDrawLayerSelect(); } 
                else { alert("Please enter a layer name"); }
            });

            document.getElementById("drawLayerSelect").addEventListener("change", function(e) {
                var layer = map.findLayerById(e.target.value);
                if (layer) { activeDrawingLayer = layer; initializeSketch(); updateLayerList(); }
            });

            document.getElementById("updateLayerColorBtn").addEventListener("click", function() {
                if(!activeDrawingLayer) return;
                const conf = confirm("Update ALL graphics in layer '" + activeDrawingLayer.title + "' to current color?");
                if(conf) {
                    activeDrawingLayer.graphics.forEach(g => {
                        g.symbol = createSymbol(g.geometry.type, activeColor);
                        g.attributes.color = activeColor;
                    });
                    alert("Layer color updated.");
                }
            });

            // --- BUFFER TOOL ---
            document.getElementById("executeBufferBtn").addEventListener("click", function() {
                var targetLayerId = document.getElementById("bufferTargetLayer").value;
                var dist = parseFloat(document.getElementById("manualBufferDist").value);
                if (!targetLayerId) { alert("Please select a layer to buffer."); return; }
                if (isNaN(dist) || dist <= 0) { alert("Please enter a valid buffer distance."); return; }
                var targetLayer = map.findLayerById(targetLayerId);
                if (targetLayer && targetLayer.graphics.length > 0) {
                    var newLayerName = `Buffer ${dist}m - ${targetLayer.title}`;
                    var bufferLayer = new GraphicsLayer({ title: newLayerName, isDrawLayer: true });
                    map.add(bufferLayer);
                    targetLayer.graphics.forEach(function(graphic) {
                        try {
                            var bufferGeom = geometryEngine.buffer(graphic.geometry, dist, "meters");
                            if (bufferGeom) {
                                var bufferGraphic = new Graphic({
                                    geometry: bufferGeom,
                                    symbol: new SimpleFillSymbol({ color: hexToRgba(activeColor, 0.3), outline: { color: activeColor, width: 2 } }),
                                    attributes: { description: `Buffer ${dist}m`, color: activeColor }
                                });
                                handleGraphicCreation(bufferGraphic, true);
                                bufferLayer.add(bufferGraphic);
                            }
                        } catch (e) { console.error("Buffer error:", e); }
                    });
                    updateLayerList(); populateDrawLayerSelect(); updateExportLayerList(); alert(`Created buffer layer: ${newLayerName}`);
                } else { alert("Selected layer is empty."); }
            });

            // --- CENTRALIZED COORDINATE ATTRIBUTE HANDLER ---
            function getUTMAttributes(pointWGS84) {
                var result = { utmz47: "-", utmz48: "-" };
                try {
                    var sr47 = new SpatialReference({ wkid: 32647 });
                    var sr48 = new SpatialReference({ wkid: 32648 });
                    
                    var p47 = projection.project(pointWGS84, sr47);
                    if (p47) result.utmz47 = `${p47.x.toFixed(2)}, ${p47.y.toFixed(2)}`;
                    
                    var p48 = projection.project(pointWGS84, sr48);
                    if (p48) result.utmz48 = `${p48.x.toFixed(2)}, ${p48.y.toFixed(2)}`;
                } catch (e) { console.error("Projection Error:", e); }
                return result;
            }

            function handleGraphicCreation(graphic, isBuffer) {
                graphic.attributes = graphic.attributes || {};
                graphic.attributes.color = graphic.attributes.color || activeColor;
                graphic.attributes.isBuffer = isBuffer ? "Yes" : "No";

                var geom = graphic.geometry;
                var centerPoint = (geom.type === "point") ? geom : geom.extent.center;
                
                var latLon;
                if (centerPoint.spatialReference.isWebMercator) {
                    latLon = webMercatorUtils.webMercatorToGeographic(centerPoint);
                } else {
                    latLon = centerPoint;
                }
                
                var utmAttrs = getUTMAttributes(latLon);
                graphic.attributes.utmz47 = utmAttrs.utmz47;
                graphic.attributes.utmz48 = utmAttrs.utmz48;

                var lat = latLon.latitude.toFixed(6);
                var lon = latLon.longitude.toFixed(6);
                graphic.attributes.latitude = lat;
                graphic.attributes.longitude = lon;

                var mgrsStr = "";
                try { mgrsStr = coordinateFormatter.toMgrs(latLon, "automatic", 5); } catch(e) { mgrsStr = "Error"; }
                graphic.attributes.mgrs = mgrsStr;

                graphic.attributes.type = geom.type;
                if(!graphic.attributes.timestamp) {
                    graphic.attributes.timestamp = new Date().toISOString();
                }

                graphic.popupTemplate = {
                    title: "{description}",
                    content: [{
                        type: "fields",
                        fieldInfos: [
                            { fieldName: "latitude", label: "Lat (WGS84)" },
                            { fieldName: "longitude", label: "Lon (WGS84)" },
                            { fieldName: "mgrs", label: "MGRS (WGS84)" },
                            { fieldName: "utmz47", label: "UTM Z47N (WGS84)" },
                            { fieldName: "utmz48", label: "UTM Z48N (WGS84)" },
                            { fieldName: "type", label: "Type" },
                            { fieldName: "LayerName", label: "Layer" }
                        ]
                    }],
                    actions: [editAttributeAction]
                };

                if (!isBuffer && !graphic.attributes.description) {
                    // showAttributeModal(graphic); // Optional: auto open
                }
            }

            // --- SEARCH SYSTEM ---
            document.querySelectorAll('input[name="searchType"]').forEach((elem) => { 
                elem.addEventListener("change", (e) => { 
                    document.getElementById("searchInput").placeholder = e.target.value === "latlon" ? "e.g. 13.7, 100.5" : "e.g. 47Q LA 377 437"; 
                }); 
            });

            document.getElementById("searchCoordBtn").addEventListener("click", function() {
                var input = document.getElementById("searchInput").value.trim();
                var searchType = document.querySelector('input[name="searchType"]:checked').value;
                
                if (searchType === "latlon") {
                    var coords = input.split(",");
                    if (coords.length === 2 && !isNaN(parseFloat(coords[0])) && !isNaN(parseFloat(coords[1]))) {
                        executeSearch(parseFloat(coords[1].trim()), parseFloat(coords[0].trim()));
                    } else { alert("Invalid Lat/Lon format. Use: lat,lon"); }
                } else if (searchType === "mgrs") {
                    if (coordinateFormatter.isSupported()) {
                        try { 
                            var p = coordinateFormatter.fromMgrs(input, new SpatialReference({ wkid: 4326 }), "automatic"); 
                            if(p) {
                                executeSearch(p.longitude, p.latitude); 
                            } else { alert("Invalid MGRS coordinate"); }
                        } catch(e) { alert("Error parsing MGRS"); }
                    }
                }
            });

            function executeSearch(lon, lat) {
                var point = new Point({ 
                    latitude: lat, 
                    longitude: lon,
                    spatialReference: new SpatialReference({ wkid: 4326 }) 
                });
                
                var graphic = new Graphic({ 
                    geometry: point, 
                    symbol: markerSymbol, 
                    attributes: { 
                        description: "Search Result (" + lat.toFixed(5) + ", " + lon.toFixed(5) + ")", 
                        color: "#0000ff",
                        LayerName: "Search History"
                    } 
                });

                handleGraphicCreation(graphic, false); 
                
                searchGraphicsLayer.add(graphic);
                view.goTo({ target: point, zoom: 16 }); 
                updateLayerList(); 
                updateExportLayerList();
            }

            // --- DYNAMIC ATTRIBUTE EDITING LOGIC (UPDATED) ---
            var currentEditingGraphic = null;

            window.showAttributeModal = function(graphic) {
                currentEditingGraphic = graphic;
                var attrs = graphic.attributes || {};
                
                var container = document.getElementById("attributeDynamicFields");
                container.innerHTML = ""; // Clear old fields

                // Define system fields that should perhaps be read-only or handled specifically
                const systemFields = ["latitude", "longitude", "mgrs", "utmz47", "utmz48", "color", "type", "timestamp", "isBuffer"];

                // Create fields for all attributes
                Object.keys(attrs).forEach(key => {
                    // Skip geometry object if it appears in attributes (it shouldn't, but safety check)
                    if(key === "geometry") return;

                    var div = document.createElement("div");
                    div.className = "mb-2";
                    
                    var label = document.createElement("label");
                    label.className = "form-label small fw-bold";
                    label.textContent = key;
                    
                    var input = document.createElement("input");
                    input.type = "text";
                    input.className = "form-control form-control-sm";
                    input.id = "attr_input_" + key;
                    input.name = key;
                    input.value = (attrs[key] !== undefined && attrs[key] !== null) ? attrs[key] : "";
                    
                    // Mark system fields as read-only (optional, remove this if you want EVERYTHING editable)
                    // if(systemFields.includes(key)) {
                    //    input.readOnly = true;
                    //    input.classList.add("bg-light");
                    // }

                    div.appendChild(label);
                    div.appendChild(input);
                    container.appendChild(div);
                });

                // Add button to add new field
                var addFieldDiv = document.createElement("div");
                addFieldDiv.className = "mt-3 border-top pt-2";
                addFieldDiv.innerHTML = `
                    <label class="small text-muted">Add New Field:</label>
                    <div class="input-group input-group-sm">
                        <input type="text" id="new_attr_key" class="form-control" placeholder="Field Name">
                        <input type="text" id="new_attr_value" class="form-control" placeholder="Value">
                        <button class="btn btn-outline-secondary" type="button" onclick="addNewAttributeField()">Add</button>
                    </div>
                `;
                container.appendChild(addFieldDiv);

                document.getElementById('modalBackdrop').style.display = 'block';
                document.getElementById('attributeModal').style.display = 'block';
            }

            window.addNewAttributeField = function() {
                var key = document.getElementById("new_attr_key").value.trim();
                var val = document.getElementById("new_attr_value").value.trim();
                if(key) {
                    if(currentEditingGraphic) {
                        currentEditingGraphic.attributes[key] = val;
                        // Refresh modal
                        showAttributeModal(currentEditingGraphic);
                    }
                }
            }

            document.getElementById('attributeForm').onsubmit = function(e) {
                e.preventDefault();
                if (currentEditingGraphic) {
                    var container = document.getElementById("attributeDynamicFields");
                    var inputs = container.querySelectorAll("input:not(#new_attr_key):not(#new_attr_value)");
                    
                    inputs.forEach(input => {
                        currentEditingGraphic.attributes[input.name] = input.value;
                    });

                    // Special update for 'description' to update title
                    if(currentEditingGraphic.attributes.description) {
                         if (view.popup.selectedFeature === currentEditingGraphic) {
                            view.popup.title = currentEditingGraphic.attributes.description;
                        }
                    }

                    closeAttributeModal();
                }
            };

            window.closeAttributeModal = function() {
                document.getElementById('modalBackdrop').style.display = 'none';
                document.getElementById('attributeModal').style.display = 'none';
                document.getElementById('attributeForm').reset();
                currentEditingGraphic = null;
            }

            // --- SELECT BY ATTRIBUTE (UPDATED WITH OPERATORS) ---
            document.getElementById("selectAttrLayer").addEventListener("change", function(e) {
                var layerId = e.target.value;
                var fieldSelect = document.getElementById("selectAttrField");
                fieldSelect.innerHTML = "";
                
                if (layerId) {
                    var layer = map.findLayerById(layerId);
                    if (layer && layer.graphics.length > 0) {
                        var firstGraphic = layer.graphics.getItemAt(0);
                        var keys = Object.keys(firstGraphic.attributes);
                        keys.forEach(key => {
                            if (key !== "geometry") { 
                                var opt = document.createElement("option");
                                opt.value = key; opt.textContent = key;
                                fieldSelect.appendChild(opt);
                            }
                        });
                    }
                }
            });

            document.getElementById("executeSelectAttrBtn").addEventListener("click", function() {
                var layerId = document.getElementById("selectAttrLayer").value;
                var field = document.getElementById("selectAttrField").value;
                var operator = document.getElementById("selectOperator").value;
                var val = document.getElementById("selectAttrValue").value.trim();
                var resultMsg = document.getElementById("selectResultMsg");
                resultMsg.textContent = "";

                if (!layerId || !field || !val) { resultMsg.textContent = "Please fill all fields."; return; }

                var layer = map.findLayerById(layerId);
                var foundGraphics = [];
                
                layer.graphics.forEach(function(g) {
                    var attrVal = g.attributes[field];
                    var match = false;

                    // Convert to number for comparison if possible
                    var numAttr = parseFloat(attrVal);
                    var numVal = parseFloat(val);
                    var isNumber = !isNaN(numAttr) && !isNaN(numVal);

                    if(operator === "=") {
                         // Loose equality for string/number mix
                        match = (String(attrVal).toLowerCase() === String(val).toLowerCase());
                    } else if (operator === "contains") {
                        match = String(attrVal).toLowerCase().includes(String(val).toLowerCase());
                    } else if (isNumber) {
                        if (operator === ">") match = numAttr > numVal;
                        else if (operator === "<") match = numAttr < numVal;
                        else if (operator === ">=") match = numAttr >= numVal;
                        else if (operator === "<=") match = numAttr <= numVal;
                    }

                    if (match) {
                        foundGraphics.push(g);
                    }
                });

                if (foundGraphics.length > 0) {
                    view.goTo(foundGraphics);
                    view.popup.open({
                        features: foundGraphics,
                        featureMenuOpen: true
                    });
                    resultMsg.textContent = `Found ${foundGraphics.length} features.`;
                    resultMsg.className = "mt-2 small text-success";
                } else {
                    resultMsg.textContent = "No features found.";
                    resultMsg.className = "mt-2 small text-danger";
                }
            });

            // --- EXPORT SYSTEM ---
            function updateExportLayerList() {
                var container = document.getElementById("exportLayerList"); container.innerHTML = "";
                var hasLayers = false;
                map.layers.forEach(function(layer) {
                    if (layer.isDrawLayer) {
                        hasLayers = true;
                        var div = document.createElement("div"); div.className = "form-check";
                        div.innerHTML = `<input class="form-check-input export-layer-checkbox" type="checkbox" value="${layer.id}" id="export_${layer.id}" checked><label class="form-check-label" for="export_${layer.id}">${layer.title}</label>`;
                        container.appendChild(div);
                    }
                });
                document.getElementById("confirmExportBtn").disabled = !hasLayers;
                if (!hasLayers) container.innerHTML = "<p class='text-center text-muted'>No drawing layers found.</p>";
            }

            document.getElementById("confirmExportBtn").addEventListener("click", function() {
                var checkboxes = document.querySelectorAll('.export-layer-checkbox:checked');
                var layerIds = Array.from(checkboxes).map(cb => cb.value);
                if (layerIds.length === 0) { alert("Please select at least one layer."); return; }
                var exportType = document.querySelector('input[name="exportFormat"]:checked').value;
                if (exportType === "kml") exportSelectedLayersToKML(layerIds);
                else if (exportType === "geojson") exportSelectedLayersToGeoJSON(layerIds, 4326);
                else if (exportType === "geojson_47") exportSelectedLayersToGeoJSON(layerIds, 32647);
                else if (exportType === "geojson_48") exportSelectedLayersToGeoJSON(layerIds, 32648);
                else if (exportType === "excel") exportSelectedLayersToExcel(layerIds);
            });

            function exportSelectedLayersToExcel(layerIds) {
                var wb = XLSX.utils.book_new();
                var hasData = false;
                layerIds.forEach(function(id) {
                    var layer = map.findLayerById(id);
                    if (layer && layer.graphics && layer.graphics.length > 0) {
                        var rowData = [];
                        layer.graphics.forEach(function(graphic) {
                            var attrs = graphic.attributes || {};
                            var row = Object.assign({}, attrs);
                            if (!row.latitude) {
                                var geom = graphic.geometry;
                                var center = (geom.type === "point") ? geom : geom.extent.center;
                                var ll = webMercatorUtils.webMercatorToGeographic(center);
                                row.latitude = ll.latitude.toFixed(6); row.longitude = ll.longitude.toFixed(6);
                                try { row.mgrs = coordinateFormatter.toMgrs(ll, "automatic", 5); } catch(e){}
                                var utm = getUTMAttributes(ll);
                                row.utmz47 = utm.utmz47; row.utmz48 = utm.utmz48;
                            }
                            row.LayerName = layer.title;
                            rowData.push(row);
                        });
                        if (rowData.length > 0) {
                            hasData = true;
                            var ws = XLSX.utils.json_to_sheet(rowData);
                            var sheetName = (layer.title || "Layer").replace(/[\\/?*\[\]]/g, "").substring(0, 30);
                            XLSX.utils.book_append_sheet(wb, ws, sheetName);
                        }
                    }
                });
                if (hasData) { XLSX.writeFile(wb, "map_export_wgs84_utm.xlsx"); closePanel('exportPanel'); } 
                else { alert("No data found to export."); }
            }

            function toKmlColor(hexColor, alpha) {
                var a = alpha || "ff"; if (!hexColor) return "ff0000ff";
                var hex = hexColor.replace("#", "");
                if (hex.length === 3) hex = hex[0]+hex[0] + hex[1]+hex[1] + hex[2]+hex[2];
                return a + hex.substring(4, 6) + hex.substring(2, 4) + hex.substring(0, 2);
            }

            function exportSelectedLayersToKML(layerIds) {
                var kml = `<?xml version="1.0" encoding="UTF-8"?><kml xmlns="http://www.opengis.net/kml/2.2"><Document><name>Map Export</name>`;
                layerIds.forEach(function(id) {
                    var layer = map.findLayerById(id);
                    if (layer && layer.graphics && layer.graphics.length > 0) {
                        kml += `<Folder><name>${layer.title}</name>`;
                        layer.graphics.forEach(function(graphic, index) {
                            var attrs = graphic.attributes || {};
                            var name = attrs.description || "Untitled"; 
                            var color = attrs.color || "#0000ff";
                            var styleId = "style_" + id + "_" + index;
                            var kmlColor = toKmlColor(color, "ff");
                            var kmlFillColor = toKmlColor(color, "4D");
                            kml += `<Style id="${styleId}"><LineStyle><color>${kmlColor}</color><width>2</width></LineStyle><PolyStyle><color>${kmlFillColor}</color></PolyStyle><IconStyle><color>${kmlColor}</color><scale>1.0</scale><Icon><href>http://maps.google.com/mapfiles/kml/pushpin/wht-pushpin.png</href></Icon></IconStyle></Style>`;
                            var desc = "";
                            for (var key in attrs) { if (key !== "color" && key !== "timestamp") desc += `<b>${key}:</b> ${attrs[key]}<br>`; }
                            kml += `<Placemark><name>${name}</name><description><![CDATA[${desc}]]></description><styleUrl>#${styleId}</styleUrl>`;
                            var geom = graphic.geometry;
                            if (geom.type === "point") {
                                var ll = attrs.latitude ? {latitude:attrs.latitude, longitude:attrs.longitude} : webMercatorUtils.webMercatorToGeographic(geom);
                                kml += `<Point><coordinates>${ll.longitude},${ll.latitude}</coordinates></Point>`;
                            } else if (geom.type === "polyline") {
                                kml += '<LineString><coordinates>';
                                var geoLine = webMercatorUtils.webMercatorToGeographic(geom);
                                geoLine.paths[0].forEach(p => { kml += `${p[0]},${p[1]} `; });
                                kml += '</coordinates></LineString>';
                            } else if (geom.type === "polygon") {
                                kml += '<Polygon><outerBoundaryIs><LinearRing><coordinates>';
                                var geoPoly = webMercatorUtils.webMercatorToGeographic(geom);
                                geoPoly.rings[0].forEach(p => { kml += `${p[0]},${p[1]} `; });
                                kml += '</coordinates></LinearRing></outerBoundaryIs></Polygon>';
                            }
                            kml += `</Placemark>`;
                        });
                        kml += `</Folder>`;
                    }
                });
                kml += `</Document></kml>`;
                downloadFile(kml, "map_export.kml", "application/vnd.google-earth.kml+xml");
            }

            function exportSelectedLayersToGeoJSON(layerIds, wkid) {
                var features = [];
                var crsObj = null;
                var sr = new SpatialReference({ wkid: wkid });

                if (wkid === 32647) crsObj = { "type": "name", "properties": { "name": "urn:ogc:def:crs:EPSG::32647" } };
                else if (wkid === 32648) crsObj = { "type": "name", "properties": { "name": "urn:ogc:def:crs:EPSG::32648" } };
                else crsObj = { "type": "name", "properties": { "name": "urn:ogc:def:crs:OGC:1.3:CRS84" } }; 

                layerIds.forEach(function(id) {
                    var layer = map.findLayerById(id);
                    if (layer && layer.graphics && layer.graphics.length > 0) {
                        layer.graphics.forEach(function(graphic) {
                            var attrs = graphic.attributes || {};
                            var properties = Object.assign({}, attrs);
                            
                            var projectedGeom = (wkid === 4326) 
                                ? webMercatorUtils.webMercatorToGeographic(graphic.geometry) 
                                : projection.project(graphic.geometry, sr);
                            
                            var geoJsonGeom = null;
                            if (projectedGeom) {
                                if (projectedGeom.type === "point") geoJsonGeom = { type: "Point", coordinates: [projectedGeom.x, projectedGeom.y] };
                                else if (projectedGeom.type === "polyline") geoJsonGeom = { type: "LineString", coordinates: projectedGeom.paths[0] };
                                else if (projectedGeom.type === "polygon") geoJsonGeom = { type: "Polygon", coordinates: projectedGeom.rings };
                            }
                            if (geoJsonGeom) features.push({ type: "Feature", properties: properties, geometry: geoJsonGeom });
                        });
                    }
                });
                var geoJsonObj = { type: "FeatureCollection", crs: crsObj, features: features };
                var fileName = (wkid === 32647) ? "map_export_utm47n.geojson" : (wkid === 32648) ? "map_export_utm48n.geojson" : "map_export_wgs84.geojson";
                downloadFile(JSON.stringify(geoJsonObj, null, 2), fileName, "application/geo+json");
            }

            function downloadFile(content, fileName, mimeType) {
                var blob = new Blob([content], {type: mimeType});
                var url = URL.createObjectURL(blob);
                var a = document.createElement("a"); a.href = url; a.download = fileName;
                document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
                closePanel('exportPanel');
            }

            // --- IMPORT VECTOR FILES (KML, KMZ, GeoJSON, Shp Zip) ---
            document.getElementById("importVectorBtn").addEventListener("click", function() {
                try {
                    var fileInput = document.getElementById("vectorFile");
                    if (!fileInput.files || fileInput.files.length === 0) { 
                        alert("Please select a file."); 
                        return; 
                    }
                    
                    var file = fileInput.files[0];
                    var fileName = file.name.toLowerCase(); // Use lower case for check
                    var fileNameOriginal = file.name;
                    var fileNameNoExt = fileNameOriginal.split('.').slice(0, -1).join('.');
                    
                    console.log("Attempting to import: " + fileNameOriginal);

                    // Create a dedicated layer for this import
                    createNewDrawingLayer("Import: " + fileNameNoExt);
                    
                    var reader = new FileReader();

                    if (fileName.endsWith(".zip")) {
                        // Shapefile (requires ArrayBuffer)
                        reader.onload = function(e) {
                            if (typeof shp === 'undefined') { alert("Shapefile library (shpjs) not loaded."); return; }
                            shp(e.target.result).then(function(geojson){
                                if (Array.isArray(geojson)) {
                                    geojson.forEach(fc => addGeoJsonToLayer(fc));
                                } else {
                                    addGeoJsonToLayer(geojson);
                                }
                            }).catch(err => {
                                console.error(err);
                                alert("Shapefile parsing error: " + err);
                            });
                        };
                        reader.readAsArrayBuffer(file);
                    } else if (fileName.endsWith(".kmz")) {
                        // KMZ (Unzip -> find KML)
                        reader.onload = function(e) {
                            if (typeof JSZip === 'undefined') { alert("JSZip library not loaded."); return; }
                            JSZip.loadAsync(e.target.result).then(function(zip) {
                                var kmlFile = Object.values(zip.files).find(f => f.name.toLowerCase().endsWith(".kml"));
                                if (kmlFile) {
                                    kmlFile.async("string").then(function(kmlText) {
                                        parseKmlText(kmlText);
                                    });
                                } else { alert("No KML file found in KMZ."); }
                            }).catch(err => alert("KMZ error: " + err));
                        };
                        reader.readAsArrayBuffer(file);
                    } else if (fileName.endsWith(".kml")) {
                        // KML
                        reader.onload = function(e) {
                            parseKmlText(e.target.result);
                        };
                        reader.readAsText(file);
                    } else if (fileName.endsWith(".geojson") || fileName.endsWith(".json")) {
                        // GeoJSON
                        reader.onload = function(e) {
                            try {
                                var json = JSON.parse(e.target.result);
                                addGeoJsonToLayer(json);
                            } catch(err) { alert("Invalid JSON: " + err); }
                        };
                        reader.readAsText(file);
                    } else {
                        alert("Unsupported file type. Please use .zip (Shapefile), .kml, .kmz, or .geojson");
                    }
                } catch (e) {
                    console.error("Import button error:", e);
                    alert("Error initiating import: " + e.message);
                }
            });

            function parseKmlText(kmlText) {
                try {
                    var parser = new DOMParser();
                    var kml = parser.parseFromString(kmlText, "text/xml");
                    // Check if toGeoJSON exists
                    if (typeof toGeoJSON === 'undefined') {
                        if(typeof window.toGeoJSON !== 'undefined') toGeoJSON = window.toGeoJSON; // Fallback
                        else { alert("toGeoJSON library not loaded."); return; }
                    }
                    var geojson = toGeoJSON.kml(kml);
                    addGeoJsonToLayer(geojson);
                } catch(err) { alert("KML Parsing error: " + err); }
            }

            // --- ADDED FUNCTION: Extract WKID from GeoJSON CRS ---
            function getWkidFromCrs(crs) {
                if (!crs || !crs.properties || !crs.properties.name) return 4326; // Default to WGS84 if no CRS
                // Try to find EPSG code in the string (e.g., "urn:ogc:def:crs:EPSG::32647" or "EPSG:32647")
                var match = crs.properties.name.match(/EPSG\D+(\d+)/i);
                if (match && match[1]) {
                    return parseInt(match[1], 10);
                }
                return 4326; // Fallback
            }

            function addGeoJsonToLayer(geojson) {
                if (!activeDrawingLayer) return;
                var graphicsToAdd = [];
                var features = geojson.features || (geojson.type === "Feature" ? [geojson] : []);

                // 1. Determine Input Spatial Reference from GeoJSON CRS object
                var wkid = getWkidFromCrs(geojson.crs);
                var sourceSR = new SpatialReference({ wkid: wkid });

                features.forEach(f => {
                    var geom = f.geometry;
                    // FIX: Check if geometry exists
                    if (!geom) return; 

                    var props = f.properties || {};
                    var esriGeom = null;

                    // Improved Geometry Conversion with validation
                    try {
                        // NOTE: Use 'x' and 'y' instead of 'longitude'/'latitude' to support non-WGS84 coordinates (like UTM)
                        // Also attach the sourceSR to the geometry so the projection engine knows what it is.

                        if (geom.type === "Point" && geom.coordinates && geom.coordinates.length >= 2) {
                            esriGeom = new Point({ x: geom.coordinates[0], y: geom.coordinates[1], spatialReference: sourceSR });
                        } else if (geom.type === "MultiPoint" && geom.coordinates) {
                             esriGeom = new Multipoint({ points: geom.coordinates, spatialReference: sourceSR });
                        } else if (geom.type === "LineString" && geom.coordinates) {
                            esriGeom = new Polyline({ paths: [geom.coordinates], spatialReference: sourceSR });
                        } else if (geom.type === "MultiLineString" && geom.coordinates) {
                            esriGeom = new Polyline({ paths: geom.coordinates, spatialReference: sourceSR });
                        } else if (geom.type === "Polygon" && geom.coordinates) {
                            esriGeom = new Polygon({ rings: geom.coordinates, spatialReference: sourceSR });
                        } else if (geom.type === "MultiPolygon" && geom.coordinates) {
                            var rings = [];
                            geom.coordinates.forEach(polyRings => {
                                polyRings.forEach(ring => rings.push(ring));
                            });
                            esriGeom = new Polygon({ rings: rings, spatialReference: sourceSR });
                        }
                    } catch (err) {
                        console.warn("Geometry conversion error for feature:", f, err);
                        return;
                    }
                    
                    if (esriGeom) {
                        // 2. Reproject if necessary
                        // If the input is NOT WGS84 (4326) and NOT WebMercator (3857/102100), try to project it to the view's SR
                        if (wkid !== 4326 && wkid !== 3857 && wkid !== 102100) {
                            try {
                                var projected = projection.project(esriGeom, view.spatialReference);
                                if (projected) {
                                    esriGeom = projected;
                                }
                            } catch (e) {
                                console.warn("Projection failed:", e);
                                // Continue with original geometry, map might fail to render if SR is wildly different
                            }
                        }

                        var g = new Graphic({
                            geometry: esriGeom,
                            attributes: props
                        });
                        
                        // Set symbol based on type
                        if (esriGeom.type === "point" || esriGeom.type === "multipoint") g.symbol = new SimpleMarkerSymbol({color: activeColor, size: "8px", outline: {color:"white"}});
                        else if (esriGeom.type === "polyline") g.symbol = new SimpleLineSymbol({color: activeColor, width: 2});
                        else if (esriGeom.type === "polygon") g.symbol = new SimpleFillSymbol({color: hexToRgba(activeColor, 0.3), outline: {color: activeColor, width: 2}});
                        
                        if (!g.attributes.description && g.attributes.name) g.attributes.description = g.attributes.name;
                        
                        handleGraphicCreation(g, false);
                        graphicsToAdd.push(g);
                    }
                });

                if (graphicsToAdd.length > 0) {
                    activeDrawingLayer.addMany(graphicsToAdd);
                    view.goTo(graphicsToAdd);
                    alert(`Imported ${graphicsToAdd.length} features.`);
                    closePanel('importDataPanel');
                    updateLayerList();
                } else {
                    alert("No valid features found to import.");
                }
            }

            // --- EXCEL IMPORT HANDLERS (UPDATED WITH PAGE 2 LOGIC) ---
            document.getElementById("excelFile").addEventListener("change", function(e) {
                var file = e.target.files[0];
                if (file) {
                    var reader = new FileReader();
                    reader.onload = function(e) {
                        var data = new Uint8Array(e.target.result);
                        var wb = XLSX.read(data, { type: 'array' });
                        var json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header: 1 });
                        if (json.length > 0) {
                            var headers = json[0];
                            ['latColumn', 'lonColumn', 'labelColumn'].forEach(id => {
                                var sel = document.getElementById(id);
                                sel.innerHTML = '<option value="">Select Column</option>';
                                headers.forEach((h, i) => { 
                                    var op = document.createElement('option'); 
                                    op.value = i; 
                                    op.textContent = h; 
                                    sel.appendChild(op); 
                                });
                            });
                            document.getElementById("importExcelBtn").disabled = false;
                        }
                    };
                    reader.readAsArrayBuffer(file);
                }
            });

            document.getElementById("importExcelBtn").addEventListener("click", function() {
                var file = document.getElementById("excelFile").files[0];
                var latI = parseInt(document.getElementById("latColumn").value);
                var lonI = parseInt(document.getElementById("lonColumn").value);
                var lblI = parseInt(document.getElementById("labelColumn").value);

                if (file && !isNaN(latI) && !isNaN(lonI)) {
                    var reader = new FileReader();
                    reader.onload = function(e) {
                        var data = new Uint8Array(e.target.result);
                        var wb = XLSX.read(data, { type: 'array' });
                        var json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header: 1 });
                        var headers = json[0];

                        // Create New Layer Logic from Page 2
                        var layerName = "Excel: " + file.name;
                        createNewDrawingLayer(layerName);
                        var pts = [];

                        for (var i = 1; i < json.length; i++) {
                            var row = json[i];
                            var lat = parseFloat(row[latI]);
                            var lon = parseFloat(row[lonI]);

                            if (!isNaN(lat) && !isNaN(lon)) {
                                var point = new Point({
                                    latitude: lat,
                                    longitude: lon,
                                    spatialReference: new SpatialReference({ wkid: 4326 })
                                });
                                var attributes = {};
                                headers.forEach((h, idx) => attributes[h] = row[idx]);
                                attributes.color = "#ff0000";
                                attributes.LayerName = layerName;
                                attributes.description = !isNaN(lblI) ? row[lblI] : "Point " + i;

                                var graphic = new Graphic({
                                    geometry: point,
                                    symbol: new SimpleMarkerSymbol({ color: "red", size: "10px", outline: { color: "white", width: 1 } }),
                                    attributes: attributes
                                });
                                handleGraphicCreation(graphic, false);
                                pts.push(graphic);
                            }
                        }
                        activeDrawingLayer.addMany(pts);
                        if (pts.length > 0) view.goTo(pts);
                        updateLayerList();
                        closePanel('importDataPanel'); 
                        alert("Imported " + pts.length + " points.");
                    };
                    reader.readAsArrayBuffer(file);
                } else {
                    alert("Please select Lat/Lon columns.");
                }
            });

            document.getElementById("mgrsExcelFile").addEventListener("change", function(e) {
                var file = e.target.files[0];
                if (file) {
                    var reader = new FileReader();
                    reader.onload = function(e) {
                        var data = new Uint8Array(e.target.result);
                        var wb = XLSX.read(data, { type: 'array' });
                        var json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header: 1 });
                        if (json.length > 0) {
                            var headers = json[0];
                            ['mgrsColumn', 'mgrsLabelColumn'].forEach(id => {
                                var sel = document.getElementById(id);
                                sel.innerHTML = '<option value="">Select Column</option>';
                                headers.forEach((h, i) => { 
                                    var op = document.createElement('option'); 
                                    op.value = i; 
                                    op.textContent = h; 
                                    sel.appendChild(op); 
                                });
                            });
                            document.getElementById("importMgrsExcelBtn").disabled = false;
                        }
                    };
                    reader.readAsArrayBuffer(file);
                }
            });

            document.getElementById("importMgrsExcelBtn").addEventListener("click", function() {
                var file = document.getElementById("mgrsExcelFile").files[0];
                var mgrsI = parseInt(document.getElementById("mgrsColumn").value);
                var lblI = parseInt(document.getElementById("mgrsLabelColumn").value);

                if (file && !isNaN(mgrsI)) {
                    var reader = new FileReader();
                    reader.onload = function(e) {
                        var data = new Uint8Array(e.target.result);
                        var wb = XLSX.read(data, { type: 'array' });
                        var json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header: 1 });
                        var headers = json[0];

                        // Create New Layer Logic from Page 2
                        var layerName = "MGRS: " + file.name;
                        createNewDrawingLayer(layerName);
                        var pts = [];

                        for (var i = 1; i < json.length; i++) {
                            var row = json[i];
                            var mgrsString = row[mgrsI];
                            if (mgrsString) {
                                try {
                                    var point = coordinateFormatter.fromMgrs(mgrsString.toString().trim(), new SpatialReference({ wkid: 4326 }), "automatic");
                                    if (point) {
                                        var attributes = {};
                                        headers.forEach((h, idx) => attributes[h] = row[idx]);
                                        attributes.color = "#008000";
                                        attributes.LayerName = layerName;
                                        attributes.description = !isNaN(lblI) ? row[lblI] : "Point " + i;

                                        var graphic = new Graphic({
                                            geometry: point,
                                            symbol: new SimpleMarkerSymbol({ color: "green", size: "10px", outline: { color: "white", width: 1 } }),
                                            attributes: attributes
                                        });
                                        handleGraphicCreation(graphic, false);
                                        pts.push(graphic);
                                    }
                                } catch (err) {}
                            }
                        }
                        activeDrawingLayer.addMany(pts);
                        if (pts.length > 0) view.goTo(pts);
                        updateLayerList();
                        closePanel('importDataPanel'); 
                        alert("Imported " + pts.length + " MGRS points.");
                    };
                    reader.readAsArrayBuffer(file);
                } else {
                    alert("Please select MGRS column.");
                }
            });

            // --- ADD SERVICE HANDLER (IMPROVED - From Page 2) ---
            document.getElementById("btnAddService").addEventListener("click", function() {
                var url = document.getElementById("serviceUrl").value.trim();
                var type = document.getElementById("serviceType").value;
                var layer;

                if (url) {
                    try {
                        if (type === "wms") layer = new WMSLayer({ url: url, customParameters: { transparent: true } });
                        else if (type === "feature") layer = new FeatureLayer({ url: url, outFields: ["*"], popupTemplate: { title: "{*}", content: "{*}", actions: [copyToDrawAction] } });
                        else if (type === "map-image") layer = new MapImageLayer({ url: url });
                        else if (type === "tile") layer = new TileLayer({ url: url });

                        if (layer) {
                            map.add(layer);
                            updateLayerList();
                            closePanel('addServicePanel');
                        }
                    } catch (err) {
                        alert("Error adding service: " + err.message);
                    }
                } else {
                    alert("Please enter a Service URL.");
                }
            });

            // --- TRACK LOCATION (Original) ---
            var track = new Track({ view: view, graphic: new Graphic({ symbol: { type: "simple-marker", size: "14px", color: "blue", outline: { color: "white", width: 2 } } }), useHeadingEnabled: false });
            track.on("track", function(trackEvent) {
                view.goTo({ target: trackEvent.position, zoom: 18 });
                var geom = trackEvent.position.geometry;
                var geographic = webMercatorUtils.webMercatorToGeographic(geom);
                var mgrs = ""; try { mgrs = coordinateFormatter.toMgrs(geographic, "automatic", 5); } catch(e) {}
                var labelText = `Lat: ${geographic.latitude.toFixed(5)}\nLon: ${geographic.longitude.toFixed(5)}\nMGRS: ${mgrs}`;
                var textGraphic = new Graphic({ geometry: geom, symbol: { type: "text", color: "black", haloColor: "white", haloSize: "2px", text: labelText, xoffset: 0, yoffset: -25, font: { size: 10, weight: "bold" } } });
                locationLabelLayer.removeAll(); locationLabelLayer.add(textGraphic);
            });

            document.getElementById("locationBtn").addEventListener("click", function() {
                if (!track.tracking) { track.start(); this.classList.add("tool-active"); } 
                else { track.stop(); this.classList.remove("tool-active"); locationLabelLayer.removeAll(); }
            });
            
            view.when(() => { document.querySelectorAll('.panel, .draw-tools, .excel-import-panel').forEach(p => p.style.display = 'none'); });
        });
    </script>
</body>
</html>
