<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Floor Area Ratio Web App</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <style>
    html, body, #mapDiv {
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
    }
    #controlPanel {
      position: absolute;
      top: 20px;
      right: 20px;
      padding: 15px;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      max-width: 350px;
      z-index: 1000;
      max-height: 80vh;
      overflow-y: auto;
    }
    #layerPanel {
      position: absolute;
      top: 20px;
      left: 20px;
      padding: 15px;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      max-width: 300px;
      z-index: 1000;
    }
    #processingConfigPanel {
      position: absolute;
      bottom: 20px;
      left: 20px;
      padding: 15px;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      max-width: 300px;
      z-index: 1000;
    }
    .button {
      margin-top: 10px;
      padding: 8px 12px;
      background-color: #0079c1;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      width: 100%;
    }
    .button:hover {
      background-color: #005e95;
    }
    .button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    .file-input-container {
      margin-bottom: 10px;
    }
    .field-selector {
      margin-top: 10px;
      width: 100%;
    }
    .result-info {
      margin-top: 15px;
      padding: 10px;
      background-color: #f8f8f8;
      border-radius: 4px;
      font-size: 14px;
    }
    .loading {
      display: none;
      margin-top: 15px;
      text-align: center;
    }
    .progress-container {
      width: 100%;
      background-color: #f3f3f3;
      margin-top: 5px;
      border-radius: 4px;
      overflow: hidden;
    }
    .progress-bar {
      height: 10px;
      background-color: #0079c1;
      width: 0%;
      transition: width 0.3s;
    }
    .layer-item {
      margin-bottom: 8px;
      display: flex;
      align-items: center;
    }
    .layer-toggle {
      margin-right: 8px;
    }
    .layer-label {
      font-size: 14px;
      cursor: pointer;
    }
    .attribute-table {
      margin-top: 15px;
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    .attribute-table th, .attribute-table td {
      border: 1px solid #ddd;
      padding: 6px;
      text-align: left;
    }
    .attribute-table th {
      background-color: #f2f2f2;
    }
    .attribute-panel {
      margin-top: 15px;
      padding: 8px;
      background-color: #f8f8f8;
      border-radius: 4px;
      max-height: 300px;
      overflow-y: auto;
    }
    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .panel-title {
      font-weight: bold;
      margin: 0;
    }
    hr {
      margin: 15px 0;
      border: 0;
      border-top: 1px solid #ddd;
    }
    .info-popup {
      max-height: 200px;
      overflow-y: auto;
    }
    .crs-selector {
      margin-top: 10px;
      margin-bottom: 5px;
    }
    .export-options {
      display: flex;
      justify-content: space-between;
      gap: 10px;
    }
    .export-button {
      flex: 1;
    }
    .home-button {
      position: absolute;
      top: 15px;
      right: 15px;
      z-index: 1001;
    }
    .home-button a {
      display: block;
      padding: 8px;
      color: #0079c1;
      background-color: white;
      border-radius: 50%;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      text-decoration: none;
      text-align: center;
    }
    .home-button a:hover {
      background-color: #f0f0f0;
    }
    .home-button i {
      font-size: 18px;
    }
    .config-item {
      margin-bottom: 10px;
    }
    .config-label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    .log-container {
      background-color: #f8f8f8;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 10px;
      max-height: 200px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 12px;
      margin-top: 10px;
    }
    .log-entry {
      margin-bottom: 4px;
      word-wrap: break-word;
    }
    .log-info {
      color: #0079c1;
    }
    .log-warning {
      color: #ff9800;
    }
    .log-error {
      color: #f44336;
    }
    .toggle-label {
      display: flex;
      align-items: center;
      cursor: pointer;
    }
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 40px;
      height: 20px;
      margin-right: 8px;
    }
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 20px;
    }
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 2px;
      bottom: 2px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    input:checked + .toggle-slider {
      background-color: #0079c1;
    }
    input:checked + .toggle-slider:before {
      transform: translateX(20px);
    }
  </style>
</head>
<body>
  <div id="mapDiv"></div>
  
  <!-- Main Control Panel -->
  <div id="controlPanel">
    <div class="panel-header">
      <h2 class="panel-title">Floor Area Ratio Web App</h2>
      <div class="home-button">
        <a href="page11.html" title="Back to Main Page">
          <i class="fas fa-home"></i>
        </a>
      </div>
    </div>
    
    <div class="crs-selector">
      <label for="coordSystem">Coordinate Reference System:</label>
      <select id="coordSystem" class="field-selector">
        <option value="EPSG:4326">EPSG:4326 (WGS84)</option>
        <option value="EPSG:32647">EPSG:32647 (UTM Zone 47N)</option>
        <option value="EPSG:32648">EPSG:32648 (UTM Zone 48N)</option>
      </select>
    </div>
    
    <div class="file-input-container">
      <label for="buildingFile">1. Upload Building GeoJSON:</label>
      <input type="file" id="buildingFile" accept=".geojson,.json">
      <div id="buildingStatus"></div>
    </div>
    
    <div class="file-input-container">
      <label for="parcelFile">2. Upload Land Parcel GeoJSON:</label>
      <input type="file" id="parcelFile" accept=".geojson,.json">
      <div id="parcelStatus"></div>
    </div>
    
    <div id="fieldSelectorContainer" style="display:none;">
      <label for="parcelFieldSelector">Select Parcel Identifier Field:</label>
      <select id="parcelFieldSelector" class="field-selector"></select>
    </div>
    
    <button id="processStep1" class="button" disabled>3.1 Calculate Parcel Area</button>
    <div id="step1Result" class="result-info" style="display:none;"></div>
    
    <button id="processStep2" class="button" disabled>3.2 Extract Parcel Information</button>
    <div id="step2Result" class="result-info" style="display:none;"></div>
    
    <button id="processStep3" class="button" disabled>3.3 Calculate Total Building Area</button>
    <div id="step3Result" class="result-info" style="display:none;"></div>
    
    <button id="processStep4" class="button" disabled>3.4 Calculate FAR</button>
    <div id="step4Result" class="result-info" style="display:none;"></div>
    
    <div class="export-options">
      <button id="exportButton" class="button export-button" disabled>4.1 Export as GeoJSON</button>
      <button id="exportExcelButton" class="button export-button" disabled>4.2 Export as Excel</button>
    </div>
    
    <div id="loadingIndicator" class="loading">
      <i class="fas fa-cog fa-spin"></i> Processing...<span id="processingStatus"></span>
      <div class="progress-container">
        <div id="progressBar" class="progress-bar"></div>
      </div>
    </div>
    
    <hr>
    
    <!-- Attribute Viewer Section -->
    <div class="panel-header">
      <h3 class="panel-title">Attribute Viewer</h3>
    </div>
    
    <div>
      <label for="layerSelect">Select Layer for Attributes:</label>
      <select id="layerSelect" class="field-selector">
        <option value="">-- Select a layer --</option>
      </select>
    </div>
    
    <div id="attributePanel" class="attribute-panel" style="display:none;">
      <div id="attributeContent"></div>
    </div>
  </div>
  
  <!-- Layer Control Panel -->
  <div id="layerPanel">
    <div class="panel-header">
      <h3 class="panel-title">Map Layers</h3>
    </div>
    <div id="layerList">
      <!-- Layer toggles will be added here dynamically -->
      <div class="layer-item">
        <span class="layer-label">No layers available</span>
      </div>
    </div>
  </div>
  
  <!-- Processing Configuration Panel -->
  <div id="processingConfigPanel">
    <div class="panel-header">
      <h3 class="panel-title">Processing Settings</h3>
      <button id="toggleLogButton" class="button" style="width: auto; padding: 4px 8px; margin: 0;">
        <i class="fas fa-list"></i>
      </button>
    </div>
    
    <div class="config-item">
      <label class="toggle-label">
        <span class="toggle-switch">
          <input type="checkbox" id="useWebWorkers" checked>
          <span class="toggle-slider"></span>
        </span>
        Use Web Workers
      </label>
    </div>
    
    <div class="config-item">
      <label for="batchSize" class="config-label">Batch Size:</label>
      <input type="number" id="batchSize" min="10" max="500" value="100" class="field-selector">
    </div>
    
    <div class="config-item">
      <label for="processingDelay" class="config-label">Processing Delay (ms):</label>
      <input type="number" id="processingDelay" min="0" max="1000" value="10" class="field-selector">
      <small>Delay between batches to allow UI updates</small>
    </div>
    
    <div class="config-item">
      <button id="runAllSteps" class="button">Run All Steps</button>
    </div>
    
    <div id="logContainer" class="log-container" style="display: none;">
      <div id="logContent"></div>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
  <!-- Turf.js for geometry operations -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Turf.js/6.5.0/turf.min.js"></script>
  <!-- Proj4js for coordinate transformations -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js"></script>
  <!-- Proj4Leaflet for CRS handling in Leaflet -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4leaflet/1.0.2/proj4leaflet.min.js"></script>
  <!-- Esri Leaflet for ESRI basemaps -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/esri-leaflet/3.0.10/esri-leaflet.js"></script>
  <!-- SheetJS (XLSX) for Excel export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
  <!-- Web Worker Script (Created dynamically) -->
  <script id="workerScript" type="text/worker-script">
    // Import libraries via importScripts
    importScripts('https://cdnjs.cloudflare.com/ajax/libs/Turf.js/6.5.0/turf.min.js');
    importScripts('https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js');
    
    // Define UTM zone projections
    proj4.defs("EPSG:32647", "+proj=utm +zone=47 +datum=WGS84 +units=m +no_defs");
    proj4.defs("EPSG:32648", "+proj=utm +zone=48 +datum=WGS84 +units=m +no_defs");
    
    // Function to transform coordinates between CRS
    function transformCoords(coords, fromCRS, toCRS) {
      if (fromCRS === toCRS) {
        return coords;
      }
      return proj4(fromCRS, toCRS, coords);
    }
    
    // Shoelace formula for calculating polygon area
    function polygonArea(coords) {
      let area = 0;
      const numPoints = coords.length;
      
      if (numPoints < 3) {
        return 0;
      }
      
      for (let i = 0; i < numPoints - 1; i++) {
        area += coords[i][0] * coords[i+1][1] - coords[i+1][0] * coords[i][1];
      }
      
      // Close the polygon
      area += coords[numPoints-1][0] * coords[0][1] - coords[0][0] * coords[numPoints-1][1];
      
      // Return absolute value of area
      return Math.abs(area / 2);
    }
    
    // Function to calculate area in UTM coordinates
    function calculateAreaUTM(geometry, crs) {
      // For UTM coordinates, we can calculate area directly
      let area = 0;
      
      if (geometry.type === 'Polygon') {
        // Calculate polygon area using Shoelace formula (Gauss's Area formula)
        area = polygonArea(geometry.coordinates[0]);
      } else if (geometry.type === 'MultiPolygon') {
        // Calculate area for each polygon and sum them
        for (const polygon of geometry.coordinates) {
          area += polygonArea(polygon[0]); // Outer ring
          
          // Subtract area of inner rings (holes)
          for (let i = 1; i < polygon.length; i++) {
            area -= polygonArea(polygon[i]);
          }
        }
      }
      
      return Math.abs(area); // Ensure positive area
    }
    
    // Function to calculate centroid of a polygon
    function calculateCentroid(coords) {
      let sumX = 0;
      let sumY = 0;
      
      for (let i = 0; i < coords.length; i++) {
        sumX += coords[i][0];
        sumY += coords[i][1];
      }
      
      return [sumX / coords.length, sumY / coords.length];
    }
    
    // Process batches of parcel areas for step 1
    function processParcelAreaBatch(batchData) {
      const { 
        parcelBatch, 
        selectedCRS, 
        startIndex, 
        endIndex
      } = batchData;
      
      const processedParcels = [];
      
      for (let i = 0; i < parcelBatch.length; i++) {
        try {
          const parcel = parcelBatch[i];
          const parcelIndex = startIndex + i;
          
          // Log progress
          self.postMessage({
            type: 'progress',
            message: `Processing parcel ${parcelIndex + 1}/${endIndex}`,
            index: parcelIndex,
            total: endIndex
          });
          
          let area;
          
          // Calculate area using appropriate method based on CRS
          if (selectedCRS === 'EPSG:4326') {
            // For WGS84, use Turf.js area calculation (uses Haversine)
            area = turf.area(parcel);
          } else {
            // For UTM, use native area calculation (much more accurate for projected coordinates)
            area = calculateAreaUTM(parcel.geometry, selectedCRS);
          }
          
          self.postMessage({
            type: 'log',
            level: 'info',
            message: `Parcel ${parcelIndex}: Area = ${area.toFixed(2)} sq.m`
          });
          
          // Create feature with calculated area
          const processedParcel = {
            type: "Feature",
            properties: {
              ...parcel.properties,
              parcelArea: Math.round(area * 100) / 100
            },
            geometry: parcel.geometry
          };
          
          processedParcels.push(processedParcel);
        } catch (error) {
          self.postMessage({
            type: 'log',
            level: 'error',
            message: `Error processing parcel ${startIndex + i}: ${error.message}`
          });
        }
      }
      
      return processedParcels;
    }
    
    // Process building points batch for step 2
    function processBuildingPointsBatch(batchData) {
      const {
        buildingBatch,
        parcelGeojson,
        selectedField,
        startIndex,
        endIndex
      } = batchData;
      
      const buildingPoints = [];
      let errorCount = 0;
      let successCount = 0;
      
      for (let i = 0; i < buildingBatch.length; i++) {
        try {
          const building = buildingBatch[i];
          const buildingIndex = startIndex + i;
          
          // Log progress
          self.postMessage({
            type: 'progress',
            message: `Processing building ${buildingIndex + 1}/${endIndex}`,
            index: buildingIndex,
            total: endIndex
          });
          
          // Get coordinates of building center
          let centerCoords;
          
          if (building.geometry.type === "Polygon") {
            // Calculate centroid using turf.js
            const centroid = turf.centroid(building);
            centerCoords = centroid.geometry.coordinates;
          } else if (building.geometry.type === "MultiPolygon") {
            // For multipolygon, use the first polygon's centroid
            const firstPolygon = {
              type: "Feature",
              properties: {},
              geometry: {
                type: "Polygon",
                coordinates: building.geometry.coordinates[0]
              }
            };
            const centroid = turf.centroid(firstPolygon);
            centerCoords = centroid.geometry.coordinates;
          } else {
            throw new Error(`Unsupported geometry type: ${building.geometry.type}`);
          }
          
          // Create a point feature
          const pointFeature = {
            type: "Feature",
            properties: {
              ...building.properties,
              parcelId: null,
              parcelName: null,
              buildingArea: typeof building.properties.BL_AREA === 'number' ? building.properties.BL_AREA : 0,
              buildingStoreys: typeof building.properties.BL_NSTOREY === 'number' ? building.properties.BL_NSTOREY : 1
            },
            geometry: {
              type: "Point",
              coordinates: centerCoords
            }
          };
          
          // Find which parcel this building belongs to
          for (const parcel of parcelGeojson.features) {
            // Check if point is within the parcel
            if (turf.booleanPointInPolygon(pointFeature.geometry.coordinates, parcel.geometry)) {
              // Add parcel information to the building point
              pointFeature.properties.parcelId = parcel.properties[selectedField];
              pointFeature.properties.parcelName = parcel.properties[selectedField];
              break;
            }
          }
          
          buildingPoints.push(pointFeature);
          successCount++;
        } catch (error) {
          self.postMessage({
            type: 'log',
            level: 'warning',
            message: `Error creating point for building ${startIndex + i}: ${error.message}`
          });
          errorCount++;
        }
      }
      
      self.postMessage({
        type: 'log',
        level: 'info',
        message: `Batch processed. Success: ${successCount}, Failed: ${errorCount}`
      });
      
      return buildingPoints;
    }
    
    // Process building areas by parcel for step 3
    function processBuildingAreasBatch(batchData) {
      const {
        parcelBatch,
        buildingGeojson,
        selectedField,
        startIndex,
        endIndex,
        parcelAreaResults
      } = batchData;
      
      const processedParcels = [];
      
      for (let i = 0; i < parcelBatch.length; i++) {
        try {
          const parcel = parcelBatch[i];
          const parcelIndex = startIndex + i;
          
          // Log progress
          self.postMessage({
            type: 'progress',
            message: `Processing parcel ${parcelIndex + 1}/${endIndex}`,
            index: parcelIndex,
            total: endIndex
          });
          
          const parcelId = parcel.properties[selectedField];
          let totalBuildingArea = 0;
          let buildingCount = 0;
          let buildingList = [];
          
          // Find all buildings within this parcel
          for (let j = 0; j < buildingGeojson.features.length; j++) {
            const building = buildingGeojson.features[j];
            
            try {
              // Get building center
              let center;
              
              if (building.geometry.type === "Polygon") {
                const centroid = turf.centroid(building);
                center = centroid.geometry.coordinates;
              } else if (building.geometry.type === "MultiPolygon") {
                const firstPolygon = {
                  type: "Feature",
                  properties: {},
                  geometry: {
                    type: "Polygon",
                    coordinates: building.geometry.coordinates[0]
                  }
                };
                const centroid = turf.centroid(firstPolygon);
                center = centroid.geometry.coordinates;
              } else {
                continue; // Skip this building due to unsupported geometry
              }
              
              // Check if this building is within the parcel
              if (turf.booleanPointInPolygon(center, parcel.geometry)) {
                // Get building properties with proper validation
                let area = 0;
                let storeys = 1;
                
                if (typeof building.properties.BL_AREA === 'number') {
                  area = building.properties.BL_AREA;
                } else if (typeof building.properties.BL_AREA === 'string') {
                  area = parseFloat(building.properties.BL_AREA) || 0;
                }
                
                if (typeof building.properties.BL_NSTOREY === 'number') {
                  storeys = building.properties.BL_NSTOREY;
                } else if (typeof building.properties.BL_NSTOREY === 'string') {
                  storeys = parseInt(building.properties.BL_NSTOREY) || 1;
                }
                
                // Make sure we have valid values (not NaN, not negative)
                area = isNaN(area) || area < 0 ? 0 : area;
                storeys = isNaN(storeys) || storeys < 1 ? 1 : storeys;
                
                const buildingTotalArea = area * storeys;
                
                // Add to totals
                totalBuildingArea += buildingTotalArea;
                buildingCount++;
                
                // Add to building details
                buildingList.push({
                  id: j,
                  area: area,
                  storeys: storeys,
                  totalArea: buildingTotalArea
                });
              }
            } catch (error) {
              self.postMessage({
                type: 'log',
                level: 'warning', 
                message: `Error processing building ${j} for parcel ${parcelIndex}: ${error.message}`
              });
            }
          }
          
          // Round to 2 decimal places for display
          totalBuildingArea = Math.round(totalBuildingArea * 100) / 100;
          
          // Find parcel area from step 1 results
          let parcelArea = 0;
          
          if (parcelAreaResults && parcelAreaResults.features) {
            const parcelAreaFeature = parcelAreaResults.features.find(f => 
              f.properties[selectedField] === parcelId
            );
            
            if (parcelAreaFeature) {
              parcelArea = parcelAreaFeature.properties.parcelArea || 0;
            }
          }
          
          // Create calculation details string
          let calculationDetails = "Buildings calculation details:\n";
          buildingList.forEach(building => {
            calculationDetails += `Building ${building.id}: ${building.area} sq.m × ${building.storeys} floors = ${building.totalArea} sq.m\n`;
          });
          
          if (buildingList.length === 0) {
            calculationDetails = "No buildings found in this parcel";
          }
          
          // Create processed parcel with all the data
          const processedParcel = {
            type: "Feature",
            properties: {
              ...parcel.properties,
              totalBuildingArea: totalBuildingArea,
              buildingCount: buildingCount,
              parcelArea: parcelArea,
              calculationDetails: calculationDetails
            },
            geometry: parcel.geometry
          };
          
          processedParcels.push(processedParcel);
        } catch (error) {
          self.postMessage({
            type: 'log',
            level: 'error',
            message: `Error processing parcel ${startIndex + i} for building areas: ${error.message}`
          });
        }
      }
      
      return processedParcels;
    }
    
    // Calculate FAR for parcels in step 4
    function calculateFARBatch(batchData) {
      const {
        parcelBatch,
        startIndex,
        endIndex
      } = batchData;
      
      const processedParcels = [];
      
      for (let i = 0; i < parcelBatch.length; i++) {
        try {
          const parcel = parcelBatch[i];
          const parcelIndex = startIndex + i;
          
          // Log progress
          self.postMessage({
            type: 'progress',
            message: `Calculating FAR for parcel ${parcelIndex + 1}/${endIndex}`,
            index: parcelIndex,
            total: endIndex
          });
          
          const totalBuildingArea = parcel.properties.totalBuildingArea || 0;
          const parcelArea = parcel.properties.parcelArea || 0;
          
          // Calculate FAR as per the formula: totalBuildingArea / parcelArea
          let far = 0;
          if (parcelArea > 0) {
            far = totalBuildingArea / parcelArea;
          }
          
          // Round values for display
          far = Math.round(far * 1000) / 1000;
          
          // Create processed parcel with FAR
          const processedParcel = {
            type: "Feature",
            properties: {
              ...parcel.properties,
              FAR: far
            },
            geometry: parcel.geometry
          };
          
          processedParcels.push(processedParcel);
        } catch (error) {
          self.postMessage({
            type: 'log',
            level: 'error',
            message: `Error calculating FAR for parcel ${startIndex + i}: ${error.message}`
          });
        }
      }
      
      return processedParcels;
    }
    
    // Ray casting algorithm for point in polygon test
    function isPointInPolygon(point, polygon) {
      const x = point[0];
      const y = point[1];
      
      let inside = false;
      for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
        const xi = polygon[i][0];
        const yi = polygon[i][1];
        const xj = polygon[j][0];
        const yj = polygon[j][1];
        
        const intersect = ((yi > y) !== (yj > y)) && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
        if (intersect) inside = !inside;
      }
      
      return inside;
    }
    
    // Function to check if a point is inside a polygon
    function pointInPolygon(point, polygon) {
      try {
        if (polygon.type === "Polygon") {
          return isPointInPolygon(point, polygon.coordinates[0]);
        } else if (polygon.type === "MultiPolygon") {
          // Check each polygon
          for (const poly of polygon.coordinates) {
            if (isPointInPolygon(point, poly[0])) {
              return true;
            }
          }
        }
        return false;
      } catch (e) {
        self.postMessage({
          type: 'log',
          level: 'warning',
          message: `Error in pointInPolygon: ${e.message}`
        });
        return false;
      }
    }
    
    // Listen for messages from the main thread
    self.onmessage = function(e) {
      const data = e.data;
      
      try {
        if (data.command === 'processParcelArea') {
          const result = processParcelAreaBatch(data);
          self.postMessage({
            type: 'result',
            features: result,
            batchIndex: data.batchIndex,
            totalBatches: data.totalBatches
          });
        }
        else if (data.command === 'processBuildingPoints') {
          const result = processBuildingPointsBatch(data);
          self.postMessage({
            type: 'result',
            features: result,
            batchIndex: data.batchIndex,
            totalBatches: data.totalBatches
          });
        }
        else if (data.command === 'processBuildingAreas') {
          const result = processBuildingAreasBatch(data);
          self.postMessage({
            type: 'result',
            features: result,
            batchIndex: data.batchIndex,
            totalBatches: data.totalBatches
          });
        }
        else if (data.command === 'calculateFAR') {
          const result = calculateFARBatch(data);
          self.postMessage({
            type: 'result',
            features: result,
            batchIndex: data.batchIndex,
            totalBatches: data.totalBatches
          });
        }
      } catch (error) {
        self.postMessage({
          type: 'error',
          message: error.message
        });
      }
    };
  </script>
  
  <script>
const _0x5307db=_0x4de3;(function(_0x2902ab,_0x4566b6){const _0x23e4b8=_0x4de3,_0x58fc76=_0x2902ab();while(!![]){try{const _0x282ab3=parseInt(_0x23e4b8(0x1a7))/0x1*(-parseInt(_0x23e4b8(0x165))/0x2)+parseInt(_0x23e4b8(0x119))/0x3+parseInt(_0x23e4b8(0xe5))/0x4*(parseInt(_0x23e4b8(0x177))/0x5)+-parseInt(_0x23e4b8(0x89))/0x6+-parseInt(_0x23e4b8(0x14a))/0x7*(parseInt(_0x23e4b8(0x155))/0x8)+-parseInt(_0x23e4b8(0x9d))/0x9*(parseInt(_0x23e4b8(0x8f))/0xa)+-parseInt(_0x23e4b8(0xeb))/0xb*(-parseInt(_0x23e4b8(0xaf))/0xc);if(_0x282ab3===_0x4566b6)break;else _0x58fc76['push'](_0x58fc76['shift']());}catch(_0x1424e0){_0x58fc76['push'](_0x58fc76['shift']());}}}(_0x3a88,0x56f5e));let map,buildingLayer,parcelLayer,resultLayer,buildingGeojson,parcelGeojson,resultGeojson,parcelFields=[],currentCRS=_0x5307db(0xfd),parcelOriginalShapes=null,basemapLayer,allLayers=[],layerData={},isProcessing=![],processFlags={'step1':![],'step2':![],'step3':![],'step4':![]},workers=[],maxWorkers=0x4,useWebWorkers=!![];function createWorkers(){const _0x7c7e1f=_0x5307db;terminateWorkers();if(window[_0x7c7e1f(0x125)]&&document[_0x7c7e1f(0x12a)]('useWebWorkers')['checked']){useWebWorkers=!![];const _0x3950a8=new Blob([document[_0x7c7e1f(0x103)](_0x7c7e1f(0x149))[_0x7c7e1f(0x12c)]],{'type':_0x7c7e1f(0xe6)}),_0x3cf7a8=URL[_0x7c7e1f(0x108)](_0x3950a8);for(let _0x5b99de=0x0;_0x5b99de<maxWorkers;_0x5b99de++){const _0x47a5d9=new Worker(_0x3cf7a8);_0x47a5d9[_0x7c7e1f(0x193)]=handleWorkerMessage,_0x47a5d9[_0x7c7e1f(0x13d)]=function(_0x595268){const _0x599b69=_0x7c7e1f;console[_0x599b69(0x107)](_0x599b69(0xe3),_0x595268),logMessage(_0x599b69(0x17c)+_0x595268[_0x599b69(0x94)],_0x599b69(0x107));},workers[_0x7c7e1f(0x109)](_0x47a5d9);}logMessage(_0x7c7e1f(0x1a4)+workers[_0x7c7e1f(0x10a)]+_0x7c7e1f(0xb6),_0x7c7e1f(0xcb));}else useWebWorkers=![],logMessage(_0x7c7e1f(0x117),_0x7c7e1f(0xcb));}function terminateWorkers(){workers['forEach'](_0x21135d=>_0x21135d['terminate']()),workers=[];}function handleWorkerMessage(_0x3069c9){const _0x1a71b1=_0x5307db,_0x4078d1=_0x3069c9['data'];if(_0x4078d1[_0x1a71b1(0x1b9)]===_0x1a71b1(0x1ca))updateProgress(_0x4078d1[_0x1a71b1(0x1c6)],_0x4078d1[_0x1a71b1(0xf0)],_0x4078d1[_0x1a71b1(0x94)]);else{if(_0x4078d1[_0x1a71b1(0x1b9)]==='log')logMessage(_0x4078d1[_0x1a71b1(0x94)],_0x4078d1[_0x1a71b1(0xca)]);else{if(_0x4078d1[_0x1a71b1(0x1b9)]==='result')processBatchResult(_0x4078d1);else _0x4078d1[_0x1a71b1(0x1b9)]==='error'&&(console['error'](_0x1a71b1(0xe3),_0x4078d1[_0x1a71b1(0x94)]),logMessage(_0x1a71b1(0x158)+_0x4078d1['message'],_0x1a71b1(0x107)),hideLoadingIndicator());}}}proj4[_0x5307db(0x18f)](_0x5307db(0x1a0),_0x5307db(0xd0)),proj4['defs'](_0x5307db(0x11d),_0x5307db(0xb2));const crs={'EPSG:4326':L['CRS'][_0x5307db(0x144)],'EPSG:32647':new L[(_0x5307db(0x1d2))][(_0x5307db(0x91))](_0x5307db(0x1a0),proj4[_0x5307db(0x18f)]('EPSG:32647'),{'resolutions':[0x100,0x80,0x40,0x20,0x10,0x8,0x4,0x2,0x1,0.5,0.25],'origin':[0x0,0x0]}),'EPSG:32648':new L[(_0x5307db(0x1d2))][(_0x5307db(0x91))]('EPSG:32648',proj4['defs'](_0x5307db(0x11d)),{'resolutions':[0x100,0x80,0x40,0x20,0x10,0x8,0x4,0x2,0x1,0.5,0.25],'origin':[0x0,0x0]})};let batchResults=[],currentBatch=0x0,totalBatches=0x0,batchSize=0x64,processingDelay=0xa,currentStep='',batchStats={'startTime':0x0,'endTime':0x0,'featureCount':0x0};function initMap(){const _0x8f5dc5=_0x5307db,_0x1bcf14=document[_0x8f5dc5(0x12a)](_0x8f5dc5(0x131))[_0x8f5dc5(0x1ab)];currentCRS=_0x1bcf14,map&&map[_0x8f5dc5(0x143)](),map=L[_0x8f5dc5(0x18e)](_0x8f5dc5(0x9c),{'crs':crs[_0x1bcf14]})['setView']([13.7,100.5],0xa),_0x1bcf14===_0x8f5dc5(0xfd)?(basemapLayer=L['esri'][_0x8f5dc5(0x16d)](_0x8f5dc5(0x154),{'detectRetina':!![]})[_0x8f5dc5(0x198)](map),L[_0x8f5dc5(0x181)][_0x8f5dc5(0x16d)](_0x8f5dc5(0x8e))[_0x8f5dc5(0x198)](map)):(basemapLayer=L['rectangle']([[-0x5a,-0xb4],[0x5a,0xb4]],{'color':'#f8f8f8','weight':0x1,'fillColor':_0x8f5dc5(0x19d),'fillOpacity':0x1})['addTo'](map),L['control'][_0x8f5dc5(0xb0)]({'prefix':_0x8f5dc5(0xbf)})['addTo'](map)),logMessage(_0x8f5dc5(0xe9)+_0x1bcf14,_0x8f5dc5(0xcb)),reloadLayers();}function reloadLayers(){const _0x5c91ef=_0x5307db;buildingLayer&&map[_0x5c91ef(0x1c0)](buildingLayer)&&map['removeLayer'](buildingLayer);parcelLayer&&map[_0x5c91ef(0x1c0)](parcelLayer)&&map[_0x5c91ef(0xe2)](parcelLayer);resultLayer&&map['hasLayer'](resultLayer)&&map[_0x5c91ef(0xe2)](resultLayer);buildingGeojson&&addGeoJSONToMap(buildingGeojson,_0x5c91ef(0xb5),_0x5c91ef(0x114));parcelGeojson&&addGeoJSONToMap(parcelGeojson,_0x5c91ef(0x147),_0x5c91ef(0x152));if(resultGeojson){let _0x37942c=_0x5c91ef(0x1bf),_0x1a3689=_0x5c91ef(0x18b);if(resultGeojson[_0x5c91ef(0x19f)][_0x5c91ef(0x10a)]>0x0){const _0x34f9e4=resultGeojson[_0x5c91ef(0x19f)][0x0]['properties'];if(_0x34f9e4['FAR']!==undefined)_0x37942c=_0x5c91ef(0x1bf),_0x1a3689='Final\x20Result\x20(FAR)';else{if(_0x34f9e4[_0x5c91ef(0xb3)]!==undefined)_0x37942c='parcelsBuildingAreas',_0x1a3689=_0x5c91ef(0xcf);else _0x34f9e4[_0x5c91ef(0x124)]!==undefined&&(_0x37942c='parcelArea',_0x1a3689=_0x5c91ef(0xb4));}}addGeoJSONToMap(resultGeojson,_0x37942c,_0x1a3689);}}function checkCRS(_0x37881c){const _0x5eddd8=_0x5307db,_0x2c2127=document[_0x5eddd8(0x12a)](_0x5eddd8(0x131))['value'];if(!_0x37881c||!_0x37881c[_0x5eddd8(0x19f)]||_0x37881c[_0x5eddd8(0x19f)][_0x5eddd8(0x10a)]===0x0)return![];const _0x425361=_0x37881c[_0x5eddd8(0x19f)][0x0];let _0x15aaf4=[];if(_0x425361[_0x5eddd8(0x199)][_0x5eddd8(0x1b9)]===_0x5eddd8(0xa2))_0x15aaf4=_0x425361['geometry'][_0x5eddd8(0x1d7)];else{if(_0x425361[_0x5eddd8(0x199)][_0x5eddd8(0x1b9)]===_0x5eddd8(0x11c)||_0x425361[_0x5eddd8(0x199)][_0x5eddd8(0x1b9)]===_0x5eddd8(0x14f))_0x15aaf4=_0x425361['geometry'][_0x5eddd8(0x1d7)][0x0];else{if(_0x425361[_0x5eddd8(0x199)]['type']==='Polygon'||_0x425361[_0x5eddd8(0x199)]['type']===_0x5eddd8(0x97))_0x15aaf4=_0x425361[_0x5eddd8(0x199)][_0x5eddd8(0x1d7)][0x0][0x0];else _0x425361['geometry'][_0x5eddd8(0x1b9)]===_0x5eddd8(0x136)&&(_0x15aaf4=_0x425361[_0x5eddd8(0x199)]['coordinates'][0x0][0x0][0x0]);}}if(_0x15aaf4[_0x5eddd8(0x10a)]<0x2)return![];const _0x5a97e2=_0x15aaf4[0x0],_0x51f4d1=_0x15aaf4[0x1];return _0x2c2127===_0x5eddd8(0xfd)?_0x5a97e2>=-0xb4&&_0x5a97e2<=0xb4&&_0x51f4d1>=-0x5a&&_0x51f4d1<=0x5a:_0x5a97e2>0x186a0&&_0x51f4d1>0x186a0;}function addGeoJSONToMap(_0x267e31,_0x2b4d72,_0x10b6c8){const _0x56eaeb=_0x5307db,_0x3a77cc=document['getElementById'](_0x56eaeb(0x131))[_0x56eaeb(0x1ab)];let _0x158d8a=JSON[_0x56eaeb(0x1d1)](JSON['stringify'](_0x267e31));const _0x1f34f3={'color':_0x2b4d72===_0x56eaeb(0xb5)?_0x56eaeb(0x87):_0x56eaeb(0x1aa),'weight':0x1,'opacity':0x1,'fillOpacity':0.5};if(_0x2b4d72==='parcelArea')_0x1f34f3[_0x56eaeb(0x19b)]=_0x56eaeb(0x15e);else{if(_0x2b4d72==='parcelsBuildingAreas')_0x1f34f3[_0x56eaeb(0x19b)]=_0x56eaeb(0x15e);else _0x2b4d72===_0x56eaeb(0x1bf)&&(_0x1f34f3[_0x56eaeb(0x19b)]=_0x56eaeb(0x15e));}let _0x484991;if(_0x2b4d72===_0x56eaeb(0x1bf)){function _0xefae76(_0x4798bb){const _0x334c0f=_0x56eaeb;return _0x4798bb<0.5?_0x334c0f(0x1aa):_0x4798bb<0x1?_0x334c0f(0x12e):_0x4798bb<0x2?_0x334c0f(0x129):_0x334c0f(0x87);}_0x484991=L[_0x56eaeb(0x180)](_0x158d8a,{'coordsToLatLng':function(_0x2730dc){const _0x333c5f=_0x56eaeb;if(_0x3a77cc!=='EPSG:4326'){const _0x3f7652=proj4(_0x3a77cc,_0x333c5f(0xfd),_0x2730dc);return new L[(_0x333c5f(0x18a))](_0x3f7652[0x1],_0x3f7652[0x0]);}return new L[(_0x333c5f(0x18a))](_0x2730dc[0x1],_0x2730dc[0x0]);},'style':function(_0x1f2623){const _0xdc0d47=_0x56eaeb;return{'fillColor':_0xefae76(_0x1f2623['properties'][_0xdc0d47(0x17e)]),'weight':0x1,'opacity':0x1,'color':_0xdc0d47(0x15e),'fillOpacity':0.7};},'onEachFeature':function(_0x46678b,_0x4e2446){const _0x35db21=_0x56eaeb,_0x2b925a=document[_0x35db21(0x12a)]('parcelFieldSelector')[_0x35db21(0x1ab)]||'ID',_0x2c3270='\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22info-popup\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<strong>'+_0x2b925a+_0x35db21(0x1a3)+_0x46678b[_0x35db21(0x174)][_0x2b925a]+'<br>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<strong>Parcel\x20Area:</strong>\x20'+_0x46678b[_0x35db21(0x174)][_0x35db21(0x124)]+_0x35db21(0x17b)+_0x46678b[_0x35db21(0x174)][_0x35db21(0xb3)]+'\x20sq.m<br>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<strong>FAR:</strong>\x20'+_0x46678b['properties'][_0x35db21(0x17e)]+_0x35db21(0x166)+(_0x46678b['properties'][_0x35db21(0x1d0)]||0x0)+_0x35db21(0x175)+(_0x46678b['properties'][_0x35db21(0x11f)]?_0x35db21(0xc1)+_0x46678b[_0x35db21(0x174)][_0x35db21(0x11f)]+_0x35db21(0x19e):'')+_0x35db21(0x189);_0x4e2446['bindPopup'](_0x2c3270);}})[_0x56eaeb(0x198)](map);}else{if(_0x2b4d72===_0x56eaeb(0x10e)){function _0x14550a(_0x37ca32){const _0x4939b0=_0x56eaeb;return _0x37ca32<0x3e8?'#ffff00':_0x37ca32<0x1388?'#ffaa00':_0x37ca32<0x2710?_0x4939b0(0x1b5):_0x4939b0(0x87);}_0x484991=L['geoJSON'](_0x158d8a,{'coordsToLatLng':function(_0x37ee7d){const _0x44e837=_0x56eaeb;if(_0x3a77cc!==_0x44e837(0xfd)){const _0x1aa3b0=proj4(_0x3a77cc,_0x44e837(0xfd),_0x37ee7d);return new L[(_0x44e837(0x18a))](_0x1aa3b0[0x1],_0x1aa3b0[0x0]);}return new L[(_0x44e837(0x18a))](_0x37ee7d[0x1],_0x37ee7d[0x0]);},'style':function(_0x5b387f){const _0x17fe62=_0x56eaeb;return{'fillColor':_0x14550a(_0x5b387f[_0x17fe62(0x174)]['totalBuildingArea']),'weight':0x1,'opacity':0x1,'color':_0x17fe62(0x15e),'fillOpacity':0.7};},'onEachFeature':function(_0x20884d,_0x1e76ce){const _0x14e7b8=_0x56eaeb,_0x4a54ac=document['getElementById'](_0x14e7b8(0xd7))[_0x14e7b8(0x1ab)]||'ID',_0xff824a=_0x14e7b8(0x81)+_0x4a54ac+_0x14e7b8(0x1a3)+_0x20884d[_0x14e7b8(0x174)][_0x4a54ac]+_0x14e7b8(0x166)+(_0x20884d[_0x14e7b8(0x174)][_0x14e7b8(0x1d0)]||0x0)+'<br>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<strong>Total\x20Building\x20Area:</strong>\x20'+_0x20884d['properties']['totalBuildingArea']+_0x14e7b8(0x164)+(_0x20884d[_0x14e7b8(0x174)][_0x14e7b8(0x11f)]?_0x14e7b8(0xc1)+_0x20884d[_0x14e7b8(0x174)][_0x14e7b8(0x11f)]+_0x14e7b8(0x19e):'')+_0x14e7b8(0x189);_0x1e76ce[_0x14e7b8(0x1d6)](_0xff824a);}})[_0x56eaeb(0x198)](map);}else{if(_0x2b4d72==='parcelArea'){function _0x3b5589(_0x4fe143){const _0x28b9f8=_0x56eaeb;return _0x4fe143<0x1f4?_0x28b9f8(0x12e):_0x4fe143<0x3e8?_0x28b9f8(0x1a5):_0x4fe143<0x1388?'#ff5500':_0x28b9f8(0x87);}_0x484991=L[_0x56eaeb(0x180)](_0x158d8a,{'coordsToLatLng':function(_0x440870){const _0x29badb=_0x56eaeb;if(_0x3a77cc!==_0x29badb(0xfd)){const _0x4443ce=proj4(_0x3a77cc,_0x29badb(0xfd),_0x440870);return new L[(_0x29badb(0x18a))](_0x4443ce[0x1],_0x4443ce[0x0]);}return new L[(_0x29badb(0x18a))](_0x440870[0x1],_0x440870[0x0]);},'style':function(_0x179551){const _0x3bcb76=_0x56eaeb;return{'fillColor':_0x3b5589(_0x179551['properties']['parcelArea']),'weight':0x1,'opacity':0x1,'color':_0x3bcb76(0x15e),'fillOpacity':0.7};},'onEachFeature':function(_0x40746f,_0x30a697){const _0x4b6931=_0x56eaeb,_0x43e3df=document[_0x4b6931(0x12a)](_0x4b6931(0xd7))[_0x4b6931(0x1ab)]||'ID',_0x361195='\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22info-popup\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<strong>'+_0x43e3df+_0x4b6931(0x1a3)+_0x40746f[_0x4b6931(0x174)][_0x43e3df]+_0x4b6931(0x1b2)+_0x40746f[_0x4b6931(0x174)][_0x4b6931(0x124)]+_0x4b6931(0x14b);_0x30a697['bindPopup'](_0x361195);}})[_0x56eaeb(0x198)](map);}else _0x2b4d72===_0x56eaeb(0x8b)?_0x484991=L['geoJSON'](_0x158d8a,{'coordsToLatLng':function(_0x2e46a7){const _0x2906bd=_0x56eaeb;if(_0x3a77cc!==_0x2906bd(0xfd)){const _0x4a226f=proj4(_0x3a77cc,'EPSG:4326',_0x2e46a7);return new L[(_0x2906bd(0x18a))](_0x4a226f[0x1],_0x4a226f[0x0]);}return new L[(_0x2906bd(0x18a))](_0x2e46a7[0x1],_0x2e46a7[0x0]);},'pointToLayer':function(_0x1cbb4f,_0x484ca5){const _0x347895=_0x56eaeb;return L[_0x347895(0x138)](_0x484ca5,{'radius':0x6,'fillColor':_0x347895(0x87),'color':_0x347895(0x168),'weight':0x1,'opacity':0x1,'fillOpacity':0.8});},'onEachFeature':function(_0x161b22,_0xd0aaa7){const _0x238641=_0x56eaeb;let _0x5046ec=_0x238641(0xbd);for(const _0x4b4bc3 in _0x161b22[_0x238641(0x174)]){_0x5046ec+=_0x238641(0x83)+_0x4b4bc3+_0x238641(0x1a3)+_0x161b22['properties'][_0x4b4bc3]+'<br>';}_0x5046ec+=_0x238641(0xfb),_0xd0aaa7[_0x238641(0x1d6)](_0x5046ec);}})[_0x56eaeb(0x198)](map):_0x484991=L[_0x56eaeb(0x180)](_0x158d8a,{'coordsToLatLng':function(_0x41a277){const _0x137211=_0x56eaeb;if(_0x3a77cc!==_0x137211(0xfd)){const _0x30065c=proj4(_0x3a77cc,_0x137211(0xfd),_0x41a277);return new L[(_0x137211(0x18a))](_0x30065c[0x1],_0x30065c[0x0]);}return new L[(_0x137211(0x18a))](_0x41a277[0x1],_0x41a277[0x0]);},'style':_0x1f34f3,'onEachFeature':function(_0x1fa802,_0x402798){const _0x4a8ca5=_0x56eaeb;let _0x325544=_0x4a8ca5(0xbd);for(const _0x182b89 in _0x1fa802[_0x4a8ca5(0x174)]){_0x325544+=_0x4a8ca5(0x83)+_0x182b89+':</strong>\x20'+_0x1fa802[_0x4a8ca5(0x174)][_0x182b89]+_0x4a8ca5(0xc8);}_0x325544+=_0x4a8ca5(0xfb),_0x402798['bindPopup'](_0x325544);}})[_0x56eaeb(0x198)](map);}}if(_0x2b4d72===_0x56eaeb(0xb5))buildingLayer=_0x484991;else _0x2b4d72==='parcel'?parcelLayer=_0x484991:resultLayer=_0x484991;addLayerToControl(_0x484991,_0x2b4d72,_0x10b6c8,_0x158d8a);try{map[_0x56eaeb(0xf1)](_0x484991['getBounds']());}catch(_0x47ac43){logMessage('Could\x20not\x20zoom\x20to\x20layer\x20bounds:\x20'+_0x47ac43[_0x56eaeb(0x94)],'warning');}return _0x484991;}function addLayerToControl(_0x4488c3,_0x27305c,_0x4ef835,_0x3b8496){const _0xfc885b=_0x5307db;if(layerData[_0x27305c]){const _0x52544a=allLayers[_0xfc885b(0x113)](layerData[_0x27305c][_0xfc885b(0xd4)]);_0x52544a>-0x1&&allLayers['splice'](_0x52544a,0x1);}allLayers[_0xfc885b(0x109)](_0x4488c3),layerData[_0x27305c]={'layer':_0x4488c3,'title':_0x4ef835,'geojson':_0x3b8496};const _0x44d1fc=document['getElementById'](_0xfc885b(0x1be));let _0x2e7ea7=![];for(let _0x27d866=0x0;_0x27d866<_0x44d1fc[_0xfc885b(0xba)]['length'];_0x27d866++){if(_0x44d1fc[_0xfc885b(0xba)][_0x27d866][_0xfc885b(0x1ab)]===_0x27305c){_0x2e7ea7=!![];break;}}if(!_0x2e7ea7){const _0x50847c=document[_0xfc885b(0x163)](_0xfc885b(0x85));_0x50847c[_0xfc885b(0x1ab)]=_0x27305c,_0x50847c[_0xfc885b(0x12c)]=_0x4ef835,_0x44d1fc[_0xfc885b(0x123)](_0x50847c);}updateLayerControlPanel();}function updateLayerControlPanel(){const _0x376ba5=_0x5307db,_0x536ed4=document[_0x376ba5(0x12a)](_0x376ba5(0x12d));_0x536ed4[_0x376ba5(0x169)]='',Object[_0x376ba5(0x127)](layerData)[_0x376ba5(0x183)]()[_0x376ba5(0xad)](_0x16c4e5=>{const _0x1c631b=_0x376ba5,_0x4812b6=layerData[_0x16c4e5],_0x2a2715=document[_0x1c631b(0x163)]('div');_0x2a2715['className']='layer-item';const _0x3adc66=document[_0x1c631b(0x163)](_0x1c631b(0xf2));_0x3adc66[_0x1c631b(0x1b9)]=_0x1c631b(0x98),_0x3adc66[_0x1c631b(0xda)]='layer-toggle',_0x3adc66['checked']=map[_0x1c631b(0x1c0)](_0x4812b6['layer']),_0x3adc66['dataset']['layerId']=_0x16c4e5,_0x3adc66['addEventListener'](_0x1c631b(0x82),function(){const _0x2c298f=_0x1c631b;this[_0x2c298f(0xb8)]?!map[_0x2c298f(0x1c0)](_0x4812b6[_0x2c298f(0xd4)])&&map[_0x2c298f(0x121)](_0x4812b6[_0x2c298f(0xd4)]):map['hasLayer'](_0x4812b6['layer'])&&map[_0x2c298f(0xe2)](_0x4812b6[_0x2c298f(0xd4)]);});const _0x2fb3ec=document[_0x1c631b(0x163)](_0x1c631b(0x1c1));_0x2fb3ec[_0x1c631b(0xda)]=_0x1c631b(0x10d),_0x2fb3ec['textContent']=_0x4812b6[_0x1c631b(0x185)],_0x2a2715[_0x1c631b(0x123)](_0x3adc66),_0x2a2715['appendChild'](_0x2fb3ec),_0x536ed4[_0x1c631b(0x123)](_0x2a2715);});}function displayAttributes(_0x47eb75){const _0x24e660=_0x5307db,_0x310fd2=document['getElementById'](_0x24e660(0x1a2)),_0x27d4f4=document[_0x24e660(0x12a)](_0x24e660(0x197));if(!_0x47eb75||!layerData[_0x47eb75]){_0x310fd2[_0x24e660(0x195)][_0x24e660(0x14e)]=_0x24e660(0xc7);return;}const _0x35c3d2=layerData[_0x47eb75],_0x5b395d=_0x35c3d2[_0x24e660(0x1b8)];if(!_0x5b395d||!_0x5b395d[_0x24e660(0x19f)]||_0x5b395d[_0x24e660(0x19f)][_0x24e660(0x10a)]===0x0){_0x27d4f4['innerHTML']='<p>No\x20attribute\x20data\x20available\x20for\x20this\x20layer.</p>',_0x310fd2[_0x24e660(0x195)][_0x24e660(0x14e)]=_0x24e660(0x105);return;}let _0x3ad67a=_0x24e660(0x9f)+_0x35c3d2[_0x24e660(0x185)]+_0x24e660(0x8c);_0x3ad67a+=_0x24e660(0xd9);const _0x4c51e7={},_0x465ead=document[_0x24e660(0x12a)]('parcelFieldSelector')[_0x24e660(0x1ab)]||'ID';_0x4c51e7[_0x24e660(0x147)]=[_0x24e660(0x1cb),_0x465ead],_0x4c51e7[_0x24e660(0xb5)]=['OBJECTID',_0x24e660(0x19a),_0x24e660(0x95)],_0x4c51e7[_0x24e660(0x8b)]=[_0x24e660(0xed),_0x24e660(0xfe),_0x24e660(0x93),_0x24e660(0xff)],_0x4c51e7[_0x24e660(0x124)]=[_0x465ead,'parcelArea'],_0x4c51e7[_0x24e660(0x10e)]=[_0x465ead,'totalBuildingArea'],_0x4c51e7[_0x24e660(0x1bf)]=[_0x465ead,'parcelArea',_0x24e660(0xb3),'FAR'];let _0x2a6e93=[];_0x4c51e7[_0x47eb75]?_0x2a6e93=_0x4c51e7[_0x47eb75]:_0x5b395d[_0x24e660(0x19f)][_0x24e660(0xad)](_0x24624f=>{const _0x4d1b1d=_0x24e660;_0x24624f[_0x4d1b1d(0x174)]&&Object[_0x4d1b1d(0x127)](_0x24624f[_0x4d1b1d(0x174)])[_0x4d1b1d(0xad)](_0x385a7a=>{const _0x5a9659=_0x4d1b1d;!_0x2a6e93[_0x5a9659(0xf5)](_0x385a7a)&&_0x2a6e93[_0x5a9659(0x109)](_0x385a7a);});}),_0x3ad67a+=_0x24e660(0xc5),_0x3ad67a+=_0x24e660(0x17f),_0x2a6e93[_0x24e660(0xad)](_0x5e48f9=>{const _0x3c53a1=_0x24e660;_0x3ad67a+=_0x3c53a1(0x1ae)+_0x5e48f9+_0x3c53a1(0xea);}),_0x3ad67a+=_0x24e660(0x96),_0x5b395d[_0x24e660(0x19f)]['forEach']((_0x182e52,_0x65b8d3)=>{const _0x153025=_0x24e660;_0x3ad67a+=_0x153025(0xc5),_0x3ad67a+=_0x153025(0x190)+_0x65b8d3+_0x153025(0xa7),_0x2a6e93[_0x153025(0xad)](_0x3a8d4c=>{const _0x52995e=_0x153025,_0x143af5=_0x182e52[_0x52995e(0x174)]?_0x182e52[_0x52995e(0x174)][_0x3a8d4c]:'';_0x3ad67a+=_0x52995e(0x190)+(_0x143af5!==undefined&&_0x143af5!==null?_0x143af5:'')+_0x52995e(0xa7);}),_0x3ad67a+='</tr>';}),_0x3ad67a+=_0x24e660(0xa9),_0x27d4f4[_0x24e660(0x169)]=_0x3ad67a,_0x310fd2[_0x24e660(0x195)][_0x24e660(0x14e)]='block';}function handleFileUpload(_0x56d2a3,_0xfdb80){const _0x17e1d8=_0x5307db,_0x14ee0e=_0x56d2a3[_0x17e1d8(0x1bb)][0x0];if(!_0x14ee0e)return;const _0x28b180=new FileReader();_0x28b180[_0x17e1d8(0x179)]=function(_0x426445){const _0x3175dc=_0x17e1d8,_0x303e61=_0x426445[_0x3175dc(0x1d5)][_0x3175dc(0xc4)];try{const _0x1ec425=JSON[_0x3175dc(0x1d1)](_0x303e61),_0x337d73=checkCRS(_0x1ec425);if(!_0x337d73){const _0x4d04c2=confirm(_0x3175dc(0x182)+document[_0x3175dc(0x12a)]('coordSystem')[_0x3175dc(0x1ab)]+').\x20Do\x20you\x20want\x20to\x20continue\x20anyway?\x20If\x20not,\x20please\x20change\x20the\x20coordinate\x20system\x20and\x20try\x20again.');if(!_0x4d04c2)return;}if(_0xfdb80===_0x3175dc(0xb5)&&buildingLayer)map[_0x3175dc(0xe2)](buildingLayer),delete layerData['building'];else _0xfdb80===_0x3175dc(0x147)&&parcelLayer&&(map[_0x3175dc(0xe2)](parcelLayer),delete layerData[_0x3175dc(0x147)]);if(_0xfdb80==='building')buildingGeojson=_0x1ec425,document[_0x3175dc(0x12a)](_0x3175dc(0x1b7))[_0x3175dc(0x169)]=_0x3175dc(0xd1)+_0x14ee0e[_0x3175dc(0x161)]+_0x3175dc(0xbb)+_0x1ec425[_0x3175dc(0x19f)][_0x3175dc(0x10a)]+_0x3175dc(0xe8),logMessage(_0x3175dc(0xf9)+_0x1ec425[_0x3175dc(0x19f)][_0x3175dc(0x10a)]+_0x3175dc(0xb1)+_0x14ee0e['name'],_0x3175dc(0xcb));else{if(_0xfdb80===_0x3175dc(0x147)){parcelGeojson=_0x1ec425,document['getElementById'](_0x3175dc(0xbc))[_0x3175dc(0x169)]='<i\x20class=\x22fas\x20fa-check-circle\x22></i>\x20'+_0x14ee0e[_0x3175dc(0x161)]+_0x3175dc(0xbb)+_0x1ec425[_0x3175dc(0x19f)][_0x3175dc(0x10a)]+_0x3175dc(0x133),logMessage(_0x3175dc(0xf9)+_0x1ec425[_0x3175dc(0x19f)][_0x3175dc(0x10a)]+_0x3175dc(0xc3)+_0x14ee0e[_0x3175dc(0x161)],'info');if(_0x1ec425[_0x3175dc(0x19f)]&&_0x1ec425[_0x3175dc(0x19f)][_0x3175dc(0x10a)]>0x0){const _0x14d7db=_0x1ec425[_0x3175dc(0x19f)][0x0][_0x3175dc(0x174)];parcelFields=Object[_0x3175dc(0x127)](_0x14d7db);const _0x4fe976=document[_0x3175dc(0x12a)](_0x3175dc(0xd7));_0x4fe976[_0x3175dc(0x169)]='',parcelFields['forEach'](_0x4fffa1=>{const _0x4784cf=_0x3175dc,_0x1ddae8=document[_0x4784cf(0x163)](_0x4784cf(0x85));_0x1ddae8[_0x4784cf(0x1ab)]=_0x4fffa1,_0x1ddae8[_0x4784cf(0x12c)]=_0x4fffa1,_0x4fe976[_0x4784cf(0x123)](_0x1ddae8);}),document['getElementById']('fieldSelectorContainer')['style'][_0x3175dc(0x14e)]=_0x3175dc(0x105);}}}addGeoJSONToMap(_0x1ec425,_0xfdb80,_0xfdb80==='building'?_0x3175dc(0x114):'Land\x20Parcels'),buildingGeojson&&parcelGeojson&&(document[_0x3175dc(0x12a)](_0x3175dc(0x141))[_0x3175dc(0x15f)]=![],document[_0x3175dc(0x12a)](_0x3175dc(0xe0))['disabled']=![]),resetProcessFlags();}catch(_0x25b102){console[_0x3175dc(0x107)]('Error\x20parsing\x20GeoJSON:',_0x25b102),logMessage(_0x3175dc(0x102)+_0x25b102[_0x3175dc(0x94)],_0x3175dc(0x107)),alert('Error\x20parsing\x20GeoJSON\x20file.\x20Please\x20check\x20the\x20file\x20format.');}},_0x28b180[_0x17e1d8(0x1b0)](_0x14ee0e);}function resetProcessFlags(){const _0x45922a=_0x5307db;processFlags={'step1':![],'step2':![],'step3':![],'step4':![]},document['getElementById'](_0x45922a(0x1af))[_0x45922a(0x195)][_0x45922a(0x14e)]=_0x45922a(0xc7),document[_0x45922a(0x12a)](_0x45922a(0xac))[_0x45922a(0x195)][_0x45922a(0x14e)]=_0x45922a(0xc7),document[_0x45922a(0x12a)](_0x45922a(0xa5))[_0x45922a(0x195)]['display']=_0x45922a(0xc7),document[_0x45922a(0x12a)]('step4Result')['style'][_0x45922a(0x14e)]=_0x45922a(0xc7),document[_0x45922a(0x12a)](_0x45922a(0x111))[_0x45922a(0x15f)]=!![],document[_0x45922a(0x12a)](_0x45922a(0xa4))[_0x45922a(0x15f)]=!![],document[_0x45922a(0x12a)](_0x45922a(0xa3))[_0x45922a(0x15f)]=!![],document[_0x45922a(0x12a)]('exportButton')[_0x45922a(0x15f)]=!![],document[_0x45922a(0x12a)](_0x45922a(0x13e))['disabled']=!![];}function transformCoords(_0x5650cb,_0x1989e9,_0x11fb2c){if(_0x1989e9===_0x11fb2c)return _0x5650cb;return proj4(_0x1989e9,_0x11fb2c,_0x5650cb);}function _0x3a88(){const _0x4d0c9d=['utils','Error\x20processing\x20parcel\x20','Please\x20complete\x20step\x203\x20first.','Starting\x20parcel\x20area\x20calculation...','properties','<br>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','sort','30ULuOdW','batchIndex','onload','step4','\x20sq.m<br>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<strong>Total\x20Building\x20Area:</strong>\x20','Worker\x20error:\x20','postMessage','FAR','<th>FID</th>','geoJSON','esri','WARNING:\x20The\x20coordinates\x20in\x20this\x20file\x20may\x20not\x20match\x20the\x20selected\x20coordinate\x20system\x20(','reverse','\x20sq.m</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<p>Total\x20building\x20area:\x20','title','Step\x201\x20has\x20already\x20been\x20completed.\x20Do\x20you\x20want\x20to\x20run\x20it\x20again?','toFixed','</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<p>Total\x20parcel\x20area:\x20','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','LatLng','Final\x20Result\x20(FAR)','Error\x20processing\x20batch:','reduce','map','defs','<td>','\x20parcels:</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<p>FAR\x20=\x20(Total\x20Building\x20Area\x20/\x20Parcel\x20Area)</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<hr>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<p>Summary\x20Statistics:</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<p>Total\x20parcels:\x20','</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<p>Parcels\x20with\x20building\x20data:\x20','onmessage','Processing\x20building\x20','style','Building\x20Points','attributeContent','addTo','geometry','BL_AREA','color','Please\x20select\x20a\x20parcel\x20field.','#f8f8f8','</pre>','features','EPSG:32647','finalResultGeojson','attributePanel',':</strong>\x20','Created\x20','#ffaa00','scrollTop','1kfpXWb','slice','href','#00ff00','value','warning','writeFile','<th>','step1Result','readAsText','step3','<br>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<strong>Parcel\x20Area:</strong>\x20','progressBar','FAR_analysis_result_','#ff5500','\x20seconds','buildingStatus','geojson','type','Error\x20calculating\x20FAR\x20for\x20parcel\x20','files','crs','book_new','layerSelect','finalResult','hasLayer','label','number','string','max','Step\x202\x20has\x20already\x20been\x20completed.\x20Do\x20you\x20want\x20to\x20run\x20it\x20again?','index','warn','ceil','parcelAreaResults','progress','OBJECTID','startIndex','Starting\x20step\x201\x20processing\x20-\x20calculating\x20areas\x20for\x20','Exported\x20Excel\x20result\x20successfully','items','buildingCount','parse','Proj','\x20sq.m</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<p>CRS:\x20','%)</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<p>Parcel\x20identifier\x20used:\x20','target','bindPopup','coordinates','Buildings\x20calculation\x20details:\x0a','Processing\x20parcel\x20','processedWith','click','\x0a\x20\x20\x20\x20\x20\x20\x20\x20<p>FAR\x20calculated\x20for\x20','selectedCRS','replace','Starting\x20building\x20conversion...','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22info-popup\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<strong>','change','<strong>','Please\x20upload\x20both\x20parcel\x20and\x20building\x20files\x20first.','option','buildingBatch','#ff0000','Completed\x20all\x20processing\x20steps\x20successfully!','2321010ncYUxQ','Failed\x20to\x20calculate\x20areas\x20for\x20any\x20parcels.','buildingPoints','\x20Attributes</h4>','calculateFAR','ImageryLabels','10GwNfQg','Starting\x20building\x20area\x20calculation...','CRS','loadingIndicator','buildingArea','message','BL_NSTOREY','</tr>','MultiLineString','checkbox','body','\x20parcels</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<p>Parcels\x20containing\x20buildings:\x20','toISOString','mapDiv','837756VZdorv','area','<h4>','\x20buildings\x20to\x20points\x20in\x20','\x0a\x20\x20\x20\x20\x20\x20\x20\x20<p>Building\x20areas\x20calculated\x20for\x20','Point','processStep4','processStep3','step3Result','Application\x20initialized\x20successfully!','</td>','removeChild','</table>','Processing\x20already\x20in\x20progress,\x20please\x20wait','endIndex','step2Result','forEach','Calculating\x20FAR\x20values','12PMtXda','attribution','\x20buildings\x20from\x20','+proj=utm\x20+zone=48\x20+datum=WGS84\x20+units=m\x20+no_defs','totalBuildingArea','Parcels\x20with\x20Area','building','\x20web\x20workers','processingDate','checked','Error\x20creating\x20point\x20for\x20building\x20','options','\x20loaded\x20(','parcelStatus','<div\x20class=\x22info-popup\x22>','\x20sq.m</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<p>Formula:\x20Building\x20Area\x20×\x20Number\x20of\x20Floors\x20=\x20Total\x20Building\x20Area</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<p>CRS:\x20','Base\x20map\x20limited\x20in\x20UTM\x20projection.\x20Switch\x20to\x20EPSG:4326\x20for\x20full\x20basemap.','Please\x20complete\x20step\x202\x20first.','<strong>Calculation\x20Details:</strong><br>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<pre\x20style=\x22max-height:\x20100px;\x20overflow-y:\x20auto;\x22>','\x20for\x20building\x20areas:\x20','\x20parcels\x20from\x20','result','<tr>','round','none','<br>','step4Result','level','info','SUMMARY\x20STATISTICS','CRS\x20used','abs','Parcels\x20with\x20Building\x20Areas','+proj=utm\x20+zone=47\x20+datum=WGS84\x20+units=m\x20+no_defs','<i\x20class=\x22fas\x20fa-check-circle\x22></i>\x20','\x0a\x20\x20\x20\x20\x20\x20\x20\x20<p>Buildings\x20converted\x20to\x20points:\x20','Starting\x20step\x204\x20processing\x20-\x20calculating\x20FAR\x20for\x20','layer','download','selectedField','parcelFieldSelector','startTime','<table\x20class=\x22attribute-table\x22>','className','Error\x20combining\x20batch\x20results:','Error\x20combining\x20batch\x20results:\x20','processBuildingAreas','Please\x20complete\x20step\x201\x20first.','concat','runAllSteps','application/json','removeLayer','Worker\x20error:','Average\x20FAR','241812UjBZwX','application/javascript','enabled','\x20buildings)','Map\x20initialized\x20with\x20CRS:\x20','</th>','4788993fTPxPj','Calculating\x20building\x20areas\x20by\x20parcel','parcelId','buildingFile','FeatureCollection','total','fitBounds','input','\x20parcels</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<p>Total\x20area:\x20','</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<p><strong>Maximum\x20FAR:</strong>\x20','includes','step2','featureCount','Processing\x20batch\x20','Loaded\x20','log','</div>','now','EPSG:4326','parcelName','buildingStoreys','parcelBatch','buildingGeojson','Error\x20parsing\x20GeoJSON\x20file:\x20','querySelector','Starting\x20step\x203\x20processing\x20-\x20calculating\x20building\x20areas\x20for\x20','block','json_to_sheet','error','createObjectURL','push','length','.xlsx','\x20coordinate\x20system','layer-label','parcelsBuildingAreas','book_append_sheet','\x20batches','processStep2','processingDelay','indexOf','Buildings','Generated\x20on','width','Web\x20Workers\x20disabled\x20-\x20using\x20main\x20thread\x20processing','FAR_analysis_result.geojson','962925kEJCgo','batchSize','\x20for\x20parcel\x20','LineString','EPSG:32648','parcelFile','calculationDetails','<i\x20class=\x22fas\x20fa-list\x22></i>','addLayer','Failed\x20to\x20calculate\x20building\x20areas\x20for\x20any\x20parcels.','appendChild','parcelArea','Worker','parcelGeojson','keys','</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<p>Buildings\x20assigned\x20to\x20parcels:\x20','#ffa500','getElementById','toLocaleTimeString','textContent','layerList','#ffff00','filter','</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<p>Total\x20building\x20area:\x20','coordSystem','Failed\x20to\x20calculate\x20FAR\x20values\x20for\x20any\x20parcels.','\x20parcels)','Please\x20complete\x20step\x204\x20first.','processingStatus','MultiPolygon','centroid','circleMarker','totalArea','\x20parcels\x20in\x20','processBuildingPoints','Feature','onerror','exportExcelButton','processParcelArea','Calculating\x20parcel\x20areas','processStep1','toLocaleString','remove','EPSG3857','...','exportButton','parcel','toggleLogButton','#workerScript','14HvCQNb','\x20sq.m\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','Converting\x20buildings\x20to\x20points','min','display','MultiPoint','booleanPointInPolygon','scrollHeight','Land\x20Parcels','Failed\x20to\x20create\x20any\x20building\x20points.\x20Check\x20the\x20building\x20GeoJSON\x20data.','Imagery','555976ZmbWbb','</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<p>Total\x20buildings\x20processed:\x20','endTime','Processing\x20error:\x20','Floor\x20Area\x20Ratio\x20Web\x20App','\x0a\x20\x20\x20\x20\x20\x20\x20\x20<p>Parcel\x20areas\x20calculated\x20for\x20','stringify','useWebWorkers','step1','#000000','disabled','shift','name','data','createElement','\x20sq.m<br>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','287906xwJlAU','<br>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<strong>Building\x20Count:</strong>\x20','Polygon','#000','innerHTML','</p>\x0a\x20\x20\x20\x20\x20\x20','addEventListener','\x20sq.m\x0a','basemapLayer','Error\x20processing\x20batch\x20','No\x20buildings\x20found\x20in\x20this\x20parcel'];_0x3a88=function(){return _0x4d0c9d;};return _0x3a88();}function transformGeoJSON(_0x3051e9,_0x18f69d,_0x2a424e){const _0x4bf2ee=_0x5307db;if(_0x18f69d===_0x2a424e)return JSON[_0x4bf2ee(0x1d1)](JSON['stringify'](_0x3051e9));const _0x943f84={'type':_0x3051e9[_0x4bf2ee(0x1b9)],'features':[]};return _0x3051e9['features'][_0x4bf2ee(0xad)](_0x19f221=>{const _0x3f128f=_0x4bf2ee,_0x51193d={'type':_0x19f221[_0x3f128f(0x1b9)],'properties':{..._0x19f221[_0x3f128f(0x174)]},'geometry':{'type':_0x19f221[_0x3f128f(0x199)]['type']}};if(_0x19f221[_0x3f128f(0x199)]['type']==='Point')_0x51193d[_0x3f128f(0x199)][_0x3f128f(0x1d7)]=transformCoords(_0x19f221[_0x3f128f(0x199)][_0x3f128f(0x1d7)],_0x18f69d,_0x2a424e);else{if(_0x19f221[_0x3f128f(0x199)][_0x3f128f(0x1b9)]===_0x3f128f(0x11c)||_0x19f221[_0x3f128f(0x199)]['type']===_0x3f128f(0x14f))_0x51193d[_0x3f128f(0x199)][_0x3f128f(0x1d7)]=_0x19f221[_0x3f128f(0x199)]['coordinates'][_0x3f128f(0x18e)](_0x27e31e=>transformCoords(_0x27e31e,_0x18f69d,_0x2a424e));else{if(_0x19f221[_0x3f128f(0x199)][_0x3f128f(0x1b9)]===_0x3f128f(0x167)||_0x19f221[_0x3f128f(0x199)][_0x3f128f(0x1b9)]===_0x3f128f(0x97))_0x51193d['geometry'][_0x3f128f(0x1d7)]=_0x19f221['geometry']['coordinates'][_0x3f128f(0x18e)](_0x4f692e=>_0x4f692e[_0x3f128f(0x18e)](_0x3c680f=>transformCoords(_0x3c680f,_0x18f69d,_0x2a424e)));else _0x19f221['geometry'][_0x3f128f(0x1b9)]===_0x3f128f(0x136)&&(_0x51193d[_0x3f128f(0x199)][_0x3f128f(0x1d7)]=_0x19f221[_0x3f128f(0x199)][_0x3f128f(0x1d7)][_0x3f128f(0x18e)](_0x2d1fba=>_0x2d1fba['map'](_0x25b1f0=>_0x25b1f0[_0x3f128f(0x18e)](_0x1235af=>transformCoords(_0x1235af,_0x18f69d,_0x2a424e)))));}}_0x943f84['features'][_0x3f128f(0x109)](_0x51193d);}),_0x943f84;}function calculateAreaUTM(_0x355e8b,_0x4b2092){const _0x539320=_0x5307db;let _0x3b1838=0x0;if(_0x355e8b['type']===_0x539320(0x167))_0x3b1838=polygonArea(_0x355e8b[_0x539320(0x1d7)][0x0]);else{if(_0x355e8b[_0x539320(0x1b9)]===_0x539320(0x136))for(const _0x497dcf of _0x355e8b[_0x539320(0x1d7)]){_0x3b1838+=polygonArea(_0x497dcf[0x0]);for(let _0x5492ee=0x1;_0x5492ee<_0x497dcf[_0x539320(0x10a)];_0x5492ee++){_0x3b1838-=polygonArea(_0x497dcf[_0x5492ee]);}}}return Math[_0x539320(0xce)](_0x3b1838);}function polygonArea(_0x3954ba){const _0x4b0123=_0x5307db;let _0x3b9235=0x0;const _0x437785=_0x3954ba[_0x4b0123(0x10a)];if(_0x437785<0x3)return 0x0;for(let _0x323c24=0x0;_0x323c24<_0x437785-0x1;_0x323c24++){_0x3b9235+=_0x3954ba[_0x323c24][0x0]*_0x3954ba[_0x323c24+0x1][0x1]-_0x3954ba[_0x323c24+0x1][0x0]*_0x3954ba[_0x323c24][0x1];}return _0x3b9235+=_0x3954ba[_0x437785-0x1][0x0]*_0x3954ba[0x0][0x1]-_0x3954ba[0x0][0x0]*_0x3954ba[_0x437785-0x1][0x1],Math[_0x4b0123(0xce)](_0x3b9235/0x2);}function processStep1(){const _0x153e3d=_0x5307db;if(isProcessing){logMessage(_0x153e3d(0xaa),_0x153e3d(0x1ac));return;}if(processFlags[_0x153e3d(0x15d)]){const _0x26e9ec=confirm(_0x153e3d(0x186));if(!_0x26e9ec)return;}if(!parcelGeojson){alert('Please\x20upload\x20parcel\x20file\x20first.');return;}currentStep=_0x153e3d(0x15d),batchSize=parseInt(document[_0x153e3d(0x12a)](_0x153e3d(0x11a))['value'])||0x64,processingDelay=parseInt(document['getElementById'](_0x153e3d(0x112))['value'])||0xa;const _0x486581=JSON[_0x153e3d(0x1d1)](JSON[_0x153e3d(0x15b)](parcelGeojson));batchResults=[],currentBatch=0x0;const _0x195318=_0x486581[_0x153e3d(0x19f)]['length'];totalBatches=Math[_0x153e3d(0x1c8)](_0x195318/batchSize),showLoadingIndicator(_0x153e3d(0x140)),updateProgress(0x0,_0x195318,_0x153e3d(0x173)),logMessage(_0x153e3d(0x1cd)+_0x195318+_0x153e3d(0x13a)+totalBatches+_0x153e3d(0x110),_0x153e3d(0xcb)),batchStats['startTime']=Date[_0x153e3d(0xfc)](),batchStats[_0x153e3d(0xf7)]=_0x195318,isProcessing=!![],processBatchesStep1(_0x486581);}function processBatchesStep1(_0x120df1){const _0x2f7e4c=_0x5307db;useWebWorkers&&workers[_0x2f7e4c(0x10a)]>0x0?processBatchesWithWorkers(_0x120df1['features'],null,_0x2f7e4c(0x13f)):processBatchesInMainThread(_0x120df1[_0x2f7e4c(0x19f)],(_0x1cc4b4,_0x1b48fc,_0x436e55)=>{return processParcelAreaBatch({'parcelBatch':_0x1cc4b4,'selectedCRS':currentCRS,'startIndex':_0x1b48fc,'endIndex':_0x436e55});});}function processBatchesWithWorkers(_0x5d21e2,_0x230d1e,_0x1080dd){const _0x430b3c=_0x5307db,_0x515062=[];for(let _0x49c192=0x0;_0x49c192<_0x5d21e2[_0x430b3c(0x10a)];_0x49c192+=batchSize){_0x515062[_0x430b3c(0x109)]({'items':_0x5d21e2[_0x430b3c(0x1a8)](_0x49c192,_0x49c192+batchSize),'startIndex':_0x49c192,'endIndex':Math[_0x430b3c(0x14d)](_0x49c192+batchSize,_0x5d21e2['length'])});}let _0x504732=0x0;const _0x2b1822=assignBatchesToWorkers(_0x515062);function _0x475be7(_0x419c87){const _0x184530=_0x430b3c;if(_0x2b1822[_0x419c87][_0x184530(0x10a)]===0x0)return null;return _0x2b1822[_0x419c87][_0x184530(0x160)]();}for(let _0x51cfde=0x0;_0x51cfde<workers['length'];_0x51cfde++){_0x4968a0(_0x51cfde);}function _0x4968a0(_0x3795c2){const _0x29e4c7=_0x430b3c,_0x55f639=_0x475be7(_0x3795c2);if(!_0x55f639)return;const _0x43c1dc=workers[_0x3795c2],_0x477661={'command':_0x1080dd,'batchIndex':_0x504732,'totalBatches':totalBatches};if(_0x1080dd===_0x29e4c7(0x13f))_0x477661[_0x29e4c7(0x100)]=_0x55f639['items'],_0x477661[_0x29e4c7(0x7e)]=currentCRS,_0x477661[_0x29e4c7(0x1cc)]=_0x55f639[_0x29e4c7(0x1cc)],_0x477661['endIndex']=_0x55f639[_0x29e4c7(0xab)];else{if(_0x1080dd===_0x29e4c7(0x13b))_0x477661[_0x29e4c7(0x86)]=_0x55f639[_0x29e4c7(0x1cf)],_0x477661[_0x29e4c7(0x126)]=_0x230d1e,_0x477661[_0x29e4c7(0xd6)]=document['getElementById'](_0x29e4c7(0xd7))['value'],_0x477661[_0x29e4c7(0x1cc)]=_0x55f639[_0x29e4c7(0x1cc)],_0x477661[_0x29e4c7(0xab)]=_0x55f639['endIndex'];else{if(_0x1080dd===_0x29e4c7(0xdd))_0x477661[_0x29e4c7(0x100)]=_0x55f639[_0x29e4c7(0x1cf)],_0x477661[_0x29e4c7(0x101)]=_0x230d1e,_0x477661['selectedField']=document[_0x29e4c7(0x12a)](_0x29e4c7(0xd7))['value'],_0x477661['startIndex']=_0x55f639[_0x29e4c7(0x1cc)],_0x477661[_0x29e4c7(0xab)]=_0x55f639[_0x29e4c7(0xab)],_0x477661[_0x29e4c7(0x1c9)]=resultGeojson;else _0x1080dd==='calculateFAR'&&(_0x477661[_0x29e4c7(0x100)]=_0x55f639['items'],_0x477661[_0x29e4c7(0x1cc)]=_0x55f639[_0x29e4c7(0x1cc)],_0x477661[_0x29e4c7(0xab)]=_0x55f639[_0x29e4c7(0xab)]);}}_0x43c1dc[_0x29e4c7(0x17d)](_0x477661);const _0x479456=_0x43c1dc[_0x29e4c7(0x193)];_0x43c1dc['onmessage']=function(_0x2c775a){const _0x464296=_0x29e4c7;_0x2c775a[_0x464296(0x162)]['type']==='result'?(batchResults[_0x464296(0x109)]({'batchIndex':_0x2c775a[_0x464296(0x162)][_0x464296(0x178)],'features':_0x2c775a[_0x464296(0x162)][_0x464296(0x19f)]}),_0x504732++,_0x504732===totalBatches?combineBatchResults():setTimeout(()=>{_0x4968a0(_0x3795c2);},processingDelay),_0x43c1dc[_0x464296(0x193)]=_0x479456):_0x479456(_0x2c775a);};}}function assignBatchesToWorkers(_0x41d158){const _0x52c181=_0x5307db,_0x538fd8={};for(let _0x2c2471=0x0;_0x2c2471<workers['length'];_0x2c2471++){_0x538fd8[_0x2c2471]=[];}for(let _0x41bdf7=0x0;_0x41bdf7<_0x41d158[_0x52c181(0x10a)];_0x41bdf7++){const _0x4c0a9f=_0x41bdf7%workers[_0x52c181(0x10a)];_0x538fd8[_0x4c0a9f]['push'](_0x41d158[_0x41bdf7]);}return _0x538fd8;}function processBatchesInMainThread(_0x2d91b3,_0x4df6e1){const _0xa7ae31=_0x5307db,_0x4585cc=[];for(let _0x4be167=0x0;_0x4be167<_0x2d91b3[_0xa7ae31(0x10a)];_0x4be167+=batchSize){_0x4585cc['push']({'items':_0x2d91b3[_0xa7ae31(0x1a8)](_0x4be167,_0x4be167+batchSize),'startIndex':_0x4be167,'endIndex':Math[_0xa7ae31(0x14d)](_0x4be167+batchSize,_0x2d91b3[_0xa7ae31(0x10a)])});}function _0x2d8e4a(_0x2a7d93){const _0x1f1177=_0xa7ae31;if(_0x2a7d93>=_0x4585cc['length']){combineBatchResults();return;}const _0x37f668=_0x4585cc[_0x2a7d93];updateProgress(_0x37f668['startIndex'],_0x2d91b3['length'],_0x1f1177(0xf8)+(_0x2a7d93+0x1)+'/'+_0x4585cc['length']+_0x1f1177(0x145));try{const _0xd64977=_0x4df6e1(_0x37f668[_0x1f1177(0x1cf)],_0x37f668[_0x1f1177(0x1cc)],_0x37f668['endIndex']);batchResults[_0x1f1177(0x109)]({'batchIndex':_0x2a7d93,'features':_0xd64977}),setTimeout(()=>{_0x2d8e4a(_0x2a7d93+0x1);},processingDelay);}catch(_0x146189){console[_0x1f1177(0x107)](_0x1f1177(0x18c),_0x146189),logMessage(_0x1f1177(0x16e)+_0x2a7d93+':\x20'+_0x146189['message'],_0x1f1177(0x107)),isProcessing=![],hideLoadingIndicator();}}_0x2d8e4a(0x0);}function processParcelAreaBatch(_0x2ca292){const _0x3e5360=_0x5307db,{parcelBatch:_0x530d98,selectedCRS:_0x19ae2d,startIndex:_0x3ec9fc,endIndex:_0x55d08e}=_0x2ca292,_0x14b711=[];for(let _0x47743d=0x0;_0x47743d<_0x530d98[_0x3e5360(0x10a)];_0x47743d++){try{const _0x38c9b9=_0x530d98[_0x47743d],_0x391218=_0x3ec9fc+_0x47743d;updateProgress(_0x391218,_0x55d08e,_0x3e5360(0x1d9)+(_0x391218+0x1)+'/'+_0x55d08e);let _0x3070cf;_0x19ae2d===_0x3e5360(0xfd)?_0x3070cf=turf[_0x3e5360(0x9e)](_0x38c9b9):_0x3070cf=calculateAreaUTM(_0x38c9b9[_0x3e5360(0x199)],_0x19ae2d);const _0x12ae9e={'type':_0x3e5360(0x13c),'properties':{..._0x38c9b9[_0x3e5360(0x174)],'parcelArea':Math[_0x3e5360(0xc6)](_0x3070cf*0x64)/0x64},'geometry':_0x38c9b9[_0x3e5360(0x199)]};_0x14b711[_0x3e5360(0x109)](_0x12ae9e);}catch(_0x506a7d){logMessage(_0x3e5360(0x171)+(_0x3ec9fc+_0x47743d)+':\x20'+_0x506a7d[_0x3e5360(0x94)],_0x3e5360(0x107));}}return _0x14b711;}function combineBatchResults(){const _0x5228bf=_0x5307db;try{batchResults[_0x5228bf(0x176)]((_0x565d5a,_0x5767b8)=>_0x565d5a[_0x5228bf(0x178)]-_0x5767b8['batchIndex']);let _0x319316=[];for(const _0x48a97b of batchResults){_0x319316=_0x319316[_0x5228bf(0xdf)](_0x48a97b[_0x5228bf(0x19f)]);}const _0x414414={'type':_0x5228bf(0xef),'features':_0x319316};batchStats['endTime']=Date[_0x5228bf(0xfc)]();const _0x29c601=(batchStats[_0x5228bf(0x157)]-batchStats['startTime'])/0x3e8;logMessage('Completed\x20processing\x20'+batchStats[_0x5228bf(0xf7)]+'\x20features\x20in\x20'+_0x29c601[_0x5228bf(0x187)](0x2)+_0x5228bf(0x1b6),_0x5228bf(0xcb));if(currentStep===_0x5228bf(0x15d))finalizeStep1(_0x414414);else{if(currentStep===_0x5228bf(0xf6))finalizeStep2(_0x414414);else{if(currentStep==='step3')finalizeStep3(_0x414414);else currentStep===_0x5228bf(0x17a)&&finalizeStep4(_0x414414);}}isProcessing=![],hideLoadingIndicator();}catch(_0x18f16d){console[_0x5228bf(0x107)](_0x5228bf(0xdb),_0x18f16d),logMessage(_0x5228bf(0xdc)+_0x18f16d[_0x5228bf(0x94)],_0x5228bf(0x107)),isProcessing=![],hideLoadingIndicator();}}function finalizeStep1(_0x6abf9){const _0x285e24=_0x5307db;if(_0x6abf9[_0x285e24(0x19f)][_0x285e24(0x10a)]===0x0){alert(_0x285e24(0x8a));return;}resultGeojson=_0x6abf9,parcelOriginalShapes=JSON[_0x285e24(0x1d1)](JSON[_0x285e24(0x15b)](parcelGeojson));resultLayer&&(map[_0x285e24(0xe2)](resultLayer),delete layerData[_0x285e24(0x124)]);addGeoJSONToMap(resultGeojson,'parcelArea',_0x285e24(0xb4));let _0x3b53d9=0x0;resultGeojson[_0x285e24(0x19f)][_0x285e24(0xad)](_0x2c3a33=>{const _0x1b9788=_0x285e24;_0x3b53d9+=_0x2c3a33[_0x1b9788(0x174)][_0x1b9788(0x124)];});const _0x4b07b8=_0x3b53d9/resultGeojson[_0x285e24(0x19f)][_0x285e24(0x10a)];document[_0x285e24(0x12a)](_0x285e24(0x1af))[_0x285e24(0x169)]=_0x285e24(0x15a)+resultGeojson[_0x285e24(0x19f)][_0x285e24(0x10a)]+_0x285e24(0xf3)+Math[_0x285e24(0xc6)](_0x3b53d9*0x64)/0x64+'\x20sq.m</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<p>Average\x20parcel\x20area:\x20'+Math['round'](_0x4b07b8*0x64)/0x64+_0x285e24(0x1d3)+currentCRS+_0x285e24(0x16a),document[_0x285e24(0x12a)](_0x285e24(0x1af))[_0x285e24(0x195)][_0x285e24(0x14e)]=_0x285e24(0x105),document['getElementById']('processStep2')[_0x285e24(0x15f)]=![],processFlags[_0x285e24(0x15d)]=!![],runningAllSteps&&setTimeout(()=>processStep2(),0x1f4);}function processStep2(){const _0x401d5b=_0x5307db;if(isProcessing){logMessage('Processing\x20already\x20in\x20progress,\x20please\x20wait',_0x401d5b(0x1ac));return;}if(processFlags['step2']){const _0xd5a372=confirm(_0x401d5b(0x1c5));if(!_0xd5a372)return;}if(!buildingGeojson||!parcelGeojson){alert(_0x401d5b(0xde));return;}const _0x3e3ee9=document[_0x401d5b(0x12a)](_0x401d5b(0xd7))[_0x401d5b(0x1ab)];if(!_0x3e3ee9){alert(_0x401d5b(0x19c));return;}currentStep=_0x401d5b(0xf6),batchSize=parseInt(document['getElementById'](_0x401d5b(0x11a))['value'])||0x64,processingDelay=parseInt(document[_0x401d5b(0x12a)](_0x401d5b(0x112))[_0x401d5b(0x1ab)])||0xa;const _0x4e3e08=JSON[_0x401d5b(0x1d1)](JSON[_0x401d5b(0x15b)](buildingGeojson)),_0x2c5095=JSON[_0x401d5b(0x1d1)](JSON[_0x401d5b(0x15b)](parcelGeojson));batchResults=[],currentBatch=0x0;const _0x2e2c1b=_0x4e3e08[_0x401d5b(0x19f)][_0x401d5b(0x10a)];totalBatches=Math[_0x401d5b(0x1c8)](_0x2e2c1b/batchSize),showLoadingIndicator(_0x401d5b(0x14c)),updateProgress(0x0,_0x2e2c1b,_0x401d5b(0x80)),logMessage('Starting\x20step\x202\x20processing\x20-\x20converting\x20'+_0x2e2c1b+_0x401d5b(0xa0)+totalBatches+_0x401d5b(0x110),'info'),batchStats['startTime']=Date[_0x401d5b(0xfc)](),batchStats[_0x401d5b(0xf7)]=_0x2e2c1b,isProcessing=!![],processBatchesStep2(_0x4e3e08,_0x2c5095);}function processBatchesStep2(_0x4f897c,_0x4180f3){const _0x20bab7=_0x5307db;useWebWorkers&&workers[_0x20bab7(0x10a)]>0x0?processBatchesWithWorkers(_0x4f897c[_0x20bab7(0x19f)],_0x4180f3,_0x20bab7(0x13b)):processBatchesInMainThread(_0x4f897c[_0x20bab7(0x19f)],(_0x1a5c3e,_0x1b8736,_0x2fc4a0)=>{const _0x584b72=_0x20bab7;return processBuildingPointsBatch({'buildingBatch':_0x1a5c3e,'parcelGeojson':_0x4180f3,'selectedField':document['getElementById']('parcelFieldSelector')[_0x584b72(0x1ab)],'startIndex':_0x1b8736,'endIndex':_0x2fc4a0});});}function processBuildingPointsBatch(_0x1f04b9){const _0x26ff74=_0x5307db,{buildingBatch:_0x44a805,parcelGeojson:_0x3d0099,selectedField:_0x1ea913,startIndex:_0x5b6a95,endIndex:_0x59036a}=_0x1f04b9,_0xb8e346=[];let _0x4ae795=0x0,_0x11811c=0x0;for(let _0x1b021d=0x0;_0x1b021d<_0x44a805['length'];_0x1b021d++){try{const _0x3776d8=_0x44a805[_0x1b021d],_0xd00d63=_0x5b6a95+_0x1b021d;updateProgress(_0xd00d63,_0x59036a,_0x26ff74(0x194)+(_0xd00d63+0x1)+'/'+_0x59036a);let _0x13529b;if(_0x3776d8[_0x26ff74(0x199)][_0x26ff74(0x1b9)]===_0x26ff74(0x167)){const _0x3194fa=turf[_0x26ff74(0x137)](_0x3776d8);_0x13529b=_0x3194fa[_0x26ff74(0x199)][_0x26ff74(0x1d7)];}else{if(_0x3776d8[_0x26ff74(0x199)]['type']===_0x26ff74(0x136)){const _0x496bf7={'type':_0x26ff74(0x13c),'properties':{},'geometry':{'type':'Polygon','coordinates':_0x3776d8[_0x26ff74(0x199)]['coordinates'][0x0]}},_0x3c3e60=turf[_0x26ff74(0x137)](_0x496bf7);_0x13529b=_0x3c3e60[_0x26ff74(0x199)][_0x26ff74(0x1d7)];}else throw new Error('Unsupported\x20geometry\x20type:\x20'+_0x3776d8['geometry'][_0x26ff74(0x1b9)]);}const _0x3a5077={'type':_0x26ff74(0x13c),'properties':{..._0x3776d8['properties'],'parcelId':null,'parcelName':null,'buildingArea':typeof _0x3776d8[_0x26ff74(0x174)][_0x26ff74(0x19a)]===_0x26ff74(0x1c2)?_0x3776d8[_0x26ff74(0x174)][_0x26ff74(0x19a)]:0x0,'buildingStoreys':typeof _0x3776d8[_0x26ff74(0x174)][_0x26ff74(0x95)]===_0x26ff74(0x1c2)?_0x3776d8['properties'][_0x26ff74(0x95)]:0x1},'geometry':{'type':_0x26ff74(0xa2),'coordinates':_0x13529b}};for(const _0x134371 of _0x3d0099['features']){if(turf['booleanPointInPolygon'](_0x3a5077[_0x26ff74(0x199)]['coordinates'],_0x134371[_0x26ff74(0x199)])){_0x3a5077[_0x26ff74(0x174)]['parcelId']=_0x134371[_0x26ff74(0x174)][_0x1ea913],_0x3a5077['properties']['parcelName']=_0x134371['properties'][_0x1ea913];break;}}_0xb8e346[_0x26ff74(0x109)](_0x3a5077),_0x11811c++;}catch(_0x3f653a){logMessage(_0x26ff74(0xb9)+(_0x5b6a95+_0x1b021d)+':\x20'+_0x3f653a[_0x26ff74(0x94)],'warning'),_0x4ae795++;}}return _0xb8e346;}function finalizeStep2(_0x1f6914){const _0x4c4711=_0x5307db;if(_0x1f6914[_0x4c4711(0x19f)][_0x4c4711(0x10a)]===0x0){alert(_0x4c4711(0x153));return;}layerData['buildingPoints']&&layerData['buildingPoints'][_0x4c4711(0xd4)]&&(map[_0x4c4711(0xe2)](layerData[_0x4c4711(0x8b)][_0x4c4711(0xd4)]),delete layerData['buildingPoints']);addGeoJSONToMap(_0x1f6914,_0x4c4711(0x8b),_0x4c4711(0x196));let _0x290a16=0x0;_0x1f6914[_0x4c4711(0x19f)][_0x4c4711(0xad)](_0x5ef366=>{const _0x73d831=_0x4c4711;_0x5ef366[_0x73d831(0x174)][_0x73d831(0xed)]&&_0x290a16++;});const _0x1ca3c6=document[_0x4c4711(0x12a)](_0x4c4711(0xd7))[_0x4c4711(0x1ab)];document[_0x4c4711(0x12a)]('step2Result')[_0x4c4711(0x169)]=_0x4c4711(0xd2)+_0x1f6914[_0x4c4711(0x19f)][_0x4c4711(0x10a)]+_0x4c4711(0x128)+_0x290a16+'\x20('+Math['round'](_0x290a16/_0x1f6914[_0x4c4711(0x19f)][_0x4c4711(0x10a)]*0x64)+_0x4c4711(0x1d4)+_0x1ca3c6+'</p>\x0a\x20\x20\x20\x20\x20\x20',document[_0x4c4711(0x12a)]('step2Result')[_0x4c4711(0x195)][_0x4c4711(0x14e)]='block',document[_0x4c4711(0x12a)](_0x4c4711(0xa4))[_0x4c4711(0x15f)]=![],processFlags[_0x4c4711(0xf6)]=!![],runningAllSteps&&setTimeout(()=>processStep3(),0x1f4);}function processStep3(){const _0x1d7401=_0x5307db;if(isProcessing){logMessage(_0x1d7401(0xaa),'warning');return;}if(processFlags['step3']){const _0x4ff0eb=confirm('Step\x203\x20has\x20already\x20been\x20completed.\x20Do\x20you\x20want\x20to\x20run\x20it\x20again?');if(!_0x4ff0eb)return;}if(!buildingGeojson||!parcelGeojson){alert(_0x1d7401(0xc0));return;}const _0x254d32=parcelOriginalShapes||parcelGeojson;currentStep=_0x1d7401(0x1b1),batchSize=parseInt(document['getElementById'](_0x1d7401(0x11a))[_0x1d7401(0x1ab)])||0x64,processingDelay=parseInt(document['getElementById'](_0x1d7401(0x112))[_0x1d7401(0x1ab)])||0xa;const _0x266ac5=JSON['parse'](JSON[_0x1d7401(0x15b)](_0x254d32)),_0x35c3c1=JSON[_0x1d7401(0x1d1)](JSON[_0x1d7401(0x15b)](buildingGeojson));batchResults=[],currentBatch=0x0;const _0x360342=_0x266ac5[_0x1d7401(0x19f)][_0x1d7401(0x10a)];totalBatches=Math[_0x1d7401(0x1c8)](_0x360342/batchSize),showLoadingIndicator(_0x1d7401(0xec)),updateProgress(0x0,_0x360342,_0x1d7401(0x90)),logMessage(_0x1d7401(0x104)+_0x360342+_0x1d7401(0x13a)+totalBatches+_0x1d7401(0x110),_0x1d7401(0xcb)),batchStats[_0x1d7401(0xd8)]=Date[_0x1d7401(0xfc)](),batchStats[_0x1d7401(0xf7)]=_0x360342,isProcessing=!![],processBatchesStep3(_0x266ac5,_0x35c3c1);}function processBatchesStep3(_0x2fd91d,_0x27e1f6){const _0x21eab8=_0x5307db;useWebWorkers&&workers[_0x21eab8(0x10a)]>0x0?processBatchesWithWorkers(_0x2fd91d[_0x21eab8(0x19f)],_0x27e1f6,'processBuildingAreas'):processBatchesInMainThread(_0x2fd91d[_0x21eab8(0x19f)],(_0x19dfb9,_0x2aebc3,_0x30bc59)=>{const _0x175910=_0x21eab8;return processBuildingAreasBatch({'parcelBatch':_0x19dfb9,'buildingGeojson':_0x27e1f6,'selectedField':document[_0x175910(0x12a)]('parcelFieldSelector')[_0x175910(0x1ab)],'startIndex':_0x2aebc3,'endIndex':_0x30bc59,'parcelAreaResults':resultGeojson});});}function processBuildingAreasBatch(_0x1a2df9){const _0x5e816f=_0x5307db,{parcelBatch:_0xde6054,buildingGeojson:_0x1af213,selectedField:_0x291fbc,startIndex:_0x2e092c,endIndex:_0x50e266,parcelAreaResults:_0x2cd1f6}=_0x1a2df9,_0x1f8f11=[];for(let _0x3061a8=0x0;_0x3061a8<_0xde6054[_0x5e816f(0x10a)];_0x3061a8++){try{const _0x405145=_0xde6054[_0x3061a8],_0x1ac5b1=_0x2e092c+_0x3061a8;updateProgress(_0x1ac5b1,_0x50e266,_0x5e816f(0x1d9)+(_0x1ac5b1+0x1)+'/'+_0x50e266);const _0x2dbfad=_0x405145[_0x5e816f(0x174)][_0x291fbc];let _0x42c84e=0x0,_0x5ec373=0x0,_0x10f7a5=[];for(let _0xe66f4a=0x0;_0xe66f4a<_0x1af213[_0x5e816f(0x19f)]['length'];_0xe66f4a++){const _0x1f0ab9=_0x1af213['features'][_0xe66f4a];try{let _0x283e0b;if(_0x1f0ab9['geometry'][_0x5e816f(0x1b9)]==='Polygon'){const _0x4c3726=turf[_0x5e816f(0x137)](_0x1f0ab9);_0x283e0b=_0x4c3726[_0x5e816f(0x199)][_0x5e816f(0x1d7)];}else{if(_0x1f0ab9[_0x5e816f(0x199)][_0x5e816f(0x1b9)]===_0x5e816f(0x136)){const _0x3b0eef={'type':_0x5e816f(0x13c),'properties':{},'geometry':{'type':_0x5e816f(0x167),'coordinates':_0x1f0ab9[_0x5e816f(0x199)][_0x5e816f(0x1d7)][0x0]}},_0x3c9095=turf['centroid'](_0x3b0eef);_0x283e0b=_0x3c9095[_0x5e816f(0x199)][_0x5e816f(0x1d7)];}else continue;}if(turf[_0x5e816f(0x150)](_0x283e0b,_0x405145[_0x5e816f(0x199)])){let _0x519aea=0x0,_0x45d791=0x1;if(typeof _0x1f0ab9[_0x5e816f(0x174)][_0x5e816f(0x19a)]===_0x5e816f(0x1c2))_0x519aea=_0x1f0ab9['properties'][_0x5e816f(0x19a)];else typeof _0x1f0ab9[_0x5e816f(0x174)][_0x5e816f(0x19a)]===_0x5e816f(0x1c3)&&(_0x519aea=parseFloat(_0x1f0ab9[_0x5e816f(0x174)][_0x5e816f(0x19a)])||0x0);if(typeof _0x1f0ab9[_0x5e816f(0x174)][_0x5e816f(0x95)]==='number')_0x45d791=_0x1f0ab9[_0x5e816f(0x174)][_0x5e816f(0x95)];else typeof _0x1f0ab9[_0x5e816f(0x174)][_0x5e816f(0x95)]===_0x5e816f(0x1c3)&&(_0x45d791=parseInt(_0x1f0ab9[_0x5e816f(0x174)][_0x5e816f(0x95)])||0x1);_0x519aea=isNaN(_0x519aea)||_0x519aea<0x0?0x0:_0x519aea,_0x45d791=isNaN(_0x45d791)||_0x45d791<0x1?0x1:_0x45d791;const _0x89189f=_0x519aea*_0x45d791;_0x42c84e+=_0x89189f,_0x5ec373++,_0x10f7a5[_0x5e816f(0x109)]({'id':_0xe66f4a,'area':_0x519aea,'storeys':_0x45d791,'totalArea':_0x89189f});}}catch(_0x37eb95){logMessage('Error\x20processing\x20building\x20'+_0xe66f4a+_0x5e816f(0x11b)+_0x1ac5b1+':\x20'+_0x37eb95[_0x5e816f(0x94)],'warning');}}_0x42c84e=Math[_0x5e816f(0xc6)](_0x42c84e*0x64)/0x64;let _0x49f49b=0x0;if(_0x2cd1f6&&_0x2cd1f6['features']){const _0x492fc5=_0x2cd1f6[_0x5e816f(0x19f)]['find'](_0x104691=>_0x104691[_0x5e816f(0x174)][_0x291fbc]===_0x2dbfad);_0x492fc5&&(_0x49f49b=_0x492fc5[_0x5e816f(0x174)][_0x5e816f(0x124)]||0x0);}let _0x32c000=_0x5e816f(0x1d8);_0x10f7a5['forEach'](_0x3ef443=>{const _0x32c493=_0x5e816f;_0x32c000+='Building\x20'+_0x3ef443['id']+':\x20'+_0x3ef443[_0x32c493(0x9e)]+'\x20sq.m\x20×\x20'+_0x3ef443['storeys']+'\x20floors\x20=\x20'+_0x3ef443[_0x32c493(0x139)]+_0x32c493(0x16c);});_0x10f7a5[_0x5e816f(0x10a)]===0x0&&(_0x32c000=_0x5e816f(0x16f));const _0x589b85={'type':_0x5e816f(0x13c),'properties':{..._0x405145['properties'],'totalBuildingArea':_0x42c84e,'buildingCount':_0x5ec373,'parcelArea':_0x49f49b,'calculationDetails':_0x32c000},'geometry':_0x405145[_0x5e816f(0x199)]};_0x1f8f11[_0x5e816f(0x109)](_0x589b85);}catch(_0x3489da){logMessage(_0x5e816f(0x171)+(_0x2e092c+_0x3061a8)+_0x5e816f(0xc2)+_0x3489da[_0x5e816f(0x94)],'error');}}return _0x1f8f11;}function finalizeStep3(_0x20fcb7){const _0x10e0c2=_0x5307db;if(_0x20fcb7['features'][_0x10e0c2(0x10a)]===0x0){alert(_0x10e0c2(0x122));return;}resultGeojson=_0x20fcb7;resultLayer&&(map[_0x10e0c2(0xe2)](resultLayer),delete layerData['parcelsBuildingAreas']);addGeoJSONToMap(resultGeojson,_0x10e0c2(0x10e),'Parcels\x20with\x20Building\x20Areas');let _0x49b4ca=0x0,_0x10209c=0x0,_0x2c9f46=0x0;resultGeojson[_0x10e0c2(0x19f)]['forEach'](_0x219ec0=>{const _0x29cae1=_0x10e0c2,_0x52c1bf=_0x219ec0['properties'][_0x29cae1(0x1d0)]||0x0,_0x501abd=_0x219ec0[_0x29cae1(0x174)][_0x29cae1(0xb3)]||0x0;_0x49b4ca+=_0x52c1bf,_0x10209c+=_0x501abd,_0x52c1bf>0x0&&_0x2c9f46++;}),document['getElementById'](_0x10e0c2(0xa5))[_0x10e0c2(0x169)]=_0x10e0c2(0xa1)+resultGeojson[_0x10e0c2(0x19f)][_0x10e0c2(0x10a)]+_0x10e0c2(0x9a)+_0x2c9f46+_0x10e0c2(0x156)+_0x49b4ca+_0x10e0c2(0x130)+Math[_0x10e0c2(0xc6)](_0x10209c*0x64)/0x64+_0x10e0c2(0xbe)+currentCRS+_0x10e0c2(0x16a),document['getElementById'](_0x10e0c2(0xa5))['style'][_0x10e0c2(0x14e)]=_0x10e0c2(0x105),document[_0x10e0c2(0x12a)](_0x10e0c2(0xa3))['disabled']=![],processFlags[_0x10e0c2(0x1b1)]=!![],runningAllSteps&&setTimeout(()=>processStep4(),0x1f4);}function processStep4(){const _0x4f5c40=_0x5307db;if(isProcessing){logMessage(_0x4f5c40(0xaa),'warning');return;}if(processFlags['step4']){const _0xfe07f=confirm('Step\x204\x20has\x20already\x20been\x20completed.\x20Do\x20you\x20want\x20to\x20run\x20it\x20again?');if(!_0xfe07f)return;}if(!resultGeojson){alert(_0x4f5c40(0x172));return;}currentStep=_0x4f5c40(0x17a),batchSize=parseInt(document[_0x4f5c40(0x12a)](_0x4f5c40(0x11a))[_0x4f5c40(0x1ab)])||0x64,processingDelay=parseInt(document['getElementById'](_0x4f5c40(0x112))[_0x4f5c40(0x1ab)])||0xa;const _0x5b654e=JSON[_0x4f5c40(0x1d1)](JSON[_0x4f5c40(0x15b)](resultGeojson));batchResults=[],currentBatch=0x0;const _0x5f0bcc=_0x5b654e[_0x4f5c40(0x19f)][_0x4f5c40(0x10a)];totalBatches=Math[_0x4f5c40(0x1c8)](_0x5f0bcc/batchSize),showLoadingIndicator(_0x4f5c40(0xae)),updateProgress(0x0,_0x5f0bcc,'Starting\x20FAR\x20calculation...'),logMessage(_0x4f5c40(0xd3)+_0x5f0bcc+'\x20parcels\x20in\x20'+totalBatches+_0x4f5c40(0x110),_0x4f5c40(0xcb)),batchStats[_0x4f5c40(0xd8)]=Date[_0x4f5c40(0xfc)](),batchStats['featureCount']=_0x5f0bcc,isProcessing=!![],processBatchesStep4(_0x5b654e);}function processBatchesStep4(_0x2731b6){const _0x4db300=_0x5307db;useWebWorkers&&workers['length']>0x0?processBatchesWithWorkers(_0x2731b6[_0x4db300(0x19f)],null,_0x4db300(0x8d)):processBatchesInMainThread(_0x2731b6[_0x4db300(0x19f)],(_0x8e4da6,_0x6c1f6e,_0x557eaf)=>{return calculateFARBatch({'parcelBatch':_0x8e4da6,'startIndex':_0x6c1f6e,'endIndex':_0x557eaf});});}function calculateFARBatch(_0x16f240){const _0x3cdb33=_0x5307db,{parcelBatch:_0x2db62c,startIndex:_0x5ed103,endIndex:_0x5a2128}=_0x16f240,_0x46d90e=[];for(let _0x346012=0x0;_0x346012<_0x2db62c[_0x3cdb33(0x10a)];_0x346012++){try{const _0x510803=_0x2db62c[_0x346012],_0x57f652=_0x5ed103+_0x346012;updateProgress(_0x57f652,_0x5a2128,'Calculating\x20FAR\x20for\x20parcel\x20'+(_0x57f652+0x1)+'/'+_0x5a2128);const _0xcffa44=_0x510803['properties'][_0x3cdb33(0xb3)]||0x0,_0x11858c=_0x510803['properties'][_0x3cdb33(0x124)]||0x0;let _0x5ed135=0x0;_0x11858c>0x0&&(_0x5ed135=_0xcffa44/_0x11858c);_0x5ed135=Math[_0x3cdb33(0xc6)](_0x5ed135*0x3e8)/0x3e8;const _0x1a3dd2={'type':'Feature','properties':{..._0x510803['properties'],'FAR':_0x5ed135},'geometry':_0x510803[_0x3cdb33(0x199)]};_0x46d90e['push'](_0x1a3dd2);}catch(_0x1ecd9a){logMessage(_0x3cdb33(0x1ba)+(_0x5ed103+_0x346012)+':\x20'+_0x1ecd9a[_0x3cdb33(0x94)],_0x3cdb33(0x107));}}return _0x46d90e;}function _0x4de3(_0x368788,_0x3fc834){const _0x3a88eb=_0x3a88();return _0x4de3=function(_0x4de387,_0x28364e){_0x4de387=_0x4de387-0x7d;let _0x22908b=_0x3a88eb[_0x4de387];return _0x22908b;},_0x4de3(_0x368788,_0x3fc834);}function finalizeStep4(_0x54ee0b){const _0x3dd645=_0x5307db;if(_0x54ee0b[_0x3dd645(0x19f)][_0x3dd645(0x10a)]===0x0){alert(_0x3dd645(0x132));return;}resultGeojson=_0x54ee0b,window[_0x3dd645(0x1a1)]=_0x54ee0b;resultLayer&&(map[_0x3dd645(0xe2)](resultLayer),delete layerData[_0x3dd645(0x1bf)]);addGeoJSONToMap(resultGeojson,_0x3dd645(0x1bf),_0x3dd645(0x18b));let _0x1a1554=0x0,_0xc30313=0x0,_0x176548=resultGeojson[_0x3dd645(0x19f)]['length'],_0x345178=0x0,_0x2fe7d8=[];resultGeojson[_0x3dd645(0x19f)][_0x3dd645(0xad)](_0x5b72e8=>{const _0xf8d23b=_0x3dd645;_0x5b72e8[_0xf8d23b(0x174)][_0xf8d23b(0x124)]>0x0&&(_0x1a1554+=_0x5b72e8[_0xf8d23b(0x174)][_0xf8d23b(0x124)],_0xc30313+=_0x5b72e8['properties'][_0xf8d23b(0xb3)]||0x0,_0x5b72e8[_0xf8d23b(0x174)]['FAR']!==undefined&&_0x5b72e8['properties'][_0xf8d23b(0xb3)]>0x0&&_0x2fe7d8[_0xf8d23b(0x109)](_0x5b72e8[_0xf8d23b(0x174)][_0xf8d23b(0x17e)]),_0x345178++);});const _0x2e38f0=_0x2fe7d8['length']>0x0?_0x2fe7d8['reduce']((_0x37a812,_0x1fc07d)=>_0x37a812+_0x1fc07d,0x0)/_0x2fe7d8[_0x3dd645(0x10a)]:0x0,_0x542a02=_0x2fe7d8['length']>0x0?Math[_0x3dd645(0x1c4)](..._0x2fe7d8):0x0,_0x571677=_0x2fe7d8[_0x3dd645(0x10a)]>0x0?Math[_0x3dd645(0x14d)](..._0x2fe7d8):0x0;document[_0x3dd645(0x12a)]('step4Result')[_0x3dd645(0x169)]=_0x3dd645(0x7d)+resultGeojson[_0x3dd645(0x19f)]['length']+_0x3dd645(0x191)+_0x176548+_0x3dd645(0x192)+_0x345178+_0x3dd645(0x188)+Math['round'](_0x1a1554*0x64)/0x64+_0x3dd645(0x184)+Math[_0x3dd645(0xc6)](_0xc30313*0x64)/0x64+'\x20sq.m</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<p><strong>Average\x20FAR:</strong>\x20'+Math[_0x3dd645(0xc6)](_0x2e38f0*0x3e8)/0x3e8+_0x3dd645(0xf4)+Math['round'](_0x542a02*0x3e8)/0x3e8+'</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<p><strong>Minimum\x20FAR:</strong>\x20'+Math['round'](_0x571677*0x3e8)/0x3e8+'</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<p>CRS:\x20'+currentCRS+'</p>\x0a\x20\x20\x20\x20\x20\x20',document[_0x3dd645(0x12a)](_0x3dd645(0xc9))[_0x3dd645(0x195)][_0x3dd645(0x14e)]=_0x3dd645(0x105),document[_0x3dd645(0x12a)](_0x3dd645(0x146))[_0x3dd645(0x15f)]=![],document['getElementById'](_0x3dd645(0x13e))['disabled']=![],processFlags[_0x3dd645(0x17a)]=!![],runningAllSteps&&(runningAllSteps=![],logMessage(_0x3dd645(0x88),_0x3dd645(0xcb)));}let runningAllSteps=![];function runAllSteps(){const _0x57b1e0=_0x5307db;if(isProcessing){logMessage('Processing\x20already\x20in\x20progress,\x20please\x20wait',_0x57b1e0(0x1ac));return;}if(!buildingGeojson||!parcelGeojson){alert(_0x57b1e0(0x84));return;}const _0x3c8e01=document[_0x57b1e0(0x12a)](_0x57b1e0(0xd7))[_0x57b1e0(0x1ab)];if(!_0x3c8e01){alert(_0x57b1e0(0x19c));return;}if(processFlags[_0x57b1e0(0x15d)]||processFlags[_0x57b1e0(0xf6)]||processFlags['step3']||processFlags['step4']){const _0x530982=confirm('Some\x20steps\x20have\x20already\x20been\x20completed.\x20Do\x20you\x20want\x20to\x20run\x20all\x20steps\x20again?');if(!_0x530982)return;}runningAllSteps=!![],processStep1();}function showLoadingIndicator(_0x32e304){const _0x33a22d=_0x5307db,_0x5bea36=document[_0x33a22d(0x12a)](_0x33a22d(0x92)),_0x1f237=document[_0x33a22d(0x12a)](_0x33a22d(0x135));_0x32e304?_0x1f237[_0x33a22d(0x12c)]=':\x20'+_0x32e304:_0x1f237[_0x33a22d(0x12c)]='',_0x5bea36[_0x33a22d(0x195)][_0x33a22d(0x14e)]=_0x33a22d(0x105),document[_0x33a22d(0x12a)]('progressBar')['style'][_0x33a22d(0x116)]='0%';}function hideLoadingIndicator(){const _0x4455ca=_0x5307db;document[_0x4455ca(0x12a)](_0x4455ca(0x92))[_0x4455ca(0x195)][_0x4455ca(0x14e)]=_0x4455ca(0xc7);}function updateProgress(_0x13bfbb,_0x46b486,_0xa53111){const _0x34c947=_0x5307db,_0x7be8d3=Math[_0x34c947(0x14d)](0x64,Math['round'](_0x13bfbb/_0x46b486*0x64));document[_0x34c947(0x12a)](_0x34c947(0x1b3))[_0x34c947(0x195)]['width']=_0x7be8d3+'%',_0xa53111&&(document[_0x34c947(0x12a)]('processingStatus')[_0x34c947(0x12c)]=':\x20'+_0xa53111);}function logMessage(_0x242c21,_0x3bda89=_0x5307db(0xcb)){const _0x3d7663=_0x5307db,_0xbdf4dc=new Date(),_0x39d5e7=_0xbdf4dc[_0x3d7663(0x12b)](),_0x3bb11e=document[_0x3d7663(0x163)]('div');_0x3bb11e[_0x3d7663(0xda)]='log-entry\x20log-'+_0x3bda89,_0x3bb11e[_0x3d7663(0x12c)]='['+_0x39d5e7+']\x20'+_0x242c21;const _0x2a9706=document[_0x3d7663(0x12a)]('logContent');_0x2a9706['appendChild'](_0x3bb11e),_0x2a9706[_0x3d7663(0x1a6)]=_0x2a9706[_0x3d7663(0x151)];switch(_0x3bda89){case'error':console[_0x3d7663(0x107)](_0x242c21);break;case _0x3d7663(0x1ac):console[_0x3d7663(0x1c7)](_0x242c21);break;default:console[_0x3d7663(0xfa)](_0x242c21);}}function exportResult(){const _0x2093b4=_0x5307db;if(!window['finalResultGeojson']){alert(_0x2093b4(0x134));return;}const _0x5b91fc=JSON[_0x2093b4(0x1d1)](JSON[_0x2093b4(0x15b)](window[_0x2093b4(0x1a1)]));parcelGeojson&&parcelGeojson['crs']?_0x5b91fc[_0x2093b4(0x1bc)]=parcelGeojson['crs']:_0x5b91fc[_0x2093b4(0x1bc)]={'type':'name','properties':{'name':currentCRS}};_0x5b91fc[_0x2093b4(0x174)]=_0x5b91fc[_0x2093b4(0x174)]||{},_0x5b91fc[_0x2093b4(0x174)][_0x2093b4(0x1da)]=_0x2093b4(0x159),_0x5b91fc[_0x2093b4(0x174)][_0x2093b4(0xb7)]=new Date()[_0x2093b4(0x9b)](),_0x5b91fc[_0x2093b4(0x174)]['originalCRS']=currentCRS;const _0xf5a33=new Blob([JSON[_0x2093b4(0x15b)](_0x5b91fc)],{'type':_0x2093b4(0xe1)}),_0x1b0db5=URL[_0x2093b4(0x108)](_0xf5a33),_0xfafb9e=document['createElement']('a');_0xfafb9e[_0x2093b4(0x1a9)]=_0x1b0db5,_0xfafb9e[_0x2093b4(0xd5)]=_0x2093b4(0x118),document[_0x2093b4(0x99)][_0x2093b4(0x123)](_0xfafb9e),_0xfafb9e[_0x2093b4(0x1db)](),document[_0x2093b4(0x99)][_0x2093b4(0xa8)](_0xfafb9e),URL['revokeObjectURL'](_0x1b0db5),logMessage('Exported\x20GeoJSON\x20result\x20successfully',_0x2093b4(0xcb));}function exportExcel(){const _0xd1147b=_0x5307db;if(!window[_0xd1147b(0x1a1)]){alert('Please\x20complete\x20step\x204\x20first.');return;}const _0x1e5126=document[_0xd1147b(0x12a)](_0xd1147b(0x131))[_0xd1147b(0x1ab)],_0x42724a=document['getElementById']('parcelFieldSelector')[_0xd1147b(0x1ab)]||'ID',_0x10f3a9=XLSX['utils'][_0xd1147b(0x1bd)](),_0x342842=window[_0xd1147b(0x1a1)][_0xd1147b(0x19f)][_0xd1147b(0x18e)](_0x40e99d=>{const _0x5068a5=_0xd1147b;return{[_0x42724a]:_0x40e99d[_0x5068a5(0x174)][_0x42724a],'Parcel\x20Area\x20(sq.m)':_0x40e99d[_0x5068a5(0x174)][_0x5068a5(0x124)],'Total\x20Building\x20Area\x20(sq.m)':_0x40e99d['properties']['totalBuildingArea'],'FAR':_0x40e99d['properties'][_0x5068a5(0x17e)],'Building\x20Count':_0x40e99d[_0x5068a5(0x174)][_0x5068a5(0x1d0)]||0x0};});let _0x54bd62=_0x342842[_0xd1147b(0x12f)](_0x515608=>_0x515608['Parcel\x20Area\x20(sq.m)']>0x0)[_0xd1147b(0x18e)](_0x34250b=>_0x34250b[_0xd1147b(0x17e)]);const _0x2c82bc=_0x54bd62[_0xd1147b(0x10a)]>0x0?_0x54bd62[_0xd1147b(0x18d)]((_0xc11c3a,_0x494c4d)=>_0xc11c3a+_0x494c4d,0x0)/_0x54bd62[_0xd1147b(0x10a)]:0x0,_0x438ac8=_0x54bd62[_0xd1147b(0x10a)]>0x0?Math['max'](..._0x54bd62):0x0,_0xe8ba5c=_0x54bd62[_0xd1147b(0x10a)]>0x0?Math[_0xd1147b(0x14d)](..._0x54bd62):0x0;_0x342842[_0xd1147b(0x109)]({}),_0x342842['push']({[_0x42724a]:_0xd1147b(0xcc)}),_0x342842[_0xd1147b(0x109)]({[_0x42724a]:_0xd1147b(0xe4),'FAR':Math[_0xd1147b(0xc6)](_0x2c82bc*0x3e8)/0x3e8}),_0x342842[_0xd1147b(0x109)]({[_0x42724a]:'Maximum\x20FAR','FAR':Math[_0xd1147b(0xc6)](_0x438ac8*0x3e8)/0x3e8}),_0x342842[_0xd1147b(0x109)]({[_0x42724a]:'Minimum\x20FAR','FAR':Math['round'](_0xe8ba5c*0x3e8)/0x3e8}),_0x342842[_0xd1147b(0x109)]({}),_0x342842[_0xd1147b(0x109)]({[_0x42724a]:'PROCESSING\x20INFORMATION'}),_0x342842[_0xd1147b(0x109)]({[_0x42724a]:_0xd1147b(0xcd),'FAR':_0x1e5126}),_0x342842[_0xd1147b(0x109)]({[_0x42724a]:_0xd1147b(0x115),'FAR':new Date()[_0xd1147b(0x142)]()});const _0x3c466e=XLSX[_0xd1147b(0x170)][_0xd1147b(0x106)](_0x342842);XLSX[_0xd1147b(0x170)][_0xd1147b(0x10f)](_0x10f3a9,_0x3c466e,'FAR\x20Analysis'),XLSX[_0xd1147b(0x1ad)](_0x10f3a9,_0xd1147b(0x1b4)+_0x1e5126[_0xd1147b(0x7f)](':','_')+_0xd1147b(0x10b)),logMessage(_0xd1147b(0x1ce),_0xd1147b(0xcb));}function init(){const _0x51e504=_0x5307db;createWorkers(),initMap(),document['getElementById']('coordSystem')['addEventListener'](_0x51e504(0x82),function(){initMap();}),document[_0x51e504(0x12a)](_0x51e504(0xee))['addEventListener'](_0x51e504(0x82),function(){const _0x29ca45=_0x51e504;handleFileUpload(this,_0x29ca45(0xb5));}),document[_0x51e504(0x12a)](_0x51e504(0x11e))['addEventListener'](_0x51e504(0x82),function(){const _0x45d15d=_0x51e504;handleFileUpload(this,_0x45d15d(0x147));}),document[_0x51e504(0x12a)](_0x51e504(0x141))[_0x51e504(0x16b)]('click',processStep1),document[_0x51e504(0x12a)](_0x51e504(0x111))['addEventListener']('click',processStep2),document[_0x51e504(0x12a)](_0x51e504(0xa4))['addEventListener'](_0x51e504(0x1db),processStep3),document[_0x51e504(0x12a)](_0x51e504(0xa3))[_0x51e504(0x16b)](_0x51e504(0x1db),processStep4),document[_0x51e504(0x12a)](_0x51e504(0x146))['addEventListener'](_0x51e504(0x1db),exportResult),document[_0x51e504(0x12a)](_0x51e504(0x13e))['addEventListener'](_0x51e504(0x1db),exportExcel),document['getElementById'](_0x51e504(0xe0))[_0x51e504(0x16b)](_0x51e504(0x1db),runAllSteps),document[_0x51e504(0x12a)](_0x51e504(0x1be))[_0x51e504(0x16b)](_0x51e504(0x82),function(){const _0x17b1f6=_0x51e504;displayAttributes(this[_0x17b1f6(0x1ab)]);}),document[_0x51e504(0x12a)](_0x51e504(0x15c))[_0x51e504(0x16b)]('change',function(){const _0x47307a=_0x51e504;useWebWorkers=this[_0x47307a(0xb8)],useWebWorkers?createWorkers():terminateWorkers(),logMessage('Web\x20Workers\x20'+(useWebWorkers?_0x47307a(0xe7):_0x47307a(0x15f)),_0x47307a(0xcb));}),document['getElementById'](_0x51e504(0x148))[_0x51e504(0x16b)](_0x51e504(0x1db),function(){const _0x14205c=_0x51e504,_0x1db109=document[_0x14205c(0x12a)]('logContainer');_0x1db109[_0x14205c(0x195)][_0x14205c(0x14e)]===_0x14205c(0xc7)?(_0x1db109['style'][_0x14205c(0x14e)]='block',this[_0x14205c(0x169)]='<i\x20class=\x22fas\x20fa-times\x22></i>'):(_0x1db109['style'][_0x14205c(0x14e)]=_0x14205c(0xc7),this['innerHTML']=_0x14205c(0x120));}),document['getElementById'](_0x51e504(0x141))[_0x51e504(0x15f)]=!![],document[_0x51e504(0x12a)]('processStep2')[_0x51e504(0x15f)]=!![],document[_0x51e504(0x12a)](_0x51e504(0xa4))[_0x51e504(0x15f)]=!![],document[_0x51e504(0x12a)](_0x51e504(0xa3))[_0x51e504(0x15f)]=!![],document[_0x51e504(0x12a)](_0x51e504(0x146))[_0x51e504(0x15f)]=!![],document[_0x51e504(0x12a)]('exportExcelButton')[_0x51e504(0x15f)]=!![],document[_0x51e504(0x12a)](_0x51e504(0xe0))[_0x51e504(0x15f)]=!![],logMessage(_0x51e504(0xa6),_0x51e504(0xcb)),logMessage('Using\x20'+currentCRS+_0x51e504(0x10c),_0x51e504(0xcb));}window[_0x5307db(0x179)]=init;
  </script>
  <script data-goatcounter="https://mponline.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
</body>
</html>