<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Building Coverage Ratio Web App</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <style>
    html, body, #mapDiv {
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
    }
    #controlPanel {
      position: absolute;
      top: 20px;
      right: 20px;
      padding: 15px;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      max-width: 350px;
      z-index: 1000;
      max-height: 80vh;
      overflow-y: auto;
    }
    #layerPanel {
      position: absolute;
      top: 20px;
      left: 20px;
      padding: 15px;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      max-width: 300px;
      z-index: 1000;
    }
    #processingConfigPanel {
      position: absolute;
      bottom: 20px;
      left: 20px;
      padding: 15px;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      max-width: 300px;
      z-index: 1000;
    }
    .button {
      margin-top: 10px;
      padding: 8px 12px;
      background-color: #0079c1;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      width: 100%;
    }
    .button:hover {
      background-color: #005e95;
    }
    .button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    .file-input-container {
      margin-bottom: 10px;
    }
    .field-selector {
      margin-top: 10px;
      width: 100%;
    }
    .result-info {
      margin-top: 15px;
      padding: 10px;
      background-color: #f8f8f8;
      border-radius: 4px;
      font-size: 14px;
    }
    .loading {
      display: none;
      margin-top: 15px;
      text-align: center;
    }
    .progress-container {
      width: 100%;
      background-color: #f3f3f3;
      margin-top: 5px;
      border-radius: 4px;
      overflow: hidden;
    }
    .progress-bar {
      height: 10px;
      background-color: #0079c1;
      width: 0%;
      transition: width 0.3s;
    }
    .layer-item {
      margin-bottom: 8px;
      display: flex;
      align-items: center;
    }
    .layer-toggle {
      margin-right: 8px;
    }
    .layer-label {
      font-size: 14px;
      cursor: pointer;
    }
    .attribute-table {
      margin-top: 15px;
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    .attribute-table th, .attribute-table td {
      border: 1px solid #ddd;
      padding: 6px;
      text-align: left;
    }
    .attribute-table th {
      background-color: #f2f2f2;
    }
    .attribute-panel {
      margin-top: 15px;
      padding: 8px;
      background-color: #f8f8f8;
      border-radius: 4px;
      max-height: 300px;
      overflow-y: auto;
    }
    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .panel-title {
      font-weight: bold;
      margin: 0;
    }
    hr {
      margin: 15px 0;
      border: 0;
      border-top: 1px solid #ddd;
    }
    .info-popup {
      max-height: 200px;
      overflow-y: auto;
    }
    .crs-selector {
      margin-top: 10px;
      margin-bottom: 5px;
    }
    .export-options {
      display: flex;
      justify-content: space-between;
      gap: 10px;
    }
    .export-button {
      flex: 1;
    }
    .home-button {
      position: absolute;
      top: 15px;
      right: 15px;
      z-index: 1001;
    }
    .home-button a {
      display: block;
      padding: 8px;
      color: #0079c1;
      background-color: white;
      border-radius: 50%;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      text-decoration: none;
      text-align: center;
    }
    .home-button a:hover {
      background-color: #f0f0f0;
    }
    .home-button i {
      font-size: 18px;
    }
    .config-item {
      margin-bottom: 10px;
    }
    .config-label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    .log-container {
      background-color: #f8f8f8;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 10px;
      max-height: 200px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 12px;
      margin-top: 10px;
    }
    .log-entry {
      margin-bottom: 4px;
      word-wrap: break-word;
    }
    .log-info {
      color: #0079c1;
    }
    .log-warning {
      color: #ff9800;
    }
    .log-error {
      color: #f44336;
    }
    .toggle-label {
      display: flex;
      align-items: center;
      cursor: pointer;
    }
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 40px;
      height: 20px;
      margin-right: 8px;
    }
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 20px;
    }
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 2px;
      bottom: 2px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    input:checked + .toggle-slider {
      background-color: #0079c1;
    }
    input:checked + .toggle-slider:before {
      transform: translateX(20px);
    }
  </style>
</head>
<body>
  <div id="mapDiv"></div>
  
  <!-- Main Control Panel -->
  <div id="controlPanel">
    <div class="panel-header">
      <h2 class="panel-title">Building Coverage Ratio Web App</h2>
      <div class="home-button">
        <a href="page11.html" title="Back to Main Page">
          <i class="fas fa-home"></i>
        </a>
      </div>
    </div>
    
    <div class="crs-selector">
      <label for="coordSystem">Coordinate Reference System:</label>
      <select id="coordSystem" class="field-selector">
        <option value="EPSG:4326">EPSG:4326 (WGS84)</option>
        <option value="EPSG:32647">EPSG:32647 (UTM Zone 47N)</option>
        <option value="EPSG:32648">EPSG:32648 (UTM Zone 48N)</option>
      </select>
    </div>
    
    <div class="file-input-container">
      <label for="buildingFile">1. Upload Building GeoJSON:</label>
      <input type="file" id="buildingFile" accept=".geojson,.json">
      <div id="buildingStatus"></div>
    </div>
    
    <div class="file-input-container">
      <label for="parcelFile">2. Upload Land Parcel GeoJSON:</label>
      <input type="file" id="parcelFile" accept=".geojson,.json">
      <div id="parcelStatus"></div>
    </div>
    
    <div id="fieldSelectorContainer" style="display:none;">
      <label for="parcelFieldSelector">Select Parcel Identifier Field:</label>
      <select id="parcelFieldSelector" class="field-selector"></select>
    </div>
    
    <button id="processStep1" class="button" disabled>3.1 Calculate Parcel Area</button>
    <div id="step1Result" class="result-info" style="display:none;"></div>
    
    <button id="processStep2" class="button" disabled>3.2 Extract Parcel Information</button>
    <div id="step2Result" class="result-info" style="display:none;"></div>
    
    <button id="processStep3" class="button" disabled>3.3 Calculate Total Building Coverage Area</button>
    <div id="step3Result" class="result-info" style="display:none;"></div>
    
    <button id="processStep4" class="button" disabled>3.4 Calculate BCR</button>
    <div id="step4Result" class="result-info" style="display:none;"></div>
    
    <div class="export-options">
      <button id="exportButton" class="button export-button" disabled>4.1 Export as GeoJSON</button>
      <button id="exportExcelButton" class="button export-button" disabled>4.2 Export as Excel</button>
    </div>
    
    <div id="loadingIndicator" class="loading">
      <i class="fas fa-cog fa-spin"></i> Processing...<span id="processingStatus"></span>
      <div class="progress-container">
        <div id="progressBar" class="progress-bar"></div>
      </div>
    </div>
    
    <hr>
    
    <!-- Attribute Viewer Section -->
    <div class="panel-header">
      <h3 class="panel-title">Attribute Viewer</h3>
    </div>
    
    <div>
      <label for="layerSelect">Select Layer for Attributes:</label>
      <select id="layerSelect" class="field-selector">
        <option value="">-- Select a layer --</option>
      </select>
    </div>
    
    <div id="attributePanel" class="attribute-panel" style="display:none;">
      <div id="attributeContent"></div>
    </div>
  </div>
  
  <!-- Layer Control Panel -->
  <div id="layerPanel">
    <div class="panel-header">
      <h3 class="panel-title">Map Layers</h3>
    </div>
    <div id="layerList">
      <!-- Layer toggles will be added here dynamically -->
      <div class="layer-item">
        <span class="layer-label">No layers available</span>
      </div>
    </div>
  </div>
  
  <!-- Processing Configuration Panel -->
  <div id="processingConfigPanel">
    <div class="panel-header">
      <h3 class="panel-title">Processing Settings</h3>
      <button id="toggleLogButton" class="button" style="width: auto; padding: 4px 8px; margin: 0;">
        <i class="fas fa-list"></i>
      </button>
    </div>
    
    <div class="config-item">
      <label class="toggle-label">
        <span class="toggle-switch">
          <input type="checkbox" id="useWebWorkers" checked>
          <span class="toggle-slider"></span>
        </span>
        Use Web Workers
      </label>
    </div>
    
    <div class="config-item">
      <label for="batchSize" class="config-label">Batch Size:</label>
      <input type="number" id="batchSize" min="10" max="500" value="100" class="field-selector">
    </div>
    
    <div class="config-item">
      <label for="processingDelay" class="config-label">Processing Delay (ms):</label>
      <input type="number" id="processingDelay" min="0" max="1000" value="10" class="field-selector">
      <small>Delay between batches to allow UI updates</small>
    </div>
    
    <div class="config-item">
      <button id="runAllSteps" class="button">Run All Steps</button>
    </div>
    
    <div id="logContainer" class="log-container" style="display: none;">
      <div id="logContent"></div>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
  <!-- Turf.js for geometry operations -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Turf.js/6.5.0/turf.min.js"></script>
  <!-- Proj4js for coordinate transformations -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js"></script>
  <!-- Proj4Leaflet for CRS handling in Leaflet -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4leaflet/1.0.2/proj4leaflet.min.js"></script>
  <!-- Esri Leaflet for ESRI basemaps -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/esri-leaflet/3.0.10/esri-leaflet.js"></script>
  <!-- SheetJS (XLSX) for Excel export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
  <!-- Web Worker Script (Created dynamically) -->
  <script id="workerScript" type="text/worker-script">
    // Import libraries via importScripts
    importScripts('https://cdnjs.cloudflare.com/ajax/libs/Turf.js/6.5.0/turf.min.js');
    importScripts('https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js');
    
    // Define UTM zone projections
    proj4.defs("EPSG:32647", "+proj=utm +zone=47 +datum=WGS84 +units=m +no_defs");
    proj4.defs("EPSG:32648", "+proj=utm +zone=48 +datum=WGS84 +units=m +no_defs");
    
    // Function to transform coordinates between CRS
    function transformCoords(coords, fromCRS, toCRS) {
      if (fromCRS === toCRS) {
        return coords;
      }
      return proj4(fromCRS, toCRS, coords);
    }
    
    // Shoelace formula for calculating polygon area
    function polygonArea(coords) {
      let area = 0;
      const numPoints = coords.length;
      
      if (numPoints < 3) {
        return 0;
      }
      
      for (let i = 0; i < numPoints - 1; i++) {
        area += coords[i][0] * coords[i+1][1] - coords[i+1][0] * coords[i][1];
      }
      
      // Close the polygon
      area += coords[numPoints-1][0] * coords[0][1] - coords[0][0] * coords[numPoints-1][1];
      
      // Return absolute value of area
      return Math.abs(area / 2);
    }
    
    // Function to calculate area in UTM coordinates
    function calculateAreaUTM(geometry, crs) {
      // For UTM coordinates, we can calculate area directly
      let area = 0;
      
      if (geometry.type === 'Polygon') {
        // Calculate polygon area using Shoelace formula (Gauss's Area formula)
        area = polygonArea(geometry.coordinates[0]);
      } else if (geometry.type === 'MultiPolygon') {
        // Calculate area for each polygon and sum them
        for (const polygon of geometry.coordinates) {
          area += polygonArea(polygon[0]); // Outer ring
          
          // Subtract area of inner rings (holes)
          for (let i = 1; i < polygon.length; i++) {
            area -= polygonArea(polygon[i]);
          }
        }
      }
      
      return Math.abs(area); // Ensure positive area
    }
    
    // Function to calculate centroid of a polygon
    function calculateCentroid(coords) {
      let sumX = 0;
      let sumY = 0;
      
      for (let i = 0; i < coords.length; i++) {
        sumX += coords[i][0];
        sumY += coords[i][1];
      }
      
      return [sumX / coords.length, sumY / coords.length];
    }
    
    // Process batches of parcel areas for step 1
    function processParcelAreaBatch(batchData) {
      const { 
        parcelBatch, 
        selectedCRS, 
        startIndex, 
        endIndex
      } = batchData;
      
      const processedParcels = [];
      
      for (let i = 0; i < parcelBatch.length; i++) {
        try {
          const parcel = parcelBatch[i];
          const parcelIndex = startIndex + i;
          
          // Log progress
          self.postMessage({
            type: 'progress',
            message: `Processing parcel ${parcelIndex + 1}/${endIndex}`,
            index: parcelIndex,
            total: endIndex
          });
          
          let area;
          
          // Calculate area using appropriate method based on CRS
          if (selectedCRS === 'EPSG:4326') {
            // For WGS84, use Turf.js area calculation (uses Haversine)
            area = turf.area(parcel);
          } else {
            // For UTM, use native area calculation (much more accurate for projected coordinates)
            area = calculateAreaUTM(parcel.geometry, selectedCRS);
          }
          
          self.postMessage({
            type: 'log',
            level: 'info',
            message: `Parcel ${parcelIndex}: Area = ${area.toFixed(2)} sq.m`
          });
          
          // Create feature with calculated area
          const processedParcel = {
            type: "Feature",
            properties: {
              ...parcel.properties,
              parcelArea: Math.round(area * 100) / 100
            },
            geometry: parcel.geometry
          };
          
          processedParcels.push(processedParcel);
        } catch (error) {
          self.postMessage({
            type: 'log',
            level: 'error',
            message: `Error processing parcel ${startIndex + i}: ${error.message}`
          });
        }
      }
      
      return processedParcels;
    }
    
    // Process building points batch for step 2
    function processBuildingPointsBatch(batchData) {
      const {
        buildingBatch,
        parcelGeojson,
        selectedField,
        startIndex,
        endIndex
      } = batchData;
      
      const buildingPoints = [];
      let errorCount = 0;
      let successCount = 0;
      
      for (let i = 0; i < buildingBatch.length; i++) {
        try {
          const building = buildingBatch[i];
          const buildingIndex = startIndex + i;
          
          // Log progress
          self.postMessage({
            type: 'progress',
            message: `Processing building ${buildingIndex + 1}/${endIndex}`,
            index: buildingIndex,
            total: endIndex
          });
          
          // Get coordinates of building center
          let centerCoords;
          
          if (building.geometry.type === "Polygon") {
            // Calculate centroid using turf.js
            const centroid = turf.centroid(building);
            centerCoords = centroid.geometry.coordinates;
          } else if (building.geometry.type === "MultiPolygon") {
            // For multipolygon, use the first polygon's centroid
            const firstPolygon = {
              type: "Feature",
              properties: {},
              geometry: {
                type: "Polygon",
                coordinates: building.geometry.coordinates[0]
              }
            };
            const centroid = turf.centroid(firstPolygon);
            centerCoords = centroid.geometry.coordinates;
          } else {
            throw new Error(`Unsupported geometry type: ${building.geometry.type}`);
          }
          
          // Create a point feature
          const pointFeature = {
            type: "Feature",
            properties: {
              ...building.properties,
              parcelId: null,
              parcelName: null,
              buildingArea: typeof building.properties.BL_AREA === 'number' ? building.properties.BL_AREA : 0
            },
            geometry: {
              type: "Point",
              coordinates: centerCoords
            }
          };
          
          // Find which parcel this building belongs to
          for (const parcel of parcelGeojson.features) {
            // Check if point is within the parcel
            if (turf.booleanPointInPolygon(pointFeature.geometry.coordinates, parcel.geometry)) {
              // Add parcel information to the building point
              pointFeature.properties.parcelId = parcel.properties[selectedField];
              pointFeature.properties.parcelName = parcel.properties[selectedField];
              break;
            }
          }
          
          buildingPoints.push(pointFeature);
          successCount++;
        } catch (error) {
          self.postMessage({
            type: 'log',
            level: 'warning',
            message: `Error creating point for building ${startIndex + i}: ${error.message}`
          });
          errorCount++;
        }
      }
      
      self.postMessage({
        type: 'log',
        level: 'info',
        message: `Batch processed. Success: ${successCount}, Failed: ${errorCount}`
      });
      
      return buildingPoints;
    }
    
    // Process building areas by parcel for step 3
    function processBuildingAreasBatch(batchData) {
      const {
        parcelBatch,
        buildingGeojson,
        selectedField,
        startIndex,
        endIndex,
        parcelAreaResults
      } = batchData;
      
      const processedParcels = [];
      
      for (let i = 0; i < parcelBatch.length; i++) {
        try {
          const parcel = parcelBatch[i];
          const parcelIndex = startIndex + i;
          
          // Log progress
          self.postMessage({
            type: 'progress',
            message: `Processing parcel ${parcelIndex + 1}/${endIndex}`,
            index: parcelIndex,
            total: endIndex
          });
          
          const parcelId = parcel.properties[selectedField];
          let totalBuildingArea = 0;
          let buildingCount = 0;
          let buildingList = [];
          
          // Find all buildings within this parcel
          for (let j = 0; j < buildingGeojson.features.length; j++) {
            const building = buildingGeojson.features[j];
            
            try {
              // Get building center
              let center;
              
              if (building.geometry.type === "Polygon") {
                const centroid = turf.centroid(building);
                center = centroid.geometry.coordinates;
              } else if (building.geometry.type === "MultiPolygon") {
                const firstPolygon = {
                  type: "Feature",
                  properties: {},
                  geometry: {
                    type: "Polygon",
                    coordinates: building.geometry.coordinates[0]
                  }
                };
                const centroid = turf.centroid(firstPolygon);
                center = centroid.geometry.coordinates;
              } else {
                continue; // Skip this building due to unsupported geometry
              }
              
              // Check if this building is within the parcel
              if (turf.booleanPointInPolygon(center, parcel.geometry)) {
                // Get building properties with proper validation
                let area = 0;
                
                if (typeof building.properties.BL_AREA === 'number') {
                  area = building.properties.BL_AREA;
                } else if (typeof building.properties.BL_AREA === 'string') {
                  area = parseFloat(building.properties.BL_AREA) || 0;
                }
                
                // Make sure we have valid values (not NaN, not negative)
                area = isNaN(area) || area < 0 ? 0 : area;
                
                // For BCR we only use the building footprint area
                const buildingFootprintArea = area;
                
                // Add to totals
                totalBuildingArea += buildingFootprintArea;
                buildingCount++;
                
                // Add to building details
                buildingList.push({
                  id: j,
                  area: area,
                  footprintArea: buildingFootprintArea
                });
              }
            } catch (error) {
              self.postMessage({
                type: 'log',
                level: 'warning', 
                message: `Error processing building ${j} for parcel ${parcelIndex}: ${error.message}`
              });
            }
          }
          
          // Round to 2 decimal places for display
          totalBuildingArea = Math.round(totalBuildingArea * 100) / 100;
          
          // Find parcel area from step 1 results
          let parcelArea = 0;
          
          if (parcelAreaResults && parcelAreaResults.features) {
            const parcelAreaFeature = parcelAreaResults.features.find(f => 
              f.properties[selectedField] === parcelId
            );
            
            if (parcelAreaFeature) {
              parcelArea = parcelAreaFeature.properties.parcelArea || 0;
            }
          }
          
          // Create calculation details string
          let calculationDetails = "Buildings calculation details:\n";
          buildingList.forEach(building => {
            calculationDetails += `Building ${building.id}: ${building.area} sq.m footprint area\n`;
          });
          
          if (buildingList.length === 0) {
            calculationDetails = "No buildings found in this parcel";
          }
          
          // Create processed parcel with all the data
          const processedParcel = {
            type: "Feature",
            properties: {
              ...parcel.properties,
              totalBuildingArea: totalBuildingArea,
              buildingCount: buildingCount,
              parcelArea: parcelArea,
              calculationDetails: calculationDetails
            },
            geometry: parcel.geometry
          };
          
          processedParcels.push(processedParcel);
        } catch (error) {
          self.postMessage({
            type: 'log',
            level: 'error',
            message: `Error processing parcel ${startIndex + i} for building areas: ${error.message}`
          });
        }
      }
      
      return processedParcels;
    }
    
    // Calculate BCR for parcels in step 4
    function calculateBCRBatch(batchData) {
      const {
        parcelBatch,
        startIndex,
        endIndex
      } = batchData;
      
      const processedParcels = [];
      
      for (let i = 0; i < parcelBatch.length; i++) {
        try {
          const parcel = parcelBatch[i];
          const parcelIndex = startIndex + i;
          
          // Log progress
          self.postMessage({
            type: 'progress',
            message: `Calculating BCR for parcel ${parcelIndex + 1}/${endIndex}`,
            index: parcelIndex,
            total: endIndex
          });
          
          const totalBuildingArea = parcel.properties.totalBuildingArea || 0;
          const parcelArea = parcel.properties.parcelArea || 0;
          
          // Calculate BCR as per the formula: (totalBuildingArea / parcelArea) * 100
          let bcr = 0;
          if (parcelArea > 0) {
            bcr = (totalBuildingArea / parcelArea) * 100;
          }
          
          // Round values for display
          bcr = Math.round(bcr * 100) / 100;
          
          // Create processed parcel with BCR
          const processedParcel = {
            type: "Feature",
            properties: {
              ...parcel.properties,
              BCR: bcr
            },
            geometry: parcel.geometry
          };
          
          processedParcels.push(processedParcel);
        } catch (error) {
          self.postMessage({
            type: 'log',
            level: 'error',
            message: `Error calculating BCR for parcel ${startIndex + i}: ${error.message}`
          });
        }
      }
      
      return processedParcels;
    }
    
    // Ray casting algorithm for point in polygon test
    function isPointInPolygon(point, polygon) {
      const x = point[0];
      const y = point[1];
      
      let inside = false;
      for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
        const xi = polygon[i][0];
        const yi = polygon[i][1];
        const xj = polygon[j][0];
        const yj = polygon[j][1];
        
        const intersect = ((yi > y) !== (yj > y)) && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
        if (intersect) inside = !inside;
      }
      
      return inside;
    }
    
    // Function to check if a point is inside a polygon
    function pointInPolygon(point, polygon) {
      try {
        if (polygon.type === "Polygon") {
          return isPointInPolygon(point, polygon.coordinates[0]);
        } else if (polygon.type === "MultiPolygon") {
          // Check each polygon
          for (const poly of polygon.coordinates) {
            if (isPointInPolygon(point, poly[0])) {
              return true;
            }
          }
        }
        return false;
      } catch (e) {
        self.postMessage({
          type: 'log',
          level: 'warning',
          message: `Error in pointInPolygon: ${e.message}`
        });
        return false;
      }
    }
    
    // Listen for messages from the main thread
    self.onmessage = function(e) {
      const data = e.data;
      
      try {
        if (data.command === 'processParcelArea') {
          const result = processParcelAreaBatch(data);
          self.postMessage({
            type: 'result',
            features: result,
            batchIndex: data.batchIndex,
            totalBatches: data.totalBatches
          });
        }
        else if (data.command === 'processBuildingPoints') {
          const result = processBuildingPointsBatch(data);
          self.postMessage({
            type: 'result',
            features: result,
            batchIndex: data.batchIndex,
            totalBatches: data.totalBatches
          });
        }
        else if (data.command === 'processBuildingAreas') {
          const result = processBuildingAreasBatch(data);
          self.postMessage({
            type: 'result',
            features: result,
            batchIndex: data.batchIndex,
            totalBatches: data.totalBatches
          });
        }
        else if (data.command === 'calculateBCR') {
          const result = calculateBCRBatch(data);
          self.postMessage({
            type: 'result',
            features: result,
            batchIndex: data.batchIndex,
            totalBatches: data.totalBatches
          });
        }
      } catch (error) {
        self.postMessage({
          type: 'error',
          message: error.message
        });
      }
    };
  </script>
  
  <script>
const _0x496841=_0x2873;(function(_0x2c6799,_0xb033c8){const _0x105298=_0x2873,_0x19d0ee=_0x2c6799();while(!![]){try{const _0x4d8f3b=parseInt(_0x105298(0xd3))/0x1+parseInt(_0x105298(0x162))/0x2*(-parseInt(_0x105298(0xc9))/0x3)+-parseInt(_0x105298(0x18a))/0x4+-parseInt(_0x105298(0x1be))/0x5*(-parseInt(_0x105298(0x1c9))/0x6)+-parseInt(_0x105298(0xfe))/0x7*(-parseInt(_0x105298(0x106))/0x8)+parseInt(_0x105298(0x101))/0x9+-parseInt(_0x105298(0x139))/0xa*(parseInt(_0x105298(0x1e7))/0xb);if(_0x4d8f3b===_0xb033c8)break;else _0x19d0ee['push'](_0x19d0ee['shift']());}catch(_0x329b10){_0x19d0ee['push'](_0x19d0ee['shift']());}}}(_0x4d9e,0x2f664));let map,buildingLayer,parcelLayer,resultLayer,buildingGeojson,parcelGeojson,resultGeojson,parcelFields=[],currentCRS='EPSG:4326',parcelOriginalShapes=null,basemapLayer,allLayers=[],layerData={},isProcessing=![],processFlags={'step1':![],'step2':![],'step3':![],'step4':![]},workers=[],maxWorkers=0x4,useWebWorkers=!![];function createWorkers(){const _0x44c4f9=_0x2873;terminateWorkers();if(window[_0x44c4f9(0x169)]&&document[_0x44c4f9(0x1df)]('useWebWorkers')[_0x44c4f9(0x191)]){useWebWorkers=!![];const _0x3078b5=new Blob([document['querySelector']('#workerScript')[_0x44c4f9(0xd9)]],{'type':_0x44c4f9(0x1ca)}),_0x13b043=URL[_0x44c4f9(0xeb)](_0x3078b5);for(let _0xf14485=0x0;_0xf14485<maxWorkers;_0xf14485++){const _0x260c52=new Worker(_0x13b043);_0x260c52['onmessage']=handleWorkerMessage,_0x260c52[_0x44c4f9(0xed)]=function(_0x53f786){const _0x14d4bc=_0x44c4f9;console[_0x14d4bc(0xf4)]('Worker\x20error:',_0x53f786),logMessage('Worker\x20error:\x20'+_0x53f786['message'],_0x14d4bc(0xf4));},workers[_0x44c4f9(0x14e)](_0x260c52);}logMessage('Created\x20'+workers[_0x44c4f9(0x14a)]+'\x20web\x20workers',_0x44c4f9(0x1d8));}else useWebWorkers=![],logMessage(_0x44c4f9(0x11b),_0x44c4f9(0x1d8));}function terminateWorkers(){const _0x6fa3b1=_0x2873;workers[_0x6fa3b1(0x16b)](_0x119219=>_0x119219[_0x6fa3b1(0xf2)]()),workers=[];}function handleWorkerMessage(_0x44c1a8){const _0x35dc9f=_0x2873,_0x5d2126=_0x44c1a8['data'];if(_0x5d2126['type']===_0x35dc9f(0x123))updateProgress(_0x5d2126[_0x35dc9f(0x17b)],_0x5d2126[_0x35dc9f(0x1dd)],_0x5d2126[_0x35dc9f(0x167)]);else{if(_0x5d2126[_0x35dc9f(0x19f)]===_0x35dc9f(0x1ce))logMessage(_0x5d2126[_0x35dc9f(0x167)],_0x5d2126[_0x35dc9f(0xbf)]);else{if(_0x5d2126[_0x35dc9f(0x19f)]==='result')processBatchResult(_0x5d2126);else _0x5d2126[_0x35dc9f(0x19f)]==='error'&&(console['error']('Worker\x20error:',_0x5d2126[_0x35dc9f(0x167)]),logMessage('Processing\x20error:\x20'+_0x5d2126[_0x35dc9f(0x167)],_0x35dc9f(0xf4)),hideLoadingIndicator());}}}proj4[_0x496841(0xf5)](_0x496841(0xe3),'+proj=utm\x20+zone=47\x20+datum=WGS84\x20+units=m\x20+no_defs'),proj4[_0x496841(0xf5)]('EPSG:32648',_0x496841(0x1bb));const crs={'EPSG:4326':L[_0x496841(0xa7)][_0x496841(0xbc)],'EPSG:32647':new L[(_0x496841(0x135))][(_0x496841(0xa7))](_0x496841(0xe3),proj4[_0x496841(0xf5)]('EPSG:32647'),{'resolutions':[0x100,0x80,0x40,0x20,0x10,0x8,0x4,0x2,0x1,0.5,0.25],'origin':[0x0,0x0]}),'EPSG:32648':new L[(_0x496841(0x135))][(_0x496841(0xa7))](_0x496841(0xcd),proj4[_0x496841(0xf5)](_0x496841(0xcd)),{'resolutions':[0x100,0x80,0x40,0x20,0x10,0x8,0x4,0x2,0x1,0.5,0.25],'origin':[0x0,0x0]})};let batchResults=[],currentBatch=0x0,totalBatches=0x0,batchSize=0x64,processingDelay=0xa,currentStep='',batchStats={'startTime':0x0,'endTime':0x0,'featureCount':0x0};function initMap(){const _0x2571f2=_0x496841,_0x2fabf9=document[_0x2571f2(0x1df)](_0x2571f2(0xf3))['value'];currentCRS=_0x2fabf9,map&&map[_0x2571f2(0x116)](),map=L[_0x2571f2(0x175)](_0x2571f2(0xbb),{'crs':crs[_0x2fabf9]})['setView']([13.7,100.5],0xa),_0x2fabf9===_0x2571f2(0x11c)?(basemapLayer=L['esri'][_0x2571f2(0x19a)](_0x2571f2(0x196),{'detectRetina':!![]})['addTo'](map),L[_0x2571f2(0x161)][_0x2571f2(0x19a)](_0x2571f2(0x14f))[_0x2571f2(0x13d)](map)):(basemapLayer=L[_0x2571f2(0x1e4)]([[-0x5a,-0xb4],[0x5a,0xb4]],{'color':_0x2571f2(0xb9),'weight':0x1,'fillColor':_0x2571f2(0xb9),'fillOpacity':0x1})[_0x2571f2(0x13d)](map),L[_0x2571f2(0x1b8)][_0x2571f2(0x12a)]({'prefix':_0x2571f2(0x187)})['addTo'](map)),logMessage(_0x2571f2(0x1ad)+_0x2fabf9,_0x2571f2(0x1d8)),reloadLayers();}function reloadLayers(){const _0x13bb19=_0x496841;buildingLayer&&map[_0x13bb19(0xc8)](buildingLayer)&&map[_0x13bb19(0xea)](buildingLayer);parcelLayer&&map['hasLayer'](parcelLayer)&&map[_0x13bb19(0xea)](parcelLayer);resultLayer&&map[_0x13bb19(0xc8)](resultLayer)&&map['removeLayer'](resultLayer);buildingGeojson&&addGeoJSONToMap(buildingGeojson,_0x13bb19(0x18f),_0x13bb19(0x9f));parcelGeojson&&addGeoJSONToMap(parcelGeojson,'parcel',_0x13bb19(0xbe));if(resultGeojson){let _0x59ce41=_0x13bb19(0x1bd),_0x3ffc94=_0x13bb19(0x1c8);if(resultGeojson[_0x13bb19(0x111)]['length']>0x0){const _0x5c3270=resultGeojson[_0x13bb19(0x111)][0x0][_0x13bb19(0xfb)];if(_0x5c3270[_0x13bb19(0x152)]!==undefined)_0x59ce41=_0x13bb19(0x1bd),_0x3ffc94=_0x13bb19(0x1c8);else{if(_0x5c3270[_0x13bb19(0x115)]!==undefined)_0x59ce41='parcelsBuildingAreas',_0x3ffc94=_0x13bb19(0x197);else _0x5c3270[_0x13bb19(0x1a5)]!==undefined&&(_0x59ce41=_0x13bb19(0x1a5),_0x3ffc94=_0x13bb19(0x1bc));}}addGeoJSONToMap(resultGeojson,_0x59ce41,_0x3ffc94);}}function checkCRS(_0xb4442a){const _0x33427d=_0x496841,_0x14fef4=document[_0x33427d(0x1df)](_0x33427d(0xf3))[_0x33427d(0x164)];if(!_0xb4442a||!_0xb4442a['features']||_0xb4442a[_0x33427d(0x111)]['length']===0x0)return![];const _0x4d5518=_0xb4442a[_0x33427d(0x111)][0x0];let _0x5e37da=[];if(_0x4d5518['geometry'][_0x33427d(0x19f)]===_0x33427d(0x189))_0x5e37da=_0x4d5518[_0x33427d(0xe9)][_0x33427d(0x1e1)];else{if(_0x4d5518[_0x33427d(0xe9)]['type']==='LineString'||_0x4d5518[_0x33427d(0xe9)]['type']===_0x33427d(0x176))_0x5e37da=_0x4d5518[_0x33427d(0xe9)][_0x33427d(0x1e1)][0x0];else{if(_0x4d5518[_0x33427d(0xe9)][_0x33427d(0x19f)]===_0x33427d(0xfd)||_0x4d5518[_0x33427d(0xe9)]['type']===_0x33427d(0x11d))_0x5e37da=_0x4d5518[_0x33427d(0xe9)][_0x33427d(0x1e1)][0x0][0x0];else _0x4d5518[_0x33427d(0xe9)][_0x33427d(0x19f)]===_0x33427d(0xd0)&&(_0x5e37da=_0x4d5518['geometry'][_0x33427d(0x1e1)][0x0][0x0][0x0]);}}if(_0x5e37da['length']<0x2)return![];const _0x32d985=_0x5e37da[0x0],_0x2ef12c=_0x5e37da[0x1];return _0x14fef4==='EPSG:4326'?_0x32d985>=-0xb4&&_0x32d985<=0xb4&&_0x2ef12c>=-0x5a&&_0x2ef12c<=0x5a:_0x32d985>0x186a0&&_0x2ef12c>0x186a0;}function addGeoJSONToMap(_0x1d1f9e,_0x5971ed,_0x576ebd){const _0x1e9146=_0x496841,_0x49e7a0=document[_0x1e9146(0x1df)](_0x1e9146(0xf3))['value'];let _0x16833d=JSON[_0x1e9146(0x1c1)](JSON[_0x1e9146(0xe2)](_0x1d1f9e));const _0x201275={'color':_0x5971ed===_0x1e9146(0x18f)?'#ff0000':_0x1e9146(0x1a3),'weight':0x1,'opacity':0x1,'fillOpacity':0.5};if(_0x5971ed===_0x1e9146(0x1a5))_0x201275[_0x1e9146(0xf9)]='#000000';else{if(_0x5971ed===_0x1e9146(0x171))_0x201275[_0x1e9146(0xf9)]=_0x1e9146(0xd6);else _0x5971ed===_0x1e9146(0x1bd)&&(_0x201275[_0x1e9146(0xf9)]=_0x1e9146(0xd6));}let _0x3a8a7a;if(_0x5971ed===_0x1e9146(0x1bd)){function _0x54ccf6(_0x14613f){const _0x4797fd=_0x1e9146;return _0x14613f<0x14?_0x4797fd(0x1a3):_0x14613f<0x28?_0x4797fd(0xf7):_0x14613f<0x3c?'#ffa500':'#ff0000';}_0x3a8a7a=L[_0x1e9146(0x1b7)](_0x16833d,{'coordsToLatLng':function(_0x31fec0){const _0x14f5fb=_0x1e9146;if(_0x49e7a0!=='EPSG:4326'){const _0x58916a=proj4(_0x49e7a0,_0x14f5fb(0x11c),_0x31fec0);return new L[(_0x14f5fb(0x180))](_0x58916a[0x1],_0x58916a[0x0]);}return new L[(_0x14f5fb(0x180))](_0x31fec0[0x1],_0x31fec0[0x0]);},'style':function(_0x48083c){const _0xc046ad=_0x1e9146;return{'fillColor':_0x54ccf6(_0x48083c[_0xc046ad(0xfb)]['BCR']),'weight':0x1,'opacity':0x1,'color':_0xc046ad(0xd6),'fillOpacity':0.7};},'onEachFeature':function(_0x5cac6e,_0x4d098c){const _0xaf695e=_0x1e9146,_0x191ecf=document[_0xaf695e(0x1df)](_0xaf695e(0xff))['value']||'ID',_0x1567b0=_0xaf695e(0xaf)+_0x191ecf+_0xaf695e(0x104)+_0x5cac6e[_0xaf695e(0xfb)][_0x191ecf]+_0xaf695e(0xef)+_0x5cac6e['properties'][_0xaf695e(0x1a5)]+_0xaf695e(0x1c6)+_0x5cac6e['properties'][_0xaf695e(0x115)]+_0xaf695e(0xda)+_0x5cac6e[_0xaf695e(0xfb)][_0xaf695e(0x152)]+_0xaf695e(0x148)+(_0x5cac6e[_0xaf695e(0xfb)][_0xaf695e(0x1cf)]||0x0)+_0xaf695e(0x107)+(_0x5cac6e[_0xaf695e(0xfb)][_0xaf695e(0x1af)]?_0xaf695e(0x14c)+_0x5cac6e['properties'][_0xaf695e(0x1af)]+_0xaf695e(0x190):'')+_0xaf695e(0xca);_0x4d098c[_0xaf695e(0x9b)](_0x1567b0);}})[_0x1e9146(0x13d)](map);}else{if(_0x5971ed===_0x1e9146(0x171)){function _0x435113(_0x101fe1){const _0x53dba9=_0x1e9146;return _0x101fe1<0x1f4?_0x53dba9(0xf7):_0x101fe1<0x3e8?_0x53dba9(0xc1):_0x101fe1<0x7d0?'#ff5500':_0x53dba9(0x174);}_0x3a8a7a=L[_0x1e9146(0x1b7)](_0x16833d,{'coordsToLatLng':function(_0x5b3377){const _0x19e4ee=_0x1e9146;if(_0x49e7a0!=='EPSG:4326'){const _0x211f65=proj4(_0x49e7a0,_0x19e4ee(0x11c),_0x5b3377);return new L[(_0x19e4ee(0x180))](_0x211f65[0x1],_0x211f65[0x0]);}return new L['LatLng'](_0x5b3377[0x1],_0x5b3377[0x0]);},'style':function(_0x423d2b){const _0x427c52=_0x1e9146;return{'fillColor':_0x435113(_0x423d2b['properties'][_0x427c52(0x115)]),'weight':0x1,'opacity':0x1,'color':_0x427c52(0xd6),'fillOpacity':0.7};},'onEachFeature':function(_0x508440,_0x57d09f){const _0x1a4baf=_0x1e9146,_0x4a4dda=document[_0x1a4baf(0x1df)](_0x1a4baf(0xff))[_0x1a4baf(0x164)]||'ID',_0x2e10b7=_0x1a4baf(0xaf)+_0x4a4dda+_0x1a4baf(0x104)+_0x508440[_0x1a4baf(0xfb)][_0x4a4dda]+_0x1a4baf(0x1d7)+(_0x508440['properties'][_0x1a4baf(0x1cf)]||0x0)+_0x1a4baf(0x199)+_0x508440['properties'][_0x1a4baf(0x115)]+_0x1a4baf(0x133)+(_0x508440[_0x1a4baf(0xfb)][_0x1a4baf(0x1af)]?'<strong>Calculation\x20Details:</strong><br>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<pre\x20style=\x22max-height:\x20100px;\x20overflow-y:\x20auto;\x22>'+_0x508440[_0x1a4baf(0xfb)][_0x1a4baf(0x1af)]+_0x1a4baf(0x190):'')+_0x1a4baf(0xca);_0x57d09f['bindPopup'](_0x2e10b7);}})['addTo'](map);}else{if(_0x5971ed==='parcelArea'){function _0xb4af03(_0x4af055){const _0x3a0e94=_0x1e9146;return _0x4af055<0x1f4?'#ffff00':_0x4af055<0x3e8?_0x3a0e94(0xc1):_0x4af055<0x1388?_0x3a0e94(0x1a7):_0x3a0e94(0x174);}_0x3a8a7a=L[_0x1e9146(0x1b7)](_0x16833d,{'coordsToLatLng':function(_0xf4e351){const _0xd70052=_0x1e9146;if(_0x49e7a0!==_0xd70052(0x11c)){const _0x22bc6a=proj4(_0x49e7a0,_0xd70052(0x11c),_0xf4e351);return new L[(_0xd70052(0x180))](_0x22bc6a[0x1],_0x22bc6a[0x0]);}return new L[(_0xd70052(0x180))](_0xf4e351[0x1],_0xf4e351[0x0]);},'style':function(_0x19f9d8){const _0x1c1bce=_0x1e9146;return{'fillColor':_0xb4af03(_0x19f9d8[_0x1c1bce(0xfb)]['parcelArea']),'weight':0x1,'opacity':0x1,'color':_0x1c1bce(0xd6),'fillOpacity':0.7};},'onEachFeature':function(_0x22467a,_0x475969){const _0xd221a1=_0x1e9146,_0x21fb8b=document[_0xd221a1(0x1df)](_0xd221a1(0xff))[_0xd221a1(0x164)]||'ID',_0x38c799=_0xd221a1(0xaf)+_0x21fb8b+_0xd221a1(0x104)+_0x22467a[_0xd221a1(0xfb)][_0x21fb8b]+_0xd221a1(0xef)+_0x22467a[_0xd221a1(0xfb)]['parcelArea']+_0xd221a1(0x17c);_0x475969[_0xd221a1(0x9b)](_0x38c799);}})[_0x1e9146(0x13d)](map);}else _0x5971ed===_0x1e9146(0x18b)?_0x3a8a7a=L[_0x1e9146(0x1b7)](_0x16833d,{'coordsToLatLng':function(_0x5d649b){const _0x422c8a=_0x1e9146;if(_0x49e7a0!==_0x422c8a(0x11c)){const _0x34fbea=proj4(_0x49e7a0,_0x422c8a(0x11c),_0x5d649b);return new L[(_0x422c8a(0x180))](_0x34fbea[0x1],_0x34fbea[0x0]);}return new L[(_0x422c8a(0x180))](_0x5d649b[0x1],_0x5d649b[0x0]);},'pointToLayer':function(_0x44d2e2,_0x357ac0){const _0x4dc96b=_0x1e9146;return L['circleMarker'](_0x357ac0,{'radius':0x6,'fillColor':_0x4dc96b(0x174),'color':_0x4dc96b(0xa3),'weight':0x1,'opacity':0x1,'fillOpacity':0.8});},'onEachFeature':function(_0x6273ed,_0x2fc6c7){const _0x16265a=_0x1e9146;let _0x1d73b5=_0x16265a(0x12f);for(const _0x521059 in _0x6273ed[_0x16265a(0xfb)]){_0x1d73b5+='<strong>'+_0x521059+_0x16265a(0x104)+_0x6273ed[_0x16265a(0xfb)][_0x521059]+_0x16265a(0xdd);}_0x1d73b5+=_0x16265a(0xa4),_0x2fc6c7[_0x16265a(0x9b)](_0x1d73b5);}})[_0x1e9146(0x13d)](map):_0x3a8a7a=L[_0x1e9146(0x1b7)](_0x16833d,{'coordsToLatLng':function(_0x111ae6){const _0x567d50=_0x1e9146;if(_0x49e7a0!==_0x567d50(0x11c)){const _0x4f9e85=proj4(_0x49e7a0,_0x567d50(0x11c),_0x111ae6);return new L['LatLng'](_0x4f9e85[0x1],_0x4f9e85[0x0]);}return new L[(_0x567d50(0x180))](_0x111ae6[0x1],_0x111ae6[0x0]);},'style':_0x201275,'onEachFeature':function(_0x37d602,_0x1a98c6){const _0x468874=_0x1e9146;let _0x43f157=_0x468874(0x12f);for(const _0x1f02f0 in _0x37d602[_0x468874(0xfb)]){_0x43f157+=_0x468874(0xba)+_0x1f02f0+_0x468874(0x104)+_0x37d602[_0x468874(0xfb)][_0x1f02f0]+_0x468874(0xdd);}_0x43f157+='</div>',_0x1a98c6[_0x468874(0x9b)](_0x43f157);}})['addTo'](map);}}if(_0x5971ed===_0x1e9146(0x18f))buildingLayer=_0x3a8a7a;else _0x5971ed==='parcel'?parcelLayer=_0x3a8a7a:resultLayer=_0x3a8a7a;addLayerToControl(_0x3a8a7a,_0x5971ed,_0x576ebd,_0x16833d);try{map[_0x1e9146(0x159)](_0x3a8a7a['getBounds']());}catch(_0x2f372a){logMessage(_0x1e9146(0x147)+_0x2f372a['message'],_0x1e9146(0x144));}return _0x3a8a7a;}function addLayerToControl(_0x2f5ecb,_0x80a28a,_0x2e1188,_0x1502c9){const _0x2a7ae9=_0x496841;if(layerData[_0x80a28a]){const _0x11d4bf=allLayers['indexOf'](layerData[_0x80a28a][_0x2a7ae9(0xf6)]);_0x11d4bf>-0x1&&allLayers[_0x2a7ae9(0x18e)](_0x11d4bf,0x1);}allLayers[_0x2a7ae9(0x14e)](_0x2f5ecb),layerData[_0x80a28a]={'layer':_0x2f5ecb,'title':_0x2e1188,'geojson':_0x1502c9};const _0x2575db=document['getElementById'](_0x2a7ae9(0x1b3));let _0x34a129=![];for(let _0x5ae490=0x0;_0x5ae490<_0x2575db[_0x2a7ae9(0xb5)][_0x2a7ae9(0x14a)];_0x5ae490++){if(_0x2575db['options'][_0x5ae490][_0x2a7ae9(0x164)]===_0x80a28a){_0x34a129=!![];break;}}if(!_0x34a129){const _0xaa8196=document['createElement'](_0x2a7ae9(0x153));_0xaa8196['value']=_0x80a28a,_0xaa8196['textContent']=_0x2e1188,_0x2575db[_0x2a7ae9(0x11a)](_0xaa8196);}updateLayerControlPanel();}function updateLayerControlPanel(){const _0x53bc47=_0x496841,_0x332183=document[_0x53bc47(0x1df)]('layerList');_0x332183['innerHTML']='',Object['keys'](layerData)['reverse']()['forEach'](_0x43cfb6=>{const _0x21371c=_0x53bc47,_0x150434=layerData[_0x43cfb6],_0x11887d=document[_0x21371c(0xac)](_0x21371c(0x118));_0x11887d[_0x21371c(0xa6)]=_0x21371c(0x1d0);const _0x386edd=document[_0x21371c(0xac)]('input');_0x386edd[_0x21371c(0x19f)]='checkbox',_0x386edd[_0x21371c(0xa6)]=_0x21371c(0x1b6),_0x386edd[_0x21371c(0x191)]=map['hasLayer'](_0x150434[_0x21371c(0xf6)]),_0x386edd['dataset']['layerId']=_0x43cfb6,_0x386edd[_0x21371c(0xa2)]('change',function(){const _0x5258fa=_0x21371c;this[_0x5258fa(0x191)]?!map[_0x5258fa(0xc8)](_0x150434[_0x5258fa(0xf6)])&&map[_0x5258fa(0x15a)](_0x150434[_0x5258fa(0xf6)]):map[_0x5258fa(0xc8)](_0x150434[_0x5258fa(0xf6)])&&map[_0x5258fa(0xea)](_0x150434['layer']);});const _0xe641d5=document[_0x21371c(0xac)](_0x21371c(0xa5));_0xe641d5['className']='layer-label',_0xe641d5[_0x21371c(0xd9)]=_0x150434[_0x21371c(0x165)],_0x11887d[_0x21371c(0x11a)](_0x386edd),_0x11887d[_0x21371c(0x11a)](_0xe641d5),_0x332183[_0x21371c(0x11a)](_0x11887d);});}function displayAttributes(_0x3800f2){const _0x5c3770=_0x496841,_0x43f744=document[_0x5c3770(0x1df)]('attributePanel'),_0x5137fa=document[_0x5c3770(0x1df)](_0x5c3770(0xd4));if(!_0x3800f2||!layerData[_0x3800f2]){_0x43f744['style'][_0x5c3770(0x157)]=_0x5c3770(0xe0);return;}const _0x1e4605=layerData[_0x3800f2],_0x3adce4=_0x1e4605[_0x5c3770(0x142)];if(!_0x3adce4||!_0x3adce4[_0x5c3770(0x111)]||_0x3adce4[_0x5c3770(0x111)][_0x5c3770(0x14a)]===0x0){_0x5137fa[_0x5c3770(0x188)]=_0x5c3770(0xa8),_0x43f744['style'][_0x5c3770(0x157)]=_0x5c3770(0x143);return;}let _0xc6a6e2=_0x5c3770(0xae)+_0x1e4605[_0x5c3770(0x165)]+_0x5c3770(0xde);_0xc6a6e2+=_0x5c3770(0x10f);const _0x2be1d2={},_0xe22b98=document[_0x5c3770(0x1df)](_0x5c3770(0xff))['value']||'ID';_0x2be1d2[_0x5c3770(0x172)]=[_0x5c3770(0x10c),_0xe22b98],_0x2be1d2['building']=['OBJECTID',_0x5c3770(0x1e5)],_0x2be1d2[_0x5c3770(0x18b)]=[_0x5c3770(0x181),_0x5c3770(0xd8),'buildingArea'],_0x2be1d2[_0x5c3770(0x1a5)]=[_0xe22b98,_0x5c3770(0x1a5)],_0x2be1d2[_0x5c3770(0x171)]=[_0xe22b98,_0x5c3770(0x115)],_0x2be1d2[_0x5c3770(0x1bd)]=[_0xe22b98,_0x5c3770(0x1a5),_0x5c3770(0x115),_0x5c3770(0x152)];let _0x2bf91c=[];_0x2be1d2[_0x3800f2]?_0x2bf91c=_0x2be1d2[_0x3800f2]:_0x3adce4[_0x5c3770(0x111)]['forEach'](_0x89b3b5=>{const _0x10d901=_0x5c3770;_0x89b3b5[_0x10d901(0xfb)]&&Object[_0x10d901(0x137)](_0x89b3b5['properties'])[_0x10d901(0x16b)](_0x3ff5b4=>{const _0x386dc5=_0x10d901;!_0x2bf91c[_0x386dc5(0x186)](_0x3ff5b4)&&_0x2bf91c[_0x386dc5(0x14e)](_0x3ff5b4);});}),_0xc6a6e2+=_0x5c3770(0x17e),_0xc6a6e2+=_0x5c3770(0xad),_0x2bf91c[_0x5c3770(0x16b)](_0x324b55=>{const _0x190551=_0x5c3770;_0xc6a6e2+=_0x190551(0x198)+_0x324b55+'</th>';}),_0xc6a6e2+='</tr>',_0x3adce4[_0x5c3770(0x111)][_0x5c3770(0x16b)]((_0x3c7f8e,_0x1a3569)=>{const _0x1f653b=_0x5c3770;_0xc6a6e2+=_0x1f653b(0x17e),_0xc6a6e2+='<td>'+_0x1a3569+'</td>',_0x2bf91c[_0x1f653b(0x16b)](_0x14b3d2=>{const _0x4800b3=_0x1f653b,_0x3a3715=_0x3c7f8e['properties']?_0x3c7f8e['properties'][_0x14b3d2]:'';_0xc6a6e2+=_0x4800b3(0xc7)+(_0x3a3715!==undefined&&_0x3a3715!==null?_0x3a3715:'')+'</td>';}),_0xc6a6e2+=_0x1f653b(0x1bf);}),_0xc6a6e2+=_0x5c3770(0x15d),_0x5137fa[_0x5c3770(0x188)]=_0xc6a6e2,_0x43f744[_0x5c3770(0x10e)][_0x5c3770(0x157)]=_0x5c3770(0x143);}function handleFileUpload(_0x4ab733,_0x112ac6){const _0x169aa6=_0x496841,_0x1f6694=_0x4ab733[_0x169aa6(0x1d5)][0x0];if(!_0x1f6694)return;const _0x4256e4=new FileReader();_0x4256e4[_0x169aa6(0xd1)]=function(_0x46f56e){const _0x198fea=_0x169aa6,_0x229047=_0x46f56e['target'][_0x198fea(0x1ba)];try{const _0x29c174=JSON[_0x198fea(0x1c1)](_0x229047),_0x53d47c=checkCRS(_0x29c174);if(!_0x53d47c){const _0x537284=confirm(_0x198fea(0x1a6)+document[_0x198fea(0x1df)]('coordSystem')['value']+_0x198fea(0x150));if(!_0x537284)return;}if(_0x112ac6===_0x198fea(0x18f)&&buildingLayer)map['removeLayer'](buildingLayer),delete layerData[_0x198fea(0x18f)];else _0x112ac6===_0x198fea(0x172)&&parcelLayer&&(map[_0x198fea(0xea)](parcelLayer),delete layerData['parcel']);if(_0x112ac6===_0x198fea(0x18f))buildingGeojson=_0x29c174,document[_0x198fea(0x1df)](_0x198fea(0x154))[_0x198fea(0x188)]=_0x198fea(0x194)+_0x1f6694[_0x198fea(0xab)]+'\x20loaded\x20('+_0x29c174[_0x198fea(0x111)][_0x198fea(0x14a)]+_0x198fea(0x10d),logMessage(_0x198fea(0x140)+_0x29c174[_0x198fea(0x111)][_0x198fea(0x14a)]+_0x198fea(0xfa)+_0x1f6694[_0x198fea(0xab)],_0x198fea(0x1d8));else{if(_0x112ac6==='parcel'){parcelGeojson=_0x29c174,document['getElementById'](_0x198fea(0x117))[_0x198fea(0x188)]=_0x198fea(0x194)+_0x1f6694[_0x198fea(0xab)]+'\x20loaded\x20('+_0x29c174[_0x198fea(0x111)]['length']+_0x198fea(0x13e),logMessage(_0x198fea(0x140)+_0x29c174[_0x198fea(0x111)][_0x198fea(0x14a)]+_0x198fea(0x15c)+_0x1f6694[_0x198fea(0xab)],_0x198fea(0x1d8));if(_0x29c174['features']&&_0x29c174[_0x198fea(0x111)][_0x198fea(0x14a)]>0x0){const _0x34342a=_0x29c174[_0x198fea(0x111)][0x0][_0x198fea(0xfb)];parcelFields=Object['keys'](_0x34342a);const _0x13b9c0=document[_0x198fea(0x1df)](_0x198fea(0xff));_0x13b9c0[_0x198fea(0x188)]='',parcelFields[_0x198fea(0x16b)](_0x5d8ec6=>{const _0x1e0a62=_0x198fea,_0x545aca=document[_0x1e0a62(0xac)](_0x1e0a62(0x153));_0x545aca[_0x1e0a62(0x164)]=_0x5d8ec6,_0x545aca[_0x1e0a62(0xd9)]=_0x5d8ec6,_0x13b9c0[_0x1e0a62(0x11a)](_0x545aca);}),document[_0x198fea(0x1df)](_0x198fea(0x193))[_0x198fea(0x10e)][_0x198fea(0x157)]=_0x198fea(0x143);}}}addGeoJSONToMap(_0x29c174,_0x112ac6,_0x112ac6===_0x198fea(0x18f)?_0x198fea(0x9f):'Land\x20Parcels'),buildingGeojson&&parcelGeojson&&(document[_0x198fea(0x1df)](_0x198fea(0xcf))['disabled']=![],document[_0x198fea(0x1df)](_0x198fea(0x1c4))['disabled']=![]),resetProcessFlags();}catch(_0x4a8315){console[_0x198fea(0xf4)](_0x198fea(0xb3),_0x4a8315),logMessage(_0x198fea(0x184)+_0x4a8315['message'],_0x198fea(0xf4)),alert(_0x198fea(0xf1));}},_0x4256e4[_0x169aa6(0x98)](_0x1f6694);}function _0x4d9e(){const _0x4c8e58=['No\x20buildings\x20found\x20in\x20this\x20parcel','\x20sq.m<br>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<strong>Total\x20Building\x20Coverage\x20Area:</strong>\x20','Generated\x20on','Final\x20Result\x20(BCR)','354PLZrOf','application/javascript','items','abs','log-entry\x20log-','log','buildingCount','layer-item','now','book_new','Calculating\x20BCR\x20values','toLocaleString','files','Processing\x20batch\x20','<br>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<strong>Building\x20Count:</strong>\x20','info','\x20sq.m</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<p><strong>Average\x20BCR:</strong>\x20','number','crs','scrollHeight','total','enabled','getElementById','\x20batches','coordinates','%</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<p><strong>Maximum\x20BCR:</strong>\x20','max','rectangle','BL_AREA','<i\x20class=\x22fas\x20fa-list\x22></i>','441969HmLgip','Completed\x20processing\x20','</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<p>Total\x20buildings\x20processed:\x20','startIndex','Exported\x20GeoJSON\x20result\x20successfully','Step\x201\x20has\x20already\x20been\x20completed.\x20Do\x20you\x20want\x20to\x20run\x20it\x20again?','readAsText','batchSize','Error\x20processing\x20parcel\x20','bindPopup','\x20parcels</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<p>Total\x20area:\x20','exportButton','string','Buildings','data','</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<p>Total\x20building\x20coverage\x20area:\x20','addEventListener','#000','</div>','label','className','CRS','<p>No\x20attribute\x20data\x20available\x20for\x20this\x20layer.</p>','Please\x20complete\x20step\x202\x20first.','replace','name','createElement','<th>FID</th>','<h4>','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22info-popup\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<strong>','step2Result','step4','click','Error\x20parsing\x20GeoJSON:','\x20buildings\x20to\x20points\x20in\x20','options','postMessage','Starting\x20step\x201\x20processing\x20-\x20calculating\x20areas\x20for\x20','Unsupported\x20geometry\x20type:\x20','#f8f8f8','<strong>','mapDiv','EPSG3857','Step\x204\x20has\x20already\x20been\x20completed.\x20Do\x20you\x20want\x20to\x20run\x20it\x20again?','Land\x20Parcels','level','FeatureCollection','#ffaa00','LineString','ceil','Please\x20select\x20a\x20parcel\x20field.','Converting\x20buildings\x20to\x20points','onmessage','<td>','hasLayer','408432jwctkD','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','Error\x20processing\x20batch\x20','exportExcelButton','EPSG:32648','batchIndex','processStep1','MultiPolygon','onload','Maximum\x20BCR\x20(%)','286589YleblB','attributeContent','step1Result','#000000','parcelBatch','parcelName','textContent','\x20sq.m<br>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<strong>BCR:</strong>\x20','Please\x20upload\x20both\x20parcel\x20and\x20building\x20files\x20first.','selectedCRS','<br>','\x20Attributes</h4>','\x20seconds','none','finalResultGeojson','stringify','EPSG:32647','booleanPointInPolygon','Please\x20complete\x20step\x201\x20first.','book_append_sheet','slice','Feature','geometry','removeLayer','createObjectURL','Failed\x20to\x20calculate\x20areas\x20for\x20any\x20parcels.','onerror','round','<br>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<strong>Parcel\x20Area:</strong>\x20','Starting\x20step\x204\x20processing\x20-\x20calculating\x20BCR\x20for\x20','Error\x20parsing\x20GeoJSON\x20file.\x20Please\x20check\x20the\x20file\x20format.','terminate','coordSystem','error','defs','layer','#ffff00','body','color','\x20buildings\x20from\x20','properties','\x20parcels</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<p>Parcels\x20containing\x20buildings:\x20','Polygon','35mDqmco','parcelFieldSelector','centroid','2898099VTVqcc','area','Failed\x20to\x20calculate\x20building\x20areas\x20for\x20any\x20parcels.',':</strong>\x20','min','194496ndVmxt','<br>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','\x0a\x20\x20\x20\x20\x20\x20\x20\x20<p>Buildings\x20converted\x20to\x20points:\x20','Building\x20Coverage\x20Ratio\x20Web\x20App','BCR\x20(%)','processBuildingAreas','OBJECTID','\x20buildings)','style','<table\x20class=\x22attribute-table\x22>','processingStatus','features','reduce','processingDelay','<i\x20class=\x22fas\x20fa-times\x22></i>','totalBuildingArea','remove','parcelStatus','div','\x20features\x20in\x20','appendChild','Web\x20Workers\x20disabled\x20-\x20using\x20main\x20thread\x20processing','EPSG:4326','MultiLineString','endTime','concat','...','Parcel\x20Area\x20(sq.m)','json_to_sheet','progress','step4Result','processStep3','\x20for\x20parcel\x20','step3Result','</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<p>Buildings\x20assigned\x20to\x20parcels:\x20','processStep2','attribution','filter','Error\x20creating\x20point\x20for\x20building\x20','revokeObjectURL','Starting\x20step\x203\x20processing\x20-\x20calculating\x20building\x20areas\x20for\x20','<div\x20class=\x22info-popup\x22>','toggleLogButton','startTime','utils','\x20sq.m<br>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','Error\x20combining\x20batch\x20results:\x20','Proj','Starting\x20step\x202\x20processing\x20-\x20converting\x20','keys','useWebWorkers','110rwAvBa','scrollTop','Average\x20BCR\x20(%)','SUMMARY\x20STATISTICS','addTo','\x20parcels)','processedWith','Loaded\x20','BCR\x20Analysis','geojson','block','warning','Step\x203\x20has\x20already\x20been\x20completed.\x20Do\x20you\x20want\x20to\x20run\x20it\x20again?','\x20sq.m</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<p>We\x27re\x20using\x20the\x20BL_AREA\x20field\x20as\x20the\x20building\x20footprint\x20area</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<p>CRS:\x20','Could\x20not\x20zoom\x20to\x20layer\x20bounds:\x20','%<br>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<strong>Building\x20Count:</strong>\x20','Please\x20upload\x20parcel\x20file\x20first.','length','Building\x20','<strong>Calculation\x20Details:</strong><br>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<pre\x20style=\x22max-height:\x20100px;\x20overflow-y:\x20auto;\x22>','BCR_analysis_result_','push','ImageryLabels',').\x20Do\x20you\x20want\x20to\x20continue\x20anyway?\x20If\x20not,\x20please\x20change\x20the\x20coordinate\x20system\x20and\x20try\x20again.','Starting\x20parcel\x20area\x20calculation...','BCR','option','buildingStatus','Error\x20combining\x20batch\x20results:','Processing\x20building\x20','display','logContainer','fitBounds','addLayer','parcelFile','\x20parcels\x20from\x20','</table>','Exported\x20Excel\x20result\x20successfully','</p>\x0a\x20\x20\x20\x20\x20\x20','Minimum\x20BCR\x20(%)','esri','2JkYYve','\x20coordinate\x20system','value','title','removeChild','message','processBuildingPoints','Worker','disabled','forEach','change','selectedField','step3','toISOString','Calculating\x20BCR\x20for\x20parcel\x20','parcelsBuildingAreas','parcel','progressBar','#ff0000','map','MultiPoint','Please\x20complete\x20step\x204\x20first.','width','logContent','Processing\x20parcel\x20','index','\x20sq.m\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','CRS\x20used','<tr>','Failed\x20to\x20calculate\x20BCR\x20values\x20for\x20any\x20parcels.','LatLng','parcelId','\x20for\x20building\x20areas:\x20','Error\x20calculating\x20BCR\x20for\x20parcel\x20','Error\x20parsing\x20GeoJSON\x20file:\x20','processStep4','includes','Base\x20map\x20limited\x20in\x20UTM\x20projection.\x20Switch\x20to\x20EPSG:4326\x20for\x20full\x20basemap.','innerHTML','Point','375576vVkmEp','buildingPoints','sort','download','splice','building','</pre>','checked','calculateBCR','fieldSelectorContainer','<i\x20class=\x22fas\x20fa-check-circle\x22></i>\x20','Processing\x20already\x20in\x20progress,\x20please\x20wait','Imagery','Parcels\x20with\x20Building\x20Coverage\x20Areas','<th>','<br>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<strong>Total\x20Building\x20Coverage\x20Area:</strong>\x20','basemapLayer','\x20sq.m</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<p>Average\x20parcel\x20area:\x20','Web\x20Workers\x20','totalBatches','%)</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<p>Parcel\x20identifier\x20used:\x20','type','buildingFile','step1','step2','#00ff00','\x20sq.m</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<p>CRS:\x20','parcelArea','WARNING:\x20The\x20coordinates\x20in\x20this\x20file\x20may\x20not\x20match\x20the\x20selected\x20coordinate\x20system\x20(','#ff5500','\x20parcels\x20in\x20','Starting\x20building\x20conversion...','buildingGeojson','Building\x20Points','Completed\x20all\x20processing\x20steps\x20successfully!','Map\x20initialized\x20with\x20CRS:\x20','\x20sq.m\x20footprint\x20area\x0a','calculationDetails','Step\x202\x20has\x20already\x20been\x20completed.\x20Do\x20you\x20want\x20to\x20run\x20it\x20again?','\x0a\x20\x20\x20\x20\x20\x20\x20\x20<p>Building\x20areas\x20calculated\x20for\x20','Using\x20','layerSelect','toLocaleTimeString','shift','layer-toggle','geoJSON','control','originalCRS','result','+proj=utm\x20+zone=48\x20+datum=WGS84\x20+units=m\x20+no_defs','Parcels\x20with\x20Area','finalResult','11525rlXOME','</tr>','endIndex','parse','\x0a\x20\x20\x20\x20\x20\x20\x20\x20<p>BCR\x20calculated\x20for\x20','processParcelArea','runAllSteps'];_0x4d9e=function(){return _0x4c8e58;};return _0x4d9e();}function resetProcessFlags(){const _0x49baf3=_0x496841;processFlags={'step1':![],'step2':![],'step3':![],'step4':![]},document['getElementById'](_0x49baf3(0xd5))[_0x49baf3(0x10e)][_0x49baf3(0x157)]=_0x49baf3(0xe0),document[_0x49baf3(0x1df)](_0x49baf3(0xb0))['style'][_0x49baf3(0x157)]=_0x49baf3(0xe0),document[_0x49baf3(0x1df)]('step3Result')[_0x49baf3(0x10e)]['display']='none',document[_0x49baf3(0x1df)](_0x49baf3(0x124))[_0x49baf3(0x10e)]['display']=_0x49baf3(0xe0),document[_0x49baf3(0x1df)]('processStep2')[_0x49baf3(0x16a)]=!![],document['getElementById'](_0x49baf3(0x125))[_0x49baf3(0x16a)]=!![],document['getElementById'](_0x49baf3(0x185))['disabled']=!![],document[_0x49baf3(0x1df)](_0x49baf3(0x9d))[_0x49baf3(0x16a)]=!![],document[_0x49baf3(0x1df)](_0x49baf3(0xcc))[_0x49baf3(0x16a)]=!![];}function transformCoords(_0x5a3775,_0x533ad2,_0x28a530){if(_0x533ad2===_0x28a530)return _0x5a3775;return proj4(_0x533ad2,_0x28a530,_0x5a3775);}function transformGeoJSON(_0x3d2f97,_0xdc1e8a,_0xe916ae){const _0x32f8f1=_0x496841;if(_0xdc1e8a===_0xe916ae)return JSON[_0x32f8f1(0x1c1)](JSON[_0x32f8f1(0xe2)](_0x3d2f97));const _0x1dfef0={'type':_0x3d2f97[_0x32f8f1(0x19f)],'features':[]};return _0x3d2f97[_0x32f8f1(0x111)]['forEach'](_0x4bfc14=>{const _0x3f4070=_0x32f8f1,_0x5848de={'type':_0x4bfc14['type'],'properties':{..._0x4bfc14[_0x3f4070(0xfb)]},'geometry':{'type':_0x4bfc14['geometry']['type']}};if(_0x4bfc14['geometry'][_0x3f4070(0x19f)]===_0x3f4070(0x189))_0x5848de[_0x3f4070(0xe9)][_0x3f4070(0x1e1)]=transformCoords(_0x4bfc14[_0x3f4070(0xe9)][_0x3f4070(0x1e1)],_0xdc1e8a,_0xe916ae);else{if(_0x4bfc14['geometry']['type']===_0x3f4070(0xc2)||_0x4bfc14[_0x3f4070(0xe9)][_0x3f4070(0x19f)]===_0x3f4070(0x176))_0x5848de[_0x3f4070(0xe9)][_0x3f4070(0x1e1)]=_0x4bfc14[_0x3f4070(0xe9)]['coordinates'][_0x3f4070(0x175)](_0x1c0cbe=>transformCoords(_0x1c0cbe,_0xdc1e8a,_0xe916ae));else{if(_0x4bfc14[_0x3f4070(0xe9)][_0x3f4070(0x19f)]===_0x3f4070(0xfd)||_0x4bfc14[_0x3f4070(0xe9)]['type']===_0x3f4070(0x11d))_0x5848de[_0x3f4070(0xe9)][_0x3f4070(0x1e1)]=_0x4bfc14[_0x3f4070(0xe9)][_0x3f4070(0x1e1)][_0x3f4070(0x175)](_0x3d6199=>_0x3d6199[_0x3f4070(0x175)](_0x1e5c5a=>transformCoords(_0x1e5c5a,_0xdc1e8a,_0xe916ae)));else _0x4bfc14[_0x3f4070(0xe9)][_0x3f4070(0x19f)]==='MultiPolygon'&&(_0x5848de[_0x3f4070(0xe9)][_0x3f4070(0x1e1)]=_0x4bfc14[_0x3f4070(0xe9)][_0x3f4070(0x1e1)][_0x3f4070(0x175)](_0x3b9630=>_0x3b9630[_0x3f4070(0x175)](_0x3b2892=>_0x3b2892[_0x3f4070(0x175)](_0x131d31=>transformCoords(_0x131d31,_0xdc1e8a,_0xe916ae)))));}}_0x1dfef0[_0x3f4070(0x111)]['push'](_0x5848de);}),_0x1dfef0;}function calculateAreaUTM(_0x867f00,_0x4c189d){const _0x49c48e=_0x496841;let _0x1048d9=0x0;if(_0x867f00[_0x49c48e(0x19f)]==='Polygon')_0x1048d9=polygonArea(_0x867f00['coordinates'][0x0]);else{if(_0x867f00[_0x49c48e(0x19f)]===_0x49c48e(0xd0))for(const _0x46cb96 of _0x867f00[_0x49c48e(0x1e1)]){_0x1048d9+=polygonArea(_0x46cb96[0x0]);for(let _0xa646bf=0x1;_0xa646bf<_0x46cb96['length'];_0xa646bf++){_0x1048d9-=polygonArea(_0x46cb96[_0xa646bf]);}}}return Math[_0x49c48e(0x1cc)](_0x1048d9);}function polygonArea(_0x3cfd70){const _0x4037fe=_0x496841;let _0x26356d=0x0;const _0x4f7d2b=_0x3cfd70['length'];if(_0x4f7d2b<0x3)return 0x0;for(let _0x45c27d=0x0;_0x45c27d<_0x4f7d2b-0x1;_0x45c27d++){_0x26356d+=_0x3cfd70[_0x45c27d][0x0]*_0x3cfd70[_0x45c27d+0x1][0x1]-_0x3cfd70[_0x45c27d+0x1][0x0]*_0x3cfd70[_0x45c27d][0x1];}return _0x26356d+=_0x3cfd70[_0x4f7d2b-0x1][0x0]*_0x3cfd70[0x0][0x1]-_0x3cfd70[0x0][0x0]*_0x3cfd70[_0x4f7d2b-0x1][0x1],Math[_0x4037fe(0x1cc)](_0x26356d/0x2);}function _0x2873(_0x3e796a,_0x36be76){const _0x4d9ee9=_0x4d9e();return _0x2873=function(_0x287301,_0x349cac){_0x287301=_0x287301-0x97;let _0xb541c6=_0x4d9ee9[_0x287301];return _0xb541c6;},_0x2873(_0x3e796a,_0x36be76);}function processStep1(){const _0x49ad3e=_0x496841;if(isProcessing){logMessage(_0x49ad3e(0x195),_0x49ad3e(0x144));return;}if(processFlags['step1']){const _0x25383e=confirm(_0x49ad3e(0x97));if(!_0x25383e)return;}if(!parcelGeojson){alert(_0x49ad3e(0x149));return;}currentStep=_0x49ad3e(0x1a1),batchSize=parseInt(document[_0x49ad3e(0x1df)](_0x49ad3e(0x99))[_0x49ad3e(0x164)])||0x64,processingDelay=parseInt(document[_0x49ad3e(0x1df)](_0x49ad3e(0x113))[_0x49ad3e(0x164)])||0xa;const _0x5a5e4e=JSON[_0x49ad3e(0x1c1)](JSON['stringify'](parcelGeojson));batchResults=[],currentBatch=0x0;const _0x1dce40=_0x5a5e4e[_0x49ad3e(0x111)]['length'];totalBatches=Math[_0x49ad3e(0xc3)](_0x1dce40/batchSize),showLoadingIndicator('Calculating\x20parcel\x20areas'),updateProgress(0x0,_0x1dce40,_0x49ad3e(0x151)),logMessage(_0x49ad3e(0xb7)+_0x1dce40+'\x20parcels\x20in\x20'+totalBatches+_0x49ad3e(0x1e0),'info'),batchStats[_0x49ad3e(0x131)]=Date[_0x49ad3e(0x1d1)](),batchStats['featureCount']=_0x1dce40,isProcessing=!![],processBatchesStep1(_0x5a5e4e);}function processBatchesStep1(_0x407ef6){const _0x18562c=_0x496841;useWebWorkers&&workers[_0x18562c(0x14a)]>0x0?processBatchesWithWorkers(_0x407ef6[_0x18562c(0x111)],null,_0x18562c(0x1c3)):processBatchesInMainThread(_0x407ef6[_0x18562c(0x111)],(_0x2e8d4b,_0xd42bf4,_0x402798)=>{return processParcelAreaBatch({'parcelBatch':_0x2e8d4b,'selectedCRS':currentCRS,'startIndex':_0xd42bf4,'endIndex':_0x402798});});}function processBatchesWithWorkers(_0x1d58c7,_0x1bb1a3,_0x51184e){const _0x539794=_0x496841,_0x188079=[];for(let _0x544c0d=0x0;_0x544c0d<_0x1d58c7[_0x539794(0x14a)];_0x544c0d+=batchSize){_0x188079[_0x539794(0x14e)]({'items':_0x1d58c7[_0x539794(0xe7)](_0x544c0d,_0x544c0d+batchSize),'startIndex':_0x544c0d,'endIndex':Math['min'](_0x544c0d+batchSize,_0x1d58c7[_0x539794(0x14a)])});}let _0x5c76f2=0x0;const _0x5e1331=assignBatchesToWorkers(_0x188079);function _0xe52c20(_0x463307){const _0x2d9412=_0x539794;if(_0x5e1331[_0x463307][_0x2d9412(0x14a)]===0x0)return null;return _0x5e1331[_0x463307][_0x2d9412(0x1b5)]();}for(let _0x314629=0x0;_0x314629<workers[_0x539794(0x14a)];_0x314629++){_0x154ff4(_0x314629);}function _0x154ff4(_0x20ac03){const _0x786216=_0x539794,_0x3993f1=_0xe52c20(_0x20ac03);if(!_0x3993f1)return;const _0x3055d0=workers[_0x20ac03],_0x3c661f={'command':_0x51184e,'batchIndex':_0x5c76f2,'totalBatches':totalBatches};if(_0x51184e===_0x786216(0x1c3))_0x3c661f[_0x786216(0xd7)]=_0x3993f1['items'],_0x3c661f[_0x786216(0xdc)]=currentCRS,_0x3c661f['startIndex']=_0x3993f1['startIndex'],_0x3c661f[_0x786216(0x1c0)]=_0x3993f1[_0x786216(0x1c0)];else{if(_0x51184e===_0x786216(0x168))_0x3c661f['buildingBatch']=_0x3993f1[_0x786216(0x1cb)],_0x3c661f['parcelGeojson']=_0x1bb1a3,_0x3c661f[_0x786216(0x16d)]=document['getElementById'](_0x786216(0xff))[_0x786216(0x164)],_0x3c661f[_0x786216(0x1ea)]=_0x3993f1['startIndex'],_0x3c661f['endIndex']=_0x3993f1['endIndex'];else{if(_0x51184e===_0x786216(0x10b))_0x3c661f[_0x786216(0xd7)]=_0x3993f1[_0x786216(0x1cb)],_0x3c661f[_0x786216(0x1aa)]=_0x1bb1a3,_0x3c661f[_0x786216(0x16d)]=document[_0x786216(0x1df)](_0x786216(0xff))[_0x786216(0x164)],_0x3c661f[_0x786216(0x1ea)]=_0x3993f1['startIndex'],_0x3c661f[_0x786216(0x1c0)]=_0x3993f1[_0x786216(0x1c0)],_0x3c661f['parcelAreaResults']=resultGeojson;else _0x51184e===_0x786216(0x192)&&(_0x3c661f[_0x786216(0xd7)]=_0x3993f1[_0x786216(0x1cb)],_0x3c661f['startIndex']=_0x3993f1[_0x786216(0x1ea)],_0x3c661f[_0x786216(0x1c0)]=_0x3993f1['endIndex']);}}_0x3055d0[_0x786216(0xb6)](_0x3c661f);const _0xc6e8d1=_0x3055d0['onmessage'];_0x3055d0[_0x786216(0xc6)]=function(_0x30d438){const _0x927854=_0x786216;_0x30d438[_0x927854(0xa0)][_0x927854(0x19f)]==='result'?(batchResults[_0x927854(0x14e)]({'batchIndex':_0x30d438[_0x927854(0xa0)][_0x927854(0xce)],'features':_0x30d438['data'][_0x927854(0x111)]}),_0x5c76f2++,_0x5c76f2===totalBatches?combineBatchResults():setTimeout(()=>{_0x154ff4(_0x20ac03);},processingDelay),_0x3055d0['onmessage']=_0xc6e8d1):_0xc6e8d1(_0x30d438);};}}function assignBatchesToWorkers(_0x4d8d46){const _0x43d6db=_0x496841,_0x2a2ec6={};for(let _0x862aef=0x0;_0x862aef<workers[_0x43d6db(0x14a)];_0x862aef++){_0x2a2ec6[_0x862aef]=[];}for(let _0x5ecf56=0x0;_0x5ecf56<_0x4d8d46['length'];_0x5ecf56++){const _0x2d11d7=_0x5ecf56%workers['length'];_0x2a2ec6[_0x2d11d7][_0x43d6db(0x14e)](_0x4d8d46[_0x5ecf56]);}return _0x2a2ec6;}function processBatchesInMainThread(_0x1a5861,_0x53768a){const _0x4c2aa0=_0x496841,_0x2b663c=[];for(let _0x4bdb82=0x0;_0x4bdb82<_0x1a5861[_0x4c2aa0(0x14a)];_0x4bdb82+=batchSize){_0x2b663c[_0x4c2aa0(0x14e)]({'items':_0x1a5861[_0x4c2aa0(0xe7)](_0x4bdb82,_0x4bdb82+batchSize),'startIndex':_0x4bdb82,'endIndex':Math[_0x4c2aa0(0x105)](_0x4bdb82+batchSize,_0x1a5861[_0x4c2aa0(0x14a)])});}function _0x3bf20f(_0x4e08c4){const _0x4a79b5=_0x4c2aa0;if(_0x4e08c4>=_0x2b663c[_0x4a79b5(0x14a)]){combineBatchResults();return;}const _0x169326=_0x2b663c[_0x4e08c4];updateProgress(_0x169326['startIndex'],_0x1a5861[_0x4a79b5(0x14a)],_0x4a79b5(0x1d6)+(_0x4e08c4+0x1)+'/'+_0x2b663c[_0x4a79b5(0x14a)]+_0x4a79b5(0x120));try{const _0x2f13f6=_0x53768a(_0x169326[_0x4a79b5(0x1cb)],_0x169326[_0x4a79b5(0x1ea)],_0x169326['endIndex']);batchResults[_0x4a79b5(0x14e)]({'batchIndex':_0x4e08c4,'features':_0x2f13f6}),setTimeout(()=>{_0x3bf20f(_0x4e08c4+0x1);},processingDelay);}catch(_0x23c52d){console[_0x4a79b5(0xf4)]('Error\x20processing\x20batch:',_0x23c52d),logMessage(_0x4a79b5(0xcb)+_0x4e08c4+':\x20'+_0x23c52d[_0x4a79b5(0x167)],_0x4a79b5(0xf4)),isProcessing=![],hideLoadingIndicator();}}_0x3bf20f(0x0);}function processParcelAreaBatch(_0x3d3d03){const _0x23749e=_0x496841,{parcelBatch:_0xfff57a,selectedCRS:_0x13e33b,startIndex:_0x3486b5,endIndex:_0x196817}=_0x3d3d03,_0x32d08f=[];for(let _0x66434=0x0;_0x66434<_0xfff57a[_0x23749e(0x14a)];_0x66434++){try{const _0x2ff1de=_0xfff57a[_0x66434],_0x1ebbb5=_0x3486b5+_0x66434;updateProgress(_0x1ebbb5,_0x196817,_0x23749e(0x17a)+(_0x1ebbb5+0x1)+'/'+_0x196817);let _0x50712c;_0x13e33b===_0x23749e(0x11c)?_0x50712c=turf[_0x23749e(0x102)](_0x2ff1de):_0x50712c=calculateAreaUTM(_0x2ff1de[_0x23749e(0xe9)],_0x13e33b);const _0x58ead4={'type':_0x23749e(0xe8),'properties':{..._0x2ff1de[_0x23749e(0xfb)],'parcelArea':Math[_0x23749e(0xee)](_0x50712c*0x64)/0x64},'geometry':_0x2ff1de[_0x23749e(0xe9)]};_0x32d08f[_0x23749e(0x14e)](_0x58ead4);}catch(_0x5eca5b){logMessage(_0x23749e(0x9a)+(_0x3486b5+_0x66434)+':\x20'+_0x5eca5b[_0x23749e(0x167)],_0x23749e(0xf4));}}return _0x32d08f;}function combineBatchResults(){const _0x4a1b51=_0x496841;try{batchResults[_0x4a1b51(0x18c)]((_0x38d156,_0x38dec8)=>_0x38d156['batchIndex']-_0x38dec8[_0x4a1b51(0xce)]);let _0x162663=[];for(const _0x3b40d9 of batchResults){_0x162663=_0x162663[_0x4a1b51(0x11f)](_0x3b40d9[_0x4a1b51(0x111)]);}const _0xae8f94={'type':_0x4a1b51(0xc0),'features':_0x162663};batchStats[_0x4a1b51(0x11e)]=Date[_0x4a1b51(0x1d1)]();const _0x46024b=(batchStats[_0x4a1b51(0x11e)]-batchStats[_0x4a1b51(0x131)])/0x3e8;logMessage(_0x4a1b51(0x1e8)+batchStats['featureCount']+_0x4a1b51(0x119)+_0x46024b['toFixed'](0x2)+_0x4a1b51(0xdf),_0x4a1b51(0x1d8));if(currentStep===_0x4a1b51(0x1a1))finalizeStep1(_0xae8f94);else{if(currentStep===_0x4a1b51(0x1a2))finalizeStep2(_0xae8f94);else{if(currentStep===_0x4a1b51(0x16e))finalizeStep3(_0xae8f94);else currentStep==='step4'&&finalizeStep4(_0xae8f94);}}isProcessing=![],hideLoadingIndicator();}catch(_0x4cc181){console['error'](_0x4a1b51(0x155),_0x4cc181),logMessage(_0x4a1b51(0x134)+_0x4cc181[_0x4a1b51(0x167)],_0x4a1b51(0xf4)),isProcessing=![],hideLoadingIndicator();}}function processBatchResult(_0x1d04c0){const _0x4ccd95=_0x496841;batchResults[_0x4ccd95(0x14e)]({'batchIndex':_0x1d04c0[_0x4ccd95(0xce)],'features':_0x1d04c0['features']}),batchResults[_0x4ccd95(0x14a)]===_0x1d04c0[_0x4ccd95(0x19d)]&&combineBatchResults();}function finalizeStep1(_0x3096a7){const _0x468a5b=_0x496841;if(_0x3096a7['features'][_0x468a5b(0x14a)]===0x0){alert(_0x468a5b(0xec));return;}resultGeojson=_0x3096a7,parcelOriginalShapes=JSON[_0x468a5b(0x1c1)](JSON['stringify'](parcelGeojson));resultLayer&&(map[_0x468a5b(0xea)](resultLayer),delete layerData[_0x468a5b(0x1a5)]);addGeoJSONToMap(resultGeojson,_0x468a5b(0x1a5),_0x468a5b(0x1bc));let _0x101e40=0x0;resultGeojson[_0x468a5b(0x111)][_0x468a5b(0x16b)](_0x2e3c41=>{const _0x1543e6=_0x468a5b;_0x101e40+=_0x2e3c41[_0x1543e6(0xfb)]['parcelArea'];});const _0x436564=_0x101e40/resultGeojson[_0x468a5b(0x111)][_0x468a5b(0x14a)];document[_0x468a5b(0x1df)](_0x468a5b(0xd5))[_0x468a5b(0x188)]='\x0a\x20\x20\x20\x20\x20\x20\x20\x20<p>Parcel\x20areas\x20calculated\x20for\x20'+resultGeojson[_0x468a5b(0x111)]['length']+_0x468a5b(0x9c)+Math[_0x468a5b(0xee)](_0x101e40*0x64)/0x64+_0x468a5b(0x19b)+Math[_0x468a5b(0xee)](_0x436564*0x64)/0x64+_0x468a5b(0x1a4)+currentCRS+_0x468a5b(0x15f),document[_0x468a5b(0x1df)](_0x468a5b(0xd5))[_0x468a5b(0x10e)][_0x468a5b(0x157)]=_0x468a5b(0x143),document[_0x468a5b(0x1df)](_0x468a5b(0x129))[_0x468a5b(0x16a)]=![],processFlags['step1']=!![],runningAllSteps&&setTimeout(()=>processStep2(),0x1f4);}function processStep2(){const _0x2fd698=_0x496841;if(isProcessing){logMessage(_0x2fd698(0x195),'warning');return;}if(processFlags[_0x2fd698(0x1a2)]){const _0x329b9c=confirm(_0x2fd698(0x1b0));if(!_0x329b9c)return;}if(!buildingGeojson||!parcelGeojson){alert(_0x2fd698(0xe5));return;}const _0x419611=document['getElementById'](_0x2fd698(0xff))[_0x2fd698(0x164)];if(!_0x419611){alert(_0x2fd698(0xc4));return;}currentStep=_0x2fd698(0x1a2),batchSize=parseInt(document[_0x2fd698(0x1df)](_0x2fd698(0x99))['value'])||0x64,processingDelay=parseInt(document['getElementById'](_0x2fd698(0x113))[_0x2fd698(0x164)])||0xa;const _0x4cf811=JSON['parse'](JSON[_0x2fd698(0xe2)](buildingGeojson)),_0x403fa4=JSON[_0x2fd698(0x1c1)](JSON[_0x2fd698(0xe2)](parcelGeojson));batchResults=[],currentBatch=0x0;const _0x4926d6=_0x4cf811[_0x2fd698(0x111)]['length'];totalBatches=Math[_0x2fd698(0xc3)](_0x4926d6/batchSize),showLoadingIndicator(_0x2fd698(0xc5)),updateProgress(0x0,_0x4926d6,_0x2fd698(0x1a9)),logMessage(_0x2fd698(0x136)+_0x4926d6+_0x2fd698(0xb4)+totalBatches+_0x2fd698(0x1e0),'info'),batchStats[_0x2fd698(0x131)]=Date[_0x2fd698(0x1d1)](),batchStats['featureCount']=_0x4926d6,isProcessing=!![],processBatchesStep2(_0x4cf811,_0x403fa4);}function processBatchesStep2(_0x4afa56,_0xd5ce8){const _0x5cc161=_0x496841;useWebWorkers&&workers[_0x5cc161(0x14a)]>0x0?processBatchesWithWorkers(_0x4afa56[_0x5cc161(0x111)],_0xd5ce8,_0x5cc161(0x168)):processBatchesInMainThread(_0x4afa56[_0x5cc161(0x111)],(_0x22e552,_0xf55e63,_0x1d814d)=>{return processBuildingPointsBatch({'buildingBatch':_0x22e552,'parcelGeojson':_0xd5ce8,'selectedField':document['getElementById']('parcelFieldSelector')['value'],'startIndex':_0xf55e63,'endIndex':_0x1d814d});});}function processBuildingPointsBatch(_0x49f9b7){const _0x572e4b=_0x496841,{buildingBatch:_0x102d7a,parcelGeojson:_0x5b61b8,selectedField:_0x19b5b0,startIndex:_0x3543d7,endIndex:_0x544bf8}=_0x49f9b7,_0x296a6c=[];let _0x3ca756=0x0,_0x134901=0x0;for(let _0x1130c2=0x0;_0x1130c2<_0x102d7a[_0x572e4b(0x14a)];_0x1130c2++){try{const _0x41e52c=_0x102d7a[_0x1130c2],_0x31b263=_0x3543d7+_0x1130c2;updateProgress(_0x31b263,_0x544bf8,_0x572e4b(0x156)+(_0x31b263+0x1)+'/'+_0x544bf8);let _0x3b2a77;if(_0x41e52c['geometry'][_0x572e4b(0x19f)]===_0x572e4b(0xfd)){const _0xd37f5a=turf['centroid'](_0x41e52c);_0x3b2a77=_0xd37f5a[_0x572e4b(0xe9)][_0x572e4b(0x1e1)];}else{if(_0x41e52c['geometry']['type']===_0x572e4b(0xd0)){const _0x355e66={'type':_0x572e4b(0xe8),'properties':{},'geometry':{'type':_0x572e4b(0xfd),'coordinates':_0x41e52c[_0x572e4b(0xe9)]['coordinates'][0x0]}},_0x5c2413=turf['centroid'](_0x355e66);_0x3b2a77=_0x5c2413['geometry'][_0x572e4b(0x1e1)];}else throw new Error(_0x572e4b(0xb8)+_0x41e52c[_0x572e4b(0xe9)][_0x572e4b(0x19f)]);}const _0x253a7a={'type':_0x572e4b(0xe8),'properties':{..._0x41e52c[_0x572e4b(0xfb)],'parcelId':null,'parcelName':null,'buildingArea':typeof _0x41e52c[_0x572e4b(0xfb)][_0x572e4b(0x1e5)]==='number'?_0x41e52c['properties'][_0x572e4b(0x1e5)]:0x0},'geometry':{'type':'Point','coordinates':_0x3b2a77}};for(const _0x3a8786 of _0x5b61b8[_0x572e4b(0x111)]){if(turf[_0x572e4b(0xe4)](_0x253a7a['geometry'][_0x572e4b(0x1e1)],_0x3a8786[_0x572e4b(0xe9)])){_0x253a7a[_0x572e4b(0xfb)][_0x572e4b(0x181)]=_0x3a8786[_0x572e4b(0xfb)][_0x19b5b0],_0x253a7a[_0x572e4b(0xfb)][_0x572e4b(0xd8)]=_0x3a8786[_0x572e4b(0xfb)][_0x19b5b0];break;}}_0x296a6c[_0x572e4b(0x14e)](_0x253a7a),_0x134901++;}catch(_0x256a2d){logMessage(_0x572e4b(0x12c)+(_0x3543d7+_0x1130c2)+':\x20'+_0x256a2d[_0x572e4b(0x167)],_0x572e4b(0x144)),_0x3ca756++;}}return _0x296a6c;}function finalizeStep2(_0x11f2dd){const _0x45df72=_0x496841;if(_0x11f2dd[_0x45df72(0x111)][_0x45df72(0x14a)]===0x0){alert('Failed\x20to\x20create\x20any\x20building\x20points.\x20Check\x20the\x20building\x20GeoJSON\x20data.');return;}layerData[_0x45df72(0x18b)]&&layerData[_0x45df72(0x18b)][_0x45df72(0xf6)]&&(map['removeLayer'](layerData[_0x45df72(0x18b)][_0x45df72(0xf6)]),delete layerData[_0x45df72(0x18b)]);addGeoJSONToMap(_0x11f2dd,'buildingPoints',_0x45df72(0x1ab));let _0xd65410=0x0;_0x11f2dd[_0x45df72(0x111)]['forEach'](_0xb8c31b=>{const _0x4cd581=_0x45df72;_0xb8c31b['properties'][_0x4cd581(0x181)]&&_0xd65410++;});const _0x49ea34=document[_0x45df72(0x1df)](_0x45df72(0xff))[_0x45df72(0x164)];document[_0x45df72(0x1df)](_0x45df72(0xb0))['innerHTML']=_0x45df72(0x108)+_0x11f2dd[_0x45df72(0x111)]['length']+_0x45df72(0x128)+_0xd65410+'\x20('+Math[_0x45df72(0xee)](_0xd65410/_0x11f2dd[_0x45df72(0x111)][_0x45df72(0x14a)]*0x64)+_0x45df72(0x19e)+_0x49ea34+_0x45df72(0x15f),document[_0x45df72(0x1df)](_0x45df72(0xb0))[_0x45df72(0x10e)][_0x45df72(0x157)]=_0x45df72(0x143),document[_0x45df72(0x1df)](_0x45df72(0x125))[_0x45df72(0x16a)]=![],processFlags[_0x45df72(0x1a2)]=!![],runningAllSteps&&setTimeout(()=>processStep3(),0x1f4);}function processStep3(){const _0x5cba15=_0x496841;if(isProcessing){logMessage('Processing\x20already\x20in\x20progress,\x20please\x20wait',_0x5cba15(0x144));return;}if(processFlags[_0x5cba15(0x16e)]){const _0x291b58=confirm(_0x5cba15(0x145));if(!_0x291b58)return;}if(!buildingGeojson||!parcelGeojson){alert(_0x5cba15(0xa9));return;}const _0xf3fba0=parcelOriginalShapes||parcelGeojson;currentStep='step3',batchSize=parseInt(document['getElementById']('batchSize')[_0x5cba15(0x164)])||0x64,processingDelay=parseInt(document['getElementById'](_0x5cba15(0x113))[_0x5cba15(0x164)])||0xa;const _0x59e5ac=JSON[_0x5cba15(0x1c1)](JSON['stringify'](_0xf3fba0)),_0x487f10=JSON['parse'](JSON[_0x5cba15(0xe2)](buildingGeojson));batchResults=[],currentBatch=0x0;const _0x3a1a80=_0x59e5ac['features']['length'];totalBatches=Math[_0x5cba15(0xc3)](_0x3a1a80/batchSize),showLoadingIndicator('Calculating\x20building\x20areas\x20by\x20parcel'),updateProgress(0x0,_0x3a1a80,'Starting\x20building\x20area\x20calculation...'),logMessage(_0x5cba15(0x12e)+_0x3a1a80+_0x5cba15(0x1a8)+totalBatches+'\x20batches','info'),batchStats[_0x5cba15(0x131)]=Date[_0x5cba15(0x1d1)](),batchStats['featureCount']=_0x3a1a80,isProcessing=!![],processBatchesStep3(_0x59e5ac,_0x487f10);}function processBatchesStep3(_0x2d1b1e,_0x583ef2){const _0x2dab21=_0x496841;useWebWorkers&&workers[_0x2dab21(0x14a)]>0x0?processBatchesWithWorkers(_0x2d1b1e[_0x2dab21(0x111)],_0x583ef2,_0x2dab21(0x10b)):processBatchesInMainThread(_0x2d1b1e[_0x2dab21(0x111)],(_0x50a92e,_0x4abf80,_0x555134)=>{const _0x2ff24d=_0x2dab21;return processBuildingAreasBatch({'parcelBatch':_0x50a92e,'buildingGeojson':_0x583ef2,'selectedField':document[_0x2ff24d(0x1df)](_0x2ff24d(0xff))[_0x2ff24d(0x164)],'startIndex':_0x4abf80,'endIndex':_0x555134,'parcelAreaResults':resultGeojson});});}function processBuildingAreasBatch(_0x1ecd14){const _0x345cea=_0x496841,{parcelBatch:_0x102215,buildingGeojson:_0x47c28d,selectedField:_0x240d36,startIndex:_0x48bf99,endIndex:_0x2ebb24,parcelAreaResults:_0x3cd78b}=_0x1ecd14,_0x1e30b2=[];for(let _0x51fb05=0x0;_0x51fb05<_0x102215[_0x345cea(0x14a)];_0x51fb05++){try{const _0x2ef3ce=_0x102215[_0x51fb05],_0x8f534d=_0x48bf99+_0x51fb05;updateProgress(_0x8f534d,_0x2ebb24,_0x345cea(0x17a)+(_0x8f534d+0x1)+'/'+_0x2ebb24);const _0x1338fd=_0x2ef3ce[_0x345cea(0xfb)][_0x240d36];let _0xf5e283=0x0,_0x7fd533=0x0,_0x5074ec=[];for(let _0x1aa779=0x0;_0x1aa779<_0x47c28d[_0x345cea(0x111)][_0x345cea(0x14a)];_0x1aa779++){const _0x532585=_0x47c28d[_0x345cea(0x111)][_0x1aa779];try{let _0x4c25e1;if(_0x532585[_0x345cea(0xe9)]['type']==='Polygon'){const _0x374fd7=turf[_0x345cea(0x100)](_0x532585);_0x4c25e1=_0x374fd7[_0x345cea(0xe9)][_0x345cea(0x1e1)];}else{if(_0x532585[_0x345cea(0xe9)]['type']===_0x345cea(0xd0)){const _0x50a6b9={'type':_0x345cea(0xe8),'properties':{},'geometry':{'type':_0x345cea(0xfd),'coordinates':_0x532585[_0x345cea(0xe9)]['coordinates'][0x0]}},_0x66d4f3=turf['centroid'](_0x50a6b9);_0x4c25e1=_0x66d4f3[_0x345cea(0xe9)][_0x345cea(0x1e1)];}else continue;}if(turf[_0x345cea(0xe4)](_0x4c25e1,_0x2ef3ce[_0x345cea(0xe9)])){let _0x4f5a4a=0x0;if(typeof _0x532585[_0x345cea(0xfb)][_0x345cea(0x1e5)]===_0x345cea(0x1da))_0x4f5a4a=_0x532585[_0x345cea(0xfb)][_0x345cea(0x1e5)];else typeof _0x532585['properties'][_0x345cea(0x1e5)]===_0x345cea(0x9e)&&(_0x4f5a4a=parseFloat(_0x532585[_0x345cea(0xfb)]['BL_AREA'])||0x0);_0x4f5a4a=isNaN(_0x4f5a4a)||_0x4f5a4a<0x0?0x0:_0x4f5a4a;const _0x1050fb=_0x4f5a4a;_0xf5e283+=_0x1050fb,_0x7fd533++,_0x5074ec[_0x345cea(0x14e)]({'id':_0x1aa779,'area':_0x4f5a4a,'footprintArea':_0x1050fb});}}catch(_0x1be724){logMessage('Error\x20processing\x20building\x20'+_0x1aa779+_0x345cea(0x126)+_0x8f534d+':\x20'+_0x1be724[_0x345cea(0x167)],_0x345cea(0x144));}}_0xf5e283=Math[_0x345cea(0xee)](_0xf5e283*0x64)/0x64;let _0x199301=0x0;if(_0x3cd78b&&_0x3cd78b[_0x345cea(0x111)]){const _0x52312b=_0x3cd78b[_0x345cea(0x111)]['find'](_0x37ae06=>_0x37ae06[_0x345cea(0xfb)][_0x240d36]===_0x1338fd);_0x52312b&&(_0x199301=_0x52312b[_0x345cea(0xfb)][_0x345cea(0x1a5)]||0x0);}let _0x367f49='Buildings\x20calculation\x20details:\x0a';_0x5074ec[_0x345cea(0x16b)](_0x40cfc3=>{const _0x179b00=_0x345cea;_0x367f49+=_0x179b00(0x14b)+_0x40cfc3['id']+':\x20'+_0x40cfc3[_0x179b00(0x102)]+_0x179b00(0x1ae);});_0x5074ec['length']===0x0&&(_0x367f49=_0x345cea(0x1c5));const _0x4cfc25={'type':'Feature','properties':{..._0x2ef3ce[_0x345cea(0xfb)],'totalBuildingArea':_0xf5e283,'buildingCount':_0x7fd533,'parcelArea':_0x199301,'calculationDetails':_0x367f49},'geometry':_0x2ef3ce[_0x345cea(0xe9)]};_0x1e30b2[_0x345cea(0x14e)](_0x4cfc25);}catch(_0x292486){logMessage('Error\x20processing\x20parcel\x20'+(_0x48bf99+_0x51fb05)+_0x345cea(0x182)+_0x292486[_0x345cea(0x167)],_0x345cea(0xf4));}}return _0x1e30b2;}function finalizeStep3(_0x5d87db){const _0x2c46b6=_0x496841;if(_0x5d87db['features'][_0x2c46b6(0x14a)]===0x0){alert(_0x2c46b6(0x103));return;}resultGeojson=_0x5d87db;resultLayer&&(map[_0x2c46b6(0xea)](resultLayer),delete layerData[_0x2c46b6(0x171)]);addGeoJSONToMap(resultGeojson,_0x2c46b6(0x171),_0x2c46b6(0x197));let _0x24f34a=0x0,_0x59a416=0x0,_0xf46495=0x0;resultGeojson['features'][_0x2c46b6(0x16b)](_0x5ef3c1=>{const _0x1e736a=_0x2c46b6,_0x3d7caf=_0x5ef3c1['properties'][_0x1e736a(0x1cf)]||0x0,_0xc40818=_0x5ef3c1[_0x1e736a(0xfb)][_0x1e736a(0x115)]||0x0;_0x24f34a+=_0x3d7caf,_0x59a416+=_0xc40818,_0x3d7caf>0x0&&_0xf46495++;}),document[_0x2c46b6(0x1df)](_0x2c46b6(0x127))[_0x2c46b6(0x188)]=_0x2c46b6(0x1b1)+resultGeojson[_0x2c46b6(0x111)][_0x2c46b6(0x14a)]+_0x2c46b6(0xfc)+_0xf46495+_0x2c46b6(0x1e9)+_0x24f34a+_0x2c46b6(0xa1)+Math[_0x2c46b6(0xee)](_0x59a416*0x64)/0x64+_0x2c46b6(0x146)+currentCRS+_0x2c46b6(0x15f),document['getElementById'](_0x2c46b6(0x127))[_0x2c46b6(0x10e)][_0x2c46b6(0x157)]='block',document[_0x2c46b6(0x1df)]('processStep4')[_0x2c46b6(0x16a)]=![],processFlags['step3']=!![],runningAllSteps&&setTimeout(()=>processStep4(),0x1f4);}function processStep4(){const _0x443df6=_0x496841;if(isProcessing){logMessage('Processing\x20already\x20in\x20progress,\x20please\x20wait','warning');return;}if(processFlags['step4']){const _0x336c64=confirm(_0x443df6(0xbd));if(!_0x336c64)return;}if(!resultGeojson){alert('Please\x20complete\x20step\x203\x20first.');return;}currentStep='step4',batchSize=parseInt(document[_0x443df6(0x1df)]('batchSize')['value'])||0x64,processingDelay=parseInt(document[_0x443df6(0x1df)]('processingDelay')['value'])||0xa;const _0x4dc63f=JSON[_0x443df6(0x1c1)](JSON['stringify'](resultGeojson));batchResults=[],currentBatch=0x0;const _0x2a4ad2=_0x4dc63f[_0x443df6(0x111)][_0x443df6(0x14a)];totalBatches=Math['ceil'](_0x2a4ad2/batchSize),showLoadingIndicator(_0x443df6(0x1d3)),updateProgress(0x0,_0x2a4ad2,'Starting\x20BCR\x20calculation...'),logMessage(_0x443df6(0xf0)+_0x2a4ad2+_0x443df6(0x1a8)+totalBatches+_0x443df6(0x1e0),_0x443df6(0x1d8)),batchStats[_0x443df6(0x131)]=Date[_0x443df6(0x1d1)](),batchStats['featureCount']=_0x2a4ad2,isProcessing=!![],processBatchesStep4(_0x4dc63f);}function processBatchesStep4(_0x121320){const _0x1851c9=_0x496841;useWebWorkers&&workers[_0x1851c9(0x14a)]>0x0?processBatchesWithWorkers(_0x121320['features'],null,'calculateBCR'):processBatchesInMainThread(_0x121320[_0x1851c9(0x111)],(_0x4c8046,_0x369019,_0x397aa5)=>{return calculateBCRBatch({'parcelBatch':_0x4c8046,'startIndex':_0x369019,'endIndex':_0x397aa5});});}function calculateBCRBatch(_0xa2d090){const _0x550871=_0x496841,{parcelBatch:_0x4aca3c,startIndex:_0x4e12d9,endIndex:_0xb3b281}=_0xa2d090,_0x75d64a=[];for(let _0x480366=0x0;_0x480366<_0x4aca3c[_0x550871(0x14a)];_0x480366++){try{const _0x24d9d7=_0x4aca3c[_0x480366],_0x4f4642=_0x4e12d9+_0x480366;updateProgress(_0x4f4642,_0xb3b281,_0x550871(0x170)+(_0x4f4642+0x1)+'/'+_0xb3b281);const _0x9eac59=_0x24d9d7[_0x550871(0xfb)]['totalBuildingArea']||0x0,_0xb439fc=_0x24d9d7['properties']['parcelArea']||0x0;let _0x45e7b3=0x0;_0xb439fc>0x0&&(_0x45e7b3=_0x9eac59/_0xb439fc*0x64);_0x45e7b3=Math[_0x550871(0xee)](_0x45e7b3*0x64)/0x64;const _0x5791f0={'type':'Feature','properties':{..._0x24d9d7['properties'],'BCR':_0x45e7b3},'geometry':_0x24d9d7['geometry']};_0x75d64a[_0x550871(0x14e)](_0x5791f0);}catch(_0x46ec8d){logMessage(_0x550871(0x183)+(_0x4e12d9+_0x480366)+':\x20'+_0x46ec8d[_0x550871(0x167)],_0x550871(0xf4));}}return _0x75d64a;}function finalizeStep4(_0x442895){const _0x1e9e5c=_0x496841;if(_0x442895[_0x1e9e5c(0x111)][_0x1e9e5c(0x14a)]===0x0){alert(_0x1e9e5c(0x17f));return;}resultGeojson=_0x442895,window['finalResultGeojson']=_0x442895;resultLayer&&(map[_0x1e9e5c(0xea)](resultLayer),delete layerData[_0x1e9e5c(0x1bd)]);addGeoJSONToMap(resultGeojson,_0x1e9e5c(0x1bd),_0x1e9e5c(0x1c8));let _0x557f20=0x0,_0x2e5d6b=0x0,_0x6dac5=resultGeojson[_0x1e9e5c(0x111)][_0x1e9e5c(0x14a)],_0x4f7e3b=0x0,_0x5358bd=[];resultGeojson[_0x1e9e5c(0x111)]['forEach'](_0x1c2a57=>{const _0x40cea7=_0x1e9e5c;_0x1c2a57[_0x40cea7(0xfb)]['parcelArea']>0x0&&(_0x557f20+=_0x1c2a57[_0x40cea7(0xfb)][_0x40cea7(0x1a5)],_0x2e5d6b+=_0x1c2a57['properties'][_0x40cea7(0x115)]||0x0,_0x1c2a57[_0x40cea7(0xfb)][_0x40cea7(0x152)]!==undefined&&_0x1c2a57['properties'][_0x40cea7(0x1a5)]>0x0&&_0x5358bd[_0x40cea7(0x14e)](_0x1c2a57[_0x40cea7(0xfb)]['BCR']),_0x4f7e3b++);});const _0x41e8cf=_0x5358bd[_0x1e9e5c(0x14a)]>0x0?_0x5358bd[_0x1e9e5c(0x112)]((_0x52c5d2,_0x43076e)=>_0x52c5d2+_0x43076e,0x0)/_0x5358bd[_0x1e9e5c(0x14a)]:0x0,_0x42ac09=_0x5358bd[_0x1e9e5c(0x14a)]>0x0?Math['max'](..._0x5358bd):0x0,_0x2dd281=_0x5358bd['length']>0x0?Math[_0x1e9e5c(0x105)](..._0x5358bd):0x0;document[_0x1e9e5c(0x1df)]('step4Result')['innerHTML']=_0x1e9e5c(0x1c2)+resultGeojson[_0x1e9e5c(0x111)]['length']+'\x20parcels:</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<p>BCR\x20=\x20(totalBuildingArea\x20/\x20parcelArea)\x20*\x20100</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<hr>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<p>Summary\x20Statistics:</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<p>Total\x20parcels:\x20'+_0x6dac5+'</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<p>Total\x20parcel\x20area:\x20'+Math[_0x1e9e5c(0xee)](_0x557f20*0x64)/0x64+'\x20sq.m</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<p>Total\x20building\x20coverage\x20area:\x20'+Math[_0x1e9e5c(0xee)](_0x2e5d6b*0x64)/0x64+_0x1e9e5c(0x1d9)+Math[_0x1e9e5c(0xee)](_0x41e8cf*0x64)/0x64+_0x1e9e5c(0x1e2)+Math['round'](_0x42ac09*0x64)/0x64+'%</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<p><strong>Minimum\x20BCR:</strong>\x20'+Math[_0x1e9e5c(0xee)](_0x2dd281*0x64)/0x64+'%</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<p>CRS:\x20'+currentCRS+_0x1e9e5c(0x15f),document[_0x1e9e5c(0x1df)](_0x1e9e5c(0x124))[_0x1e9e5c(0x10e)][_0x1e9e5c(0x157)]='block',document[_0x1e9e5c(0x1df)](_0x1e9e5c(0x9d))['disabled']=![],document[_0x1e9e5c(0x1df)](_0x1e9e5c(0xcc))[_0x1e9e5c(0x16a)]=![],processFlags[_0x1e9e5c(0xb1)]=!![],runningAllSteps&&(runningAllSteps=![],logMessage(_0x1e9e5c(0x1ac),_0x1e9e5c(0x1d8)));}let runningAllSteps=![];function runAllSteps(){const _0xba3e88=_0x496841;if(isProcessing){logMessage('Processing\x20already\x20in\x20progress,\x20please\x20wait',_0xba3e88(0x144));return;}if(!buildingGeojson||!parcelGeojson){alert(_0xba3e88(0xdb));return;}const _0x4ceae3=document[_0xba3e88(0x1df)](_0xba3e88(0xff))[_0xba3e88(0x164)];if(!_0x4ceae3){alert(_0xba3e88(0xc4));return;}if(processFlags[_0xba3e88(0x1a1)]||processFlags['step2']||processFlags[_0xba3e88(0x16e)]||processFlags[_0xba3e88(0xb1)]){const _0x8cae2e=confirm('Some\x20steps\x20have\x20already\x20been\x20completed.\x20Do\x20you\x20want\x20to\x20run\x20all\x20steps\x20again?');if(!_0x8cae2e)return;}runningAllSteps=!![],processStep1();}function showLoadingIndicator(_0x278d70){const _0x1d2839=_0x496841,_0x5d0980=document[_0x1d2839(0x1df)]('loadingIndicator'),_0x31ad1f=document[_0x1d2839(0x1df)]('processingStatus');_0x278d70?_0x31ad1f[_0x1d2839(0xd9)]=':\x20'+_0x278d70:_0x31ad1f[_0x1d2839(0xd9)]='',_0x5d0980[_0x1d2839(0x10e)][_0x1d2839(0x157)]=_0x1d2839(0x143),document[_0x1d2839(0x1df)](_0x1d2839(0x173))[_0x1d2839(0x10e)][_0x1d2839(0x178)]='0%';}function hideLoadingIndicator(){const _0x1a66b0=_0x496841;document[_0x1a66b0(0x1df)]('loadingIndicator')[_0x1a66b0(0x10e)][_0x1a66b0(0x157)]=_0x1a66b0(0xe0);}function updateProgress(_0x2eef23,_0x361d86,_0x2a84f6){const _0x1ecffd=_0x496841,_0x4e0d00=Math['min'](0x64,Math[_0x1ecffd(0xee)](_0x2eef23/_0x361d86*0x64));document[_0x1ecffd(0x1df)](_0x1ecffd(0x173))['style'][_0x1ecffd(0x178)]=_0x4e0d00+'%',_0x2a84f6&&(document[_0x1ecffd(0x1df)](_0x1ecffd(0x110))[_0x1ecffd(0xd9)]=':\x20'+_0x2a84f6);}function logMessage(_0x56ab6a,_0xac84a6='info'){const _0x15fdd4=_0x496841,_0x21b3bf=new Date(),_0x10a19e=_0x21b3bf[_0x15fdd4(0x1b4)](),_0x46373d=document[_0x15fdd4(0xac)](_0x15fdd4(0x118));_0x46373d[_0x15fdd4(0xa6)]=_0x15fdd4(0x1cd)+_0xac84a6,_0x46373d['textContent']='['+_0x10a19e+']\x20'+_0x56ab6a;const _0x1d44a2=document[_0x15fdd4(0x1df)](_0x15fdd4(0x179));_0x1d44a2[_0x15fdd4(0x11a)](_0x46373d),_0x1d44a2[_0x15fdd4(0x13a)]=_0x1d44a2[_0x15fdd4(0x1dc)];switch(_0xac84a6){case _0x15fdd4(0xf4):console[_0x15fdd4(0xf4)](_0x56ab6a);break;case _0x15fdd4(0x144):console['warn'](_0x56ab6a);break;default:console[_0x15fdd4(0x1ce)](_0x56ab6a);}}function exportResult(){const _0x4126d5=_0x496841;if(!window[_0x4126d5(0xe1)]){alert(_0x4126d5(0x177));return;}const _0x393569=JSON[_0x4126d5(0x1c1)](JSON[_0x4126d5(0xe2)](window[_0x4126d5(0xe1)]));parcelGeojson&&parcelGeojson[_0x4126d5(0x1db)]?_0x393569[_0x4126d5(0x1db)]=parcelGeojson[_0x4126d5(0x1db)]:_0x393569[_0x4126d5(0x1db)]={'type':_0x4126d5(0xab),'properties':{'name':currentCRS}};_0x393569[_0x4126d5(0xfb)]=_0x393569[_0x4126d5(0xfb)]||{},_0x393569['properties'][_0x4126d5(0x13f)]=_0x4126d5(0x109),_0x393569[_0x4126d5(0xfb)]['processingDate']=new Date()[_0x4126d5(0x16f)](),_0x393569[_0x4126d5(0xfb)][_0x4126d5(0x1b9)]=currentCRS;const _0x3e4859=new Blob([JSON[_0x4126d5(0xe2)](_0x393569)],{'type':'application/json'}),_0x59c70c=URL['createObjectURL'](_0x3e4859),_0x58c749=document[_0x4126d5(0xac)]('a');_0x58c749['href']=_0x59c70c,_0x58c749[_0x4126d5(0x18d)]='BCR_analysis_result.geojson',document[_0x4126d5(0xf8)][_0x4126d5(0x11a)](_0x58c749),_0x58c749[_0x4126d5(0xb2)](),document[_0x4126d5(0xf8)][_0x4126d5(0x166)](_0x58c749),URL[_0x4126d5(0x12d)](_0x59c70c),logMessage(_0x4126d5(0x1eb),'info');}function exportExcel(){const _0x26651f=_0x496841;if(!window[_0x26651f(0xe1)]){alert(_0x26651f(0x177));return;}const _0x400278=document[_0x26651f(0x1df)](_0x26651f(0xf3))[_0x26651f(0x164)],_0x50aef5=document[_0x26651f(0x1df)]('parcelFieldSelector')[_0x26651f(0x164)]||'ID',_0x796639=XLSX[_0x26651f(0x132)][_0x26651f(0x1d2)](),_0x2ed4e4=window[_0x26651f(0xe1)][_0x26651f(0x111)][_0x26651f(0x175)](_0x2041d5=>{const _0x4c4eaa=_0x26651f;return{[_0x50aef5]:_0x2041d5[_0x4c4eaa(0xfb)][_0x50aef5],'Parcel\x20Area\x20(sq.m)':_0x2041d5[_0x4c4eaa(0xfb)][_0x4c4eaa(0x1a5)],'Total\x20Building\x20Coverage\x20Area\x20(sq.m)':_0x2041d5[_0x4c4eaa(0xfb)][_0x4c4eaa(0x115)],'BCR\x20(%)':_0x2041d5[_0x4c4eaa(0xfb)][_0x4c4eaa(0x152)],'Building\x20Count':_0x2041d5[_0x4c4eaa(0xfb)]['buildingCount']||0x0};});let _0x35e1d6=_0x2ed4e4[_0x26651f(0x12b)](_0x2f4f04=>_0x2f4f04[_0x26651f(0x121)]>0x0)['map'](_0x302978=>_0x302978[_0x26651f(0x10a)]);const _0x1b4d2a=_0x35e1d6[_0x26651f(0x14a)]>0x0?_0x35e1d6['reduce']((_0x56bcd1,_0x13c283)=>_0x56bcd1+_0x13c283,0x0)/_0x35e1d6[_0x26651f(0x14a)]:0x0,_0x1bb1f7=_0x35e1d6[_0x26651f(0x14a)]>0x0?Math[_0x26651f(0x1e3)](..._0x35e1d6):0x0,_0x1a133d=_0x35e1d6['length']>0x0?Math['min'](..._0x35e1d6):0x0;_0x2ed4e4[_0x26651f(0x14e)]({}),_0x2ed4e4['push']({[_0x50aef5]:_0x26651f(0x13c)}),_0x2ed4e4['push']({[_0x50aef5]:_0x26651f(0x13b),'BCR\x20(%)':Math[_0x26651f(0xee)](_0x1b4d2a*0x64)/0x64}),_0x2ed4e4['push']({[_0x50aef5]:_0x26651f(0xd2),'BCR\x20(%)':Math[_0x26651f(0xee)](_0x1bb1f7*0x64)/0x64}),_0x2ed4e4[_0x26651f(0x14e)]({[_0x50aef5]:_0x26651f(0x160),'BCR\x20(%)':Math['round'](_0x1a133d*0x64)/0x64}),_0x2ed4e4['push']({}),_0x2ed4e4[_0x26651f(0x14e)]({[_0x50aef5]:'PROCESSING\x20INFORMATION'}),_0x2ed4e4[_0x26651f(0x14e)]({[_0x50aef5]:_0x26651f(0x17d),'BCR\x20(%)':_0x400278}),_0x2ed4e4[_0x26651f(0x14e)]({[_0x50aef5]:_0x26651f(0x1c7),'BCR\x20(%)':new Date()[_0x26651f(0x1d4)]()});const _0x413f34=XLSX[_0x26651f(0x132)][_0x26651f(0x122)](_0x2ed4e4);XLSX['utils'][_0x26651f(0xe6)](_0x796639,_0x413f34,_0x26651f(0x141)),XLSX['writeFile'](_0x796639,_0x26651f(0x14d)+_0x400278[_0x26651f(0xaa)](':','_')+'.xlsx'),logMessage(_0x26651f(0x15e),_0x26651f(0x1d8));}function init(){const _0x32b2a0=_0x496841;createWorkers(),initMap(),document[_0x32b2a0(0x1df)](_0x32b2a0(0xf3))[_0x32b2a0(0xa2)](_0x32b2a0(0x16c),function(){initMap();}),document[_0x32b2a0(0x1df)](_0x32b2a0(0x1a0))[_0x32b2a0(0xa2)]('change',function(){const _0x436de2=_0x32b2a0;handleFileUpload(this,_0x436de2(0x18f));}),document[_0x32b2a0(0x1df)](_0x32b2a0(0x15b))[_0x32b2a0(0xa2)](_0x32b2a0(0x16c),function(){handleFileUpload(this,'parcel');}),document['getElementById'](_0x32b2a0(0xcf))['addEventListener'](_0x32b2a0(0xb2),processStep1),document[_0x32b2a0(0x1df)](_0x32b2a0(0x129))[_0x32b2a0(0xa2)](_0x32b2a0(0xb2),processStep2),document[_0x32b2a0(0x1df)](_0x32b2a0(0x125))[_0x32b2a0(0xa2)](_0x32b2a0(0xb2),processStep3),document[_0x32b2a0(0x1df)](_0x32b2a0(0x185))[_0x32b2a0(0xa2)](_0x32b2a0(0xb2),processStep4),document[_0x32b2a0(0x1df)](_0x32b2a0(0x9d))[_0x32b2a0(0xa2)]('click',exportResult),document[_0x32b2a0(0x1df)](_0x32b2a0(0xcc))[_0x32b2a0(0xa2)](_0x32b2a0(0xb2),exportExcel),document[_0x32b2a0(0x1df)]('runAllSteps')['addEventListener'](_0x32b2a0(0xb2),runAllSteps),document[_0x32b2a0(0x1df)](_0x32b2a0(0x1b3))[_0x32b2a0(0xa2)]('change',function(){const _0x2d80d3=_0x32b2a0;displayAttributes(this[_0x2d80d3(0x164)]);}),document['getElementById'](_0x32b2a0(0x138))[_0x32b2a0(0xa2)](_0x32b2a0(0x16c),function(){const _0x49ca43=_0x32b2a0;useWebWorkers=this['checked'],useWebWorkers?createWorkers():terminateWorkers(),logMessage(_0x49ca43(0x19c)+(useWebWorkers?_0x49ca43(0x1de):_0x49ca43(0x16a)),_0x49ca43(0x1d8));}),document['getElementById'](_0x32b2a0(0x130))[_0x32b2a0(0xa2)](_0x32b2a0(0xb2),function(){const _0x4d2964=_0x32b2a0,_0x5ded85=document[_0x4d2964(0x1df)](_0x4d2964(0x158));_0x5ded85[_0x4d2964(0x10e)][_0x4d2964(0x157)]===_0x4d2964(0xe0)?(_0x5ded85[_0x4d2964(0x10e)]['display']=_0x4d2964(0x143),this[_0x4d2964(0x188)]=_0x4d2964(0x114)):(_0x5ded85['style']['display']=_0x4d2964(0xe0),this[_0x4d2964(0x188)]=_0x4d2964(0x1e6));}),document['getElementById'](_0x32b2a0(0xcf))['disabled']=!![],document[_0x32b2a0(0x1df)]('processStep2')[_0x32b2a0(0x16a)]=!![],document[_0x32b2a0(0x1df)](_0x32b2a0(0x125))[_0x32b2a0(0x16a)]=!![],document[_0x32b2a0(0x1df)](_0x32b2a0(0x185))[_0x32b2a0(0x16a)]=!![],document[_0x32b2a0(0x1df)]('exportButton')['disabled']=!![],document[_0x32b2a0(0x1df)](_0x32b2a0(0xcc))[_0x32b2a0(0x16a)]=!![],document[_0x32b2a0(0x1df)](_0x32b2a0(0x1c4))[_0x32b2a0(0x16a)]=!![],logMessage('Application\x20initialized\x20successfully!',_0x32b2a0(0x1d8)),logMessage(_0x32b2a0(0x1b2)+currentCRS+_0x32b2a0(0x163),_0x32b2a0(0x1d8));}window[_0x496841(0xd1)]=init;
  </script>
</body>
</html>