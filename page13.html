<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UTM Precision Splitter (Zone 47/48) - Enhanced</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&family=Sarabun:wght@300;400;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shpjs/3.6.3/shp.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <style>
    /* Import Google Fonts */
    @import url('https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap');

    :root {
        --primary-gradient: linear-gradient(135deg, #1e88e5 0%, #1565c0 50%, #0d47a1 100%);
        --text-white: #ffffff;
        --text-yellow: #ffeb3b;
        --bg-glass: rgba(255, 255, 255, 0.1);
        --bg-glass-hover: rgba(255, 255, 255, 0.25);
        --header-height: 70px;
        --accent-color: #1e88e5;
        --success-color: #2e7d32;
        --warning-color: #ed6c02;
        --danger-color: #d32f2f;
    }

    /* Loading Spinner */
    .loading {
        display: none;
        text-align: center;
        padding: 15px;
        margin: 10px 0;
    }

    .loading.show {
        display: block;
    }

    .spinner {
        display: inline-block;
        width: 30px;
        height: 30px;
        border: 4px solid rgba(30, 136, 229, 0.2);
        border-radius: 50%;
        border-top-color: var(--accent-color);
        animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* File Type Selector */
    .file-type-selector {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
    }

    .file-type-btn {
        flex: 1;
        padding: 10px;
        background: #f0f0f0;
        color: #333;
        border: 2px solid #ddd;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s;
        font-family: 'Prompt', sans-serif;
    }

    .file-type-btn.active {
        background: var(--accent-color);
        color: white;
        border-color: var(--accent-color);
    }

    .file-type-btn:hover:not(.active) {
        background: #e0e0e0;
    }
    
    body {
        margin: 0;
        padding-top: var(--header-height);
        font-family: 'Prompt', 'Sarabun', sans-serif;
        height: 100vh;
        display: flex;
        flex-direction: column;
        background: #f4f7f9;
        overflow: hidden;
    }

    /* Header Structure */
    .mapraw-header {
        background: var(--primary-gradient);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        z-index: 2000;
        font-family: 'Prompt', sans-serif;
        height: var(--header-height);
    }
    
    .mapraw-header-content {
        max-width: 100%;
        margin: 0 auto;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 20px;
        height: 100%;
    }
    
    /* Logo Section */
    .mapraw-logo-section {
        display: flex;
        flex-direction: column;
        justify-content: center;
        flex-shrink: 0;
        padding-right: 15px;
    }
    
    .mapraw-logo-main {
        color: var(--text-white);
        font-size: 1.2rem;
        font-weight: 700;
        margin: 0;
        line-height: 1;
        white-space: nowrap;
    }
    
    .mapraw-logo-main span {
        color: var(--text-yellow);
        text-shadow: 0 0 10px rgba(255, 235, 59, 0.5);
    }
    
    .mapraw-page-title {
        color: #e3f2fd;
        font-size: 1rem;
        font-weight: 400;
        margin: 2px 0 0 0;
        white-space: nowrap;
    }
    
    /* Navigation Section */
    .mapraw-nav {
        display: flex;
        gap: 8px;
        align-items: center;
        height: 100%;
    }
    
    .mapraw-nav-item {
        position: relative;
        height: 100%;
        display: flex;
        align-items: center;
    }
    
    /* Buttons */
    .mapraw-nav-btn {
        background: var(--bg-glass);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
        padding: 8px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.85rem;
        font-weight: 500;
        transition: all 0.2s ease;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 6px;
        font-family: 'Prompt', sans-serif;
        white-space: nowrap;
    }
    
    .mapraw-nav-btn:hover {
        background: var(--bg-glass-hover);
        transform: translateY(-1px);
    }
    
    .mapraw-nav-btn.home-btn {
        background: rgba(255, 235, 59, 0.15);
        border-color: #ffeb3b;
        color: #ffeb3b;
    }
    
    .mapraw-nav-btn.home-btn:hover {
        background: #ffeb3b;
        color: #1565c0;
    }

    /* Dropdown */
    .mapraw-dropdown {
        position: absolute;
        top: calc(100% - 10px);
        left: 50%;
        transform: translateX(-50%) translateY(10px);
        background: white;
        border-radius: 8px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        min-width: 200px;
        opacity: 0;
        visibility: hidden;
        transition: all 0.2s ease;
        padding: 5px 0;
        z-index: 2001;
    }
    
    /* Hover Logic for Desktop */
    @media (min-width: 1201px) {
        .mapraw-nav-item:hover .mapraw-dropdown {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0);
        }
    }
    
    .mapraw-dropdown-item {
        display: block;
        padding: 10px 20px;
        color: #333;
        text-decoration: none;
        font-size: 0.9rem;
        transition: background 0.2s;
        white-space: nowrap;
    }
    
    .mapraw-dropdown-item:hover {
        background: #f1f8ff;
        color: #1565c0;
    }

    /* Hamburger Menu Toggle */
    .mobile-menu-toggle {
        display: none;
        background: none;
        border: none;
        cursor: pointer;
        padding: 10px;
        z-index: 1002;
    }
    
    .bar {
        display: block;
        width: 25px;
        height: 3px;
        margin: 5px auto;
        background-color: white;
        transition: all 0.3s ease-in-out;
        border-radius: 2px;
    }

    /* Main Container Layout */
    .main-container {
        display: flex;
        flex: 1;
        height: calc(100vh - var(--header-height));
        position: relative;
    }

    #map {
        flex: 1;
        height: 100%;
        z-index: 1;
    }

    #controlPanel {
        width: 400px;
        background: #ffffff;
        box-shadow: -4px 0 15px rgba(0,0,0,0.08);
        overflow-y: auto;
        padding: 20px;
        z-index: 10;
        scrollbar-width: thin;
        scrollbar-color: #cbd5e0 #f7fafc;
    }

    /* Custom Scrollbar */
    #controlPanel::-webkit-scrollbar { width: 8px; }
    #controlPanel::-webkit-scrollbar-track { background: #f7fafc; }
    #controlPanel::-webkit-scrollbar-thumb { background: #cbd5e0; border-radius: 4px; }
    #controlPanel::-webkit-scrollbar-thumb:hover { background: #a0aec0; }

    .panel-header {
        background: var(--primary-gradient);
        color: white;
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 20px;
        text-align: center;
    }

    .panel-header h2 {
        margin: 0 0 8px 0;
        font-size: 1.5rem;
        font-weight: 600;
    }

    .panel-header p {
        margin: 0;
        font-size: 0.9rem;
        opacity: 0.95;
    }

    .section {
        margin-bottom: 20px;
        padding: 20px;
        background: #fff;
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        transition: all 0.3s ease;
    }

    .section.disabled {
        opacity: 0.5;
        pointer-events: none;
        background: #f8fafc;
    }

    .section h3 {
        margin: 0 0 15px 0;
        font-size: 1.1rem;
        color: #2d3748;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .section-number {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 28px;
        height: 28px;
        background: var(--accent-color);
        color: white;
        border-radius: 50%;
        font-size: 0.85rem;
        font-weight: 600;
    }

    .form-group {
        margin-bottom: 15px;
    }

    .form-group label {
        display: block;
        margin-bottom: 6px;
        font-size: 0.9rem;
        color: #4a5568;
        font-weight: 500;
    }

    .form-control {
        width: 100%;
        padding: 10px 12px;
        border: 1.5px solid #e2e8f0;
        border-radius: 8px;
        font-size: 0.95rem;
        font-family: 'Prompt', sans-serif;
        transition: all 0.2s;
        box-sizing: border-box;
    }

    .form-control:focus {
        outline: none;
        border-color: var(--accent-color);
        box-shadow: 0 0 0 3px rgba(30, 136, 229, 0.1);
    }

    .btn {
        width: 100%;
        padding: 12px 16px;
        border: none;
        border-radius: 8px;
        font-size: 0.95rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        font-family: 'Prompt', sans-serif;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    .btn-primary {
        background: var(--accent-color);
        color: white;
    }

    .btn-primary:hover {
        background: #1976d2;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(30, 136, 229, 0.3);
    }

    .btn-success {
        background: var(--success-color);
        color: white;
    }

    .btn-success:hover {
        background: #388e3c;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(46, 125, 50, 0.3);
    }

    .btn-warning {
        background: var(--warning-color);
        color: white;
    }

    .btn-warning:hover {
        background: #f57c00;
    }

    .btn-danger {
        background: var(--danger-color);
        color: white;
    }

    .btn-danger:hover {
        background: #c62828;
    }

    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .file-upload {
        border: 2px dashed #cbd5e0;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
        background: #f7fafc;
    }

    .file-upload:hover {
        border-color: var(--accent-color);
        background: #edf2f7;
    }

    .file-upload.active {
        border-color: var(--accent-color);
        background: #e3f2fd;
    }

    .file-info {
        margin-top: 10px;
        padding: 10px;
        background: #e3f2fd;
        border-radius: 6px;
        font-size: 0.85rem;
        color: #1565c0;
    }

    .preview-box {
        background: #f7fafc;
        padding: 12px;
        border-radius: 6px;
        font-size: 0.85rem;
        margin-top: 10px;
        border-left: 3px solid var(--accent-color);
    }

    .alert {
        padding: 12px 15px;
        border-radius: 8px;
        margin-bottom: 15px;
        font-size: 0.9rem;
    }

    .alert-info {
        background: #e3f2fd;
        color: #1565c0;
        border-left: 4px solid #1e88e5;
    }

    .alert-success {
        background: #e8f5e9;
        color: #2e7d32;
        border-left: 4px solid #4caf50;
    }

    .button-group {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-top: 15px;
    }

    /* ==== Responsive Styles ==== */
    @media (max-width: 1400px) {
        .mapraw-nav-btn {
            padding: 6px 8px;
            font-size: 0.8rem;
        }
        .mapraw-nav {
            gap: 4px;
        }
    }

    @media (max-width: 1200px) {
        .mobile-menu-toggle {
            display: block;
        }

        .mapraw-nav {
            position: fixed;
            top: var(--header-height);
            right: -100%;
            width: 280px;
            height: calc(100vh - var(--header-height));
            background: white;
            flex-direction: column;
            align-items: stretch;
            gap: 0;
            padding: 10px 0;
            transition: right 0.3s ease;
            box-shadow: -5px 0 15px rgba(0,0,0,0.1);
            overflow-y: auto;
        }

        .mapraw-nav.active {
            right: 0;
        }

        .mapraw-nav-item {
            height: auto;
            width: 100%;
        }

        .mapraw-nav-btn {
            width: 100%;
            justify-content: flex-start;
            padding: 12px 20px;
            border-radius: 0;
            border: none;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            background: transparent;
            color: #333;
        }

        .mapraw-nav-btn:hover {
            background: #f1f8ff;
            color: #1565c0;
            transform: none;
        }

        .mapraw-nav-btn.home-btn {
            background: #fff3cd;
            color: #856404;
            border-color: #ffc107;
        }

        .mapraw-dropdown {
            position: static;
            transform: none;
            opacity: 1;
            visibility: visible;
            box-shadow: none;
            border-radius: 0;
            border-top: 1px solid #e0e0e0;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .mapraw-nav-item.active .mapraw-dropdown {
            max-height: 500px;
        }

        .mapraw-dropdown-item {
            padding: 12px 40px;
            font-size: 0.85rem;
        }

        .mobile-menu-toggle.active .bar:nth-child(1) {
            transform: rotate(-45deg) translate(-5px, 6px);
        }

        .mobile-menu-toggle.active .bar:nth-child(2) {
            opacity: 0;
        }

        .mobile-menu-toggle.active .bar:nth-child(3) {
            transform: rotate(45deg) translate(-5px, -6px);
        }

        #controlPanel {
            width: 100%;
            max-width: 350px;
        }
    }

    @media (max-width: 768px) {
        .mapraw-logo-main {
            font-size: 1rem;
        }

        .mapraw-page-title {
            font-size: 0.8rem;
        }

        .main-container {
            flex-direction: column;
        }

        #controlPanel {
            max-width: 100%;
            height: 50vh;
            width: 100%;
        }

        #map {
            height: 50vh;
        }

        .button-group {
            grid-template-columns: 1fr;
        }
    }
    </style>
</head>
<body>
    <!-- Header Navigation -->
   <header class="mapraw-header">
    <div class="mapraw-header-content">
        <div class="mapraw-logo-section">
            <h1 class="mapraw-logo-main">TOOL FROM <span>MAPRAW</span></h1>
            <p class="mapraw-page-title">Perpendicular Line</p>
        </div>
        
        <button class="mobile-menu-toggle" id="mobileMenuBtn">
            <span class="bar"></span>
            <span class="bar"></span>
            <span class="bar"></span>
        </button>

        <nav class="mapraw-nav" id="mainNav">
            <div class="mapraw-nav-item">
                <a href="index.html" class="mapraw-nav-btn home-btn">
                    <span>üè† ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</span>
                </a>
            </div>
            
            <div class="mapraw-nav-item" onclick="toggleMobileDropdown(this)">
                <div class="mapraw-nav-btn">
                    <span>üìã ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏™‡∏≥‡∏£‡∏ß‡∏à</span>
                    <span style="font-size: 0.8em">‚ñº</span>
                </div>
                <div class="mapraw-dropdown">
                    <a href="page1.html" class="mapraw-dropdown-item">NoteMAP</a>
                    <a href="#" class="mapraw-dropdown-item">SURVEY WORK</a>
                </div>
            </div>
            
            <div class="mapraw-nav-item" onclick="toggleMobileDropdown(this)">
                <div class="mapraw-nav-btn">
                    <span>üîß ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
                    <span style="font-size: 0.8em">‚ñº</span>
                </div>
                <div class="mapraw-dropdown">
                    <a href="page2.html" class="mapraw-dropdown-item">Reclass BLDG</a>
                    <a href="page5.html" class="mapraw-dropdown-item">Prepare PLLU</a>
                    <a href="page8.html" class="mapraw-dropdown-item">SHAPEFILE TO EXCEL</a>
                    <a href="page10.html" class="mapraw-dropdown-item">CAPTURE MAP</a>
                     <a href="page13.html" class="mapraw-dropdown-item">Perpendicular Line</a>
                </div>
            </div>
            
            <div class="mapraw-nav-item" onclick="toggleMobileDropdown(this)">
                <div class="mapraw-nav-btn">
                    <span>‚öôÔ∏è ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•</span>
                    <span style="font-size: 0.8em">‚ñº</span>
                </div>
                <div class="mapraw-dropdown">
                    <a href="page3.html" class="mapraw-dropdown-item">Calculate Landuse</a>
                    <a href="page6.html" class="mapraw-dropdown-item">Calculate Population</a>
                    <a href="page11.html" class="mapraw-dropdown-item">Calculate AREA</a>
                    <a href="page14.html" class="mapraw-dropdown-item">RECLASS FACTORY</a>
                    <a href="page12.html" class="mapraw-dropdown-item">COMPARISON LANDUSE</a>
                </div>
            </div>
            
            <div class="mapraw-nav-item" onclick="toggleMobileDropdown(this)">
                <div class="mapraw-nav-btn">
                    <span>‚öñÔ∏è ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢</span>
                    <span style="font-size: 0.8em">‚ñº</span>
                </div>
                <div class="mapraw-dropdown">
                    <a href="page4.html" class="mapraw-dropdown-item">Town Planning Laws</a>
                    <a href="page15.html" class="mapraw-dropdown-item">Building Laws</a>
                </div>
            </div>
            
            <div class="mapraw-nav-item" onclick="toggleMobileDropdown(this)">
                <div class="mapraw-nav-btn">
                    <span>üßÆ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô</span>
                    <span style="font-size: 0.8em">‚ñº</span>
                </div>
                <div class="mapraw-dropdown">
                    <a href="page7.html" class="mapraw-dropdown-item">AREA Calculator</a>
                </div>
            </div>
            
            <div class="mapraw-nav-item" onclick="toggleMobileDropdown(this)">
                <div class="mapraw-nav-btn">
                    <span>üéØ ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏≠‡∏∑‡πà‡∏ô‡πÜ</span>
                    <span style="font-size: 0.8em">‚ñº</span>
                </div>
                <div class="mapraw-dropdown">
                    <a href="page9.html" class="mapraw-dropdown-item">CREATE QRCODE</a>
                </div>
            </div>
        </nav>
    </div>
</header>

    <div class="main-container">
        <!-- Map Container -->
        <div id="map"></div>

        <!-- Control Panel -->
        <div id="controlPanel">
            <div class="panel-header">
                <h2> Perpendicular Line</h2>
                <p>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏â‡∏≤‡∏Å</p>
            </div>

            <!-- Section 1: Upload Files -->
            <div class="section" id="section1">
                <h3><span class="section-number">1</span> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ UTM & ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå</h3>
                <div class="form-group">
                    <label for="utmZone">‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏Ç‡∏≠‡∏á‡πÑ‡∏ü‡∏•‡πå (‡πÄ‡∏°‡∏ï‡∏£):</label>
                    <select id="utmZone" class="form-control">
                        <option value="32647">WGS84 / UTM Zone 47N</option>
                        <option value="32648">WGS84 / UTM Zone 48N</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÑ‡∏ü‡∏•‡πå:</label>
                    <div class="file-type-selector">
                        <button class="file-type-btn active" id="btnGeoJSON" type="button">GeoJSON</button>
                        <button class="file-type-btn" id="btnShapefile" type="button">Shapefile (ZIP)</button>
                    </div>
                </div>
                <div class="form-group">
                    <input type="file" id="fileInput" accept=".geojson,.json" class="form-control" style="display:block">
                    <input type="file" id="shapefileInput" accept=".zip" class="form-control" style="display:none">
                </div>
                <div class="loading" id="loadingIndicator">
                    <div class="spinner"></div>
                    <p style="margin-top: 10px; font-size: 0.9rem; color: #666;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</p>
                </div>
                <div id="fileInfo" class="file-info" style="display:none"></div>
            </div>

            <!-- Section 2: Find Intersections -->
            <div class="section disabled" id="section2">
                <h3><span class="section-number">2</span> ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏à‡∏∏‡∏î‡∏ï‡∏±‡∏î (Zero Error)</h3>
                <div class="form-group">
                    <label for="snapTolerance">Fuzzy Snap (‡πÄ‡∏°‡∏ï‡∏£) - ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏™‡πâ‡∏ô‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏Å‡∏±‡∏ô:</label>
                    <input type="number" id="snapTolerance" class="form-control" value="0.5" step="0.1" min="0">
                </div>
                <div class="alert alert-info">
                    ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏à‡∏∏‡∏î‡∏ï‡∏±‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏™‡∏π‡∏á
                </div>
                <button id="btnFindIntersections" class="btn btn-primary">
                    üîç ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏à‡∏∏‡∏î‡∏ï‡∏±‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏ó‡πâ‡∏à‡∏£‡∏¥‡∏á
                </button>
                <div id="selectionPreview" class="preview-box" style="display:none"></div>
                <button id="btnConfirmSelection" class="btn btn-success" style="display:none; margin-top:10px">
                    ‚úì ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                </button>
            </div>

            <!-- Section 3: Split into 360¬∞ -->
            <div class="section disabled" id="section3">
                <h3><span class="section-number">3</span> ‡πÅ‡∏¢‡∏Å‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á 360¬∞</h3>
                <div class="alert alert-info">
                    ‡πÅ‡∏¢‡∏Å‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏≠‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡∏£‡∏≠‡∏ö‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                </div>
                <button id="btnSplit360" class="btn btn-primary">
                    üß≠ ‡πÅ‡∏¢‡∏Å‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á
                </button>
            </div>

            <!-- Section 4: Select Target Line -->
            <div class="section disabled" id="section4">
                <h3><span class="section-number">4</span> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</h3>
                <div class="alert alert-info">
                    ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏â‡∏≤‡∏Å
                </div>
            </div>

            <!-- Section 5: Create Perpendicular -->
            <div class="section disabled" id="section5">
                <h3><span class="section-number">5</span> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏â‡∏≤‡∏Å</h3>
                <div class="form-group">
                    <label for="distAlong">‡∏£‡∏∞‡∏¢‡∏∞‡∏ï‡∏≤‡∏°‡πÅ‡∏ô‡∏ß‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á (‡πÄ‡∏°‡∏ï‡∏£):</label>
                    <input type="number" id="distAlong" class="form-control" value="50" step="1">
                </div>
                <div class="form-group">
                    <label for="distPerp">‡∏£‡∏∞‡∏¢‡∏∞‡∏ï‡∏±‡πâ‡∏á‡∏â‡∏≤‡∏Å (‡πÄ‡∏°‡∏ï‡∏£):</label>
                    <input type="number" id="distPerp" class="form-control" value="30" step="1">
                </div>
                <div class="form-group">
                    <label for="direction">‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á (‡∏≠‡∏á‡∏®‡∏≤):</label>
                    <select id="direction" class="form-control">
                        <option value="90">‡∏Ç‡∏ß‡∏≤ (+90¬∞)</option>
                        <option value="-90">‡∏ã‡πâ‡∏≤‡∏¢ (-90¬∞)</option>
                    </select>
                </div>
                <button id="btnCreatePerp" class="btn btn-primary">
                    ‚ûï ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏â‡∏≤‡∏Å
                </button>
            </div>

            <!-- Section 6: Export -->
            <div class="section disabled" id="section6">
                <h3><span class="section-number">6</span> ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
                <div class="alert alert-success">
                    ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡πâ‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏â‡∏≤‡∏Å
                </div>
                <div class="button-group">
                    <button id="btnExportGeoJSON" class="btn btn-success">
                        üìÑ GeoJSON
                    </button>
                    <button id="btnExportShapefile" class="btn btn-warning">
                        üó∫Ô∏è Shapefile
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.min.js"></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
    
    <script>
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ libraries ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏£‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        if (typeof L === 'undefined') {
            alert('Leaflet library ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡πÇ‡∏´‡∏•‡∏î!');
        }
        if (typeof proj4 === 'undefined') {
            alert('Proj4 library ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡πÇ‡∏´‡∏•‡∏î! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö');
        }
        if (typeof turf === 'undefined') {
            alert('Turf.js library ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡πÇ‡∏´‡∏•‡∏î!');
        }
        
        // ========================================
        // Global State & Map Initialization
        // ========================================
        // ‚öôÔ∏è ‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ‡∏ä‡∏±‡∏ô‡∏û‡∏¥‡∏Å‡∏±‡∏î
        proj4.defs("EPSG:32647", "+proj=utm +zone=47 +datum=WGS84 +units=m +no_defs");
        proj4.defs("EPSG:32648", "+proj=utm +zone=48 +datum=WGS84 +units=m +no_defs");

        const state = {
            roadsFC: null,
            selectedPoint: null,
            targetSubLine: null
        };

        let currentFileType = 'geojson';

        // ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà Deep Zoom 30 ‡∏û‡∏£‡πâ‡∏≠‡∏° zoom control ‡∏Ç‡∏ß‡∏≤‡∏ö‡∏ô
        const map = L.map('map', { 
            zoomSnap: 0, 
            maxZoom: 30, 
            zoomControl: false 
        }).setView([13.75, 100.5], 10);
        
        L.control.zoom({ position: 'topright' }).addTo(map);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxNativeZoom: 19,
            maxZoom: 30,
            opacity: 0.5,
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);

        const layers = {
            original: L.geoJson(null, { style: { color: '#888', weight: 2 } }).addTo(map),
            intersections: L.layerGroup().addTo(map),
            split: L.geoJson(null, { style: { color: '#1890ff', weight: 4 } }).addTo(map),
            perp: L.layerGroup().addTo(map)
        };

        // ========================================
        // File Type Selector
        // ========================================
        document.getElementById('btnGeoJSON').onclick = () => {
            currentFileType = 'geojson';
            document.getElementById('btnGeoJSON').classList.add('active');
            document.getElementById('btnShapefile').classList.remove('active');
            document.getElementById('fileInput').style.display = 'block';
            document.getElementById('shapefileInput').style.display = 'none';
            document.getElementById('fileInput').value = '';
            document.getElementById('fileInfo').style.display = 'none';
        };

        document.getElementById('btnShapefile').onclick = () => {
            currentFileType = 'shapefile';
            document.getElementById('btnShapefile').classList.add('active');
            document.getElementById('btnGeoJSON').classList.remove('active');
            document.getElementById('fileInput').style.display = 'none';
            document.getElementById('shapefileInput').style.display = 'block';
            document.getElementById('shapefileInput').value = '';
            document.getElementById('fileInfo').style.display = 'none';
        };

        // ========================================
        // File Upload Handlers
        // ========================================
        // üìÇ 1. Load GeoJSON
        document.getElementById('fileInput').onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            const utmZone = "EPSG:" + document.getElementById('utmZone').value;

            document.getElementById('loadingIndicator').classList.add('show');

            reader.onload = (ev) => {
                try {
                    const fc = JSON.parse(ev.target.result);
                    processGeoJSON(fc, utmZone);
                } catch (error) {
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå: ' + error.message);
                    document.getElementById('fileInfo').style.display = 'block';
                    document.getElementById('fileInfo').innerHTML = `‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ`;
                } finally {
                    document.getElementById('loadingIndicator').classList.remove('show');
                }
            };
            reader.readAsText(file);
        };

        // üìÇ 2. Load Shapefile (ZIP)
        document.getElementById('shapefileInput').onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            document.getElementById('loadingIndicator').classList.add('show');

            try {
                const arrayBuffer = await file.arrayBuffer();
                const geojson = await shp(arrayBuffer);
                
                // shpjs ‡∏≠‡∏≤‡∏à‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô FeatureCollection ‡∏´‡∏£‡∏∑‡∏≠ array ‡∏Ç‡∏≠‡∏á layers
                let fc;
                if (Array.isArray(geojson)) {
                    fc = geojson[0]; // ‡πÉ‡∏ä‡πâ layer ‡πÅ‡∏£‡∏Å
                } else if (geojson.type === 'FeatureCollection') {
                    fc = geojson;
                } else {
                    throw new Error('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö Shapefile ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                }

                const utmZone = "EPSG:" + document.getElementById('utmZone').value;
                processGeoJSON(fc, utmZone);
            } catch (error) {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô Shapefile: ' + error.message);
                document.getElementById('fileInfo').style.display = 'block';
                document.getElementById('fileInfo').innerHTML = `‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô Shapefile ‡πÑ‡∏î‡πâ`;
            } finally {
                document.getElementById('loadingIndicator').classList.remove('show');
            }
        };

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• GeoJSON - ‡πÅ‡∏õ‡∏•‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î UTM ‡πÄ‡∏õ‡πá‡∏ô WGS84 ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        function processGeoJSON(fc, utmZone) {
            // ‡πÅ‡∏õ‡∏•‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏à‡∏≤‡∏Å UTM ‡πÄ‡∏õ‡πá‡∏ô WGS84 ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ñ‡∏≤‡∏°)
            fc.features.forEach(feature => {
                turf.coordEach(feature, (coord) => {
                    // ‡∏´‡∏≤‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å > 180 ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô UTM (‡πÄ‡∏°‡∏ï‡∏£) ‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô
                    if (Math.abs(coord[0]) > 180) {
                        const wgs84 = proj4(utmZone, "WGS84", coord);
                        coord[0] = wgs84[0];
                        coord[1] = wgs84[1];
                    }
                });
            });

            state.roadsFC = fc;
            layers.original.clearLayers().addData(state.roadsFC);
            map.fitBounds(layers.original.getBounds());
            
            document.getElementById('fileInfo').style.display = 'block';
            document.getElementById('fileInfo').innerHTML = 
                `‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (${fc.features.length} ‡πÄ‡∏™‡πâ‡∏ô)<br>‡πÅ‡∏õ‡∏•‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏á‡∏®‡∏≤‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°‡πÅ‡∏•‡πâ‡∏ß`;
            enableSection('section2');
        }

        // ========================================
        // Section 2: Find Intersections
        // ========================================
        document.getElementById('btnFindIntersections').onclick = () => {
            layers.intersections.clearLayers();
            const points = [];
            const features = state.roadsFC.features;

            // ‡∏´‡∏≤‡∏à‡∏∏‡∏î‡∏ï‡∏±‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            for (let i = 0; i < features.length; i++) {
                for (let j = i + 1; j < features.length; j++) {
                    const intersect = turf.lineIntersect(features[i], features[j]);
                    intersect.features.forEach(f => {
                        // ‡∏õ‡∏±‡∏î‡πÄ‡∏®‡∏©‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥ 14 ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
                        points.push(f.geometry.coordinates.map(c => Number(c.toFixed(14))));
                    });
                }
            }

            // ‡∏Å‡∏≥‡∏à‡∏±‡∏î‡∏à‡∏∏‡∏î‡∏ã‡πâ‡∏≥
            const uniquePoints = [];
            points.forEach(p => {
                if (!uniquePoints.some(up => turf.distance(p, up) < 0.0001)) {
                    uniquePoints.push(p);
                }
            });

            // ‡πÄ‡∏û‡∏¥‡πà‡∏° markers ‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
            uniquePoints.forEach(coord => {
                const marker = L.circleMarker([coord[1], coord[0]], {
                    radius: 12,
                    fillColor: '#28a745',
                    color: '#fff',
                    weight: 3,
                    opacity: 1,
                    fillOpacity: 0.9
                }).addTo(layers.intersections);
                
                marker.on('click', (e) => {
                    L.DomEvent.stopPropagation(e);
                    state.selectedPoint = coord;
                    
                    const epsg = "EPSG:" + document.getElementById('utmZone').value;
                    const utm = proj4("WGS84", epsg, coord);
                    
                    // Reset all markers
                    layers.intersections.eachLayer(l => {
                        l.setStyle({ fillColor: '#28a745', radius: 12 });
                    });
                    
                    // Highlight selected
                    marker.setStyle({ fillColor: '#ffc107', radius: 16 });
                    
                    document.getElementById('selectionPreview').style.display = 'block';
                    document.getElementById('selectionPreview').innerHTML = `
                        <b>‡∏û‡∏¥‡∏Å‡∏±‡∏î UTM (Lock):</b><br>
                        E ${utm[0].toFixed(3)}, N ${utm[1].toFixed(3)}<br>
                        <b>Lat/Long:</b><br>
                        ${coord[1].toFixed(7)}, ${coord[0].toFixed(7)}
                    `;
                    document.getElementById('btnConfirmSelection').style.display = 'block';
                    enableSection('section3');
                });
            });

            alert(`‡∏û‡∏ö‡∏à‡∏∏‡∏î‡∏ï‡∏±‡∏î‡∏ó‡∏≤‡∏á‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå ${uniquePoints.length} ‡∏à‡∏∏‡∏î\n‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ß‡∏á‡∏Å‡∏•‡∏°‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å`);
        };

        // ========================================
        // Section 3: Confirm Selection
        // ========================================
        document.getElementById('btnConfirmSelection').onclick = () => {
            enableSection('section4');
        };

        // ========================================
        // Section 4: Split into 360¬∞
        // ========================================
        document.getElementById('btnSplit360').onclick = () => {
            if (!state.selectedPoint) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô');
                return;
            }

            const centerPt = state.selectedPoint;
            const splitSegments = [];
            const toleranceKm = 0.001; // 1 ‡πÄ‡∏°‡∏ï‡∏£

            state.roadsFC.features.forEach(road => {
                const snapped = turf.nearestPointOnLine(road, turf.point(centerPt));
                
                if (snapped.properties.dist < toleranceKm) {
                    const split = turf.lineSplit(road, turf.point(centerPt));
                    const segments = split.features.length > 0 ? split.features : [road];
                    
                    segments.forEach(seg => {
                        let coords = [...seg.geometry.coordinates];
                        const dStart = turf.distance(centerPt, turf.point(coords[0]));
                        const dEnd = turf.distance(centerPt, turf.point(coords[coords.length - 1]));

                        // Ensure segment starts from center point
                        if (dEnd < dStart) coords.reverse();
                        
                        if (turf.distance(centerPt, turf.point(coords[0])) < toleranceKm) {
                            coords[0] = centerPt; // ‡∏•‡πá‡∏≠‡∏Å‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡πâ‡∏ó‡∏±‡∏ö‡∏à‡∏∏‡∏î‡∏ï‡∏±‡∏î‡πÄ‡∏õ‡πä‡∏∞
                            splitSegments.push(turf.lineString(coords, seg.properties));
                        }
                    });
                }
            });

            layers.split.clearLayers().addData(turf.featureCollection(splitSegments));
            layers.original.setStyle({ opacity: 0.1 }); // ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏™‡πâ‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏≤‡∏á‡∏•‡∏á
            
            layers.split.eachLayer(layer => {
                layer.on('click', (e) => {
                    L.DomEvent.stopPropagation(e);
                    state.targetSubLine = layer.feature;
                    
                    // Reset all styles
                    layers.split.setStyle({ color: '#1890ff', weight: 4 });
                    
                    // Highlight selected
                    layer.setStyle({ color: '#0050b3', weight: 8 });
                    
                    enableSection('section5');
                    alert('‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ');
                });
            });

            alert(`‡πÅ‡∏ö‡πà‡∏á‡∏ñ‡∏ô‡∏ô‡∏≠‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏∏‡∏Å‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (${splitSegments.length} ‡πÄ‡∏™‡πâ‡∏ô)\n‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏™‡πâ‡∏ô‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å`);
        };

        // ========================================
        // Section 5: Create Perpendicular Line
        // ========================================
        document.getElementById('btnCreatePerp').onclick = () => {
            if (!state.targetSubLine) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô');
                return;
            }

            const distAlong = parseFloat(document.getElementById('distAlong').value) / 1000; // m to km
            const distPerp = parseFloat(document.getElementById('distPerp').value) / 1000;
            const rotation = parseFloat(document.getElementById('direction').value);

            const basePoint = turf.along(state.targetSubLine, distAlong);
            const lookAheadPoint = turf.along(state.targetSubLine, distAlong + 0.000001);
            const bearing = turf.bearing(basePoint, lookAheadPoint);
            const perpPoint = turf.destination(basePoint, distPerp, bearing + rotation);
            
            const perpLine = turf.lineString([
                basePoint.geometry.coordinates,
                perpPoint.geometry.coordinates
            ]);

            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏™‡πâ‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏â‡∏≤‡∏Å
            L.geoJson(perpLine, {
                style: { color: '#e91e63', weight: 4 }
            }).addTo(layers.perp);

            // ‡πÄ‡∏û‡∏¥‡πà‡∏° Circle Marker ‡∏ó‡∏µ‡πà‡∏à‡∏∏‡∏î‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î
            L.circleMarker([perpPoint.geometry.coordinates[1], perpPoint.geometry.coordinates[0]], {
                radius: 5,
                fillColor: '#e91e63',
                color: '#fff',
                weight: 1,
                fillOpacity: 1
            }).addTo(layers.perp);

            enableSection('section6');
            alert('‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏â‡∏≤‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
        };

        // ========================================
        // Section 6: Export Functions
        // ========================================
        document.getElementById('btnExportGeoJSON').onclick = () => {
            const geojson = layers.perp.toGeoJSON();
            const blob = new Blob([JSON.stringify(geojson, null, 2)], { 
                type: "application/json" 
            });
            saveAs(blob, `perpendicular_lines_${Date.now()}.geojson`);
            alert('‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å GeoJSON ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
        };

        document.getElementById('btnExportShapefile').onclick = async () => {
            try {
                // ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡πâ‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏â‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å layers.perp
                const geojson = layers.perp.toGeoJSON();
                
                if (!geojson.features || geojson.features.length === 0) {
                    alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡πâ‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏â‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏â‡∏≤‡∏Å‡∏Å‡πà‡∏≠‡∏ô');
                    return;
                }

                document.getElementById('loadingIndicator').classList.add('show');

                // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ LineString features (‡πÄ‡∏™‡πâ‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏â‡∏≤‡∏Å) ‡πÑ‡∏°‡πà‡πÄ‡∏≠‡∏≤ Point markers
                const perpLines = {
                    type: "FeatureCollection",
                    features: geojson.features.filter(f => 
                        f.geometry && 
                        (f.geometry.type === 'LineString' || f.geometry.type === 'MultiLineString')
                    )
                };

                if (perpLines.features.length === 0) {
                    alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏™‡πâ‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏â‡∏≤‡∏Å‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
                    document.getElementById('loadingIndicator').classList.remove('show');
                    return;
                }

                // ‡πÅ‡∏õ‡∏•‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô UTM ‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å
                const utmZone = "EPSG:" + document.getElementById('utmZone').value;
                const utmGeoJSON = JSON.parse(JSON.stringify(perpLines)); // Deep copy
                
                utmGeoJSON.features.forEach(feature => {
                    turf.coordEach(feature, (coord) => {
                        const utm = proj4("WGS84", utmZone, coord);
                        coord[0] = utm[0];
                        coord[1] = utm[1];
                    });
                });

                // ‡πÄ‡∏û‡∏¥‡πà‡∏° attributes ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÄ‡∏™‡πâ‡∏ô
                utmGeoJSON.features.forEach((feature, index) => {
                    if (!feature.properties) {
                        feature.properties = {};
                    }
                    feature.properties.ID = index + 1;
                    feature.properties.TYPE = 'Perpendicular';
                    
                    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡πÄ‡∏™‡πâ‡∏ô (‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• UTM ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥)
                    const length = turf.length(feature, { units: 'meters' });
                    feature.properties.LENGTH_M = parseFloat(length.toFixed(3));
                });

                // ‡∏™‡∏£‡πâ‡∏≤‡∏á Shapefile
                await createShapefile(utmGeoJSON, `perpendicular_lines_${Date.now()}`);
                
                alert(`‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÄ‡∏™‡πâ‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏â‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${perpLines.features.length} ‡πÄ‡∏™‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!`);
                
            } catch (error) {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Shapefile: ' + error.message);
                console.error(error);
            } finally {
                document.getElementById('loadingIndicator').classList.remove('show');
            }
        };

        // ========================================
        // Shapefile Creation Functions
        // ========================================
        async function createShapefile(geojson, filename) {
            const zip = new JSZip();
            
            // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó geometry
            let shapeType = 0;
            const firstFeature = geojson.features[0];
            if (firstFeature) {
                const geomType = firstFeature.geometry.type;
                if (geomType === 'Point' || geomType === 'MultiPoint') shapeType = 1;
                else if (geomType === 'LineString' || geomType === 'MultiLineString') shapeType = 3;
                else if (geomType === 'Polygon' || geomType === 'MultiPolygon') shapeType = 5;
            }

            const shpBuffer = createSHPFile(geojson, shapeType);
            const shxBuffer = createSHXFile(geojson, shapeType);
            const dbfBuffer = createDBFFile(geojson);
            const prjContent = createPRJFile();
            
            zip.file(`${filename}.shp`, shpBuffer);
            zip.file(`${filename}.shx`, shxBuffer);
            zip.file(`${filename}.dbf`, dbfBuffer);
            zip.file(`${filename}.prj`, prjContent);
            
            const blob = await zip.generateAsync({ type: 'blob' });
            saveAs(blob, `${filename}.zip`);
        }

        function createSHPFile(geojson, shapeType) {
            const features = geojson.features;
            const records = [];
            let totalContentLength = 0;

            features.forEach((feature) => {
                const coords = feature.geometry.coordinates;
                const numPoints = coords.length;
                const numParts = 1;
                const contentLength = 44 + (4 * numParts) + (16 * numPoints);
                
                records.push({
                    numPoints: numPoints,
                    numParts: numParts,
                    partIndices: [0],
                    points: coords,
                    contentLengthBytes: contentLength,
                    contentLengthWords: contentLength / 2
                });
                
                totalContentLength += 8 + contentLength;
            });

            const fileLength = 100 + totalContentLength;
            const buffer = new ArrayBuffer(fileLength);
            const view = new DataView(buffer);

            // File Header
            view.setInt32(0, 9994, false); // File Code
            view.setInt32(24, fileLength / 2, false); // File Length
            view.setInt32(28, 1000, true); // Version
            view.setInt32(32, shapeType, true); // Shape Type

            // Bounding Box
            const bbox = calculateBoundingBox(geojson);
            view.setFloat64(36, bbox.xmin, true);
            view.setFloat64(44, bbox.ymin, true);
            view.setFloat64(52, bbox.xmax, true);
            view.setFloat64(60, bbox.ymax, true);

            // Records
            let offset = 100;
            records.forEach((record, index) => {
                view.setInt32(offset, index + 1, false); // Record Number
                view.setInt32(offset + 4, record.contentLengthWords, false);
                offset += 8;

                view.setInt32(offset, shapeType, true);
                offset += 4;

                const recBbox = calculateGeometryBbox(record.points);
                view.setFloat64(offset, recBbox.xmin, true);
                view.setFloat64(offset + 8, recBbox.ymin, true);
                view.setFloat64(offset + 16, recBbox.xmax, true);
                view.setFloat64(offset + 24, recBbox.ymax, true);
                offset += 32;

                view.setInt32(offset, record.numParts, true);
                view.setInt32(offset + 4, record.numPoints, true);
                offset += 8;

                // Part indices
                record.partIndices.forEach(partIndex => {
                    view.setInt32(offset, partIndex, true);
                    offset += 4;
                });

                // Points
                record.points.forEach(pt => {
                    view.setFloat64(offset, pt[0], true);
                    view.setFloat64(offset + 8, pt[1], true);
                    offset += 16;
                });
            });

            return buffer;
        }

        function createSHXFile(geojson, shapeType) {
            const features = geojson.features;
            const fileLength = 100 + features.length * 8;
            const buffer = new ArrayBuffer(fileLength);
            const view = new DataView(buffer);

            // Header
            view.setInt32(0, 9994, false);
            view.setInt32(24, fileLength / 2, false);
            view.setInt32(28, 1000, true);
            view.setInt32(32, shapeType, true);

            const bbox = calculateBoundingBox(geojson);
            view.setFloat64(36, bbox.xmin, true);
            view.setFloat64(44, bbox.ymin, true);
            view.setFloat64(52, bbox.xmax, true);
            view.setFloat64(60, bbox.ymax, true);

            // Index records
            let indexOffset = 100;
            let contentOffset = 50; // Start after header

            features.forEach((feature) => {
                const numPoints = feature.geometry.coordinates.length;
                const contentLengthWords = (44 + 4 + 16 * numPoints) / 2;
                
                view.setInt32(indexOffset, contentOffset, false);
                view.setInt32(indexOffset + 4, contentLengthWords, false);
                
                indexOffset += 8;
                contentOffset += 4 + contentLengthWords;
            });

            return buffer;
        }

        function createDBFFile(geojson) {
            const features = geojson.features;
            const numRecords = features.length;

            // Analyze properties
            const propertyInfo = new Map();
            
            features.forEach(feature => {
                if (feature.properties) {
                    Object.entries(feature.properties).forEach(([key, value]) => {
                        if (!propertyInfo.has(key)) {
                            propertyInfo.set(key, {
                                name: key,
                                type: 'C',
                                maxLength: 0,
                                hasDecimals: false,
                                isNumeric: true
                            });
                        }
                        
                        const info = propertyInfo.get(key);
                        const strValue = String(value);
                        info.maxLength = Math.max(info.maxLength, strValue.length);
                        
                        if (value !== null && value !== undefined) {
                            const numValue = Number(value);
                            if (isNaN(numValue)) {
                                info.isNumeric = false;
                            } else if (String(value).includes('.')) {
                                info.hasDecimals = true;
                            }
                        }
                    });
                }
            });

            // Create field definitions
            const fieldDefinitions = [{ name: 'FID', type: 'N', length: 10, decimal: 0 }];
            const propArray = [];
            
            let fieldCount = 0;
            for (const [key, info] of propertyInfo) {
                if (fieldCount >= 9) break; // Max 10 fields including FID
                
                let fieldDef = {
                    name: key.substring(0, 10).toUpperCase(),
                    type: 'C',
                    length: 50,
                    decimal: 0
                };

                if (info.isNumeric) {
                    if (info.hasDecimals) {
                        fieldDef.type = 'N';
                        fieldDef.length = Math.min(18, Math.max(10, info.maxLength + 5));
                        fieldDef.decimal = 3;
                    } else {
                        fieldDef.type = 'N';
                        fieldDef.length = Math.min(10, Math.max(5, info.maxLength));
                        fieldDef.decimal = 0;
                    }
                } else {
                    fieldDef.type = 'C';
                    fieldDef.length = Math.min(254, Math.max(10, info.maxLength + 5));
                }
                
                fieldDefinitions.push(fieldDef);
                propArray.push(key);
                fieldCount++;
            }

            const numFields = fieldDefinitions.length;
            const headerSize = 32 + numFields * 32 + 1;
            const recordSize = 1 + fieldDefinitions.reduce((sum, f) => sum + f.length, 0);
            const totalSize = headerSize + numRecords * recordSize + 1;

            const buffer = new ArrayBuffer(totalSize);
            const view = new DataView(buffer);
            const uint8View = new Uint8Array(buffer);

            // Header
            view.setUint8(0, 0x03); // DBF version
            const now = new Date();
            view.setUint8(1, now.getFullYear() - 1900);
            view.setUint8(2, now.getMonth() + 1);
            view.setUint8(3, now.getDate());
            view.setUint32(4, numRecords, true);
            view.setUint16(8, headerSize, true);
            view.setUint16(10, recordSize, true);

            // Field descriptors
            let fieldOffset = 32;
            fieldDefinitions.forEach(field => {
                for (let i = 0; i < field.name.length && i < 10; i++) {
                    uint8View[fieldOffset + i] = field.name.charCodeAt(i);
                }
                for (let i = field.name.length; i < 11; i++) {
                    uint8View[fieldOffset + i] = 0x00;
                }
                uint8View[fieldOffset + 11] = field.type.charCodeAt(0);
                view.setUint32(fieldOffset + 12, 0, true);
                view.setUint8(fieldOffset + 16, field.length);
                view.setUint8(fieldOffset + 17, field.decimal);
                fieldOffset += 32;
            });
            uint8View[fieldOffset] = 0x0D; // Terminator

            // Records
            let recordOffset = headerSize;
            features.forEach((feature, index) => {
                uint8View[recordOffset] = 0x20; // Not deleted
                recordOffset++;

                fieldDefinitions.forEach((field, fieldIndex) => {
                    let value = '';
                    
                    if (fieldIndex === 0) {
                        value = (index + 1).toString();
                    } else {
                        const propName = propArray[fieldIndex - 1];
                        const propValue = feature.properties && feature.properties[propName];
                        
                        if (propValue !== undefined && propValue !== null) {
                            if (field.type === 'N') {
                                const numValue = Number(propValue);
                                if (!isNaN(numValue)) {
                                    if (field.decimal > 0) {
                                        value = numValue.toFixed(field.decimal);
                                    } else {
                                        value = Math.round(numValue).toString();
                                    }
                                }
                            } else {
                                value = String(propValue);
                            }
                        }
                    }
                    
                    // Format based on field type
                    if (field.type === 'N') {
                        value = value.substring(0, field.length).padStart(field.length, ' ');
                    } else {
                        value = value.substring(0, field.length).padEnd(field.length, ' ');
                    }
                    
                    for (let i = 0; i < field.length; i++) {
                        uint8View[recordOffset + i] = value.charCodeAt(i) || 0x20;
                    }
                    
                    recordOffset += field.length;
                });
            });

            uint8View[totalSize - 1] = 0x1A; // EOF marker
            return buffer;
        }

        function createPRJFile() {
            const utmZone = document.getElementById('utmZone').value;
            const zone = utmZone === '32647' ? '47' : '48';
            const centralMeridian = zone === '47' ? '99.0' : '105.0';
            
            return `PROJCS["WGS_1984_UTM_Zone_${zone}N",GEOGCS["GCS_WGS_1984",DATUM["D_WGS_1984",SPHEROID["WGS_1984",6378137.0,298.257223563]],PRIMEM["Greenwich",0.0],UNIT["Degree",0.0174532925199433]],PROJECTION["Transverse_Mercator"],PARAMETER["False_Easting",500000.0],PARAMETER["False_Northing",0.0],PARAMETER["Central_Meridian",${centralMeridian}],PARAMETER["Scale_Factor",0.9996],PARAMETER["Latitude_Of_Origin",0.0],UNIT["Meter",1.0]]`;
        }

        // ========================================
        // Helper Functions
        // ========================================
        function calculateGeometryBbox(coords) {
            let xmin = Infinity, ymin = Infinity;
            let xmax = -Infinity, ymax = -Infinity;
            
            const processCoord = (coord) => {
                if (Array.isArray(coord[0])) {
                    coord.forEach(processCoord);
                } else {
                    xmin = Math.min(xmin, coord[0]);
                    ymin = Math.min(ymin, coord[1]);
                    xmax = Math.max(xmax, coord[0]);
                    ymax = Math.max(ymax, coord[1]);
                }
            };
            
            coords.forEach(processCoord);
            return { xmin, ymin, xmax, ymax };
        }

        function calculateBoundingBox(geoJSON) {
            let xmin = Infinity, ymin = Infinity;
            let xmax = -Infinity, ymax = -Infinity;
            
            geoJSON.features.forEach(feature => {
                if (!feature.geometry || !feature.geometry.coordinates) return;
                const coords = feature.geometry.coordinates;
                
                const processCoord = (coord) => {
                    if (Array.isArray(coord[0])) {
                        coord.forEach(processCoord);
                    } else {
                        xmin = Math.min(xmin, coord[0]);
                        ymin = Math.min(ymin, coord[1]);
                        xmax = Math.max(xmax, coord[0]);
                        ymax = Math.max(ymax, coord[1]);
                    }
                };
                
                processCoord(coords);
            });
            
            return { xmin, ymin, xmax, ymax };
        }

        function enableSection(id) {
            document.getElementById(id).classList.remove('disabled');
        }

        // ========================================
        // Mobile Menu Toggle
        // ========================================
        const menuBtn = document.getElementById('mobileMenuBtn');
        const nav = document.getElementById('mainNav');

        menuBtn.addEventListener('click', () => {
            menuBtn.classList.toggle('active');
            nav.classList.toggle('active');
        });

        function toggleMobileDropdown(element) {
            if (window.innerWidth <= 1200) {
                element.classList.toggle('active');
            }
        }
        
        // Close menu when clicking outside
        document.addEventListener('click', (e) => {
            if (!nav.contains(e.target) && !menuBtn.contains(e.target) && nav.classList.contains('active')) {
                nav.classList.remove('active');
                menuBtn.classList.remove('active');
            }
        });
    </script>
</body>
</html>
