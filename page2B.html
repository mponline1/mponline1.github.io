<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RECLASS BLDG</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://unpkg.com/shpjs@latest/dist/shp.js"></script>
     <style>

    /* ==== 1. IMPORT FONTS & VARIABLES ==== */
    @import url('https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap');

    :root {
        /* Theme Colors (Blue/Yellow - Matches Header) */
        --primary-color: #1565c0;       /* Blue */
        --secondary-color: #0d47a1;     /* Dark Blue */
        --accent-color: #ffeb3b;        /* Yellow */
        --accent-text: #f57f17;         /* Darker Yellow/Orange for text */
        
        /* Backgrounds */
        --bg-body: #f8f9fa;             /* Light Grey */
        --bg-glass: rgba(255, 255, 255, 0.1);
        --bg-glass-hover: rgba(255, 255, 255, 0.25);
        --bg-light-blue: #e3f2fd;
        
        /* Text & UI */
        --text-main: #374151;
        --text-muted: #64748b;
        --border-color: #dee2e6;
        --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        --hover-shadow: 0 8px 25px rgba(21, 101, 192, 0.15);
        
        /* Layout */
        --header-height: 70px;
    }
    
    body {
        margin: 0;
        padding-top: var(--header-height);
        background-color: var(--bg-body);
        font-family: 'Prompt', sans-serif !important; /* Force Prompt Font */
        color: var(--text-main);
        min-height: 100vh;
    }

    /* ==== 2. HEADER STYLES (Preserved & Polished) ==== */
    .mapraw-header {
        background: linear-gradient(135deg, #1e88e5 0%, #1565c0 50%, #0d47a1 100%);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        z-index: 1000;
        height: var(--header-height);
    }
    
    .mapraw-header-content {
        max-width: 100%;
        margin: 0 auto;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 20px;
        height: 100%;
    }
    
    .mapraw-logo-section {
        display: flex;
        flex-direction: column;
        justify-content: center;
        flex-shrink: 0;
        padding-right: 15px;
    }
    
    .mapraw-logo-main {
        color: #ffffff;
        font-size: 1.2rem;
        font-weight: 700;
        margin: 0;
        line-height: 1;
        white-space: nowrap;
    }
    
    .mapraw-logo-main span {
        color: var(--accent-color);
        text-shadow: 0 0 10px rgba(255, 235, 59, 0.5);
    }
    
    .mapraw-page-title {
        color: #e3f2fd;
        font-size: 1rem;
        font-weight: 400;
        margin: 2px 0 0 0;
        white-space: nowrap;
    }
    
    /* Navigation */
    .mapraw-nav {
        display: flex;
        gap: 8px;
        align-items: center;
        height: 100%;
    }
    
    .mapraw-nav-item {
        position: relative;
        height: 100%;
        display: flex;
        align-items: center;
    }
    
    .mapraw-nav-btn {
        background: var(--bg-glass);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
        padding: 8px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.85rem;
        font-weight: 500;
        transition: all 0.2s ease;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 6px;
        white-space: nowrap;
    }
    
    .mapraw-nav-btn:hover {
        background: var(--bg-glass-hover);
        transform: translateY(-1px);
    }
    
    .mapraw-nav-btn.home-btn {
        background: rgba(255, 235, 59, 0.15);
        border-color: #ffeb3b;
        color: #ffeb3b;
    }
    
    .mapraw-nav-btn.home-btn:hover {
        background: #ffeb3b;
        color: #1565c0;
    }

    /* Dropdown */
    .mapraw-dropdown {
        position: absolute;
        top: calc(100% - 10px);
        left: 50%;
        transform: translateX(-50%) translateY(10px);
        background: white;
        border-radius: 8px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        min-width: 200px;
        opacity: 0;
        visibility: hidden;
        transition: all 0.2s ease;
        padding: 5px 0;
        z-index: 1001;
    }
    
    @media (min-width: 1201px) {
        .mapraw-nav-item:hover .mapraw-dropdown {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0);
        }
    }
    
    .mapraw-dropdown-item {
        display: block;
        padding: 10px 20px;
        color: var(--text-main);
        text-decoration: none;
        font-size: 0.9rem;
        transition: background 0.2s;
        white-space: nowrap;
    }
    
    .mapraw-dropdown-item:hover {
        background: #f1f8ff;
        color: var(--primary-color);
    }

    /* Hamburger Menu */
    .mobile-menu-toggle {
        display: none;
        background: none;
        border: none;
        cursor: pointer;
        padding: 10px;
        z-index: 1002;
    }
    
    .bar {
        display: block;
        width: 25px;
        height: 3px;
        margin: 5px auto;
        background-color: white;
        transition: all 0.3s ease-in-out;
        border-radius: 2px;
    }

    /* ==== 3. MAIN CONTENT STYLES (Refreshed) ==== */
    
    .main-container {
        max-width: 1600px;
        margin: 0 auto;
        padding: 2rem;
    }

    .app-header {
        text-align: center;
        margin-bottom: 2rem;
        padding: 2rem;
        background-color: white;
        border-radius: 1rem;
        box-shadow: var(--card-shadow);
        border-top: 5px solid var(--primary-color);
        position: relative;
        overflow: hidden;
    }
    
    /* Decorative circle for header */
    .app-header::after {
        content: '';
        position: absolute;
        top: -50px;
        right: -50px;
        width: 150px;
        height: 150px;
        background: rgba(21, 101, 192, 0.05);
        border-radius: 50%;
    }

    .app-title {
        color: var(--primary-color);
        font-size: 2.2rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        letter-spacing: -0.5px;
    }

    .app-subtitle {
        color: var(--text-muted);
        font-size: 1.1rem;
        font-weight: 300;
    }

    .card {
        background-color: white;
        border-radius: 1rem;
        box-shadow: var(--card-shadow);
        border: none;
        margin-bottom: 1.5rem;
        transition: transform 0.2s, box-shadow 0.2s;
        overflow: visible; /* Allow dropdowns/shadows */
    }
    
    .card:hover {
        box-shadow: var(--hover-shadow);
    }

    .card-header {
        background: white;
        color: var(--primary-color);
        font-weight: 700;
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid var(--border-color);
        border-radius: 1rem 1rem 0 0 !important;
        display: flex;
        align-items: center;
        font-size: 1.1rem;
    }
    
    /* Card Header Icon Background */
    .card-header i {
        background: var(--bg-light-blue);
        padding: 8px;
        border-radius: 8px;
        margin-right: 12px;
        font-size: 1rem;
    }

    .card-body {
        padding: 1.5rem;
    }

    /* Buttons */
    .btn {
        border-radius: 0.5rem;
        font-weight: 500;
        padding: 0.6rem 1rem;
        transition: all 0.2s;
        font-family: 'Prompt', sans-serif;
    }

    .btn-primary {
        background: linear-gradient(135deg, #1e88e5 0%, #1565c0 100%);
        border: none;
        box-shadow: 0 4px 6px rgba(21, 101, 192, 0.2);
    }

    .btn-primary:hover {
        background: linear-gradient(135deg, #1565c0 0%, #0d47a1 100%);
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(21, 101, 192, 0.3);
    }

    .btn-outline-primary {
        color: var(--primary-color);
        border-color: var(--primary-color);
    }

    .btn-outline-primary:hover {
        background-color: var(--primary-color);
        color: white;
        transform: translateY(-1px);
    }
    
    .btn-secondary {
        background-color: #f1f5f9;
        color: #475569;
        border: none;
    }

    .btn-secondary:hover {
        background-color: #e2e8f0;
        color: #1e293b;
    }
    
    .btn-outline-success {
        color: #059669;
        border-color: #059669;
    }
    
    .btn-outline-success:hover {
        background-color: #059669;
        color: white;
    }

    /* Forms */
    .form-control, .form-select {
        border-radius: 0.5rem;
        border: 1px solid #cbd5e1;
        padding: 0.7rem 0.75rem;
        font-family: 'Prompt', sans-serif;
        font-size: 0.95rem;
    }

    .form-control:focus, .form-select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 4px rgba(21, 101, 192, 0.1);
        outline: none;
    }
    
    .input-group-text {
        border-radius: 0.5rem 0 0 0.5rem;
        border: 1px solid #cbd5e1;
        border-right: none;
        background-color: #f8fafc;
    }
    
    .input-group .form-control {
        border-radius: 0 0.5rem 0.5rem 0;
    }

    /* Progress Bar */
    .progress {
        height: 1.2rem;
        border-radius: 1rem;
        background-color: #e2e8f0;
        overflow: hidden;
        box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
    }

    .progress-bar {
        background: linear-gradient(90deg, #42a5f5, #1565c0);
        font-weight: 500;
        font-size: 0.8rem;
        line-height: 1.2rem;
    }

    /* ==== 4. TABLES & DATA ==== */
    .datatable-container {
        border-radius: 0.75rem;
        overflow: hidden;
        border: 1px solid var(--border-color);
        margin-top: 1rem;
    }

    .table {
        margin-bottom: 0;
    }

    .table thead th {
        background-color: #f1f8ff; /* Light blue tint */
        color: var(--secondary-color);
        font-weight: 600;
        border-bottom: 2px solid #bbdefb;
        text-transform: uppercase;
        font-size: 0.85rem;
        letter-spacing: 0.5px;
        padding: 1rem;
        white-space: nowrap;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    .table tbody td {
        padding: 0.8rem 1rem;
        vertical-align: middle;
        border-bottom: 1px solid #f1f5f9;
        font-size: 0.95rem;
    }

    .table tbody tr:hover {
        background-color: #f8fafc;
    }
    
    .table tfoot tr {
        background-color: #f8f9fa;
        font-weight: bold;
        border-top: 2px solid #dee2e6;
    }

    /* Fixed Columns for Detailed Table */
    .fixed-column {
        position: sticky;
        left: 0;
        background-color: white;
        z-index: 5;
        border-right: 2px solid #f1f5f9;
        box-shadow: 2px 0 5px rgba(0,0,0,0.02);
    }

    .fixed-column.header {
        z-index: 15;
        background-color: #f1f8ff;
    }

    /* ==== 5. FILTERS & CHART ==== */
    .filter-section {
        background-color: #f8fafc;
        border-radius: 0.5rem;
        padding: 1rem;
    }

    .filter-scrollable {
        max-height: 200px;
        overflow-y: auto;
        background-color: white;
        border-radius: 0.5rem;
        padding: 0.75rem;
        border: 1px solid #e2e8f0;
    }

    .checkbox-label {
        display: flex;
        align-items: center;
        margin-bottom: 0.4rem;
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 4px;
        transition: background 0.1s;
    }

    .checkbox-label:hover {
        background-color: var(--bg-light-blue);
    }

    .checkbox-label input {
        margin-right: 0.75rem;
        accent-color: var(--primary-color);
        width: 1.1em;
        height: 1.1em;
    }

    .badge-total {
        background-color: var(--accent-color);
        color: var(--secondary-color);
        font-weight: 700;
        font-size: 0.9rem;
        padding: 0.5em 1em;
        border-radius: 2rem;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .chart-container {
        position: relative;
        height: 350px;
        padding: 10px;
    }

    /* Tabs */
    .nav-tabs {
        border-bottom: 2px solid #f1f5f9;
        margin-bottom: 1.5rem;
    }
    
    .nav-tabs .nav-link {
        color: var(--text-muted);
        font-weight: 500;
        border: none;
        padding: 0.8rem 1.5rem;
        transition: all 0.2s;
        border-radius: 0.5rem 0.5rem 0 0;
    }
    
    .nav-tabs .nav-link.active {
        color: var(--primary-color);
        font-weight: 700;
        border-bottom: 3px solid var(--primary-color);
        background: transparent;
    }
    
    .nav-tabs .nav-link:hover:not(.active) {
        color: var(--primary-color);
        background-color: rgba(227, 242, 253, 0.4);
    }

    /* ==== 6. ORGANIZATION SECTION (Detailed Table) ==== */
    .org-section {
        border: 1px solid #e2e8f0;
        border-radius: 0.75rem;
        margin-bottom: 24px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0,0,0,0.02);
        background: white;
    }

    .org-header {
        background: linear-gradient(90deg, #f8f9fa 0%, #ffffff 100%);
        color: var(--primary-color);
        font-weight: 700;
        font-size: 1.1rem;
        padding: 15px 20px;
        margin: 0;
        border-bottom: 1px solid #f1f5f9;
        border-left: 5px solid var(--accent-color);
        display: flex;
        align-items: center;
    }
    
    .org-header::before {
        content: 'üè¢';
        margin-right: 10px;
        font-size: 1.2rem;
    }

    .org-table .usage-row {
        background-color: #f8fafc !important;
        font-weight: 600;
        color: var(--secondary-color);
        border-top: 1px solid #e2e8f0;
    }

    .org-table .type-row {
        background-color: white;
        border-left: 3px solid transparent;
        transition: background 0.2s;
    }

    .org-table .type-row:hover {
        background-color: #fffde7 !important; /* Light yellow tint on hover */
        border-left: 3px solid var(--accent-color);
    }

    /* ==== 7. FULLSCREEN MODE ==== */
    .fullscreen {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        width: 100vw;
        height: 100vh;
        z-index: 2000;
        background: white;
        padding: 20px;
        overflow: auto;
    }

    .fullscreen .datatable-container {
        max-height: none;
        border: none;
        height: calc(100vh - 60px);
    }
    
    .exit-fullscreen-btn {
        position: fixed;
        top: 20px;
        right: 30px;
        z-index: 2002;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }

    /* ==== 8. RESPONSIVE ==== */
    @media (max-width: 1400px) {
        .mapraw-nav-btn {
            padding: 6px 8px;
            font-size: 0.8rem;
        }
        .mapraw-nav {
            gap: 4px;
        }
    }

    @media (max-width: 1200px) {
        .mobile-menu-toggle {
            display: block;
        }

        .mapraw-nav {
            position: fixed;
            top: var(--header-height);
            right: -100%;
            width: 280px;
            height: calc(100vh - var(--header-height));
            background: white;
            flex-direction: column;
            align-items: stretch;
            gap: 0;
            padding: 10px 0;
            transition: right 0.3s ease;
            box-shadow: -5px 0 15px rgba(0,0,0,0.1);
            overflow-y: auto;
        }

        .mapraw-nav.active {
            right: 0;
        }

        .mapraw-nav-item {
            height: auto;
            flex-direction: column;
            width: 100%;
            display: block;
            border-bottom: 1px solid #eee;
        }

        .mapraw-nav-btn {
            background: white;
            color: #333;
            border: none;
            border-radius: 0;
            padding: 15px 20px;
            font-size: 1rem;
            justify-content: space-between;
            width: 100%;
            box-sizing: border-box;
        }
        
        .mapraw-nav-btn:hover {
            background: #f8fafc;
            color: var(--primary-color);
            transform: none;
        }
        
        .mapraw-dropdown {
            position: static;
            transform: none;
            visibility: visible;
            opacity: 1;
            box-shadow: none;
            min-width: 100%;
            background: #f8fafc;
            display: none;
            padding: 0;
            border: none;
        }
        
        .mapraw-nav-item.active .mapraw-dropdown {
            display: block;
        }

        .mapraw-dropdown-item {
            padding-left: 40px;
            color: #64748b;
        }
        
        .main-container {
            padding: 1rem;
        }
        
        .app-title {
            font-size: 1.8rem;
        }
        
        .mobile-menu-toggle.active .bar:nth-child(2) {
            opacity: 0;
        }
        .mobile-menu-toggle.active .bar:nth-child(1) {
            transform: translateY(8px) rotate(45deg);
        }
        .mobile-menu-toggle.active .bar:nth-child(3) {
            transform: translateY(-8px) rotate(-45deg);
        }
    }
    
    @media (max-width: 480px) {
        .mapraw-logo-main { font-size: 1rem; }
        .mapraw-page-title { font-size: 0.75rem; }
        
        .card-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
        }
        
        .badge-total {
            align-self: flex-start;
        }
    }
    
    /* Scrollbar Styling */
    ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }
    ::-webkit-scrollbar-track {
        background: #f1f1f1; 
    }
    ::-webkit-scrollbar-thumb {
        background: #c1c1c1; 
        border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8; 
    }

    </style>
</head>
<body>
    <header class="mapraw-header">
    <div class="mapraw-header-content">
        <div class="mapraw-logo-section">
            <h1 class="mapraw-logo-main">TOOL FROM <span>MAPRAW</span></h1>
            <p class="mapraw-page-title">Reclass BLDG</p>
        </div>
        
        <button class="mobile-menu-toggle" id="mobileMenuBtn">
            <span class="bar"></span>
            <span class="bar"></span>
            <span class="bar"></span>
        </button>

        <nav class="mapraw-nav" id="mainNav">
            <div class="mapraw-nav-item">
                <a href="index.html" class="mapraw-nav-btn home-btn">
                    <span>üè† ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</span>
                </a>
            </div>
            
            <div class="mapraw-nav-item" onclick="toggleMobileDropdown(this)">
                <div class="mapraw-nav-btn">
                    <span>üìã ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏™‡∏≥‡∏£‡∏ß‡∏à</span>
                    <span style="font-size: 0.8em">‚ñº</span>
                </div>
                <div class="mapraw-dropdown">
                    <a href="page1.html" class="mapraw-dropdown-item">NoteMAP</a>
                    <a href="#" class="mapraw-dropdown-item">SURVEY WORK</a>
                </div>
            </div>
            
            <div class="mapraw-nav-item" onclick="toggleMobileDropdown(this)">
                <div class="mapraw-nav-btn">
                    <span>üîß ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
                    <span style="font-size: 0.8em">‚ñº</span>
                </div>
                <div class="mapraw-dropdown">
                    <a href="page2.html" class="mapraw-dropdown-item">Reclass BLDG</a>
                    <a href="page5.html" class="mapraw-dropdown-item">Prepare PLLU</a>
                    <a href="page8.html" class="mapraw-dropdown-item">SHAPEFILE TO EXCEL</a>
                    <a href="page10.html" class="mapraw-dropdown-item">CAPTURE MAP</a>
                    <a href="page13.html" class="mapraw-dropdown-item">Perpendicular Line</a>
                </div>
            </div>
            
            <div class="mapraw-nav-item" onclick="toggleMobileDropdown(this)">
                <div class="mapraw-nav-btn">
                    <span>‚öôÔ∏è ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•</span>
                    <span style="font-size: 0.8em">‚ñº</span>
                </div>
                <div class="mapraw-dropdown">
                    <a href="page3.html" class="mapraw-dropdown-item">Calculate Landuse</a>
                    <a href="page6.html" class="mapraw-dropdown-item">Calculate Population</a>
                    <a href="page11.html" class="mapraw-dropdown-item">Calculate AREA</a>
                    <a href="page14.html" class="mapraw-dropdown-item">RECLASS FACTORY</a>
                    <a href="page12.html" class="mapraw-dropdown-item">COMPARISON LANDUSE</a>
                </div>
            </div>
            
            <div class="mapraw-nav-item" onclick="toggleMobileDropdown(this)">
                <div class="mapraw-nav-btn">
                    <span>‚öñÔ∏è ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢</span>
                    <span style="font-size: 0.8em">‚ñº</span>
                </div>
                <div class="mapraw-dropdown">
                    <a href="page4.html" class="mapraw-dropdown-item">Town Planning Laws</a>
                    <a href="page15.html" class="mapraw-dropdown-item">Building Laws</a>
                </div>
            </div>
            
            <div class="mapraw-nav-item" onclick="toggleMobileDropdown(this)">
                <div class="mapraw-nav-btn">
                    <span>üßÆ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô</span>
                    <span style="font-size: 0.8em">‚ñº</span>
                </div>
                <div class="mapraw-dropdown">
                    <a href="page7.html" class="mapraw-dropdown-item">AREA Calculator</a>
                </div>
            </div>
            
            <div class="mapraw-nav-item" onclick="toggleMobileDropdown(this)">
                <div class="mapraw-nav-btn">
                    <span>üéØ ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏≠‡∏∑‡πà‡∏ô‡πÜ</span>
                    <span style="font-size: 0.8em">‚ñº</span>
                </div>
                <div class="mapraw-dropdown">
                    <a href="page9.html" class="mapraw-dropdown-item">CREATE QRCODE</a>
                </div>
            </div>
        </nav>
    </div>
</header>

    <div class="main-container">
        <!-- App Header -->
        <div class="app-header">
            <h1 class="app-title">RECLASS BLDG</h1>
            <p class="app-subtitle">‡∏à‡∏±‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£</p>
        </div>

        <div class="row">
            <!-- Control Panel -->
            <div class="col-md-4 mb-4">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-gear-fill me-2"></i>‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£
                    </div>
                    <div class="card-body">
                        <!-- File Input Section -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">‡πÑ‡∏ü‡∏•‡πå‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ (Excel ‡∏´‡∏£‡∏∑‡∏≠ Shapefile)</label>
                            <div class="row g-2">
                                <!-- Excel Input -->
                                <div class="col-md-6">
                                    <label class="form-label text-muted small">‡πÑ‡∏ü‡∏•‡πå Excel</label>
                                    <div class="input-group">
                                        <input type="file" class="form-control" id="excelFile" accept=".xlsx,.xls" onchange="updateFileName('excel')">
                                    </div>
                                    <div id="fileNameExcel" class="text-muted small mt-1"></div>
                                </div>
                                <!-- Shapefile Input -->
                                <div class="col-md-6">
                                    <label class="form-label text-muted small">‡πÑ‡∏ü‡∏•‡πå Shapefile (ZIP)</label>
                                    <div class="input-group">
                                        <input type="file" class="form-control" id="shapefileInput" accept=".zip" onchange="updateFileName('shapefile')">
                                    </div>
                                    <div id="fileNameShapefile" class="text-muted small mt-1"></div>
                                </div>
                            </div>
                            <small class="text-muted">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏´‡∏ô‡∏∂‡πà‡∏á: Excel (.xlsx, .xls) ‡∏´‡∏£‡∏∑‡∏≠ Shapefile ‡πÅ‡∏ö‡∏ö ZIP</small>
                        </div>
                        
                        <!-- Local Organization Field Selection -->
                        <div class="mb-4">
                            <label for="localOrgField" class="form-label fw-bold">‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏ó‡πâ‡∏≠‡∏á‡∏ñ‡∏¥‡πà‡∏ô</label>
                            <select class="form-select" id="localOrgField">
                                <option value="">-- ‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
                            </select>
                            <div class="form-text">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏ó‡πâ‡∏≠‡∏á‡∏ñ‡∏¥‡πà‡∏ô</div>
                        </div>

                        <!-- Process Button -->
                        <div class="mb-4">
                            <button id="processButton" class="btn btn-primary w-100 py-2" onclick="processExcel()">
                                <i class="bi bi-play-fill me-2"></i>RECLASS
                            </button>
                        </div>

                        <!-- Progress Bar -->
                        <div id="progressContainer" class="mb-4 d-none">
                            <label class="form-label fw-bold">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤</label>
                            <div class="progress">
                                <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                            </div>
                        </div>

                        <!-- Export Buttons -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">‡∏ô‡∏≥‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</label>
                            <div class="d-flex flex-wrap">
                                <button id="exportFullButton" class="btn btn-outline-primary export-button mb-2" disabled onclick="exportFullData()">
                                    <i class="bi bi-table me-2"></i>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Excel)
                                </button>
                                <button id="exportSummaryButton" class="btn btn-outline-primary export-button mb-2" disabled onclick="exportSummary()">
                                    <i class="bi bi-table me-2"></i>‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£
                                </button>
                                <button id="exportDetailedButton" class="btn btn-outline-primary export-button mb-2" disabled onclick="exportDetailedSummary()">
                                    <i class="bi bi-table me-2"></i>‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏à‡∏≥‡πÅ‡∏ô‡∏Å‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡πÅ‡∏•‡∏∞‡∏Ç‡∏ô‡∏≤‡∏î‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£
                                </button>
                                <button id="exportShapefileButton" class="btn btn-outline-success export-button mb-2" disabled onclick="exportToShapefile()">
                                    <i class="bi bi-geo-alt me-2"></i>Shapefile ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô
                                </button>
                            </div>
                        </div>
                        
                        <!-- Home Button -->
                        <div>
                            <a href="index.html" class="btn btn-secondary w-100">
                                <i class="bi bi-house-fill me-2"></i>‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Filter Panel -->
                <div id="filterCard" class="card d-none">
                    <div class="card-header">
                        <i class="bi bi-funnel-fill me-2"></i>‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á
                    </div>
                    <div class="card-body">
                        <!-- Class Filter -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£</label>
                            <div id="classFilters" class="filter-scrollable"></div>
                        </div>

                        <!-- Year Filter -->
                        <div>
                            <label class="form-label fw-bold">‡∏õ‡∏µ‡∏™‡∏≥‡∏£‡∏ß‡∏à (ACQYEAR)</label>
                            <div id="yearFilters" class="filter-scrollable"></div>
                        </div>

                        <div class="filters-label mt-3">
                            <small>* ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results Panel -->
            <div class="col-md-8">
                <div id="resultsCard" class="card d-none">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-table me-2"></i>‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£</span>
                        <span id="totalBadge" class="badge badge-total">‡∏£‡∏ß‡∏°: 0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                    </div>
                    <div class="card-body">
                        <!-- Tabs -->
                        <ul class="nav nav-tabs" id="resultTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="summary-tab" data-bs-toggle="tab" data-bs-target="#summary" type="button" role="tab" aria-controls="summary" aria-selected="true">
                                    <i class="bi bi-pie-chart me-1"></i>‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="detailed-tab" data-bs-toggle="tab" data-bs-target="#detailed" type="button" role="tab" aria-controls="detailed" aria-selected="false">
                                    <i class="bi bi-grid-3x3 me-1"></i>‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏à‡∏≥‡πÅ‡∏ô‡∏Å‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡πÅ‡∏•‡∏∞‡∏Ç‡∏ô‡∏≤‡∏î‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£
                                </button>
                            </li>
                        </ul>
                        
                        <!-- Tab Content -->
                        <div class="tab-content" id="resultTabsContent">
                            <!-- Summary Tab -->
                            <div class="tab-pane fade show active" id="summary" role="tabpanel" aria-labelledby="summary-tab">
                                <div class="datatable-container">
                                    <table class="table table-striped table-hover">
                                        <thead>
                                            <tr>
                                                <th>code</th>
                                                <th>‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£</th>
                                                <th class="text-end">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡∏´‡∏•‡∏±‡∏á)</th>
                                                <th class="text-end">‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞</th>
                                                <th class="text-end">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏ß‡∏° (‡∏ï‡∏£.‡∏°.)</th>
                                                <th class="text-end">‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞</th>
                                            </tr>
                                        </thead>
                                        <tbody id="summaryTableBody"></tbody>
                                        <tfoot id="summaryTableFoot"></tfoot>
                                    </table>
                                </div>

                                <!-- Charts -->
                                <div class="row mt-4">
                                    <div class="col-md-6 mb-3">
                                        <div class="chart-container">
                                            <canvas id="buildingCountChart"></canvas>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <div class="chart-container">
                                            <canvas id="buildingAreaChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Detailed Tab -->
                            <div class="tab-pane fade" id="detailed" role="tabpanel" aria-labelledby="detailed-tab">
                                <div id="detailedTableContainer" class="datatable-container">
                                    <button id="fullscreenBtn" class="btn btn-sm btn-secondary fullscreen-btn d-none">
                                        <i class="bi bi-arrows-fullscreen"></i> ‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏ï‡πá‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
                                    </button>
                                    <div class="text-center py-4 text-secondary" id="noOrgFieldSelected">
                                        <i class="bi bi-info-circle fs-3 d-block mb-2"></i>
                                        ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏ó‡πâ‡∏≠‡∏á‡∏ñ‡∏¥‡πà‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏à‡∏≥‡πÅ‡∏ô‡∏Å
                                    </div>
                                    <div id="detailedTableContent" class="d-none">
                                        <!-- ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏î‡∏¢ JavaScript -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£
        const buildingClassMapping = {
            "1000": "10", "1100": "10", "1101": "10", "1102": "10", "1103": "10",
            "1121": "10", "1122": "10", "1123": "10", "1131": "10", "1132": "10",
            "1200": "10", "1300": "10", "1310": "10", "1320": "10", "1330": "10",
            "1340": "10", "1350": "10", "1800": "10", "2000": "20", "2100": "20",
            "2200": "20", "2210": "20", "2220": "20", "2230": "20", "2231": "20",
            "2232": "20", "2233": "20", "2234": "20", "2240": "20", "2241": "20",
            "2250": "20", "2251": "20", "2260": "20", "2270": "20", "2280": "20",
            "2300": "20", "2301": "20", "2302": "20", "2400": "20", "2410": "20",
            "2420": "20", "2480": "20", "2500": "20", "2800": "20", "3000": "30",
            "3100": "30", "3110": "30", "3120": "30", "3300": "30", "3310": "30",
            "3311": "30", "3321": "30", "3322": "30", "3800": "30", "4100": "41",
            "4110": "41", "4120": "41", "4121": "41", "4122": "41", "4123": "41",
            "4180": "41", "4200": "30", "4300": "30", "5000": "50", "5130": "50",
            "5140": "50", "5150": "50", "5160": "50", "5180": "50", "5200": "50",
            "5210": "50", "5220": "50", "5230": "50", "5300": "50", "5310": "50",
            "5320": "50", "5330": "50", "5400": "50", "5410": "50", "5420": "50",
            "5430": "50", "5440": "50", "5500": "50", "5510": "50", "5520": "50",
            "5800": "50", "6000": "50", "6100": "61", "6105": "61", "6110": "61",
            "6120": "61", "6130": "61", "6140": "61", "6141": "61", "6142": "61",
            "6143": "61", "6150": "61", "6160": "61", "6180": "61", "6200": "62",
            "6210": "62", "6220": "62", "6230": "62", "6240": "62", "6250": "62",
            "6260": "62", "6270": "62", "6280": "62", "6300": "63", "6310": "63",
            "6320": "63", "6330": "63", "6340": "63", "6350": "63", "6360": "63",
            "6370": "63", "6380": "63", "6381": "63", "6382": "63", "6383": "63",
            "6400": "50", "6500": "63", "6510": "63", "6530": "63", "6580": "63",
            "6600": "72", "6610": "72", "6620": "50", "6630": "63", "6640": "50",
            "6650": "50", "6660": "50", "6800": "50", "6830": "62", "6831": "62",
            "7000": "50", "7200": "72", "7210": "72", "7220": "72", "7300": "73",
            "7310": "73", "7320": "73", "7321": "73", "7322": "73", "7323": "73",
            "7324": "73", "7330": "73", "7380": "73", "8000": "80", "8170": "80",
            "8180": "80", "8190": "80", "8310": "80", "8500": "80", "9991": "90",
            "9993": "90", "9998": "90", "9999": "90"
        };

        // ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£
        const classDescriptions = {
            "10": "‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏≠‡∏≤‡∏®‡∏±‡∏¢",
            "20": "‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡∏Å‡∏£‡∏£‡∏°",
            "30": "‡∏≠‡∏∏‡∏ï‡∏™‡∏≤‡∏´‡∏Å‡∏£‡∏£‡∏°",
            "41": "‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å‡∏≠‡∏≤‡∏®‡∏±‡∏¢‡∏Å‡∏∂‡πà‡∏á‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡∏Å‡∏£‡∏£‡∏°",
            "42": "‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏•‡∏∞‡∏≠‡∏∏‡∏ï‡∏™‡∏≤‡∏´‡∏Å‡∏£‡∏£‡∏°",
            "43": "‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å‡∏≠‡∏≤‡∏®‡∏±‡∏¢‡∏Å‡∏∂‡πà‡∏á‡∏≠‡∏∏‡∏ï‡∏™‡∏≤‡∏´‡∏Å‡∏£‡∏£‡∏°",
            "50": "‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏π‡∏õ‡πÇ‡∏†‡∏Ñ",
            "63": "‡∏™‡∏ñ‡∏≤‡∏ö‡∏±‡∏ô‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£",
            "61": "‡∏™‡∏ñ‡∏≤‡∏ö‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤",
            "62": "‡∏™‡∏ñ‡∏≤‡∏ö‡∏±‡∏ô‡∏®‡∏≤‡∏™‡∏ô‡∏≤",
            "72": "‡∏®‡∏¥‡∏•‡∏õ‡∏ß‡∏±‡∏í‡∏ô‡∏ò‡∏£‡∏£‡∏°",
            "73": "‡∏ô‡∏±‡∏ô‡∏ó‡∏ô‡∏≤‡∏Å‡∏≤‡∏£",
            "80": "‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡∏£‡∏°",
            "90": "‡∏≠‡∏∑‡πà‡∏ô‡πÜ",
            "99": "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"
        };
        
        // ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏à‡∏≥‡πÅ‡∏ô‡∏Å
        const detailedClassDescriptions = {
            "10": "‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏≠‡∏≤‡∏®‡∏±‡∏¢",
            "20": "‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡∏Å‡∏£‡∏£‡∏°",
            "30": "‡∏≠‡∏∏‡∏ï‡∏™‡∏≤‡∏´‡∏Å‡∏£‡∏£‡∏°",
            "41": "‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å‡∏≠‡∏≤‡∏®‡∏±‡∏¢‡∏Å‡∏∂‡πà‡∏á‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡∏Å‡∏£‡∏£‡∏°",
            "42": "‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏•‡∏∞‡∏≠‡∏∏‡∏ï‡∏™‡∏≤‡∏´‡∏Å‡∏£‡∏£‡∏°",
            "43": "‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å‡∏≠‡∏≤‡∏®‡∏±‡∏¢‡∏Å‡∏∂‡πà‡∏á‡∏≠‡∏∏‡∏ï‡∏™‡∏≤‡∏´‡∏Å‡∏£‡∏£‡∏°",
        };
        
        // ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ (BL_TYPE)
        const buildingTypeDescriptions = {
            "1": "‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß/‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß",
            "2": "‡∏ö‡πâ‡∏≤‡∏ô‡πÅ‡∏ù‡∏î",
            "3": "‡∏ó‡∏≤‡∏ß‡∏ô‡πå‡πÄ‡∏Æ‡∏≤‡∏™‡πå",
            "4": "‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏ñ‡∏ß",
            "5": "‡∏ï‡∏∂‡∏Å‡πÅ‡∏ñ‡∏ß",
            "6": "‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏≠‡∏¢‡∏π‡πà‡∏≠‡∏≤‡∏®‡∏±‡∏¢‡∏£‡∏ß‡∏°",
            "7": "‡πÄ‡∏£‡∏∑‡∏≠‡∏ô‡πÅ‡∏û",
            "8": "‡πÄ‡∏û‡∏¥‡∏á‡∏ñ‡∏≤‡∏ß‡∏£"
        };
        
        // ‡∏Ç‡∏ô‡∏≤‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£
        const sizeDescriptions = {
            "1": "0 - 300 ‡∏ï‡∏£.‡∏°.",
            "2": "300.01 - 500 ‡∏ï‡∏£.‡∏°.",
            "3": "500.01 - 1,000 ‡∏ï‡∏£.‡∏°.",
            "4": "1,000.01 - 2,000 ‡∏ï‡∏£.‡∏°.",
            "5": "2,000.01 - 4,000 ‡∏ï‡∏£.‡∏°.",
            "6": "4,000.01 - 9,999 ‡∏ï‡∏£.‡∏°.",
            "7": "‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 9,999 ‡∏ï‡∏£.‡∏°."
        };

        // ‡∏™‡∏µ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏≤‡∏ü
        const classColors = {
            "10": "#FFC107", // ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏≠‡∏≤‡∏®‡∏±‡∏¢ (Yellow/Amber - ‡∏™‡∏ß‡πà‡∏≤‡∏á)
            "20": "#F44336", // ‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡∏Å‡∏£‡∏£‡∏° (Red - ‡πÄ‡∏î‡πà‡∏ô‡∏ä‡∏±‡∏î)
            "30": "#9C27B0", // ‡∏≠‡∏∏‡∏ï‡∏™‡∏≤‡∏´‡∏Å‡∏£‡∏£‡∏° (Purple - ‡πÄ‡∏Ç‡πâ‡∏°)
            "41": "#E91E63", // ‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å+‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå (Pink - ‡∏™‡∏î‡πÉ‡∏™)
            "42": "#00BCD4", // ‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå+‡∏≠‡∏∏‡∏ï‡∏™‡∏≤‡∏´‡∏Å‡∏£‡∏£‡∏° (Cyan - ‡∏™‡∏ß‡πà‡∏≤‡∏á)
            "43": "#673AB7", // ‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å+‡∏≠‡∏∏‡∏ï‡∏™‡∏≤‡∏´‡∏Å‡∏£‡∏£‡∏° (Deep Purple)
            "50": "#2196F3", // ‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏π‡∏õ‡πÇ‡∏†‡∏Ñ (Blue - ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô)
            "61": "#4CAF50", // ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ (Green - ‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥)
            "62": "#c5c5d1", // ‡∏®‡∏≤‡∏™‡∏ô‡∏≤ (grey - ‡πÄ‡∏ó‡∏≤‡∏≠‡πà‡∏≠‡∏ô)
            "63": "#0d00ff", // ‡∏™‡∏ñ‡∏≤‡∏ö‡∏±‡∏ô‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£ (Blue - ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô)
            "72": "#795548", // ‡∏®‡∏¥‡∏•‡∏õ‡∏ß‡∏±‡∏í‡∏ô‡∏ò‡∏£‡∏£‡∏° (Brown - ‡∏Ñ‡∏•‡∏≤‡∏™‡∏™‡∏¥‡∏Ñ)
            "73": "#8BC34A", // ‡∏ô‡∏±‡∏ô‡∏ó‡∏ô‡∏≤‡∏Å‡∏≤‡∏£ (Light Green - ‡∏™‡∏î‡∏ä‡∏∑‡πà‡∏ô)
            "80": "#009688", // ‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡∏£‡∏° (Teal - ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡πÄ‡∏Ç‡πâ‡∏°)
            "90": "#607D8B", // ‡∏≠‡∏∑‡πà‡∏ô‡πÜ (Blue Grey)
            "99": "#9E9E9E"  // ‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏ (Grey)
        };

        // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        let originalData = [];
        let processedData = [];
        let selectedClassFilters = [];
        let selectedYearFilters = [];
        let selectedLocalOrgField = "";
        let countChart = null;
        let areaChart = null;
        let geoJSONData = null; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• GeoJSON ‡∏à‡∏≤‡∏Å Shapefile
        let detectedUTMZone = null; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• UTM Zone ‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡πÑ‡∏î‡πâ
        let isShapefileInput = false; // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô Shapefile ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        let originalProjection = null; // ‡πÄ‡∏Å‡πá‡∏ö projection ‡∏î‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏¥‡∏°
        let originalShpFile = null; // ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ü‡∏•‡πå .shp ‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö
        let originalShxFile = null; // ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ü‡∏•‡πå .shx ‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö
        let originalPrjFile = null; // ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ü‡∏•‡πå .prj ‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö
        let originalCpgFile = null; // ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ü‡∏•‡πå .cpg ‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)

        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        function updateFileName(type) {
            if (type === 'excel') {
                const fileInput = document.getElementById('excelFile');
                const fileNameDisplay = document.getElementById('fileNameExcel');
                const shapefileDisplay = document.getElementById('fileNameShapefile');
                
                if (fileInput.files && fileInput.files[0]) {
                    fileNameDisplay.textContent = '‚úì ' + fileInput.files[0].name;
                    shapefileDisplay.textContent = '';
                    // ‡∏•‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå Shapefile
                    document.getElementById('shapefileInput').value = '';
                    isShapefileInput = false;
                    
                    // ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà
                    const localOrgFieldSelect = document.getElementById('localOrgField');
                    localOrgFieldSelect.innerHTML = '<option value="">-- ‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>';
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, {type: 'array'});
                            const firstSheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[firstSheetName];
                            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                            
                            if (jsonData.length > 0) {
                                const headers = jsonData[0];
                                headers.forEach(header => {
                                    if (header) {
                                        const option = document.createElement('option');
                                        option.value = header;
                                        option.textContent = header;
                                        localOrgFieldSelect.appendChild(option);
                                    }
                                });
                            }
                        } catch (error) {
                            console.error('Error reading Excel file headers:', error);
                        }
                    };
                    reader.readAsArrayBuffer(fileInput.files[0]);
                } else {
                    fileNameDisplay.textContent = '';
                }
            } else if (type === 'shapefile') {
                const fileInput = document.getElementById('shapefileInput');
                const fileNameDisplay = document.getElementById('fileNameShapefile');
                const excelDisplay = document.getElementById('fileNameExcel');
                
                if (fileInput.files && fileInput.files[0]) {
                    fileNameDisplay.textContent = '‚úì ' + fileInput.files[0].name;
                    excelDisplay.textContent = '';
                    // ‡∏•‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå Excel
                    document.getElementById('excelFile').value = '';
                    isShapefileInput = true;
                    
                    // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Shapefile ‡∏à‡∏∞‡∏≠‡πà‡∏≤‡∏ô field names ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡πâ‡∏ß
                    const localOrgFieldSelect = document.getElementById('localOrgField');
                    localOrgFieldSelect.innerHTML = '<option value="">-- ‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>';
                } else {
                    fileNameDisplay.textContent = '';
                }
            }
        }

        // ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÑ‡∏ü‡∏•‡πå Excel ‡∏´‡∏£‡∏∑‡∏≠ Shapefile
        async function processExcel() {
            selectedLocalOrgField = document.getElementById('localOrgField').value;
            
            // ‡πÅ‡∏™‡∏î‡∏á Progress Bar
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            progressContainer.classList.remove('d-none');
            
            if (isShapefileInput) {
                // ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• Shapefile
                const fileInput = document.getElementById('shapefileInput');
                const file = fileInput.files[0];
                if (!file) {
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Shapefile (.zip)');
                    progressContainer.classList.add('d-none');
                    return;
                }
                await processShapefileData(file, progressBar);
            } else {
                // ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• Excel
                const fileInput = document.getElementById('excelFile');
                const file = fileInput.files[0];
                if (!file) {
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel');
                    progressContainer.classList.add('d-none');
                    return;
                }
                processExcelFile(file, progressBar);
            }
        }

        // ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÑ‡∏ü‡∏•‡πå Excel
        function processExcelFile(file, progressBar) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    originalData = XLSX.utils.sheet_to_json(worksheet);
                    
                    // ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    processData(originalData, progressBar);
                    
                    // ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏ô‡∏≥‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    document.getElementById('exportFullButton').disabled = false;
                    document.getElementById('exportSummaryButton').disabled = false;
                    document.getElementById('exportDetailedButton').disabled = !selectedLocalOrgField;
                    document.getElementById('exportShapefileButton').disabled = true; // ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Shapefile
                    
                    // ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
                    document.getElementById('filterCard').classList.remove('d-none');
                    document.getElementById('resultsCard').classList.remove('d-none');
                    
                    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á
                    createFilters();
                    
                    // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
                    updateResultsTable();
                    
                    // ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏à‡∏≥‡πÅ‡∏ô‡∏Å (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏ó‡πâ‡∏≠‡∏á‡∏ñ‡∏¥‡πà‡∏ô)
                    if (selectedLocalOrgField) {
                        document.getElementById('noOrgFieldSelected').classList.add('d-none');
                        document.getElementById('detailedTableContent').classList.remove('d-none');
                        document.getElementById('fullscreenBtn').classList.remove('d-none');
                        createDetailedTable();
                    } else {
                        document.getElementById('noOrgFieldSelected').classList.remove('d-none');
                        document.getElementById('detailedTableContent').classList.add('d-none');
                        document.getElementById('fullscreenBtn').classList.add('d-none');
                    }
                } catch (error) {
                    console.error('Error processing Excel file:', error);
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÑ‡∏ü‡∏•‡πå: ' + error.message);
                    document.getElementById('progressContainer').classList.add('d-none');
                }
            };
            
            reader.onerror = function() {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå');
                document.getElementById('progressContainer').classList.add('d-none');
            };
            
            reader.readAsArrayBuffer(file);
        }

        // ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÑ‡∏ü‡∏•‡πå Shapefile (ZIP)
        async function processShapefileData(file, progressBar) {
            try {
                progressBar.style.width = '10%';
                progressBar.textContent = '10%';
                
                // ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå ZIP
                const arrayBuffer = await file.arrayBuffer();
                const zip = await JSZip.loadAsync(arrayBuffer);
                
                progressBar.style.width = '20%';
                progressBar.textContent = '20%';
                
                // ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                for (const [filename, fileData] of Object.entries(zip.files)) {
                    const lowerFilename = filename.toLowerCase();
                    
                    if (lowerFilename.endsWith('.shp')) {
                        originalShpFile = await fileData.async('arraybuffer');
                        console.log('‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ü‡∏•‡πå .shp ‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö');
                    } else if (lowerFilename.endsWith('.shx')) {
                        originalShxFile = await fileData.async('arraybuffer');
                        console.log('‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ü‡∏•‡πå .shx ‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö');
                    } else if (lowerFilename.endsWith('.prj')) {
                        originalPrjFile = await fileData.async('text');
                        originalProjection = originalPrjFile;
                        detectedUTMZone = detectUTMZone(originalPrjFile);
                        console.log('‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö UTM Zone:', detectedUTMZone);
                    } else if (lowerFilename.endsWith('.cpg')) {
                        originalCpgFile = await fileData.async('text');
                        console.log('‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ü‡∏•‡πå .cpg ‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö');
                    }
                }
                
                progressBar.style.width = '40%';
                progressBar.textContent = '40%';
                
                // ‡πÉ‡∏ä‡πâ shpjs library ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡πà‡∏≤‡∏ô Shapefile ‡∏à‡∏≤‡∏Å ZIP
                const geoJSON = await shp(arrayBuffer);
                
                progressBar.style.width = '60%';
                progressBar.textContent = '60%';
                
                // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å GeoJSON ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£ Export
                geoJSONData = geoJSON;
                
                // ‡πÅ‡∏õ‡∏•‡∏á GeoJSON ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á
                originalData = geoJSON.features.map((feature, index) => {
                    return {
                        FID: index + 1,
                        ...feature.properties,
                        geometry: feature.geometry
                    };
                });
                
                // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó dropdown ‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏ó‡πâ‡∏≠‡∏á‡∏ñ‡∏¥‡πà‡∏ô
                if (originalData.length > 0) {
                    const fields = Object.keys(originalData[0]).filter(key => 
                        key !== 'geometry' && key !== 'FID'
                    );
                    const localOrgFieldSelect = document.getElementById('localOrgField');
                    localOrgFieldSelect.innerHTML = '<option value="">-- ‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>';
                    fields.forEach(field => {
                        const option = document.createElement('option');
                        option.value = field;
                        option.textContent = field;
                        localOrgFieldSelect.appendChild(option);
                    });
                }
                
                progressBar.style.width = '80%';
                progressBar.textContent = '80%';
                
                // ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                processData(originalData, progressBar);
                
                // ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏ô‡∏≥‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                document.getElementById('exportFullButton').disabled = false;
                document.getElementById('exportSummaryButton').disabled = false;
                document.getElementById('exportDetailedButton').disabled = !selectedLocalOrgField;
                document.getElementById('exportShapefileButton').disabled = false; // ‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Shapefile
                
                // ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
                document.getElementById('filterCard').classList.remove('d-none');
                document.getElementById('resultsCard').classList.remove('d-none');
                
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á
                createFilters();
                
                // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
                updateResultsTable();
                
                // ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏à‡∏≥‡πÅ‡∏ô‡∏Å
                if (selectedLocalOrgField) {
                    document.getElementById('noOrgFieldSelected').classList.add('d-none');
                    document.getElementById('detailedTableContent').classList.remove('d-none');
                    document.getElementById('fullscreenBtn').classList.remove('d-none');
                    createDetailedTable();
                } else {
                    document.getElementById('noOrgFieldSelected').classList.remove('d-none');
                    document.getElementById('detailedTableContent').classList.add('d-none');
                    document.getElementById('fullscreenBtn').classList.add('d-none');
                }
                
                progressBar.style.width = '100%';
                progressBar.textContent = '100%';
                
                setTimeout(() => {
                    document.getElementById('progressContainer').classList.add('d-none');
                }, 1000);
                
            } catch (error) {
                console.error('Error processing Shapefile:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå Shapefile: ' + error.message);
                document.getElementById('progressContainer').classList.add('d-none');
            }
        }

        // ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏¥‡∏•‡∏î‡πå class ‡πÅ‡∏•‡∏∞ size
        function processData(data, progressBar) {
            processedData = data.map((row, index) => {
                // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤
                const progress = Math.round((index + 1) / data.length * 100);
                progressBar.style.width = progress + '%';
                progressBar.setAttribute('aria-valuenow', progress);
                progressBar.textContent = progress + '%';
                
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
                const newRow = {...row};
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡πà‡∏≤ ACQYEAR ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                if (!newRow.ACQYEAR) {
                    newRow.ACQYEAR = "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏"; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡πà‡∏≤ "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏" ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ACQYEAR
                }
                
                // ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô string ‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
                const blUse = row.BL_USE ? row.BL_USE.toString() : '';
                
                // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤ class
                newRow.class = buildingClassMapping[blUse] || '99';
                
                // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤ size ‡∏ï‡∏≤‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà (BL_AREA)
                const area = parseFloat(row.BL_AREA) || 0;
                
                if (area <= 300) {
                    newRow.size = "1";
                } else if (area <= 500) {
                    newRow.size = "2";
                } else if (area <= 1000) {
                    newRow.size = "3";
                } else if (area <= 2000) {
                    newRow.size = "4";
                } else if (area <= 4000) {
                    newRow.size = "5";
                } else if (area <= 9999) {
                    newRow.size = "6";
                } else {
                    newRow.size = "7";
                }
                
                // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ size
                newRow.size_desc = sizeDescriptions[newRow.size];
                
                return newRow;
            });
        }

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á
        function createFilters() {
            const classFilterContainer = document.getElementById('classFilters');
            const yearFilterContainer = document.getElementById('yearFilters');
            
            // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°
            classFilterContainer.innerHTML = '';
            yearFilterContainer.innerHTML = '';
            selectedClassFilters = [];
            selectedYearFilters = [];
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á class
            const uniqueClasses = [...new Set(processedData.map(item => item.class).filter(Boolean))].sort();
            
            uniqueClasses.forEach(classCode => {
                const label = document.createElement('label');
                label.className = 'checkbox-label';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = classCode;
                checkbox.checked = true;
                checkbox.addEventListener('change', function() {
                    if (this.checked) {
                        selectedClassFilters.push(this.value);
                    } else {
                        selectedClassFilters = selectedClassFilters.filter(c => c !== this.value);
                    }
                    updateResultsTable();
                    
                    if (selectedLocalOrgField) {
                        createDetailedTable();
                    }
                });
                
                label.appendChild(checkbox);
                label.appendChild(document.createTextNode(`${classCode} - ${classDescriptions[classCode] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}`));
                
                classFilterContainer.appendChild(label);
                selectedClassFilters.push(classCode);
            });
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á ACQYEAR
            const uniqueYears = [...new Set(processedData.map(item => {
                // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô string ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ä‡∏¥‡∏á‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì
                return item.ACQYEAR ? item.ACQYEAR.toString() : '';
            }).filter(Boolean))].sort();
            
            uniqueYears.forEach(year => {
                const label = document.createElement('label');
                label.className = 'checkbox-label';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = year;
                checkbox.checked = true;
                checkbox.addEventListener('change', function() {
                    if (this.checked) {
                        selectedYearFilters.push(this.value);
                    } else {
                        selectedYearFilters = selectedYearFilters.filter(y => y !== this.value);
                    }
                    updateResultsTable();
                    
                    if (selectedLocalOrgField) {
                        createDetailedTable();
                    }
                });
                
                label.appendChild(checkbox);
                label.appendChild(document.createTextNode(year));
                
                yearFilterContainer.appendChild(label);
                selectedYearFilters.push(year);
            });
        }

        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
        function updateResultsTable() {
            // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            const filteredData = processedData.filter(item => {
                const classMatch = selectedClassFilters.includes(item.class);
                const yearMatch = !item.ACQYEAR || selectedYearFilters.includes(item.ACQYEAR ? item.ACQYEAR.toString() : '');
                return classMatch && yearMatch;
            });
            
            // ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏° class
            const groupedData = {};
            filteredData.forEach(item => {
                if (!groupedData[item.class]) {
                    groupedData[item.class] = {
                        count: 0,
                        area: 0
                    };
                }
                
                groupedData[item.class].count += 1;
                groupedData[item.class].area += parseFloat(item.BL_AREA) || 0;
            });
            
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ú‡∏•‡∏£‡∏ß‡∏°
            const totalCount = Object.values(groupedData).reduce((sum, group) => sum + group.count, 0);
            const totalArea = Object.values(groupedData).reduce((sum, group) => sum + group.area, 0);
            
            // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó badge ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏ß‡∏°
            document.getElementById('totalBadge').textContent = `‡∏£‡∏ß‡∏°: ${totalCount.toLocaleString()} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
            
            // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏ï‡∏≤‡∏£‡∏≤‡∏á
            const tableBody = document.getElementById('summaryTableBody');
            const tableFoot = document.getElementById('summaryTableFoot');
            
            tableBody.innerHTML = '';
            
            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏≤‡∏° class
            const sortedClasses = Object.keys(groupedData).sort();
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏≤‡∏ü
            const chartLabels = [];
            const chartDataCount = [];
            const chartDataArea = [];
            const chartColors = [];
            
            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
            sortedClasses.forEach(classCode => {
                const group = groupedData[classCode];
                const row = document.createElement('tr');
                
                // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏≤‡∏ü
                chartLabels.push(classCode + ' - ' + (classDescriptions[classCode] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'));
                chartDataCount.push(group.count);
                chartDataArea.push(group.area);
                chartColors.push(classColors[classCode] || '#6B7280');
                
                // Column 1: Class Code
                const classCell = document.createElement('td');
                classCell.textContent = classCode;
                row.appendChild(classCell);
                
                // Column 2: Class Description
                const descCell = document.createElement('td');
                descCell.textContent = classDescriptions[classCode] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                row.appendChild(descCell);
                
                // Column 3: Count
                const countCell = document.createElement('td');
                countCell.className = 'text-end';
                countCell.textContent = group.count.toLocaleString();
                row.appendChild(countCell);
                
                // Column 4: Count Percentage
                const countPctCell = document.createElement('td');
                countPctCell.className = 'text-end';
                const countPct = totalCount > 0 ? (group.count / totalCount) * 100 : 0;
                countPctCell.textContent = countPct.toFixed(2) + '%';
                row.appendChild(countPctCell);
                
                // Column 5: Area
                const areaCell = document.createElement('td');
                areaCell.className = 'text-end';
                areaCell.textContent = group.area.toLocaleString(undefined, {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
                row.appendChild(areaCell);
                
                // Column 6: Area Percentage
                const areaPctCell = document.createElement('td');
                areaPctCell.className = 'text-end';
                const areaPct = totalArea > 0 ? (group.area / totalArea) * 100 : 0;
                areaPctCell.textContent = areaPct.toFixed(2) + '%';
                row.appendChild(areaPctCell);
                
                tableBody.appendChild(row);
            });
            
            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß‡∏£‡∏ß‡∏°
            tableFoot.innerHTML = '';
            const totalRow = document.createElement('tr');
            totalRow.className = 'fw-bold';
            
            const labelCell = document.createElement('td');
            labelCell.colSpan = 2;
            labelCell.textContent = '‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
            totalRow.appendChild(labelCell);
            
            const totalCountCell = document.createElement('td');
            totalCountCell.className = 'text-end';
            totalCountCell.textContent = totalCount.toLocaleString();
            totalRow.appendChild(totalCountCell);
            
            const totalCountPctCell = document.createElement('td');
            totalCountPctCell.className = 'text-end';
            totalCountPctCell.textContent = totalCount > 0 ? '100.00%' : '0.00%';
            totalRow.appendChild(totalCountPctCell);
            
            const totalAreaCell = document.createElement('td');
            totalAreaCell.className = 'text-end';
            totalAreaCell.textContent = totalArea.toLocaleString(undefined, {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            totalRow.appendChild(totalAreaCell);
            
            const totalAreaPctCell = document.createElement('td');
            totalAreaPctCell.className = 'text-end';
            totalAreaPctCell.textContent = totalArea > 0 ? '100.00%' : '0.00%';
            totalRow.appendChild(totalAreaPctCell);
            
            tableFoot.appendChild(totalRow);
            
            // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Å‡∏£‡∏≤‡∏ü
            updateCharts(chartLabels, chartDataCount, chartDataArea, chartColors);
        }

        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Å‡∏£‡∏≤‡∏ü
        function updateCharts(labels, countData, areaData, colors) {
            // ‡∏Å‡∏£‡∏≤‡∏ü‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£
            const countChartCtx = document.getElementById('buildingCountChart').getContext('2d');
            
            if (countChart) {
                countChart.destroy();
            }
            
            countChart = new Chart(countChartCtx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: countData,
                        backgroundColor: colors,
                        borderWidth: 1,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                boxWidth: 15,
                                font: {
                                    size: 11
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: '‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£',
                            font: {
                                size: 16
                            },
                            padding: {
                                top: 10,
                                bottom: 30
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.formattedValue;
                                    const totalValue = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = totalValue > 0 ? (context.raw / totalValue * 100).toFixed(2) : '0.00';
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
            
            // ‡∏Å‡∏£‡∏≤‡∏ü‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£
            const areaChartCtx = document.getElementById('buildingAreaChart').getContext('2d');
            
            if (areaChart) {
                areaChart.destroy();
            }
            
            areaChart = new Chart(areaChartCtx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: areaData,
                        backgroundColor: colors,
                        borderWidth: 1,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                boxWidth: 15,
                                font: {
                                    size: 11
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: '‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£',
                            font: {
                                size: 16
                            },
                            padding: {
                                top: 10,
                                bottom: 30
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = parseFloat(context.raw).toLocaleString(undefined, {
                                        minimumFractionDigits: 2,
                                        maximumFractionDigits: 2
                                    });
                                    const totalValue = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = totalValue > 0 ? (context.raw / totalValue * 100).toFixed(2) : '0.00';
                                    return `${label}: ${value} ‡∏ï‡∏£.‡∏°. (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏à‡∏≥‡πÅ‡∏ô‡∏Å‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡πÅ‡∏•‡∏∞‡∏Ç‡∏ô‡∏≤‡∏î‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£
        function createDetailedTable() {
            if (!selectedLocalOrgField) return;
            
            const tableContainer = document.getElementById('detailedTableContent');
            
            // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°
            tableContainer.innerHTML = '';
            
            // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            const filteredData = processedData.filter(item => {
                const classMatch = selectedClassFilters.includes(item.class);
                const yearMatch = !item.ACQYEAR || selectedYearFilters.includes(item.ACQYEAR ? item.ACQYEAR.toString() : '');
                return classMatch && yearMatch;
            });
            
            // ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏ó‡πâ‡∏≠‡∏á‡∏ñ‡∏¥‡πà‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô
            const uniqueOrgs = [...new Set(filteredData.map(item => item[selectedLocalOrgField]))].filter(Boolean).sort();
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏ó‡πâ‡∏≠‡∏á‡∏ñ‡∏¥‡πà‡∏ô
            uniqueOrgs.forEach(org => {
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏ó‡πâ‡∏≠‡∏á‡∏ñ‡∏¥‡πà‡∏ô
                const orgSection = document.createElement('div');
                orgSection.className = 'org-section';
                
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏ó‡πâ‡∏≠‡∏á‡∏ñ‡∏¥‡πà‡∏ô
                const orgHeader = document.createElement('h4');
                orgHeader.className = 'org-header';
                orgHeader.textContent = org;
                orgSection.appendChild(orgHeader);
                
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á
                const table = document.createElement('table');
                table.className = 'table table-striped table-hover org-table';
                
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á
                const thead = document.createElement('thead');
                const headerRow = document.createElement('tr');
                
                // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô
                const usageHeader = document.createElement('th');
                usageHeader.textContent = '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô';
                usageHeader.className = 'fixed-column header';
                headerRow.appendChild(usageHeader);
                
                // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£
                const typeHeader = document.createElement('th');
                typeHeader.textContent = '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£';
                headerRow.appendChild(typeHeader);
                
                // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏Ç‡∏ô‡∏≤‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£
                Object.keys(sizeDescriptions).forEach(sizeCode => {
                    const sizeHeader = document.createElement('th');
                    sizeHeader.textContent = sizeDescriptions[sizeCode];
                    sizeHeader.className = 'text-center';
                    headerRow.appendChild(sizeHeader);
                });
                
                // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏£‡∏ß‡∏°
                const totalHeader = document.createElement('th');
                totalHeader.textContent = '‡∏£‡∏ß‡∏°';
                totalHeader.className = 'text-center';
                headerRow.appendChild(totalHeader);
                
                thead.appendChild(headerRow);
                table.appendChild(thead);
                
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á tbody
                const tbody = document.createElement('tbody');
                
                // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏ó‡πâ‡∏≠‡∏á‡∏ñ‡∏¥‡πà‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                const orgData = filteredData.filter(item => item[selectedLocalOrgField] === org);
                
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ñ‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô
                const usageClasses = ["10", "20", "30", "41", "42", "43"];
                
                usageClasses.forEach(usageClass => {
                    // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô
                    const usageData = orgData.filter(item => item.class === usageClass);
                    
                    if (usageData.length > 0) {
                        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ñ‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô
                        const usageRow = document.createElement('tr');
                        usageRow.className = 'usage-row';
                        
                        // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô
                        const usageCell = document.createElement('td');
                        usageCell.textContent = detailedClassDescriptions[usageClass];
                        usageCell.className = 'fixed-column';
                        usageRow.appendChild(usageCell);
                        
                        // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ (‡∏ß‡πà‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ñ‡∏ß‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠)
                        const typeCell = document.createElement('td');
                        typeCell.textContent = '';
                        usageRow.appendChild(typeCell);
                        
                        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏Ç‡∏ô‡∏≤‡∏î
                        const sizeCountsForUsage = {};
                        for (let i = 1; i <= 7; i++) {
                            sizeCountsForUsage[i] = usageData.filter(item => item.size === i.toString()).length;
                        }
                        
                        // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏Ç‡∏ô‡∏≤‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£
                        for (let i = 1; i <= 7; i++) {
                            const sizeCell = document.createElement('td');
                            sizeCell.className = 'text-center';
                            sizeCell.textContent = sizeCountsForUsage[i];
                            usageRow.appendChild(sizeCell);
                        }
                        
                        // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏£‡∏ß‡∏°
                        const totalCell = document.createElement('td');
                        totalCell.className = 'text-center fw-bold';
                        totalCell.textContent = usageData.length;
                        usageRow.appendChild(totalCell);
                        
                        tbody.appendChild(usageRow);
                        
                        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ñ‡∏ß‡∏¢‡πà‡∏≠‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£
                        const buildingTypes = ["1", "2", "3", "4", "5", "6", "7", "8"];
                        
                        buildingTypes.forEach(buildingType => {
                            // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£
                            const typeData = usageData.filter(item => {
                                return item.BL_TYPE ? item.BL_TYPE.toString() === buildingType : false;
                            });
                            
                            if (typeData.length > 0) {
                                const typeRow = document.createElement('tr');
                                typeRow.className = 'type-row';
                                
                                // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô (‡∏ß‡πà‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ñ‡∏ß‡∏¢‡πà‡∏≠‡∏¢)
                                const usageCell = document.createElement('td');
                                usageCell.textContent = '';
                                usageCell.className = 'fixed-column';
                                typeRow.appendChild(usageCell);
                                
                                // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£
                                const typeCell = document.createElement('td');
                                typeCell.textContent = buildingTypeDescriptions[buildingType];
                                typeRow.appendChild(typeCell);
                                
                                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏Ç‡∏ô‡∏≤‡∏î
                                const sizeCountsForType = {};
                                for (let i = 1; i <= 7; i++) {
                                    sizeCountsForType[i] = typeData.filter(item => item.size === i.toString()).length;
                                }
                                
                                // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏Ç‡∏ô‡∏≤‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£
                                for (let i = 1; i <= 7; i++) {
                                    const sizeCell = document.createElement('td');
                                    sizeCell.className = 'text-center';
                                    sizeCell.textContent = sizeCountsForType[i];
                                    typeRow.appendChild(sizeCell);
                                }
                                
                                // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏£‡∏ß‡∏°
                                const totalCell = document.createElement('td');
                                totalCell.className = 'text-center';
                                totalCell.textContent = typeData.length;
                                typeRow.appendChild(totalCell);
                                
                                tbody.appendChild(typeRow);
                            }
                        });
                    }
                });
                
                table.appendChild(tbody);
                orgSection.appendChild(table);
                tableContainer.appendChild(orgSection);
            });
            
            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏ï‡πá‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
            document.getElementById('fullscreenBtn').onclick = toggleFullscreen;
        }
        
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏ï‡πá‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
        function toggleFullscreen() {
            const tableContainer = document.getElementById('detailedTableContainer');
            tableContainer.classList.toggle('fullscreen');
            
            // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏∏‡πà‡∏°
            const btn = document.getElementById('fullscreenBtn');
            if (tableContainer.classList.contains('fullscreen')) {
                btn.innerHTML = '<i class="bi bi-fullscreen-exit"></i> ‡∏¢‡πà‡∏≠‡∏Ç‡∏ô‡∏≤‡∏î';
                
                // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏ï‡πá‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
                if (!document.querySelector('.exit-fullscreen-btn')) {
                    const exitBtn = document.createElement('button');
                    exitBtn.className = 'btn btn-sm btn-danger exit-fullscreen-btn';
                    exitBtn.innerHTML = '<i class="bi bi-x-lg"></i>';
                    exitBtn.onclick = toggleFullscreen;
                    tableContainer.appendChild(exitBtn);
                }
            } else {
                btn.innerHTML = '<i class="bi bi-arrows-fullscreen"></i> ‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏ï‡πá‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠';
                
                // ‡∏•‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏ï‡πá‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
                const exitBtn = document.querySelector('.exit-fullscreen-btn');
                if (exitBtn) {
                    exitBtn.remove();
                }
            }
        }

        // ‡∏ô‡∏≥‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        function exportFullData() {
            if (processedData.length === 0) {
                alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ô‡∏≥‡∏≠‡∏≠‡∏Å');
                return;
            }
            
            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ class ‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å
            const dataWithDescription = processedData.map(item => {
                const newItem = {...item};
                // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏¥‡∏•‡∏î‡πå class_desc ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£
                newItem.class_desc = classDescriptions[item.class] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                return newItem;
            });
            
            const ws = XLSX.utils.json_to_sheet(dataWithDescription);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£");
            XLSX.writeFile(wb, "building_reclass_data.xlsx");
        }

        // ‡∏ô‡∏≥‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ
        function exportSummary() {
            if (processedData.length === 0) {
                alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ô‡∏≥‡∏≠‡∏≠‡∏Å');
                return;
            }
            
            // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            const filteredData = processedData.filter(item => {
                const classMatch = selectedClassFilters.includes(item.class);
                const yearMatch = !item.ACQYEAR || selectedYearFilters.includes(item.ACQYEAR ? item.ACQYEAR.toString() : '');
                return classMatch && yearMatch;
            });
            
            // ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏° class
            const groupedData = {};
            filteredData.forEach(item => {
                if (!groupedData[item.class]) {
                    groupedData[item.class] = {
                        count: 0,
                        area: 0
                    };
                }
                
                groupedData[item.class].count += 1;
                groupedData[item.class].area += parseFloat(item.BL_AREA) || 0;
            });
            
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ú‡∏•‡∏£‡∏ß‡∏°
            const totalCount = Object.values(groupedData).reduce((sum, group) => sum + group.count, 0);
            const totalArea = Object.values(groupedData).reduce((sum, group) => sum + group.area, 0);
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ô‡∏≥‡∏≠‡∏≠‡∏Å
            const exportData = [];
            
            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏≤‡∏° class
            const sortedClasses = Object.keys(groupedData).sort();
            
            sortedClasses.forEach(classCode => {
                const group = groupedData[classCode];
                const countPct = totalCount > 0 ? (group.count / totalCount) * 100 : 0;
                const areaPct = totalArea > 0 ? (group.area / totalArea) * 100 : 0;
                
                exportData.push({
                    'code': classCode,
                    '‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£': classDescriptions[classCode] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
                    '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡∏´‡∏•‡∏±‡∏á)': group.count,
                    '‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô': countPct.toFixed(2) + '%',
                    '‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏ß‡∏° (‡∏ï‡∏£.‡∏°.)': Number(group.area.toFixed(2)),  // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô Number ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Excel ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
                    '‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà': areaPct.toFixed(2) + '%'
                });
            });
            
            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß‡∏£‡∏ß‡∏°
            exportData.push({
                'code': '‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î',
                '‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£': '',
                '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡∏´‡∏•‡∏±‡∏á)': totalCount,
                '‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô': totalCount > 0 ? '100.00%' : '0.00%',
                '‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏ß‡∏° (‡∏ï‡∏£.‡∏°.)': Number(totalArea.toFixed(2)),  // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô Number ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Excel ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
                '‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà': totalArea > 0 ? '100.00%' : '0.00%'
            });
            
            const ws = XLSX.utils.json_to_sheet(exportData);
            
            // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå "‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏ß‡∏° (‡∏ï‡∏£.‡∏°.)" ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏° 2 ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
            if(!ws['!cols']) ws['!cols'] = [];
            ws['!cols'][4] = { wch: 15, numFmt: '0.00' };  // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå E (index 4) ‡∏Ñ‡∏∑‡∏≠ "‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏ß‡∏° (‡∏ï‡∏£.‡∏°.)"
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£");
            XLSX.writeFile(wb, "building_usage_summary.xlsx");
        }

        // ‡∏ô‡∏≥‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏à‡∏≥‡πÅ‡∏ô‡∏Å
        function exportDetailedSummary() {
            if (!selectedLocalOrgField) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏ó‡πâ‡∏≠‡∏á‡∏ñ‡∏¥‡πà‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏≥‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
                return;
            }
            
            if (processedData.length === 0) {
                alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ô‡∏≥‡∏≠‡∏≠‡∏Å');
                return;
            }
            
            // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            const filteredData = processedData.filter(item => {
                const classMatch = selectedClassFilters.includes(item.class);
                const yearMatch = !item.ACQYEAR || selectedYearFilters.includes(item.ACQYEAR ? item.ACQYEAR.toString() : '');
                return classMatch && yearMatch;
            });
            
            // ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏ó‡πâ‡∏≠‡∏á‡∏ñ‡∏¥‡πà‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô
            const uniqueOrgs = [...new Set(filteredData.map(item => item[selectedLocalOrgField]))].filter(Boolean).sort();
            
            // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Excel
            const detailedData = [];
            
            // ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô
            const usageClasses = ["10", "20", "30", "41", "42", "43"];
            // ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£
            const buildingTypes = ["1", "2", "3", "4", "5", "6", "7", "8"];
            
            uniqueOrgs.forEach(org => {
                // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏ó‡πâ‡∏≠‡∏á‡∏ñ‡∏¥‡πà‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                const orgData = filteredData.filter(item => item[selectedLocalOrgField] === org);
                
                usageClasses.forEach(usageClass => {
                    // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô
                    const usageData = orgData.filter(item => item.class === usageClass);
                    
                    if (usageData.length > 0) {
                        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ñ‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô
                        const usageRow = {
                            '‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏ó‡πâ‡∏≠‡∏á‡∏ñ‡∏¥‡πà‡∏ô': org,
                            '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô': detailedClassDescriptions[usageClass],
                            '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£': '',
                        };
                        
                        // ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏Ç‡∏ô‡∏≤‡∏î
                        for (let i = 1; i <= 7; i++) {
                            usageRow[sizeDescriptions[i]] = usageData.filter(item => item.size === i.toString()).length;
                        }
                        
                        // ‡∏£‡∏ß‡∏°
                        usageRow['‡∏£‡∏ß‡∏°'] = usageData.length;
                        
                        detailedData.push(usageRow);
                        
                        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ñ‡∏ß‡∏¢‡πà‡∏≠‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£
                        buildingTypes.forEach(buildingType => {
                            // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£
                            const typeData = usageData.filter(item => {
                                return item.BL_TYPE ? item.BL_TYPE.toString() === buildingType : false;
                            });
                            
                            if (typeData.length > 0) {
                                const typeRow = {
                                    '‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏ó‡πâ‡∏≠‡∏á‡∏ñ‡∏¥‡πà‡∏ô': '',
                                    '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô': '',
                                    '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£': buildingTypeDescriptions[buildingType],
                                };
                                
                                // ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏Ç‡∏ô‡∏≤‡∏î
                                for (let i = 1; i <= 7; i++) {
                                    typeRow[sizeDescriptions[i]] = typeData.filter(item => item.size === i.toString()).length;
                                }
                                
                                // ‡∏£‡∏ß‡∏°
                                typeRow['‡∏£‡∏ß‡∏°'] = typeData.length;
                                
                                detailedData.push(typeRow);
                            }
                        });
                    }
                });
            });
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á Excel
            const ws = XLSX.utils.json_to_sheet(detailedData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏à‡∏≥‡πÅ‡∏ô‡∏Å‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£");
            XLSX.writeFile(wb, "building_usage_detailed.xlsx");
        }

        // ==================== ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Shapefile ====================
        
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö UTM Zone ‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå .prj
        function detectUTMZone(prjContent) {
            if (prjContent.includes('UTM_Zone_47N') || prjContent.includes('UTM Zone 47N') ||
                prjContent.includes('WGS_1984_UTM_Zone_47N') || prjContent.includes('EPSG:32647')) {
                return '47N';
            }
            if (prjContent.includes('UTM_Zone_48N') || prjContent.includes('UTM Zone 48N') ||
                prjContent.includes('WGS_1984_UTM_Zone_48N') || prjContent.includes('EPSG:32648')) {
                return '48N';
            }
            return null;
        }

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå .prj (Projection) - ‡πÉ‡∏ä‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö
        function createPrjFile() {
            if (detectedUTMZone === '48N') {
                return 'PROJCS["WGS_1984_UTM_Zone_48N",GEOGCS["GCS_WGS_1984",DATUM["D_WGS_1984",SPHEROID["WGS_1984",6378137.0,298.257223563]],PRIMEM["Greenwich",0.0],UNIT["Degree",0.0174532925199433]],PROJECTION["Transverse_Mercator"],PARAMETER["False_Easting",500000.0],PARAMETER["False_Northing",0.0],PARAMETER["Central_Meridian",105.0],PARAMETER["Scale_Factor",0.9996],PARAMETER["Latitude_Of_Origin",0.0],UNIT["Meter",1.0]]';
            }
            return 'PROJCS["WGS_1984_UTM_Zone_47N",GEOGCS["GCS_WGS_1984",DATUM["D_WGS_1984",SPHEROID["WGS_1984",6378137.0,298.257223563]],PRIMEM["Greenwich",0.0],UNIT["Degree",0.0174532925199433]],PROJECTION["Transverse_Mercator"],PARAMETER["False_Easting",500000.0],PARAMETER["False_Northing",0.0],PARAMETER["Central_Meridian",99.0],PARAMETER["Scale_Factor",0.9996],PARAMETER["Latitude_Of_Origin",0.0],UNIT["Meter",1.0]]';
        }

        // ‡πÅ‡∏õ‡∏•‡∏á string ‡πÄ‡∏õ‡πá‡∏ô TIS-620 bytes
        function encodeToTIS620(str, length) {
            const bytes = new Uint8Array(length);
            bytes.fill(0x20);
            let byteIndex = 0;
            for (let i = 0; i < str.length && byteIndex < length; i++) {
                const code = str.charCodeAt(i);
                if (code <= 0x7F) bytes[byteIndex++] = code;
                else if (code >= 0x0E01 && code <= 0x0E5B) bytes[byteIndex++] = code - 0x0E01 + 0xA1;
                else if (code === 0x0E3F) bytes[byteIndex++] = 0xDF;
                else if (code === 0x00A0) bytes[byteIndex++] = 0xA0;
                else if (code < 0x100) bytes[byteIndex++] = code;
                else bytes[byteIndex++] = 0x3F;
            }
            return bytes;
        }

        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì bounding box
        function calculateBoundingBox(geoJSON) {
            let xmin = Infinity, ymin = Infinity, xmax = -Infinity, ymax = -Infinity;
            geoJSON.features.forEach(feature => {
                if (!feature.geometry?.coordinates) return;
                const processCoord = (coord) => {
                    if (Array.isArray(coord[0])) coord.forEach(processCoord);
                    else {
                        xmin = Math.min(xmin, coord[0]); ymin = Math.min(ymin, coord[1]);
                        xmax = Math.max(xmax, coord[0]); ymax = Math.max(ymax, coord[1]);
                    }
                };
                processCoord(feature.geometry.coordinates);
            });
            return { xmin, ymin, xmax, ymax };
        }

        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì geometry bounding box
        function calculateGeometryBbox(coords) {
            let xmin = Infinity, ymin = Infinity, xmax = -Infinity, ymax = -Infinity;
            const processCoord = (coord) => {
                if (Array.isArray(coord[0])) coord.forEach(processCoord);
                else {
                    xmin = Math.min(xmin, coord[0]); ymin = Math.min(ymin, coord[1]);
                    xmax = Math.max(xmax, coord[0]); ymax = Math.max(ymax, coord[1]);
                }
            };
            coords.forEach(processCoord);
            return { xmin, ymin, xmax, ymax };
        }

        // ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Shapefile
        async function exportToShapefile() {
            if (!geoJSONData || processedData.length === 0) {
                alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Shapefile ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Shapefile ‡∏Å‡πà‡∏≠‡∏ô');
                return;
            }
            
            if (!originalShpFile || !originalShxFile) {
                alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Shapefile ‡πÉ‡∏´‡∏°‡πà');
                return;
            }
            
            try {
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á ZIP file
                const zip = new JSZip();
                const name = 'building_reclass';
                
                // ‡πÉ‡∏ä‡πâ‡πÑ‡∏ü‡∏•‡πå‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö .shp ‡πÅ‡∏•‡∏∞ .shx
                zip.file(name + '.shp', originalShpFile);
                zip.file(name + '.shx', originalShxFile);
                
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå .dbf ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÅ‡∏•‡πâ‡∏ß
                // ‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡∏Å‡∏±‡∏ö‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• (JOIN)
                const updatedFeatures = processedData.map(item => {
                    const props = {...item};
                    delete props.geometry; // ‡∏•‡∏ö geometry ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å properties
                    
                    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏¥‡∏•‡∏î‡πå class_desc
                    props.class_desc = classDescriptions[item.class] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                    
                    return props;
                });
                
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á GeoJSON structure ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á .dbf
                const geoJSONForDbf = {
                    type: "FeatureCollection",
                    features: updatedFeatures.map((props, index) => ({
                        type: "Feature",
                        properties: props,
                        geometry: geoJSONData.features[index]?.geometry || null
                    }))
                };
                
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå .dbf ‡πÉ‡∏´‡∏°‡πà‡∏î‡πâ‡∏ß‡∏¢ TIS-620 encoding
                const dbfBuffer = createDbfFile(geoJSONForDbf);
                zip.file(name + '.dbf', dbfBuffer);
                
                // ‡πÉ‡∏ä‡πâ‡πÑ‡∏ü‡∏•‡πå .prj ‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
                if (originalPrjFile) {
                    zip.file(name + '.prj', originalPrjFile);
                } else {
                    zip.file(name + '.prj', createPrjFile());
                }
                
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå .cpg ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏∏ encoding ‡πÄ‡∏õ‡πá‡∏ô TIS-620
                zip.file(name + '.cpg', 'TIS-620');
                
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå ZIP ‡πÅ‡∏•‡∏∞‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
                const blob = await zip.generateAsync({type: 'blob'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = name + '.zip';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                alert('‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Shapefile ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
            } catch (error) {
                console.error('Error exporting Shapefile:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
        }

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå .shp
        function createShpFile(geoJSON) {
            const features = geoJSON.features;
            const bbox = calculateBoundingBox(geoJSON);
            let totalSize = 100; // Header size
            const records = [];
            
            features.forEach((feature, index) => {
                const geom = feature.geometry;
                if (!geom?.coordinates) return;
                
                let parts = [];
                let points = [];
                
                if (geom.type === 'Polygon') {
                    parts = [0];
                    geom.coordinates[0].forEach(c => points.push({ x: c[0], y: c[1] }));
                } else if (geom.type === 'MultiPolygon') {
                    let offset = 0;
                    geom.coordinates.forEach(poly => {
                        parts.push(offset);
                        poly[0].forEach(c => { 
                            points.push({ x: c[0], y: c[1] }); 
                            offset++; 
                        });
                    });
                }
                
                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ç‡∏ô‡∏≤‡∏î record
                // Record Header (8 bytes) + Shape Type (4) + Box (32) + NumParts (4) + NumPoints (4) + Parts Array + Points Array
                const recordContentSize = 4 + 32 + 4 + 4 + (parts.length * 4) + (points.length * 16);
                const recordSize = 8 + recordContentSize; // ‡πÄ‡∏û‡∏¥‡πà‡∏° header 8 bytes
                
                records.push({
                    recordNumber: index + 1,
                    contentLength: recordContentSize / 2, // ‡πÉ‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢ 16-bit words
                    shapeType: 5,
                    bbox: calculateGeometryBbox(geom.coordinates),
                    parts: parts,
                    points: points
                });
                
                totalSize += recordSize;
            });
            
            const buffer = new ArrayBuffer(totalSize);
            const view = new DataView(buffer);
            
            // Write Header (100 bytes)
            view.setInt32(0, 9994, false); // File Code (big-endian)
            // Bytes 4-20 are unused (set to 0)
            view.setInt32(24, totalSize / 2, false); // File Length in 16-bit words (big-endian)
            view.setInt32(28, 1000, true); // Version (little-endian)
            view.setInt32(32, 5, true); // Shape Type = Polygon (little-endian)
            view.setFloat64(36, bbox.xmin, true); // Xmin
            view.setFloat64(44, bbox.ymin, true); // Ymin
            view.setFloat64(52, bbox.xmax, true); // Xmax
            view.setFloat64(60, bbox.ymax, true); // Ymax
            // Bytes 68-99 are Z and M ranges (set to 0)
            
            // Write Records
            let offset = 100;
            records.forEach(record => {
                // Record Header
                view.setInt32(offset, record.recordNumber, false); // Record number (big-endian)
                view.setInt32(offset + 4, record.contentLength, false); // Content length (big-endian)
                offset += 8;
                
                // Record Content
                view.setInt32(offset, record.shapeType, true); // Shape Type
                offset += 4;
                
                // Bounding Box
                view.setFloat64(offset, record.bbox.xmin, true);
                view.setFloat64(offset + 8, record.bbox.ymin, true);
                view.setFloat64(offset + 16, record.bbox.xmax, true);
                view.setFloat64(offset + 24, record.bbox.ymax, true);
                offset += 32;
                
                // NumParts and NumPoints
                view.setInt32(offset, record.parts.length, true);
                view.setInt32(offset + 4, record.points.length, true);
                offset += 8;
                
                // Parts Array
                record.parts.forEach(part => {
                    view.setInt32(offset, part, true);
                    offset += 4;
                });
                
                // Points Array
                record.points.forEach(point => {
                    view.setFloat64(offset, point.x, true);
                    view.setFloat64(offset + 8, point.y, true);
                    offset += 16;
                });
            });
            
            return buffer;
        }

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå .shx
        function createShxFile(geoJSON) {
            const features = geoJSON.features;
            const bbox = calculateBoundingBox(geoJSON);
            
            const headerSize = 100;
            const recordSize = 8; // Each index record is 8 bytes (offset + content length)
            const totalSize = headerSize + (features.length * recordSize);
            
            const buffer = new ArrayBuffer(totalSize);
            const view = new DataView(buffer);
            
            // Write Header (same structure as .shp)
            view.setInt32(0, 9994, false); // File Code
            view.setInt32(24, totalSize / 2, false); // File Length in 16-bit words
            view.setInt32(28, 1000, true); // Version
            view.setInt32(32, 5, true); // Shape Type = Polygon
            view.setFloat64(36, bbox.xmin, true);
            view.setFloat64(44, bbox.ymin, true);
            view.setFloat64(52, bbox.xmax, true);
            view.setFloat64(60, bbox.ymax, true);
            
            // Write Index Records
            let indexOffset = 100; // Start of index records
            let shpOffset = 50; // Start after .shp header (in 16-bit words)
            
            features.forEach(feature => {
                const geom = feature.geometry;
                if (!geom?.coordinates) return;
                
                let points = [];
                let parts = [];
                
                if (geom.type === 'Polygon') {
                    parts = [0];
                    geom.coordinates[0].forEach(c => points.push({ x: c[0], y: c[1] }));
                } else if (geom.type === 'MultiPolygon') {
                    let offset = 0;
                    geom.coordinates.forEach(poly => {
                        parts.push(offset);
                        poly[0].forEach(c => { 
                            points.push({ x: c[0], y: c[1] }); 
                            offset++; 
                        });
                    });
                }
                
                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì content length (‡πÉ‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢ 16-bit words)
                // Shape Type (4) + Box (32) + NumParts (4) + NumPoints (4) + Parts + Points
                const contentLength = (4 + 32 + 4 + 4 + (parts.length * 4) + (points.length * 16)) / 2;
                
                // Write offset and content length (both in 16-bit words, big-endian)
                view.setInt32(indexOffset, shpOffset, false);
                view.setInt32(indexOffset + 4, contentLength, false);
                
                indexOffset += 8;
                shpOffset += 4 + contentLength; // Record header (4 words) + content
            });
            
            return buffer;
        }

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå .dbf
        function createDbfFile(geoJSON) {
            const features = geoJSON.features;
            const numRecords = features.length;
            
            if (numRecords === 0) {
                throw new Error('No features to export');
            }
            
            // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Field Definitions
            const properties = features[0].properties ? Object.keys(features[0].properties) : [];
            const fieldDefinitions = [
                { name: 'FID', type: 'N', length: 10, decimal: 0 }
            ];
            
            properties.forEach(prop => {
                let fieldType = 'C';
                let fieldLength = 254;
                let decimal = 0;
                
                const sampleValue = features[0].properties[prop];
                
                if (typeof sampleValue === 'number') {
                    if (Number.isInteger(sampleValue)) {
                        fieldType = 'N';
                        fieldLength = 18;
                        decimal = 0;
                    } else {
                        fieldType = 'F';
                        fieldLength = 20;
                        decimal = 8;
                    }
                } else if (sampleValue instanceof Date) {
                    fieldType = 'D';
                    fieldLength = 8;
                    decimal = 0;
                }
                
                fieldDefinitions.push({
                    name: prop.substring(0, 10), // DBF field names limited to 10 chars
                    type: fieldType,
                    length: fieldLength,
                    decimal: decimal
                });
            });
            
            const headerSize = 32 + (fieldDefinitions.length * 32) + 1; // Header + fields + terminator
            const recordLength = fieldDefinitions.reduce((sum, field) => sum + field.length, 1); // 1 for deletion flag
            const totalSize = headerSize + (numRecords * recordLength) + 1; // +1 for EOF marker
            
            const buffer = new ArrayBuffer(totalSize);
            const view = new DataView(buffer);
            const uint8View = new Uint8Array(buffer);
            
            // Write Header
            view.setUint8(0, 0x03); // Version (dBASE Level 5)
            
            const now = new Date();
            view.setUint8(1, now.getFullYear() - 1900);
            view.setUint8(2, now.getMonth() + 1);
            view.setUint8(3, now.getDate());
            
            view.setUint32(4, numRecords, true); // Number of records
            view.setUint16(8, headerSize, true); // Header size
            view.setUint16(10, recordLength, true); // Record size
            
            // Bytes 12-31 are reserved (set to 0)
            
            // Write Field Descriptors
            let fieldOffset = 32;
            fieldDefinitions.forEach(field => {
                // Field name (11 bytes, null-terminated)
                for (let i = 0; i < field.name.length && i < 10; i++) {
                    uint8View[fieldOffset + i] = field.name.charCodeAt(i);
                }
                for (let i = field.name.length; i < 11; i++) {
                    uint8View[fieldOffset + i] = 0x00;
                }
                
                // Field type
                uint8View[fieldOffset + 11] = field.type.charCodeAt(0);
                
                // Field data address (not used in modern dBASE, set to 0)
                view.setUint32(fieldOffset + 12, 0, true);
                
                // Field length
                view.setUint8(fieldOffset + 16, field.length);
                
                // Decimal count
                view.setUint8(fieldOffset + 17, field.decimal);
                
                // Remaining bytes 18-31 are reserved (set to 0)
                
                fieldOffset += 32;
            });
            
            // Field descriptor terminator
            uint8View[fieldOffset] = 0x0D;
            
            // Write Records
            let recordOffset = headerSize;
            
            features.forEach((feature, index) => {
                // Deletion flag (0x20 = not deleted, 0x2A = deleted)
                uint8View[recordOffset] = 0x20;
                recordOffset++;
                
                fieldDefinitions.forEach((field, fieldIndex) => {
                    let value = '';
                    
                    if (fieldIndex === 0) {
                        // FID field
                        value = (index + 1).toString();
                    } else {
                        // Property field
                        const propName = properties[fieldIndex - 1];
                        const propValue = feature.properties?.[propName];
                        
                        if (propValue !== undefined && propValue !== null) {
                            if (field.type === 'D' && propValue instanceof Date) {
                                const year = propValue.getFullYear().toString().padStart(4, '0');
                                const month = (propValue.getMonth() + 1).toString().padStart(2, '0');
                                const day = propValue.getDate().toString().padStart(2, '0');
                                value = year + month + day;
                            } else if (field.type === 'N' || field.type === 'F') {
                                const numValue = typeof propValue === 'number' ? propValue : parseFloat(propValue);
                                if (!isNaN(numValue)) {
                                    if (field.decimal > 0) {
                                        value = numValue.toFixed(field.decimal);
                                    } else {
                                        value = Math.round(numValue).toString();
                                    }
                                } else {
                                    value = '';
                                }
                            } else {
                                value = propValue.toString();
                            }
                        }
                    }
                    
                    // Trim or pad value to field length
                    if (field.type === 'N' || field.type === 'F') {
                        // Numeric fields are right-aligned
                        value = value.substring(0, field.length).padStart(field.length, ' ');
                    } else {
                        // Character fields are left-aligned
                        value = value.substring(0, field.length).padEnd(field.length, ' ');
                    }
                    
                    // Write field value with TIS-620 encoding
                    const encodedBytes = encodeToTIS620(value, field.length);
                    for (let i = 0; i < field.length; i++) {
                        uint8View[recordOffset + i] = encodedBytes[i];
                    }
                    
                    recordOffset += field.length;
                });
            });
            
            // End of file marker
            uint8View[totalSize - 1] = 0x1A;
            
            return buffer;
        }
    </script>
        <script>
    const menuBtn = document.getElementById('mobileMenuBtn');
    const nav = document.getElementById('mainNav');

    menuBtn.addEventListener('click', () => {
        menuBtn.classList.toggle('active');
        nav.classList.toggle('active');
    });

    function toggleMobileDropdown(element) {
        if (window.innerWidth <= 1200) {
            element.classList.toggle('active');
        }
    }
    
    // ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á
    document.addEventListener('click', (e) => {
        if (!nav.contains(e.target) && !menuBtn.contains(e.target) && nav.classList.contains('active')) {
            nav.classList.remove('active');
            menuBtn.classList.remove('active');
        }
    });
</script>
</body>
</html>
