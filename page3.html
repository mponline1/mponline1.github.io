<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculate Landuse</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0;
            padding: 0;
            min-height: 100vh;
            background-color: rgb(249, 250, 251);
        }
        table { 
            border-collapse: collapse; 
            width: 100%; 
        }
        th, td { 
            border: 1px solid #ddd; 
            padding: 8px; 
            text-align: left; 
        }
        tr:nth-child(even) { 
            background-color: #f2f2f2; 
        }
        .filter-container { 
            margin-bottom: 20px; 
            padding: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 0.375rem;
            background-color: #f9fafb;
        }
        .filter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            cursor: pointer;
        }
        .checkbox-group { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 10px; 
        }
        .pluse-filter-group {
            margin-top: 10px;
            padding: 8px;
            border: 1px solid #e5e7eb;
            border-radius: 0.25rem;
            background-color: #ffffff;
        }
        .pluse-filter-header {
            font-weight: 600;
            color: #1e40af;
            margin-bottom: 5px;
        }
        .total-row { 
            background-color: #e6f2ff; 
            font-weight: bold; 
        }
        .main-container {
            padding: 1rem;
            min-height: 100vh;
            width: 100%;
        }
        .content-wrapper {
            width: 100%;
        }
        .header-button {
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 500;
            transition: all 0.2s;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 120px;
            white-space: nowrap;
            cursor: pointer;
            border: none;
        }
        .header-button.primary {
            background-color: #1e40af;
            color: white;
        }
        .header-button.primary:hover {
            background-color: #1e3a8a;
        }
        .header-button.home {
            background-color: #1e40af;
            color: white;
            min-width: 40px;
            padding: 8px;
        }
        .header-button.home:hover {
            background-color: #1e3a8a;
        }
        .header-buttons-container {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-left: auto;
            padding: 4px;
        }
        
        input[type="file"] {
            border: 1px solid #e2e8f0;
            padding: 0.5rem;
            border-radius: 0.375rem;
            width: 100%;
            background-color: white;
        }
        input[type="file"]:hover {
            border-color: #cbd5e0;
        }
        select {
            border: 1px solid #e2e8f0;
            padding: 0.5rem;
            border-radius: 0.375rem;
            width: 100%;
            max-width: 20rem;
            background-color: white;
        }
        .action-button {
            padding: 8px 16px;
            background-color: #1e40af;
            color: white;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: background-color 0.2s;
        }
        .action-button:hover {
            background-color: #1e3a8a;
        }
        
        @media (max-width: 768px) {
            .header-container {
                flex-direction: column;
                align-items: flex-start;
                gap: 16px;
            }
            .header-buttons-container {
                width: 100%;
                justify-content: flex-start;
                margin-left: 0;
            }
            .grid-cols-2 {
                grid-template-columns: 1fr;
            }
        }
        
        .toggle-icon {
            transition: transform 0.3s ease;
        }
        
        .collapsed .toggle-icon {
            transform: rotate(-90deg);
        }
        
        .filter-content {
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            max-height: 1000px;
            opacity: 1;
            overflow: hidden;
        }
        
        .collapsed .filter-content {
            max-height: 0;
            opacity: 0;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="content-wrapper">
            <!-- Header Section -->
            <div class="header-container flex justify-between items-center mb-6">
                <div class="flex items-center gap-2">
                    <h1 class="text-2xl font-bold text-blue-700">Calculate Landuse</h1>
                    <h2 class="text-lg text-gray-600">คำนวณพื้นที่การใช้ประโยชน์ที่ดิน</h2>
                </div>
                <div class="header-buttons-container">
                    <button onclick="window.location.href='page2.html'" class="header-button primary">
                        Reclass BLDG
                    </button>
                    <button onclick="window.location.href='page5.html'" class="header-button primary">
                        PREP PLLU
                    </button>
                    <button onclick="window.location.href='index.html'" class="header-button home" aria-label="Home">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5">
                            <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                            <polyline points="9 22 9 12 15 12 15 22"/>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Manual Link -->
            <div class="flex items-center gap-2 mb-6">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-700">
                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
                </svg>
                <a href="page.html" class="text-blue-700 hover:underline">
                    คู่มือการใช้งาน
                </a>
            </div>

            <!-- Main Content Card -->
            <div class="bg-white shadow p-6 mb-6">
                <!-- File Upload Section -->
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium mb-2">ไฟล์อาคาร (Excel):</label>
                        <input type="file" id="buildingFile" accept=".xlsx, .xls">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">ไฟล์ pllu (Excel):</label>
                        <input type="file" id="plluFile" accept=".xlsx, .xls">
                    </div>
                </div>

                <!-- Info Text -->
                <div class="mb-6 text-sm text-gray-600">
                    ไฟล์อาคารที่นำมาใช้ต้องเป็นไฟล์อาคารจากฟังก์ชัน Reclass BLDG <br>
                    กรณีต้องการเรียงรายการตามบริเวณ/ประเภทการใช้ประโยชน์ที่ดิน ให้คลิกปุ่ม PREP PLLU แล้วนำผลลัพธ์ที่ได้มาใส่ในช่อง upload ไฟล์ pllu 
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-4 mb-6">
                    <button onclick="processFiles()" class="action-button">
                        Calculate
                    </button>
                    <button onclick="exportToExcel()" class="action-button">
                        นำออกไฟล์ผลการใช้ประโยชน์ที่ดิน (Excel)
                    </button>
                </div>

                <!-- Filter Section -->
                <div class="grid gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">กรองตาม PL_USE:</label>
                        <select id="pl-use-filter">
                            <option value="all">ทั้งหมด</option>
                        </select>
                    </div>
                    
                    <!-- Collapsible RE_BL_USE Filter Section -->
                    <div class="filter-container" id="re-bl-use-container">
                        <div class="filter-header" onclick="toggleFilterSection(this)">
                            <label class="block text-sm font-medium">กรองตาม RE_BL_USE:</label>
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" 
                                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" 
                                class="toggle-icon">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        </div>
                        <div class="filter-content">
                            <div id="re-bl-use-filters-container">
                                <!-- RE_BL_USE filters will be dynamically inserted here for each PL_USE -->
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2">กรองตาม ACQYEAR:</label>
                        <div id="acqyear-filter" class="checkbox-group"></div>
                    </div>
                </div>
            </div>

            <!-- Table Container -->
            <div id="tableContainer" class="bg-white shadow w-full"></div>
        </div>
    </div>

    <script>
    let buildingData, plluData;
    
    // ข้อมูลการแปลงรหัสเป็นข้อความอธิบาย
    const reBLUseLabelMap = {
        "10_1": "พักอาศัย บ้านเดี่ยว บ้านแฝด",
        "10_2": "พักอาศัย บ้านแถว ห้องแถว ตึกแถว",
        "10_3": "พักอาศัย อาคารพักอาศัยรวม",
        "10_4": "พักอาศัย อาคารขนาดใหญ่และสูง (พื้นที่คลุมดิน 101 - 400 ตร.ม.)",
        "10_5": "พักอาศัย อาคารขนาดใหญ่และสูง (พื้นที่คลุมดิน 401 ตร.ม. ขึ้นไป)",
        "20_1": "พาณิชย์ อาคารทั่วไป",
        "20_2": "พาณิชย์ อาคารขนาดใหญ่และสูง (พื้นที่คลุมดิน 101 - 400 ตร.ม.)",
        "20_3": "พาณิชย์ อาคารขนาดใหญ่และสูง (พื้นที่คลุมดิน 401 ตร.ม. ขึ้นไป)",
        "41_1": "พักอาศัยกึ่งพาณิชย์ อาคารทั่วไป",
        "41_2": "พักอาศัยกึ่งพาณิชย์ อาคารขนาดใหญ่และสูง (พื้นที่คลุมดิน 101 - 400 ตร.ม.)",
        "41_3": "พักอาศัยกึ่งพาณิชย์ อาคารขนาดใหญ่และสูง (พื้นที่คลุมดิน 401 ตร.ม. ขึ้นไป)",
        "30_1": "อุตสาหกรรม (พื้นที่คลุมดินไม่เกิน 200 ตร.ม.)",
        "30_2": "อุตสาหกรรม (พื้นที่คลุมดิน 201 - 500 ตร.ม.)",
        "30_3": "อุตสาหกรรม (พื้นที่คลุมดิน 501 - 1,000 ตร.ม.)",
        "30_4": "อุตสาหกรรม (พื้นที่คลุมดิน 1,001 ตร.ม. ขึ้นไป)",
        "33_1": "คลังสินค้า (พื้นที่คลุมดินไม่เกิน 100 ตร.ม.)",
        "33_2": "คลังสินค้า (พื้นที่คลุมดิน 101 - 500 ตร.ม.)",
        "33_3": "คลังสินค้า (พื้นที่คลุมดิน 501 ตร.ม. ขึ้นไป)",
        "80_1": "เกษตรกรรม (พักอาศัย คอกปศุสัตว์ ฟาร์ม ยุ้งฉาง)",
        "90_1": "อื่นๆ"
    };

    // ฟังก์ชันสำหรับการซ่อน/แสดงส่วนฟิลเตอร์
    function toggleFilterSection(element) {
        const parent = element.closest('.filter-container');
        parent.classList.toggle('collapsed');
    }

    function processFiles() {
        const buildingFile = document.getElementById('buildingFile').files[0];
        const plluFile = document.getElementById('plluFile').files[0];
        
        if (!buildingFile || !plluFile) {
            alert('กรุณาเลือกไฟล์ทั้งสองไฟล์');
            return;
        }
        
        const reader1 = new FileReader();
        reader1.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            buildingData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
            
            // Normalize building data
            buildingData = buildingData.map(item => ({
                ...item,
                BL_TYPE: String(item.BL_TYPE || ''),
                BL_USE: String(item.BL_USE || ''),
                ACQYEAR: String(item.ACQYEAR || ''),
                PL_BLOCK: String(item.PL_BLOCK || ''),
                RE_BL_USE: parseFloat(item.RE_BL_USE) || 0,
                RE_BL_AREA: parseFloat(item.RE_BL_AREA) || 0,
                BL_AREA: parseFloat(item.BL_AREA) || 0
            }));
            
            const reader2 = new FileReader();
            reader2.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                plluData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                
                // Normalize pllu data
                plluData = plluData.map(item => ({
                    ...item,
                    PL_BLOCK: String(item.PL_BLOCK || ''),
                    PL_USE: String(item.PL_USE || ''),
                    AREA: parseFloat(item.AREA) || 0
                }));
                
                setupFilters();
                calculateAndDisplayTable();
            };
            reader2.readAsArrayBuffer(plluFile);
        };
        reader1.readAsArrayBuffer(buildingFile);
    }

    function setupFilters() {
        const plUseFilter = document.getElementById('pl-use-filter');
        const reBlUseFiltersContainer = document.getElementById('re-bl-use-filters-container');
        const acqyearFilter = document.getElementById('acqyear-filter');
        
        // Clear existing options
        plUseFilter.innerHTML = '<option value="all">ทั้งหมด</option>';
        reBlUseFiltersContainer.innerHTML = '';
        acqyearFilter.innerHTML = '';
        
        // Setup PL_USE filter with text values
        const plUseValues = [...new Set(plluData.map(item => String(item.PL_USE)))].sort();
        plUseValues.forEach(value => {
            const option = document.createElement('option');
            option.value = value;
            option.textContent = value;
            plUseFilter.appendChild(option);
        });
        
        // สร้างชุดฟิลเตอร์ RE_BL_USE แยกตาม PL_USE
        plUseValues.forEach(plUseValue => {
            // สร้าง container สำหรับแต่ละกลุ่ม PL_USE
            const plUseFilterGroup = document.createElement('div');
            plUseFilterGroup.classList.add('pluse-filter-group');
            plUseFilterGroup.dataset.plUse = plUseValue;
            
            // สร้างส่วนหัวข้อสำหรับแต่ละกลุ่ม
            const plUseFilterHeader = document.createElement('div');
            plUseFilterHeader.classList.add('pluse-filter-header');
            plUseFilterHeader.textContent = `PL_USE: ${plUseValue}`;
            plUseFilterGroup.appendChild(plUseFilterHeader);
            
            // สร้างส่วนเนื้อหาสำหรับเก็บ checkboxes
            const checkboxContainer = document.createElement('div');
            checkboxContainer.classList.add('checkbox-group');
            plUseFilterGroup.appendChild(checkboxContainer);
            
            // หา PL_BLOCK ทั้งหมดที่เกี่ยวข้องกับ PL_USE นี้
            const matchingPlluBlocks = plluData
                .filter(plluItem => String(plluItem.PL_USE) === plUseValue)
                .map(plluItem => String(plluItem.PL_BLOCK));
                
            // หาอาคารที่อยู่ใน PL_BLOCK ที่ตรงกับ PL_USE นี้
            const buildingsInPLUse = buildingData.filter(item => 
                matchingPlluBlocks.includes(String(item.PL_BLOCK))
            );
            
            // หา RE_BL_USE ทั้งหมดที่มีในอาคารที่อยู่ใน PL_USE นี้
            const reBLUseValues = [...new Set(buildingsInPLUse
                .map(item => parseFloat(item.RE_BL_USE))
                .filter(value => !isNaN(value) && value >= 10)
            )].sort((a, b) => a - b);
            
            // สร้าง checkboxes สำหรับ RE_BL_USE ที่พบในกลุ่ม PL_USE นี้
            reBLUseValues.forEach(value => {
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `re-bl-use-${plUseValue}-${value}`;
                checkbox.value = value;
                checkbox.dataset.plUse = plUseValue;
                checkbox.checked = true;
                checkbox.addEventListener('change', calculateAndDisplayTable);
                
                const label = document.createElement('label');
                label.htmlFor = `re-bl-use-${plUseValue}-${value}`;
                
                // แสดงค่า RE_BL_USE พร้อมคำอธิบาย (ถ้ามี)
                const comboKey = `${value}_1`; // ใช้คีย์ตัวแรกเพื่อหาคำอธิบาย
                const labelText = reBLUseLabelMap[comboKey] ? 
                    `${value} (${reBLUseLabelMap[comboKey].split(' ')[0]})` : 
                    `${value}`;
                    
                label.textContent = labelText;
                
                checkboxContainer.appendChild(checkbox);
                checkboxContainer.appendChild(label);
            });
            
            // เพิ่มกลุ่มฟิลเตอร์นี้เข้าไปในคอนเทนเนอร์หลัก
            reBlUseFiltersContainer.appendChild(plUseFilterGroup);
        });
        
        // ซ่อนกลุ่ม PL_USE ทั้งหมดยกเว้นกลุ่มที่ตรงกับ PL_USE ที่เลือก (หรือแสดงทั้งหมดถ้าเลือก 'all')
        updateVisiblePLUseFilters();
        
        // Setup ACQYEAR filter with text values
        const acqyearValues = [...new Set(buildingData.map(item => String(item.ACQYEAR)))].sort();
        acqyearValues.forEach(value => {
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = `acqyear-${value}`;
            checkbox.value = value;
            checkbox.checked = true;
            checkbox.addEventListener('change', calculateAndDisplayTable);
            
            const label = document.createElement('label');
            label.htmlFor = `acqyear-${value}`;
            label.textContent = value;
            
            acqyearFilter.appendChild(checkbox);
            acqyearFilter.appendChild(label);
        });
        
        // Add event listener for PL_USE filter change
        plUseFilter.addEventListener('change', function() {
            updateVisiblePLUseFilters();
            calculateAndDisplayTable();
        });
    }
    
    function updateVisiblePLUseFilters() {
        const selectedPLUse = document.getElementById('pl-use-filter').value;
        const plUseFilterGroups = document.querySelectorAll('.pluse-filter-group');
        
        plUseFilterGroups.forEach(group => {
            if (selectedPLUse === 'all' || group.dataset.plUse === selectedPLUse) {
                group.style.display = 'block';
            } else {
                group.style.display = 'none';
            }
        });
    }

    function calculateAndDisplayTable() {
        const selectedPLUse = document.getElementById('pl-use-filter').value;
        const selectedAcqyears = Array.from(document.querySelectorAll('#acqyear-filter input:checked'))
            .map(cb => String(cb.value));
        
        // รวบรวม RE_BL_USE ที่ถูกเลือกสำหรับแต่ละ PL_USE
        const selectedReBLUsesByPLUse = {};
        
        // ถ้าเลือก 'all' ให้ใช้ checkboxes จากทุกกลุ่ม PL_USE
        if (selectedPLUse === 'all') {
            const plUseValues = [...new Set(plluData.map(item => String(item.PL_USE)))].sort();
            plUseValues.forEach(plUseValue => {
                const checkboxes = document.querySelectorAll(`input[type="checkbox"][data-pl-use="${plUseValue}"]:checked`);
                selectedReBLUsesByPLUse[plUseValue] = Array.from(checkboxes).map(cb => String(cb.value));
            });
        } else {
            // ถ้าเลือก PL_USE เฉพาะ ให้ใช้เฉพาะ checkboxes ของ PL_USE นั้น
            const checkboxes = document.querySelectorAll(`input[type="checkbox"][data-pl-use="${selectedPLUse}"]:checked`);
            selectedReBLUsesByPLUse[selectedPLUse] = Array.from(checkboxes).map(cb => String(cb.value));
        }
        
        // Filter plluData based on selected PL_USE
        const filteredPlluData = selectedPLUse === 'all' 
            ? plluData 
            : plluData.filter(item => String(item.PL_USE) === selectedPLUse);
        
        // รวมรวม RE_BL_USE ทั้งหมดที่ถูกเลือกเพื่อใช้ในการกรองข้อมูลอาคาร
        const allSelectedReBLUses = Object.values(selectedReBLUsesByPLUse)
            .flat()
            .filter((value, index, self) => self.indexOf(value) === index);
        
        // Filter buildingData based on selected ACQYEAR and RE_BL_USE
        const filteredBuildingData = buildingData.filter(item => {
            // กรองตาม ACQYEAR ก่อน
            if (!selectedAcqyears.includes(String(item.ACQYEAR))) {
                return false;
            }
            
            // กรองตาม RE_BL_USE และ PL_USE
            const itemReBLUse = String(item.RE_BL_USE);
            const itemPLBlock = String(item.PL_BLOCK);
            
            // หา PL_USE ของอาคารนี้
            const buildingPLUse = plluData.find(plluItem => 
                String(plluItem.PL_BLOCK) === itemPLBlock
            )?.PL_USE;
            
            // ถ้าไม่พบ PL_USE หรือค่า RE_BL_USE น้อยกว่า 10 ให้ไม่รวม
            if (!buildingPLUse || parseFloat(item.RE_BL_USE) < 10) {
                return false;
            }
            
            // ถ้าเลือก PL_USE เฉพาะ ให้กรองเฉพาะอาคารที่อยู่ใน PL_USE นั้น
            if (selectedPLUse !== 'all' && buildingPLUse !== selectedPLUse) {
                return false;
            }
            
            // ตรวจสอบว่า RE_BL_USE ของอาคารอยู่ในรายการที่เลือกไว้หรือไม่
            // โดยต้องตรงกับ PL_USE ของอาคารนั้นด้วย
            return selectedReBLUsesByPLUse[buildingPLUse]?.includes(itemReBLUse);
        });
        
        // Sort RE_BL_USE and RE_BL_AREA combinations for all selected RE_BL_USE values
        const sortedReBLUseCombos = allSelectedReBLUses
            .flatMap(reBLUse => [1, 2, 3, 4, 5].map(area => `${reBLUse}_${area}`))
            .sort();

        // Calculate results
        const results = filteredPlluData.map(plluItem => {
            const plluPLBlock = String(plluItem.PL_BLOCK);
            const plluPLUse = String(plluItem.PL_USE);
            
            // กรองอาคารที่อยู่ใน PL_BLOCK นี้และมี RE_BL_USE ที่ถูกเลือก
            const buildingsInBlock = filteredBuildingData.filter(buildingItem => 
                String(buildingItem.PL_BLOCK) === plluPLBlock
            );
            
            const reBLUseResults = {};
            sortedReBLUseCombos.forEach(combo => {
                const [reBLUse, area] = combo.split('_').map(Number);
                
                // ตรวจสอบว่า RE_BL_USE นี้ถูกเลือกสำหรับ PL_USE นี้หรือไม่
                if (selectedReBLUsesByPLUse[plluPLUse]?.includes(String(reBLUse))) {
                    const buildingsInCategory = buildingsInBlock.filter(b => 
                        parseFloat(b.RE_BL_USE) === reBLUse && 
                        parseFloat(b.RE_BL_AREA) === area
                    );
                    
                    if (buildingsInCategory.length > 0) {
                        reBLUseResults[combo] = {
                            buildingCount: buildingsInCategory.length,
                            coveredArea: buildingsInCategory.reduce((sum, b) => sum + parseFloat(b.BL_AREA), 0),
                            landUseArea: calculateLandUseArea(buildingsInCategory, reBLUse, area)
                        };
                    }
                }
            });
            
            return {
                PL_BLOCK: plluItem.PL_BLOCK,
                PL_USE: plluItem.PL_USE,
                AREA: parseFloat(plluItem.AREA) || 0,
                ...reBLUseResults
            };
        });
        
        // Calculate totals
        const totals = results.reduce((acc, result) => {
            acc.AREA += result.AREA;
            
            // สร้างกลุ่มย่อยของ PL_USE ถ้ายังไม่มี
            if (!acc.byPLUse[result.PL_USE]) {
                acc.byPLUse[result.PL_USE] = { AREA: 0 };
            }
            acc.byPLUse[result.PL_USE].AREA += result.AREA;
            
            sortedReBLUseCombos.forEach(combo => {
                if (result[combo]) {
                    // เพิ่มข้อมูลสำหรับผลรวมทั้งหมด
                    if (!acc[combo]) {
                        acc[combo] = { buildingCount: 0, coveredArea: 0, landUseArea: 0 };
                    }
                    acc[combo].buildingCount += result[combo].buildingCount;
                    acc[combo].coveredArea += result[combo].coveredArea;
                    acc[combo].landUseArea += result[combo].landUseArea;
                    
                    // เพิ่มข้อมูลสำหรับกลุ่มย่อยของ PL_USE
                    if (!acc.byPLUse[result.PL_USE][combo]) {
                        acc.byPLUse[result.PL_USE][combo] = { buildingCount: 0, coveredArea: 0, landUseArea: 0 };
                    }
                    acc.byPLUse[result.PL_USE][combo].buildingCount += result[combo].buildingCount;
                    acc.byPLUse[result.PL_USE][combo].coveredArea += result[combo].coveredArea;
                    acc.byPLUse[result.PL_USE][combo].landUseArea += result[combo].landUseArea;
                }
            });
            return acc;
        }, { AREA: 0, byPLUse: {} });

        // Display results
        const tableContainer = document.getElementById('tableContainer');
        let tableHTML = '<table><tr><th>บริเวณการใช้ประโยชน์ที่ดิน</th><th>ประเภทการใช้ที่ดิน</th><th>พื้นที่ block</th>';
        
        // หา RE_BL_USE combos ที่มีข้อมูลจริงๆ เพื่อแสดงในตาราง
        const activeReBLUseCombos = sortedReBLUseCombos.filter(combo => 
            results.some(result => result[combo])
        );
        
        activeReBLUseCombos.forEach(combo => {
            // ใช้ชื่อที่มาจาก mapping หรือใช้รหัสถ้าไม่มีชื่อ
            const comboLabel = reBLUseLabelMap[combo] || combo;
            tableHTML += `<th colspan="3">${comboLabel}</th>`;
        });
        
        tableHTML += '<th colspan="2">รวมพื้นที่อาคารคลุมดิน</th><th colspan="2">การใช้ประโยชน์ที่ดิน</th></tr>';
        
        tableHTML += '<tr><th></th><th></th><th></th>';
        activeReBLUseCombos.forEach(() => {
            tableHTML += '<th>จำนวนอาคาร</th><th>พื้นที่อาคารคลุมดินรวม</th><th>พื้นที่การใช้ที่ดินรวม</th>';
        });
        tableHTML += '<th>จำนวนอาคาร</th><th>พื้นที่อาคารรวม</th><th>พื้นที่</th><th>ร้อยละพื้นที่</th></tr>';
        
        // กรณีที่เลือก PL_USE เฉพาะ - แสดงข้อมูลเรียงตาม PL_BLOCK
        if (selectedPLUse !== 'all') {
            results.forEach(result => {
                tableHTML += `<tr>
                    <td>${result.PL_BLOCK}</td>
                    <td>${result.PL_USE}</td>
                    <td>${formatNumber(result.AREA)}</td>`;
                
                let totalBuildingCount = 0;
                let totalCoveredArea = 0;
                let totalLandUseArea = 0;
                
                activeReBLUseCombos.forEach(combo => {
                    if (result[combo]) {
                        tableHTML += `<td>${formatNumber(result[combo].buildingCount)}</td>
                            <td>${formatNumber(result[combo].coveredArea)}</td>
                            <td>${formatNumber(result[combo].landUseArea)}</td>`;
                        
                        totalBuildingCount += result[combo].buildingCount;
                        totalCoveredArea += result[combo].coveredArea;
                        totalLandUseArea += result[combo].landUseArea;
                    } else {
                        tableHTML += '<td>0</td><td>0</td><td>0</td>';
                    }
                });
                
                const landUsePercentage = (totalLandUseArea / result.AREA) * 100;
                
                tableHTML += `<td>${formatNumber(totalBuildingCount)}</td>
                    <td>${formatNumber(totalCoveredArea)}</td>
                    <td>${formatNumber(totalLandUseArea)}</td>
                    <td>${formatNumber(landUsePercentage)}%</td>
                </tr>`;
            });
        } 
        // กรณีที่เลือก 'all' - แสดงผลรวมแยกตาม PL_USE
        else {
            // จัดกลุ่มตาม PL_USE
            const plUseGroups = {};
            results.forEach(result => {
                const plUse = result.PL_USE;
                if (!plUseGroups[plUse]) {
                    plUseGroups[plUse] = [];
                }
                plUseGroups[plUse].push(result);
            });
            
            // แสดงข้อมูลแต่ละ PL_USE และแต่ละ PL_BLOCK ในกลุ่มนั้น
            Object.entries(plUseGroups).sort().forEach(([plUse, plUseResults]) => {
                // แสดงผลรวมของแต่ละ PL_USE
                let plUseTotalBuildingCount = 0;
                let plUseTotalCoveredArea = 0;
                let plUseTotalLandUseArea = 0;
                let plUseTotalArea = 0;
                
                plUseResults.forEach(result => {
                    plUseTotalArea += result.AREA;
                    activeReBLUseCombos.forEach(combo => {
                        if (result[combo]) {
                            plUseTotalBuildingCount += result[combo].buildingCount;
                            plUseTotalCoveredArea += result[combo].coveredArea;
                            plUseTotalLandUseArea += result[combo].landUseArea;
                        }
                    });
                });
                
                // แสดงข้อมูลแต่ละ PL_BLOCK ในกลุ่ม PL_USE นี้
                plUseResults.forEach((result, index) => {
                    tableHTML += `<tr>
                        <td>${result.PL_BLOCK}</td>
                        <td>${index === 0 ? result.PL_USE : ''}</td>
                        <td>${formatNumber(result.AREA)}</td>`;
                    
                    let totalBuildingCount = 0;
                    let totalCoveredArea = 0;
                    let totalLandUseArea = 0;
                    
                    activeReBLUseCombos.forEach(combo => {
                        if (result[combo]) {
                            tableHTML += `<td>${formatNumber(result[combo].buildingCount)}</td>
                                <td>${formatNumber(result[combo].coveredArea)}</td>
                                <td>${formatNumber(result[combo].landUseArea)}</td>`;
                            
                            totalBuildingCount += result[combo].buildingCount;
                            totalCoveredArea += result[combo].coveredArea;
                            totalLandUseArea += result[combo].landUseArea;
                        } else {
                            tableHTML += '<td>0</td><td>0</td><td>0</td>';
                        }
                    });
                    
                    const landUsePercentage = (totalLandUseArea / result.AREA) * 100;
                    
                    tableHTML += `<td>${formatNumber(totalBuildingCount)}</td>
                        <td>${formatNumber(totalCoveredArea)}</td>
                        <td>${formatNumber(totalLandUseArea)}</td>
                        <td>${formatNumber(landUsePercentage)}%</td>
                    </tr>`;
                });
                
                // แสดงแถวสรุปสำหรับแต่ละ PL_USE
                const plUseLandUsePercentage = (plUseTotalLandUseArea / plUseTotalArea) * 100;
                tableHTML += `<tr class="total-row">
                    <td>ผลรวม ${plUse}</td>
                    <td></td>
                    <td>${formatNumber(plUseTotalArea)}</td>`;
                
                activeReBLUseCombos.forEach(combo => {
                    const plUseTotalsForCombo = totals.byPLUse[plUse]?.[combo];
                    if (plUseTotalsForCombo) {
                        tableHTML += `<td>${formatNumber(plUseTotalsForCombo.buildingCount)}</td>
                            <td>${formatNumber(plUseTotalsForCombo.coveredArea)}</td>
                            <td>${formatNumber(plUseTotalsForCombo.landUseArea)}</td>`;
                    } else {
                        tableHTML += '<td>0</td><td>0</td><td>0</td>';
                    }
                });
                
                tableHTML += `<td>${formatNumber(plUseTotalBuildingCount)}</td>
                    <td>${formatNumber(plUseTotalCoveredArea)}</td>
                    <td>${formatNumber(plUseTotalLandUseArea)}</td>
                    <td>${formatNumber(plUseLandUsePercentage)}%</td>
                </tr>`;
            });
        }
        
        // Add grand totals row
        let grandTotalBuildingCount = 0;
        let grandTotalCoveredArea = 0;
        let grandTotalLandUseArea = 0;
        
        activeReBLUseCombos.forEach(combo => {
            if (totals[combo]) {
                grandTotalBuildingCount += totals[combo].buildingCount;
                grandTotalCoveredArea += totals[combo].coveredArea;
                grandTotalLandUseArea += totals[combo].landUseArea;
            }
        });
        
        const grandTotalLandUsePercentage = (grandTotalLandUseArea / totals.AREA) * 100;
        
        tableHTML += `<tr class="total-row">
            <td>ผลรวมทั้งหมด</td>
            <td></td>
            <td>${formatNumber(totals.AREA)}</td>`;
        
        activeReBLUseCombos.forEach(combo => {
            if (totals[combo]) {
                tableHTML += `<td>${formatNumber(totals[combo].buildingCount)}</td>
                    <td>${formatNumber(totals[combo].coveredArea)}</td>
                    <td>${formatNumber(totals[combo].landUseArea)}</td>`;
            } else {
                tableHTML += '<td>0</td><td>0</td><td>0</td>';
            }
        });
        
        tableHTML += `<td>${formatNumber(grandTotalBuildingCount)}</td>
            <td>${formatNumber(grandTotalCoveredArea)}</td>
            <td>${formatNumber(grandTotalLandUseArea)}</td>
            <td>${formatNumber(grandTotalLandUsePercentage)}%</td>
        </tr>`;
        
        tableHTML += '</table>';
        tableContainer.innerHTML = tableHTML;
    }

    function calculateLandUseArea(buildings, reBLUse, area) {
        return buildings.reduce((sum, building) => {
            let factor;
            const buildingArea = parseFloat(building.BL_AREA) || 0;
            
            if (reBLUse == 10) {
                if (area == 1) factor = 50;
                else if (area == 2 || area == 3) factor = 60;
                else if (area == 4) factor = 40;
                else if (area == 5) factor = 65;
            } else if (reBLUse == 20) {
                if (area == 1) factor = 70;
                else if (area == 2) factor = 40;
                else if (area == 3) factor = 65;
            } else if (reBLUse == 41) {
                if (area == 1) factor = 70;
                else if (area == 2) factor = 40;
                else if (area == 3) factor = 65;
            } else if (reBLUse == 30) {
                if (area == 1) factor = 70;
                else if (area == 2 || area == 4) factor = 45;
                else if (area == 3) factor = 50;
            } else if (reBLUse == 33) {
                if (area == 1) factor = 20;
                else if (area == 2) factor = 40;
                else if (area == 3) factor = 50;
            } else if (reBLUse == 80 && area == 1) {
                factor = 20;
            } else if (reBLUse == 90 && area == 1) {
                factor = 70;
            }
            
            return sum + (buildingArea * 100 / (factor || 1));
        }, 0);
    }

    function formatNumber(num) {
        return Number(num).toLocaleString('en-US', {maximumFractionDigits: 2});
    }

    function exportToExcel() {
        const table = document.querySelector('table');
        if (table) {
            const wb = XLSX.utils.table_to_book(table, {sheet: "Sheet JS"});
            XLSX.writeFile(wb, 'land_use_calculation.xlsx');
        } else {
            alert('กรุณาคำนวณข้อมูลก่อนการนำออกไฟล์ Excel');
        }
    }
    </script>
</body>
</html>