<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>SHAPEFILE TO EXCEL</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://unpkg.com/shpjs@latest/dist/shp.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ag-grid/31.0.1/ag-grid-community.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/ag-grid/31.0.1/styles/ag-grid.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/ag-grid/31.0.1/styles/ag-theme-alpine.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
    /* =========================================
       1. FONTS & CORE VARIABLES (MERGED)
       ========================================= */
    @import url('https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap');

    :root {
        /* Variables from Page 2 (Main Theme) */
        --primary-gradient: linear-gradient(135deg, #1e88e5 0%, #1565c0 50%, #0d47a1 100%);
        --primary-solid: #1565c0;
        --primary-dark: #0d47a1;
        --primary-light: #e3f2fd;
        --primary-hover: #1e88e5;
        
        --text-white: #ffffff;
        --text-yellow: #ffeb3b;
        --text-gray: #546e7a;
        --text-dark: #333;

        --bg-glass: rgba(255, 255, 255, 0.1);
        --bg-glass-hover: rgba(255, 255, 255, 0.25);
        --header-height: 70px;

        /* Additional Variables from Page 8 (App Specific) */
        --card-shadow: 0 4px 12px rgba(21, 101, 192, 0.1);
        --card-border: 1px solid #e3f2fd;
        --radius-md: 12px;
        --radius-sm: 6px;
    }

    * {
        box-sizing: border-box;
        margin: 0; 
        padding: 0;
    }

    body {
        font-family: 'Prompt', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
        margin: 0;
        padding-top: var(--header-height);
        background: linear-gradient(180deg, #f0f7ff 0%, #ffffff 100%); /* Page 2 Background style */
        height: 100vh;
        overflow: hidden; /* Important for Page 8 App Layout */
        display: flex;
        flex-direction: column;
        color: var(--text-dark);
    }

    /* =========================================
       2. HEADER STYLES (EXACTLY FROM PAGE 2)
       ========================================= */
    .mapraw-header {
        background: var(--primary-gradient);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        z-index: 1000;
        height: var(--header-height);
    }
    
    .mapraw-header-content {
        max-width: 100%;
        margin: 0 auto;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 20px;
        height: 100%;
    }
    
    /* Logo Section */
    .mapraw-logo-section {
        display: flex;
        flex-direction: column;
        justify-content: center;
        padding-right: 15px;
    }
    
    .mapraw-logo-main {
        color: var(--text-white);
        font-size: 1.2rem;
        font-weight: 700;
        margin: 0;
        line-height: 1;
        white-space: nowrap;
    }
    
    .mapraw-logo-main span {
        color: var(--text-yellow);
        text-shadow: 0 0 10px rgba(255, 235, 59, 0.5);
    }
    
    .mapraw-page-title {
        color: #e3f2fd;
        font-size: 1rem;
        font-weight: 400;
        margin: 2px 0 0 0;
        white-space: nowrap;
    }
    
    /* Navigation Section */
    .mapraw-nav {
        display: flex;
        gap: 8px;
        align-items: center;
        height: 100%;
    }
    
    .mapraw-nav-item {
        position: relative;
        height: 100%;
        display: flex;
        align-items: center;
    }
    
    /* Buttons */
    .mapraw-nav-btn {
        background: var(--bg-glass);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
        padding: 8px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.85rem;
        font-weight: 500;
        transition: all 0.2s ease;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 6px;
        font-family: 'Prompt', sans-serif;
        white-space: nowrap;
    }
    
    .mapraw-nav-btn:hover {
        background: var(--bg-glass-hover);
        transform: translateY(-1px);
    }
    
    .mapraw-nav-btn.home-btn {
        background: rgba(255, 235, 59, 0.15);
        border-color: #ffeb3b;
        color: #ffeb3b;
    }
    
    .mapraw-nav-btn.home-btn:hover {
        background: #ffeb3b;
        color: #1565c0;
    }

    /* Dropdown */
    .mapraw-dropdown {
        position: absolute;
        top: calc(100% - 10px);
        left: 50%;
        transform: translateX(-50%) translateY(10px);
        background: white;
        border-radius: 8px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        min-width: 200px;
        opacity: 0;
        visibility: hidden;
        transition: all 0.2s ease;
        padding: 5px 0;
        z-index: 1001;
    }
    
    @media (min-width: 1201px) {
        .mapraw-nav-item:hover .mapraw-dropdown {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0);
        }
    }
    
    .mapraw-dropdown-item {
        display: block;
        padding: 10px 20px;
        color: #333;
        text-decoration: none;
        font-size: 0.9rem;
        transition: background 0.2s;
        white-space: nowrap;
    }
    
    .mapraw-dropdown-item:hover {
        background: #f1f8ff;
        color: var(--primary-solid);
    }

    /* Hamburger Menu Toggle */
    .mobile-menu-toggle {
        display: none;
        background: none;
        border: none;
        cursor: pointer;
        padding: 10px;
        z-index: 1002;
    }
    
    .bar {
        display: block;
        width: 25px;
        height: 3px;
        margin: 5px auto;
        background-color: white;
        transition: all 0.3s ease-in-out;
        border-radius: 2px;
    }

    /* Responsive Header Logic (From Page 2) */
    @media (max-width: 1400px) {
        .mapraw-nav-btn {
            padding: 6px 8px;
            font-size: 0.8rem;
        }
        .mapraw-nav {
            gap: 4px;
        }
    }

    @media (max-width: 1200px) {
        .mobile-menu-toggle {
            display: block;
        }

        .mapraw-nav {
            position: fixed;
            top: var(--header-height);
            right: -100%;
            width: 280px;
            height: calc(100vh - var(--header-height));
            background: white;
            flex-direction: column;
            align-items: stretch;
            gap: 0;
            padding: 10px 0;
            transition: right 0.3s ease;
            box-shadow: -5px 0 15px rgba(0,0,0,0.1);
            overflow-y: auto;
        }

        .mapraw-nav.active {
            right: 0;
        }

        .mapraw-nav-item {
            height: auto;
            flex-direction: column;
            width: 100%;
            display: block;
            border-bottom: 1px solid #eee;
        }

        .mapraw-nav-btn {
            background: white;
            color: #333;
            border: none;
            border-radius: 0;
            padding: 15px 20px;
            font-size: 1rem;
            justify-content: space-between;
            width: 100%;
        }

        .mapraw-nav-btn:hover {
            background: #f5f5f5;
            color: var(--primary-solid);
            transform: none;
        }

        .mapraw-dropdown {
            position: static;
            transform: none;
            visibility: visible;
            opacity: 1;
            box-shadow: none;
            min-width: 100%;
            background: #f9f9f9;
            display: none;
            padding: 0;
        }
        
        .mapraw-nav-item.active .mapraw-dropdown {
            display: block;
        }

        .mapraw-dropdown-item {
            padding-left: 40px;
            color: #666;
        }

        .mobile-menu-toggle.active .bar:nth-child(2) {
            opacity: 0;
        }
        .mobile-menu-toggle.active .bar:nth-child(1) {
            transform: translateY(8px) rotate(45deg);
        }
        .mobile-menu-toggle.active .bar:nth-child(3) {
            transform: translateY(-8px) rotate(-45deg);
        }
    }
    
    @media (max-width: 480px) {
        .mapraw-logo-main { font-size: 1rem; }
        .mapraw-page-title { font-size: 0.75rem; }
    }

    /* =========================================
       3. APP / PAGE 8 SPECIFIC STYLES
       ========================================= */

    /* Secondary Header (Title Bar) */
    .header-bar {
        background-color: white;
        padding: 10px 20px;
        margin: 15px 20px 10px 20px;
        border-radius: var(--radius-md);
        box-shadow: var(--card-shadow);
        border-top: 4px solid var(--primary-solid);
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-shrink: 0;
        transition: transform 0.2s;
    }
    
    .header-title {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .header-title h1 {
        color: var(--primary-dark);
        margin: 0;
        font-size: 18px;
        font-weight: 700;
        letter-spacing: 0.5px;
    }

    .manual-link {
        color: var(--primary-solid);
        background-color: var(--primary-light);
        padding: 5px 12px;
        border-radius: 20px;
        text-decoration: none;
        font-size: 13px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: all 0.2s;
    }

    .manual-link:hover {
        background-color: var(--primary-solid);
        color: white;
        transform: translateY(-1px);
    }

    /* Control Panel */
    .control-panel {
        background-color: white;
        padding: 12px 20px;
        margin: 0 20px 10px 20px;
        border-radius: var(--radius-md);
        box-shadow: var(--card-shadow);
        border: var(--card-border);
        flex-shrink: 0;
    }

    .control-row {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 15px;
        margin-bottom: 10px;
    }

    .control-row:last-child {
        margin-bottom: 0;
    }

    .control-item {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .control-label {
        font-size: 12px;
        color: var(--text-gray);
        font-weight: 600;
        text-transform: uppercase;
    }

    #fileInput {
        display: none;
    }
    
    /* Input Styling */
    .file-display, .search-input {
        padding: 8px 12px;
        border: 1px solid #cfd8dc;
        border-radius: var(--radius-sm);
        background-color: #fafafa;
        font-size: 13px;
        font-family: 'Prompt', sans-serif;
        width: 100%;
        transition: all 0.2s;
        color: var(--text-dark);
    }

    .file-display:hover, .search-input:focus {
        border-color: var(--primary-solid);
        background-color: white;
        outline: none;
        box-shadow: 0 0 0 2px var(--primary-light);
    }
    
    .file-display {
        cursor: pointer;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* App Buttons */
    .button-toolbar {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }
    
    .btn {
        padding: 8px 14px;
        border: none;
        border-radius: var(--radius-sm);
        font-size: 13px;
        font-family: 'Prompt', sans-serif;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 6px;
        white-space: nowrap;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .btn:active {
        transform: translateY(0);
    }
    
    /* Button Colors Mapping */
    .btn-process { background: var(--primary-gradient); color: white; }
    .btn-export { background-color: #2e7d32; color: white; } /* Green for Excel */
    .btn-export-csv { background-color: #00897b; color: white; } /* Teal for CSV */
    .btn-stats { background-color: #f57f17; color: white; } /* Orange */
    .btn-save-filter { background-color: #7b1fa2; color: white; } /* Purple */
    .btn-load-filter { background-color: #5e35b1; color: white; } /* Deep Purple */
    .btn-clear { background-color: #c62828; color: white; } /* Red */

    .btn i {
        font-size: 12px;
    }

    /* Status Bar */
    .status-bar {
        background-color: var(--primary-light);
        padding: 8px 20px;
        margin: 0 20px 10px 20px;
        border-radius: var(--radius-sm);
        font-size: 13px;
        color: var(--primary-dark);
        display: none;
        flex-shrink: 0;
        border: 1px solid #bbdefb;
        animation: fadeIn 0.3s ease;
    }

    .status-bar.active {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-5px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* Grid Container (Maximized) */
    .grid-container {
        flex: 1; /* Fills remaining vertical space */
        padding: 0 20px 20px 20px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        min-height: 0;
    }
    
    #grid {
        flex: 1;
        width: 100%;
        background-color: white;
        border: 1px solid #cfd8dc;
        border-radius: var(--radius-md);
        box-shadow: var(--card-shadow);
        overflow: hidden;
    }

    /* AG Grid Theme Overrides */
    .ag-theme-alpine {
        --ag-selected-row-background-color: var(--primary-light);
        --ag-header-background-color: #f5f7fa;
        --ag-header-foreground-color: var(--text-gray);
        --ag-header-cell-hover-background-color: #e3f2fd;
        --ag-row-hover-color: #f0f7ff;
        --ag-borders: solid 1px #eceff1;
        --ag-font-family: 'Prompt', sans-serif;
        --ag-font-size: 13px;
    }

    .ag-header-cell-filtered {
        background-color: var(--primary-light) !important;
        color: var(--primary-dark) !important;
        font-weight: bold;
    }

    /* Modals */
    .modal {
        display: none;
        position: fixed;
        z-index: 2000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(13, 71, 161, 0.2);
        backdrop-filter: blur(3px);
    }

    .modal-content {
        background-color: #fefefe;
        margin: 3% auto;
        padding: 25px;
        border-radius: 16px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        max-width: 600px;
        max-height: 85vh;
        overflow-y: auto;
        border-top: 5px solid var(--primary-solid);
        animation: slideUp 0.3s cubic-bezier(0.165, 0.84, 0.44, 1);
    }
    
    @keyframes slideUp {
        from { transform: translateY(50px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #eee;
    }

    .modal-header h2 {
        margin: 0;
        color: var(--primary-solid);
        font-size: 20px;
        font-weight: 600;
    }

    .close {
        color: #b0bec5;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        transition: color 0.2s;
        line-height: 1;
    }

    .close:hover {
        color: var(--primary-dark);
    }

    /* Modal Lists */
    .column-list, .filter-list {
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid #eceff1;
        border-radius: 8px;
        padding: 12px;
        background: #fafafa;
    }

    .column-item, .filter-item {
        display: flex;
        align-items: center;
        padding: 10px;
        margin-bottom: 4px;
        border-radius: 6px;
        transition: background-color 0.2s;
        border: 1px solid transparent;
        background: white;
    }

    .column-item:hover, .filter-item:hover {
        background-color: var(--primary-light);
        border-color: #bbdefb;
    }

    /* Modal Actions */
    .modal-actions {
        display: flex;
        gap: 10px;
        margin-top: 20px;
        justify-content: flex-end;
    }

    .btn-modal {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-family: 'Prompt', sans-serif;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-modal-primary {
        background-color: var(--primary-solid);
        color: white;
        box-shadow: 0 2px 6px rgba(21, 101, 192, 0.3);
    }

    .btn-modal-primary:hover {
        background-color: var(--primary-dark);
        transform: translateY(-1px);
    }

    .btn-modal-secondary {
        background-color: #eceff1;
        color: #546e7a;
    }

    .btn-modal-secondary:hover {
        background-color: #cfd8dc;
        color: #37474f;
    }

    /* Statistics & Misc Styles */
    .stats-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }

    .stat-box {
        padding: 20px;
        border-radius: 12px;
        background-color: #f8fbff;
        border: 1px solid #e3f2fd;
        border-left: 4px solid var(--primary-solid);
        box-shadow: 0 2px 4px rgba(0,0,0,0.03);
    }

    .stat-label {
        font-size: 13px;
        color: var(--text-gray);
        margin-bottom: 8px;
        font-weight: 500;
    }

    .stat-value {
        font-size: 24px;
        font-weight: 700;
        color: var(--primary-solid);
    }
    
    .stats-column-section {
        background-color: #fafafa;
        border-left: 3px solid var(--primary-solid);
        margin-bottom: 15px;
        padding: 15px;
        border-radius: 8px;
    }
    
    .stats-table th {
        background-color: var(--primary-light);
        color: var(--primary-dark);
        font-weight: 600;
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }

    ::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
        background: #cfd8dc;
        border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: #b0bec5;
    }

    /* App Responsive Adjustments */
    @media (max-width: 1200px) {
        .control-row {
            grid-template-columns: 1fr 1fr;
        }
        .button-toolbar {
            grid-column: 1 / -1;
        }
    }

    @media (max-width: 768px) {
        .control-row {
            grid-template-columns: 1fr;
        }
        .button-toolbar {
            flex-direction: column;
        }
        .btn {
            justify-content: center;
        }
        .header-bar {
            flex-direction: column;
            gap: 10px;
            align-items: flex-start;
            padding: 15px;
        }
        .header-title h1 {
            font-size: 16px;
        }
        .control-panel, .grid-container, .header-bar {
            margin-left: 10px;
            margin-right: 10px;
        }
        .grid-container {
            padding: 0 10px 10px 10px;
        }
    }
</style>
</head>
<body>
        <header class="mapraw-header">
    <div class="mapraw-header-content">
        <div class="mapraw-logo-section">
            <h1 class="mapraw-logo-main">TOOL FROM <span>MAPRAW</span></h1>
            <p class="mapraw-page-title">SHAPEFILE TO EXCEL</p>
        </div>
        
        <button class="mobile-menu-toggle" id="mobileMenuBtn">
            <span class="bar"></span>
            <span class="bar"></span>
            <span class="bar"></span>
        </button>

        <nav class="mapraw-nav" id="mainNav">
            <div class="mapraw-nav-item">
                <a href="index.html" class="mapraw-nav-btn home-btn">
                    <span>üè† ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</span>
                </a>
            </div>
            
            <div class="mapraw-nav-item" onclick="toggleMobileDropdown(this)">
                <div class="mapraw-nav-btn">
                    <span>üìã ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏™‡∏≥‡∏£‡∏ß‡∏à</span>
                    <span style="font-size: 0.8em">‚ñº</span>
                </div>
                <div class="mapraw-dropdown">
                    <a href="page1.html" class="mapraw-dropdown-item">NoteMAP</a>
                    <a href="#" class="mapraw-dropdown-item">SURVEY WORK</a>
                </div>
            </div>
            
            <div class="mapraw-nav-item" onclick="toggleMobileDropdown(this)">
                <div class="mapraw-nav-btn">
                    <span>üîß ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
                    <span style="font-size: 0.8em">‚ñº</span>
                </div>
                <div class="mapraw-dropdown">
                    <a href="page2.html" class="mapraw-dropdown-item">Reclass BLDG</a>
                    <a href="page5.html" class="mapraw-dropdown-item">Prepare PLLU</a>
                    <a href="page8.html" class="mapraw-dropdown-item">SHAPEFILE TO EXCEL</a>
                    <a href="page10.html" class="mapraw-dropdown-item">CAPTURE MAP</a>
                    <a href="page13.html" class="mapraw-dropdown-item">Perpendicular Line</a>
                </div>
            </div>
            
            <div class="mapraw-nav-item" onclick="toggleMobileDropdown(this)">
                <div class="mapraw-nav-btn">
                    <span>‚öôÔ∏è ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•</span>
                    <span style="font-size: 0.8em">‚ñº</span>
                </div>
                <div class="mapraw-dropdown">
                    <a href="page3.html" class="mapraw-dropdown-item">Calculate Landuse</a>
                    <a href="page6.html" class="mapraw-dropdown-item">Calculate Population</a>
                    <a href="page11.html" class="mapraw-dropdown-item">Calculate AREA</a>
                    <a href="page14.html" class="mapraw-dropdown-item">RECLASS FACTORY</a>
                    <a href="page12.html" class="mapraw-dropdown-item">COMPARISON LANDUSE</a>
                </div>
            </div>
            
            <div class="mapraw-nav-item" onclick="toggleMobileDropdown(this)">
                <div class="mapraw-nav-btn">
                    <span>‚öñÔ∏è ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢</span>
                    <span style="font-size: 0.8em">‚ñº</span>
                </div>
                <div class="mapraw-dropdown">
                    <a href="page4.html" class="mapraw-dropdown-item">Town Planning Laws</a>
                    <a href="page15.html" class="mapraw-dropdown-item">Building Laws</a>
                </div>
            </div>
            
            <div class="mapraw-nav-item" onclick="toggleMobileDropdown(this)">
                <div class="mapraw-nav-btn">
                    <span>üßÆ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô</span>
                    <span style="font-size: 0.8em">‚ñº</span>
                </div>
                <div class="mapraw-dropdown">
                    <a href="page7.html" class="mapraw-dropdown-item">AREA Calculator</a>
                </div>
            </div>
            
            <div class="mapraw-nav-item" onclick="toggleMobileDropdown(this)">
                <div class="mapraw-nav-btn">
                    <span>üéØ ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏≠‡∏∑‡πà‡∏ô‡πÜ</span>
                    <span style="font-size: 0.8em">‚ñº</span>
                </div>
                <div class="mapraw-dropdown">
                    <a href="page9.html" class="mapraw-dropdown-item">CREATE QRCODE</a>
                </div>
            </div>
        </nav>
    </div>
</header>

    <!-- Compact Header -->
    <div class="header-bar">
        <div class="header-title">
            <a href="SHP TO EXCEL HANDBOOK.pdf" class="manual-link" title="‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô">
                <i class="fas fa-book"></i>
                <span>‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠</span>
            </a>
        </div>
  
    </div>

    <!-- Compact Control Panel -->
    <div class="control-panel">
        <div class="control-row">
            <div class="control-item">
                <label class="control-label">‡πÑ‡∏ü‡∏•‡πå Shapefile (.zip)</label>
                <input type="file" id="fileInput" accept=".zip" />
                <input type="text" class="file-display" id="fileDisplay" placeholder="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå" readonly onclick="document.getElementById('fileInput').click();" />
            </div>
            <div class="control-item">
                <label class="control-label">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå)</label>
                <input type="text" id="quickSearch" class="search-input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." onkeyup="performQuickSearch()">
            </div>
            <div class="control-item">
                <label class="control-label">‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</label>
                <button class="btn btn-process" onclick="processShapefile()" title="‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÑ‡∏ü‡∏•‡πå Shapefile">
                    <i class="fas fa-cog"></i>
                    <span>‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•</span>
                </button>
            </div>
        </div>

        <div class="control-row">
            <div class="control-item" style="grid-column: 1 / -1;">
                <label class="control-label">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠</label>
                <div class="button-toolbar">
                    <button class="btn btn-export" onclick="showColumnSelector()" title="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel">
                        <i class="fas fa-file-excel"></i>
                        <span>Excel (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)</span>
                    </button>
                    <button class="btn btn-export" onclick="exportToExcel()" title="‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î">
                        <i class="fas fa-file-excel"></i>
                        <span>Excel (‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)</span>
                    </button>
                    <button class="btn btn-export-csv" onclick="exportToCSV()" title="‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô CSV">
                        <i class="fas fa-file-csv"></i>
                        <span>CSV</span>
                    </button>
                    <button class="btn btn-stats" onclick="showStatistics()" title="‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•">
                        <i class="fas fa-chart-bar"></i>
                        <span>‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</span>
                    </button>
                    <button class="btn btn-save-filter" onclick="showSaveFilter()" title="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á">
                        <i class="fas fa-save"></i>
                        <span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</span>
                    </button>
                    <button class="btn btn-load-filter" onclick="showLoadFilter()" title="‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á">
                        <i class="fas fa-folder-open"></i>
                        <span>‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</span>
                    </button>
                    <button class="btn btn-clear" onclick="clearAllFilters()" title="‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤">
                        <i class="fas fa-times"></i>
                        <span>‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Bar -->
    <div id="status" class="status-bar"></div>

    <!-- Grid Container -->
    <div class="grid-container">
        <div id="grid" class="ag-theme-alpine"></div>
    </div>

    <!-- Column Selector Modal -->
    <div id="columnModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-columns"></i> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å</h2>
                <span class="close" onclick="closeColumnModal()">&times;</span>
            </div>
            <div style="margin-bottom: 15px; display: flex; gap: 8px;">
                <button class="btn-modal btn-modal-secondary" onclick="selectAllColumns()">
                    <i class="fas fa-check-square"></i> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                </button>
                <button class="btn-modal btn-modal-secondary" onclick="deselectAllColumns()">
                    <i class="fas fa-square"></i> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                </button>
            </div>
            <div id="columnList" class="column-list"></div>
            <div class="modal-actions">
                <button class="btn-modal btn-modal-secondary" onclick="closeColumnModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button class="btn-modal btn-modal-primary" onclick="exportSelectedColumns()">
                    <i class="fas fa-download"></i> ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel
                </button>
            </div>
        </div>
    </div>

    <!-- Statistics Modal -->
    <div id="statsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-chart-bar"></i> ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h2>
                <span class="close" onclick="closeStatsModal()">&times;</span>
            </div>
            <div id="statsContent"></div>
            <div class="modal-actions">
                <button class="btn-modal btn-modal-secondary" onclick="closeStatsModal()">‡∏õ‡∏¥‡∏î</button>
            </div>
        </div>
    </div>

    <!-- Save Filter Modal -->
    <div id="saveFilterModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</h2>
                <span class="close" onclick="closeSaveFilterModal()">&times;</span>
            </div>
            <label class="control-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</label>
            <input type="text" id="filterName" class="filter-input" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á...">
            <div class="modal-actions">
                <button class="btn-modal btn-modal-secondary" onclick="closeSaveFilterModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button class="btn-modal btn-modal-primary" onclick="saveFilter()">
                    <i class="fas fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                </button>
            </div>
        </div>
    </div>

    <!-- Load Filter Modal -->
    <div id="loadFilterModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-folder-open"></i> ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</h2>
                <span class="close" onclick="closeLoadFilterModal()">&times;</span>
            </div>
            <div id="filterList" class="filter-list"></div>
            <div class="modal-actions">
                <button class="btn-modal btn-modal-secondary" onclick="closeLoadFilterModal()">‡∏õ‡∏¥‡∏î</button>
            </div>
        </div>
    </div>

    <script>
        let gridApi;
        let columnDefs = [];
        let rowData = [];
        let originalFileName = '';
        let savedFilters = JSON.parse(localStorage.getItem('shapefileFilters') || '[]');

        // Update file input display
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                originalFileName = file.name.replace(/\.[^/.]+$/, "");
                document.getElementById('fileDisplay').value = file.name;
            } else {
                document.getElementById('fileDisplay').value = '‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå';
                originalFileName = '';
            }
        });

        async function processShapefile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            const status = document.getElementById('status');
            
            if (!file) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Shapefile (.zip)');
                return;
            }

            status.classList.add('active');
            status.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...';

            try {
                const arrayBuffer = await file.arrayBuffer();
                const geojson = await shp(arrayBuffer);
                
                rowData = geojson.features.map(feature => feature.properties);

                if (rowData.length > 0) {
                    columnDefs = Object.keys(rowData[0]).map(key => ({
                        field: key,
                        filter: 'agSetColumnFilter',
                        floatingFilter: true,
                        sortable: true,
                        minWidth: 150,
                        filterParams: {
                            buttons: ['apply', 'clear', 'reset'],
                            closeOnApply: false,
                            suppressAndOrCondition: false,
                            values: getUniqueValues(rowData, key),
                            suppressSelectAll: false,
                            suppressMiniFilter: false
                        },
                        valueFormatter: params => {
                            if (typeof params.value === 'number') {
                                return params.value.toLocaleString();
                            }
                            return params.value;
                        },
                        comparator: (valueA, valueB) => {
                            if (typeof valueA === 'number' && typeof valueB === 'number') {
                                return valueA - valueB;
                            }
                            return valueA > valueB ? 1 : -1;
                        }
                    }));

                    const gridOptions = {
                        columnDefs: columnDefs,
                        rowData: rowData,
                        pagination: true,
                        paginationPageSize: 50,
                        domLayout: 'normal',
                        onFilterChanged: onFilterChanged,
                        defaultColDef: {
                            flex: 1,
                            minWidth: 150,
                            filter: 'agSetColumnFilter',
                            floatingFilter: true,
                            resizable: true,
                            sortable: true,
                            filterParams: {
                                buttons: ['apply', 'clear', 'reset'],
                                closeOnApply: false,
                                suppressAndOrCondition: false,
                                suppressSelectAll: false,
                                suppressMiniFilter: false
                            }
                        }
                    };

                    const gridDiv = document.querySelector('#grid');
                    gridApi = new agGrid.Grid(gridDiv, gridOptions);
                    gridApi = gridOptions.api;

                    status.innerHTML = `<i class="fas fa-check-circle"></i> ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <strong>${rowData.length.toLocaleString()}</strong> ‡πÅ‡∏ñ‡∏ß`;
                }
            } catch (error) {
                console.error('Error:', error);
                status.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`;
            }
        }

        function getUniqueValues(data, field) {
            const uniqueValues = [...new Set(data.map(item => item[field]))];
            return uniqueValues.filter(value => value !== null && value !== undefined);
        }

        function clearAllFilters() {
            if (gridApi) {
                gridApi.setFilterModel(null);
                gridApi.onFilterChanged();
                document.getElementById('quickSearch').value = '';
            }
        }

        function onFilterChanged() {
            if (gridApi) {
                const filteredCount = gridApi.getDisplayedRowCount();
                const totalCount = rowData.length;
                const status = document.getElementById('status');
                status.classList.add('active');
                
                if (filteredCount === totalCount) {
                    status.innerHTML = `<i class="fas fa-table"></i> ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: <strong>${totalCount.toLocaleString()}</strong> ‡πÅ‡∏ñ‡∏ß`;
                } else {
                    status.innerHTML = `<i class="fas fa-filter"></i> ‡πÅ‡∏™‡∏î‡∏á: <strong>${filteredCount.toLocaleString()}</strong> / ${totalCount.toLocaleString()} ‡πÅ‡∏ñ‡∏ß`;
                }
            }
        }

        // Quick Search Function
        function performQuickSearch() {
            if (!gridApi) return;
            
            const searchText = document.getElementById('quickSearch').value.toLowerCase();
            gridApi.setQuickFilter(searchText);
            onFilterChanged();
        }

        // Column Selector Functions
        function showColumnSelector() {
            if (!gridApi) {
                alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å');
                return;
            }

            const columnList = document.getElementById('columnList');
            columnList.innerHTML = '';

            columnDefs.forEach(col => {
                const div = document.createElement('div');
                div.className = 'column-item';
                div.innerHTML = `
                    <input type="checkbox" id="col_${col.field}" value="${col.field}" checked>
                    <label for="col_${col.field}">${col.field}</label>
                `;
                columnList.appendChild(div);
            });

            document.getElementById('columnModal').style.display = 'block';
        }

        function closeColumnModal() {
            document.getElementById('columnModal').style.display = 'none';
        }

        function selectAllColumns() {
            document.querySelectorAll('#columnList input[type="checkbox"]').forEach(cb => {
                cb.checked = true;
            });
        }

        function deselectAllColumns() {
            document.querySelectorAll('#columnList input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
        }

        function exportSelectedColumns() {
            const selectedColumns = [];
            document.querySelectorAll('#columnList input[type="checkbox"]:checked').forEach(cb => {
                selectedColumns.push(cb.value);
            });

            if (selectedColumns.length === 0) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå');
                return;
            }

            const filteredData = [];
            gridApi.forEachNodeAfterFilter(node => {
                const rowData = {};
                selectedColumns.forEach(col => {
                    rowData[col] = node.data[col];
                });
                filteredData.push(rowData);
            });

            const ws = XLSX.utils.json_to_sheet(filteredData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "ShapefileData");
            
            const exportFileName = originalFileName ? `${originalFileName}_selected.xlsx` : 'shapefile_data_selected.xlsx';
            XLSX.writeFile(wb, exportFileName);

            closeColumnModal();
        }

        // CSV Export Function - Improved to preserve data types
        function exportToCSV() {
            if (!gridApi) {
                alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å');
                return;
            }

            const filteredData = [];
            gridApi.forEachNodeAfterFilter(node => {
                filteredData.push(node.data);
            });

            if (filteredData.length === 0) {
                alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å');
                return;
            }

            // Convert to CSV with proper data type handling
            const headers = Object.keys(filteredData[0]);
            let csv = headers.join(',') + '\n';

            filteredData.forEach(row => {
                const values = headers.map(header => {
                    let value = row[header];
                    
                    // Handle null/undefined
                    if (value === null || value === undefined) {
                        return '';
                    }
                    
                    // Check if value is numeric (quantitative)
                    if (typeof value === 'number') {
                        // Keep as number, no quotes
                        return value;
                    }
                    
                    // Handle qualitative data (text)
                    value = String(value);
                    
                    // Escape quotes
                    value = value.replace(/"/g, '""');
                    
                    // Quote if contains special characters
                    if (value.includes(',') || value.includes('\n') || value.includes('"') || value.includes('\r')) {
                        value = `"${value}"`;
                    }
                    
                    return value;
                });
                csv += values.join(',') + '\n';
            });

            // Download CSV
            const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            const exportFileName = originalFileName ? `${originalFileName}.csv` : 'shapefile_data.csv';
            
            link.setAttribute('href', url);
            link.setAttribute('download', exportFileName);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Statistics Functions - Enhanced with expandable details
        function showStatistics() {
            if (!gridApi || rowData.length === 0) {
                alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥');
                return;
            }

            const filteredData = [];
            gridApi.forEachNodeAfterFilter(node => {
                filteredData.push(node.data);
            });

            const statsContent = document.getElementById('statsContent');
            
            // Basic stats
            let html = '<div class="stats-container">';
            html += `<div class="stat-box">
                        <div class="stat-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                        <div class="stat-value">${rowData.length.toLocaleString()}</div>
                    </div>`;
            html += `<div class="stat-box">
                        <div class="stat-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á</div>
                        <div class="stat-value">${filteredData.length.toLocaleString()}</div>
                    </div>`;
            html += `<div class="stat-box">
                        <div class="stat-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå</div>
                        <div class="stat-value">${columnDefs.length}</div>
                    </div>`;
            html += '</div>';

            // Detailed stats for each column
            html += '<div class="stats-detail">';
            html += '<h3>‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå</h3>';

            columnDefs.forEach((col, colIndex) => {
                const field = col.field;
                const values = filteredData.map(row => row[field]).filter(v => v !== null && v !== undefined);
                
                if (values.length === 0) return;

                const isNumeric = values.every(v => typeof v === 'number');
                
                html += `<div class="stats-column-section">`;
                html += `<h4 onclick="toggleStatsDetail('stats-detail-${colIndex}')" style="cursor: pointer; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-chevron-right stats-toggle" id="stats-toggle-${colIndex}"></i>
                            ${field}
                            <span style="font-size: 12px; color: #666; font-weight: normal;">
                                (${isNumeric ? '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ä‡∏¥‡∏á‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì' : '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ä‡∏¥‡∏á‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û'})
                            </span>
                         </h4>`;
                
                html += `<div id="stats-detail-${colIndex}" class="stats-detail-content" style="display: none;">`;
                
                if (isNumeric) {
                    // Quantitative data statistics
                    const sum = values.reduce((a, b) => a + b, 0);
                    const avg = sum / values.length;
                    const min = Math.min(...values);
                    const max = Math.max(...values);
                    const sortedValues = [...values].sort((a, b) => a - b);
                    const median = sortedValues.length % 2 === 0
                        ? (sortedValues[sortedValues.length / 2 - 1] + sortedValues[sortedValues.length / 2]) / 2
                        : sortedValues[Math.floor(sortedValues.length / 2)];
                    
                    html += '<table class="stats-table">';
                    html += '<tr><th>‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</th><th>‡∏Ñ‡πà‡∏≤</th></tr>';
                    html += `<tr><td>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td><td>${values.length.toLocaleString()}</td></tr>`;
                    html += `<tr><td>‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (Mean)</td><td>${avg.toLocaleString(undefined, {maximumFractionDigits: 2})}</td></tr>`;
                    html += `<tr><td>‡∏Ñ‡πà‡∏≤‡∏Å‡∏•‡∏≤‡∏á (Median)</td><td>${median.toLocaleString(undefined, {maximumFractionDigits: 2})}</td></tr>`;
                    html += `<tr><td>‡∏Ñ‡πà‡∏≤‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î (Min)</td><td>${min.toLocaleString()}</td></tr>`;
                    html += `<tr><td>‡∏Ñ‡πà‡∏≤‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î (Max)</td><td>${max.toLocaleString()}</td></tr>`;
                    html += `<tr><td>‡∏ú‡∏•‡∏£‡∏ß‡∏° (Sum)</td><td>${sum.toLocaleString(undefined, {maximumFractionDigits: 2})}</td></tr>`;
                    html += `<tr><td>‡∏ä‡πà‡∏ß‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Range)</td><td>${(max - min).toLocaleString(undefined, {maximumFractionDigits: 2})}</td></tr>`;
                    html += '</table>';
                    
                    // Show unique values if reasonable amount
                    const uniqueValues = [...new Set(values)];
                    if (uniqueValues.length <= 50) {
                        const valueCounts = {};
                        values.forEach(v => {
                            valueCounts[v] = (valueCounts[v] || 0) + 1;
                        });
                        const sortedCounts = Object.entries(valueCounts)
                            .sort((a, b) => parseFloat(a[0]) - parseFloat(b[0]));
                        
                        html += `<div style="margin-top: 15px;">`;
                        html += `<h5 style="margin-bottom: 10px; color: #666;">‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h5>`;
                        html += '<table class="stats-table">';
                        html += '<tr><th>‡∏Ñ‡πà‡∏≤</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th>‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå</th></tr>';
                        sortedCounts.forEach(([value, count]) => {
                            const percent = ((count / values.length) * 100).toFixed(1);
                            html += `<tr><td>${parseFloat(value).toLocaleString()}</td><td>${count.toLocaleString()}</td><td>${percent}%</td></tr>`;
                        });
                        html += '</table></div>';
                    }
                } else {
                    // Qualitative data statistics
                    const uniqueValues = [...new Set(values)];
                    const valueCounts = {};
                    values.forEach(v => {
                        valueCounts[v] = (valueCounts[v] || 0) + 1;
                    });
                    
                    const sortedCounts = Object.entries(valueCounts)
                        .sort((a, b) => b[1] - a[1]);
                    
                    html += '<table class="stats-table">';
                    html += '<tr><th>‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</th><th>‡∏Ñ‡πà‡∏≤</th></tr>';
                    html += `<tr><td>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td><td>${values.length.toLocaleString()}</td></tr>`;
                    html += `<tr><td>‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥</td><td>${uniqueValues.length.toLocaleString()}</td></tr>`;
                    html += `<tr><td>‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏ö‡∏ö‡πà‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</td><td>${sortedCounts[0][0]} (${sortedCounts[0][1]} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)</td></tr>`;
                    html += '</table>';
                    
                    // Show all values in expandable section
                    html += `<div style="margin-top: 15px;">`;
                    html += `<h5 style="margin-bottom: 10px; color: #666; cursor: pointer; display: flex; align-items: center; gap: 8px;" onclick="toggleValueList('values-${colIndex}')">
                                <i class="fas fa-chevron-right value-toggle" id="value-toggle-${colIndex}"></i>
                                ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (${sortedCounts.length} ‡∏Ñ‡πà‡∏≤)
                             </h5>`;
                    html += `<div id="values-${colIndex}" class="value-list" style="display: none;">`;
                    html += '<table class="stats-table">';
                    html += '<tr><th>‡∏•‡∏≥‡∏î‡∏±‡∏ö</th><th>‡∏Ñ‡πà‡∏≤</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th>‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå</th></tr>';
                    sortedCounts.forEach(([value, count], idx) => {
                        const percent = ((count / values.length) * 100).toFixed(1);
                        html += `<tr><td>${idx + 1}</td><td>${value}</td><td>${count.toLocaleString()}</td><td>${percent}%</td></tr>`;
                    });
                    html += '</table></div></div>';
                }
                
                html += '</div></div>';
            });

            html += '</div>';
            statsContent.innerHTML = html;

            document.getElementById('statsModal').style.display = 'block';
        }

        function toggleStatsDetail(id) {
            const element = document.getElementById(id);
            const toggleIcon = document.getElementById(id.replace('stats-detail-', 'stats-toggle-'));
            
            if (element.style.display === 'none') {
                element.style.display = 'block';
                toggleIcon.classList.remove('fa-chevron-right');
                toggleIcon.classList.add('fa-chevron-down');
            } else {
                element.style.display = 'none';
                toggleIcon.classList.remove('fa-chevron-down');
                toggleIcon.classList.add('fa-chevron-right');
            }
        }

        function toggleValueList(id) {
            const element = document.getElementById(id);
            const toggleIcon = document.getElementById(id.replace('values-', 'value-toggle-'));
            
            if (element.style.display === 'none') {
                element.style.display = 'block';
                toggleIcon.classList.remove('fa-chevron-right');
                toggleIcon.classList.add('fa-chevron-down');
            } else {
                element.style.display = 'none';
                toggleIcon.classList.remove('fa-chevron-down');
                toggleIcon.classList.add('fa-chevron-right');
            }
        }

        function closeStatsModal() {
            document.getElementById('statsModal').style.display = 'none';
        }

        // Filter Management Functions
        function showSaveFilter() {
            if (!gridApi) {
                alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á');
                return;
            }

            const filterModel = gridApi.getFilterModel();
            if (Object.keys(filterModel).length === 0) {
                alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô');
                return;
            }

            document.getElementById('filterName').value = '';
            document.getElementById('saveFilterModal').style.display = 'block';
        }

        function closeSaveFilterModal() {
            document.getElementById('saveFilterModal').style.display = 'none';
        }

        function saveFilter() {
            const filterName = document.getElementById('filterName').value.trim();
            
            if (!filterName) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á');
                return;
            }

            const filterModel = gridApi.getFilterModel();
            const quickSearchValue = document.getElementById('quickSearch').value;

            const filterData = {
                name: filterName,
                filterModel: filterModel,
                quickSearch: quickSearchValue,
                timestamp: new Date().toISOString()
            };

            const existingIndex = savedFilters.findIndex(f => f.name === filterName);
            if (existingIndex >= 0) {
                if (!confirm('‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                    return;
                }
                savedFilters[existingIndex] = filterData;
            } else {
                savedFilters.push(filterData);
            }

            localStorage.setItem('shapefileFilters', JSON.stringify(savedFilters));
            
            alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            closeSaveFilterModal();
        }

        function showLoadFilter() {
            const filterList = document.getElementById('filterList');
            filterList.innerHTML = '';

            if (savedFilters.length === 0) {
                filterList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-folder-open"></i>
                        <p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ</p>
                    </div>
                `;
            } else {
                savedFilters.forEach((filter, index) => {
                    const div = document.createElement('div');
                    div.className = 'filter-item';
                    
                    const timestamp = new Date(filter.timestamp).toLocaleString('th-TH');
                    
                    div.innerHTML = `
                        <div>
                            <div class="filter-name">${filter.name}</div>
                            <div class="filter-date">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${timestamp}</div>
                        </div>
                        <div class="filter-actions">
                            <button class="btn-filter-action btn-load" onclick="loadFilter(${index})">
                                <i class="fas fa-download"></i> ‡πÇ‡∏´‡∏•‡∏î
                            </button>
                            <button class="btn-filter-action btn-delete" onclick="deleteFilter(${index})">
                                <i class="fas fa-trash"></i> ‡∏•‡∏ö
                            </button>
                        </div>
                    `;
                    filterList.appendChild(div);
                });
            }

            document.getElementById('loadFilterModal').style.display = 'block';
        }

        function closeLoadFilterModal() {
            document.getElementById('loadFilterModal').style.display = 'none';
        }

        function loadFilter(index) {
            if (!gridApi) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô');
                return;
            }

            const filter = savedFilters[index];
            
            gridApi.setFilterModel(filter.filterModel);
            
            if (filter.quickSearch) {
                document.getElementById('quickSearch').value = filter.quickSearch;
                gridApi.setQuickFilter(filter.quickSearch);
            }

            alert('‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            closeLoadFilterModal();
        }

        function deleteFilter(index) {
            if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                return;
            }

            savedFilters.splice(index, 1);
            localStorage.setItem('shapefileFilters', JSON.stringify(savedFilters));
            
            showLoadFilter();
        }

        // Original export function
        function exportToExcel() {
            if (!gridApi) {
                alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å');
                return;
            }

            const filteredData = [];
            gridApi.forEachNodeAfterFilter(node => {
                filteredData.push(node.data);
            });

            const ws = XLSX.utils.json_to_sheet(filteredData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "ShapefileData");
            
            const exportFileName = originalFileName ? `${originalFileName}.xlsx` : 'shapefile_data.xlsx';
            XLSX.writeFile(wb, exportFileName);
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + F for quick search
            if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
                e.preventDefault();
                document.getElementById('quickSearch').focus();
            }
        });
    </script> 
    <script>
    const menuBtn = document.getElementById('mobileMenuBtn');
    const nav = document.getElementById('mainNav');

    menuBtn.addEventListener('click', () => {
        menuBtn.classList.toggle('active');
        nav.classList.toggle('active');
    });

    function toggleMobileDropdown(element) {
        if (window.innerWidth <= 1200) {
            element.classList.toggle('active');
        }
    }
    
    // ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á
    document.addEventListener('click', (e) => {
        if (!nav.contains(e.target) && !menuBtn.contains(e.target) && nav.classList.contains('active')) {
            nav.classList.remove('active');
            menuBtn.classList.remove('active');
        }
    });
</script>
<script data-goatcounter="https://mponline.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script> 
</body>
</html>
